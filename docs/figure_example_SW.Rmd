---
title: "Figure Examples"
output: html_document
date: "2023-05-10"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("./packages.R")
  library(patchwork)
  library(egg)
  library(ggbreak)
  devtools::load_all()
}
```

```{r}
tar_load(config)
tar_load(clean_data)
tar_load(data_min)
tar_load(data_raw)
# tar_load(clean_data_index)
tar_load(figmap_leep_cone)
tar_load(figmap_leep_timeseries)
tar_load(figmap_leep_stackbar)

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

# convert EJ to Quad
clean_data = clean_data %>% mutate(value = case_when(
  unit == "EJ/yr" ~ value * 0.9478,
  TRUE ~ value
)) %>% mutate(unit = case_when(
  unit == "EJ/yr" ~ "Quads",
  TRUE ~ unit
))

# clean_data = clean_data %>% mutate(value = case_when(
#     (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Buildings") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value) / 2,
#     (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Industry") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value) / 2,
#     (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Transportation") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value) / 2,
#     
#     (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Buildings") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value) / 2,
#     (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Industry") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value) / 2,
#     (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Transportation") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value) / 2,
#   TRUE ~ value
# ))

cap_add_avg = clean_data %>% 
  filter(model %in% c("USREP-ReEDS", "GCAM-PNNL", "OP-NEMS"), 
         (grepl("Capacity Additions", variable) | grepl("Capacity Retirements", variable)),
         (year >= 2021 | year <= 2035)) %>%
  filter(!(variable %in% c("Capacity Additions|Electricity|Biomass", "Capacity Additions|Electricity|Biomass|w/ CCS", "Capacity Additions|Electricity|Biomass|w/o CCS",
                           "Capacity Additions|Electricity|Coal", "Capacity Additions|Electricity|Gas", 
                           "Capacity Additions|Electricity|Geothermal", 
                           "Capacity Additions|Electricity|Oil", "Capacity Additions|Electricity|Oil|w/ CCS", "Capacity Additions|Electricity|Oil|w/o CCS",
                           "Capacity Additions|Electricity|Solar|CSP","Capacity Additions|Electricity|Solar|PV",
                           "Capacity Additions|Electricity|Solar|PV|Rooftop","Capacity Additions|Electricity|Solar|PV|Utility-Scale",
                           "Capacity Additions|Electricity|Storage Capacity|Battery","Capacity Additions|Electricity|Storage Capacity|PSH",
                           "Capacity Additions|Electricity|Wind|Offshore","Capacity Additions|Electricity|Wind|Onshore",
                           "Capacity Additions|Electricity|Gas|CT|w/o CCS","Capacity Additions|Electricity|Gas|CT|w/ CCS", "Capacity Additions|Electricity|Gas|CT",
                           "Capacity Additions|Electricity|Gas|CC|w/o CCS","Capacity Additions|Electricity|Gas|CC|w/ CCS", "Capacity Additions|Electricity|Gas|CC",
                           "Capacity Additions|Electricity|Gas|ST|w/o CCS","Capacity Additions|Electricity|Gas|ST|w/ CCS", "Capacity Additions|Electricity|Gas|ST",
                           "Capacity Additions|Electricity"))) %>%
    filter(!(variable %in% c("Capacity Retirements|Electricity|Biomass", "Capacity Retirements|Electricity|Biomass|w/ CCS", 
                           "Capacity Retirements|Electricity|Biomass|w/o CCS",
                           "Capacity Retirements|Electricity|Coal", "Capacity Retirements|Electricity|Gas", 
                           "Capacity Retirements|Electricity|Geothermal", 
                           "Capacity Retirements|Electricity|Oil", "Capacity Retirements|Electricity|Oil|w/ CCS", "Capacity Retirements|Electricity|Oil|w/o CCS",
                           "Capacity Retirements|Electricity|Solar|CSP","Capacity Retirements|Electricity|Solar|PV",
                           "Capacity Retirements|Electricity|Solar|PV|Rooftop","Capacity Retirements|Electricity|Solar|PV|Utility-Scale",
                           "Capacity Retirements|Electricity|Storage Capacity|Battery","Capacity Retirements|Electricity|Storage Capacity|PSH",
                           "Capacity Retirements|Electricity|Wind|Offshore","Capacity Retirements|Electricity|Wind|Onshore",
                           "Capacity Retirements|Electricity|Gas|CT|w/o CCS","Capacity Retirements|Electricity|Gas|CT|w/ CCS", 
                           "Capacity Retirements|Electricity|Gas|CT",
                           "Capacity Retirements|Electricity|Gas|CC|w/o CCS","Capacity Retirements|Electricity|Gas|CC|w/ CCS", 
                           "Capacity Retirements|Electricity|Gas|CC",
                           "Capacity Retirements|Electricity|Gas|ST|w/o CCS","Capacity Retirements|Electricity|Gas|ST|w/ CCS", 
                           "Capacity Retirements|Electricity|Gas|ST",
                           "Capacity Retirements|Electricity"))) %>%
  group_by(model, scenario, unit, datasrc, variable, region) %>%
  summarize(value = mean(value)) %>%
  mutate(variable = paste0(variable,"|Average 2021-2035"), year = 2035)

clean_data = rbind(clean_data, cap_add_avg)

clean_data %>% write.csv("output/data/clean_data.csv", row.names = FALSE)

# data_cdr = data.frame("model" = rep("EIA-LTS",16), "year" = seq(2005,2020,by = 1), "unit" = rep("Mt CO2/yr",16), "scenario" = rep("Historic",16),
#                         "datasrc" = rep("LTS_data_small.xlsx",16), variable = rep("Emissions|CO2|CDR",16), region = "United States",
#                         "value" = rep(0,16))
# clean_data = rbind(clean_data,data_cdr)
```


```{r, eval = FALSE}
# This function does a bunch of stuff
# Calls the main functions to print a spagetti plot
# Then makes some dot plots to show the distributions: one for 2030, one for 2035
# The inputs are the same as for the print_graph() function, plus some new ones:
#   ymin and ymax: to manually set the y axis limits so that the axes line up across plots
#   plot_title: manually set the plot title of the combined plot
#   metric: what centrality metric to show on the dot plots: "mean" or "median"
dot_plots_sens = function(plot_type, config, emf_data_long, figmap, figure_num, reg, ymin, ymax, plot_title, metric, labels = FALSE, historic_coord = c(0,0), iralow_coord = c(0,0), irahigh_coord = c(0,0)) {
  
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # make the spagetti plot
  fig = print_graph(plot_type, config, emf_data_long, figmap, figure_num, reg)
  # update the axis range
  fig = fig + scale_y_continuous(limits = c(ymin, ymax)) +
      #scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035), labels = c(2005, 2021, 2025, 2030, 2035)) +
      scale_alpha(range = c(0.6, 1), guide = "none") + 
      annotate("text", x = historic_coord[1], y = historic_coord[2], label = "Historic", color = "black", alpha = 1) +
      annotate("text", x = iralow_coord[1], y = iralow_coord[2], label = "IRA.Low", color = "#A1A1A1", alpha = 1) +
      annotate("text", x = irahigh_coord[1], y = irahigh_coord[2], label = "IRA.High", color = "#363636", alpha = 1) +
      theme(legend.position = "none", plot.title = element_blank())
  
  if (labels) {
    label_data = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
      filter(year == 2035)
    print(unique(label_data$model))
    fig = fig + 
      geom_text(data = label_data, aes(x = year + 0.25, y = value, label = model, color = scenario), size = 2, hjust = 0) +
      #geom_text_repel(data = label_data, aes(label = model), size = 2, hjust = 0) +
      scale_x_continuous(limits = c(NA,2037))
  }
  
  # pull the data from the graph and filter/summarize for 2030/2035
  df_30 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  df_35 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  
  stats = 0
  # these are the summary stats we'll eventually want to overlay on the plot to highlight the efficacy of the IRA
  # preira_mean_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean
  # ira_mean_30 = df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  # preira_mean_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean
  # ira_mean_35 = df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  # preira_med_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median
  # ira_med_30 = df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  # preira_med_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median
  # ira_med_35 = df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # 
  # # calculate raw differences
  # mean_diff_30 = preira_mean_30 - ira_mean_30
  # mean_diff_35 = preira_mean_35 - ira_mean_35
  # med_diff_30 = preira_med_30 - ira_med_30
  # med_diff_35 = preira_med_35 - ira_med_35
  # 
  # # calculate percent differences
  # mean_pctdiff_30 = mean_diff_30 / preira_mean_30
  # mean_pctdiff_35 = mean_diff_35 / preira_mean_35
  # med_pctdiff_30 = med_diff_30 / preira_med_30
  # med_pctdiff_35 = med_diff_35 / preira_med_35
  # 
  # # stick em all in a data frame
  # # stats = 0
  # stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"),
  #                    "No IRA mean" = c(preira_mean_30, preira_mean_35, preira_med_30, preira_med_35),
  #                    "IRA mean" = c(ira_mean_30, ira_mean_35, ira_med_30, ira_med_35),
  #                    "difference" = c(mean_diff_30, mean_diff_35, med_diff_30, med_diff_35),
  #                    "percent difference" = c(mean_pctdiff_30, mean_pctdiff_35, med_pctdiff_30, med_pctdiff_35))

  # still not entirely sure what this does...
  # subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario),
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = mean, color = scenario), 
                          label = "Avg", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = median, color = scenario), 
                          label = "Med", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  }
  
  # dot plot for 2030
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions Sensitivity") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions Sensitivity") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # combine all the plots
  final = fig + dots_30 + dots_35 + 
    plot_annotation(title = plot_title, theme = theme(plot.title = element_blank())) +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
  # return the full plot + the components + the summary stats
  return(list(
    full = final,
    line = fig,
    dot1 = dots_30,
    dot2 = dots_35,
    stats = stats
  ))
}

# p = dot_plots("time_series", config, clean_data, figmap_leep_timeseries, 4, "United States", 0, 2500, "Emissions|CO2|Energy|Demand|Electricity", metric = "median")
# print(p$full)
# print(p$stats)

```

## Function for Spaghetti plots
```{r}
# function for spaghetti plots + dot plots
dot_plots = function(plot_type, config, emf_data_long, figmap, figure_num, reg, ymin, ymax, plot_title, metric, labels = FALSE, hist_year = 2021, historic_coord = c(0,0), preira_coord = c(0,0), ira_coord = c(0,0)) {
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # make the spagetti plot
  fig = print_graph(plot_type, config, emf_data_long, figmap, figure_num, reg)
  # update the axis range
  fig = fig + scale_y_continuous(limits = c(ymin, ymax)) +
      scale_x_continuous(breaks = c(2005,2010, hist_year, 2025, 2030, 2035), labels = c(2005, 2010, hist_year, 2025, 2030, 2035)) +
      scale_alpha(range = c(0.6, 1), guide = "none") + 
      annotate("text", x = historic_coord[1], y = historic_coord[2], label = "Historic", color = "black", alpha = 1) +
      annotate("text", x = preira_coord[1], y = preira_coord[2], label = "No IRA", color = "#F28063", alpha = 1) +
      annotate("text", x = ira_coord[1], y = ira_coord[2], label = "IRA", color = "#0388B3", alpha = 1) +
      theme(legend.position = "none", plot.title = element_blank())
  
  if (labels) {
    label_data = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
      filter(year == 2035)
    print(unique(label_data$model))
    fig = fig + 
      geom_text(data = label_data, aes(x = year + 0.25, y = value, label = model, color = scenario), size = 2, hjust = 0) +
      #geom_text_repel(data = label_data, aes(label = model), size = 2, hjust = 0) +
      scale_x_continuous(limits = c(NA,2037))
  }
  
  # pull the data from the graph and filter/summarize for 2030/2035
  df_30 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  df_35 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  
  # these are the summary stats we'll eventually want to overlay on the plot to highlight the efficacy of the IRA
  preira_mean_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean
  ira_mean_30 = df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  preira_mean_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean
  ira_mean_35 = df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  preira_med_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median
  ira_med_30 = df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  preira_med_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median
  ira_med_35 = df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  
  # calculate raw differences
  mean_diff_30 = preira_mean_30 - ira_mean_30
  mean_diff_35 = preira_mean_35 - ira_mean_35
  med_diff_30 = preira_med_30 - ira_med_30
  med_diff_35 = preira_med_35 - ira_med_35
  
  # calculate percent differences
  mean_pctdiff_30 = mean_diff_30 / preira_mean_30
  mean_pctdiff_35 = mean_diff_35 / preira_mean_35
  med_pctdiff_30 = med_diff_30 / preira_med_30
  med_pctdiff_35 = med_diff_35 / preira_med_35
  
  # stick em all in a data frame
  stats = 0
  # stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"),
  #                    "No IRA mean" = c(preira_mean_30, preira_mean_35, preira_med_30, preira_med_35),
  #                    "IRA mean" = c(ira_mean_30, ira_mean_35, ira_med_30, ira_med_35),
  #                    "difference" = c(mean_diff_30, mean_diff_35, med_diff_30, med_diff_35),
  #                    "percent difference" = c(mean_pctdiff_30, mean_pctdiff_35, med_pctdiff_30, med_pctdiff_35))

  # still not entirely sure what this does...
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario),
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = mean, color = scenario), 
                          label = "Avg", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = median, color = scenario), 
                          label = "Med", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  }
  
  # dot plot for 2030
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # grapes
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # combine all the plots
  final = fig + dots_30 + dots_35 + 
    plot_annotation(title = plot_title, theme = theme(plot.title = element_blank())) +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
  # return the full plot + the components + the summary stats
  return(list(
    full = final,
    line = fig,
    dot1 = dots_30,
    dot2 = dots_35,
    stats = stats
  ))
}


```

## Some data manipulations
```{r}
duplicate_historical_data <- function(data_long, hist_model, hist_year, criteria = FALSE) {
  # short circuit
  if (hist_model == "none") {
    return(data_long)
  }

  # this is the data we'll stamp for every model
  copy_data = data_long %>% filter(model == hist_model, year == hist_year)

  # this is all the historical data, don't lose it
  hist_data = data_long %>% filter(model == hist_model & year <= hist_year)
  # temporary data_long which will be appended many times
  data_in = data_long %>% filter(year >= hist_year & model != hist_model)
  
  if (criteria) {
    data_25 = data_long %>% filter(model != hist_model, year == 2025) %>%
      mutate(year = hist_year)
    data_in = bind_rows(data_in, data_25)
  }
  
  data_wide = data_in %>% left_join(select(copy_data,c(value,year,variable,region)), by = c("year", "variable","region")) %>%
    mutate(value = case_when(
      year == hist_year & !is.na(value.y) ~ value.y,
      TRUE ~ value.x
    )) %>%
    select(-c(value.x,value.y))
  
  data_final = bind_rows(data_wide, hist_data)                        

  # the end
  return(data_final)
}

# remove all historical data and replace with EIA-LTS 2020 data for connectivity purposes
# clean_data2 = clean_data %>% duplicate_historical_data("EIA-LTS",2020)
```

## Function for cone plots for LTS plots
```{r}
# function for coneplot with dots overlaid
lts_coneplot_with_dots = function(config, data, figmap, lts_fignum, leep_fignum, region, ymin, ymax, title, titlesize = 8, metric = "mean", facet = FALSE) {
  # update the historical data (is this even necessary anymore?)
  data = data %>% duplicate_historical_data("EIA-LTS",2020)
  
  # make the LTS cone plot
  fig1 = print_graph("cone_uncertainty", config, data, figmap, lts_fignum, region) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    scale_x_continuous(breaks = c(2005, 2021, 2030, 2035, 2050), labels = c(2005, 2021, 2030, 2035, 2050)) +
    #again
    theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.ticks = element_blank(), plot.title = element_text(hjust = 0.5, size = titlesize))
    
  
  # extract points and summary statistics for 2030 and 2035
  df_30 = data_from_graph("cone_uncertainty", config, data, figmap, leep_fignum, region) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = data_from_graph("cone_uncertainty", config, data, figmap, leep_fignum, region) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  if (facet) {
    dash_len = 2.0
  } else {
    dash_len = 0.5
  }
  
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - dash_len, xend = year + dash_len, y = mean, yend = mean, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - dash_len, xend = year + dash_len, y = mean, yend = mean, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - dash_len, xend = year + dash_len, y = median, yend = median, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - dash_len, xend = year + dash_len, y = median, yend = median, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
  }

  
  fig2 = fig1 +
    geom_point(data = df_30, aes(x = year, y = value, color = variable_rename), 
               shape = 1, size = 2, position = position_dodge(width = 1)) +
    segment_code_30 +
    geom_point(data = df_35, aes(x = year, y = value, color = variable_rename), 
               shape = 1, size = 2, position = position_dodge(width = 1)) +
    segment_code_35 +
    ggtitle(title) +
    theme(legend.position = "none", axis.title.x = element_blank())
    #bottom1
  return(fig2)
  
}

```

# PLOTS START HERE

## Figures 6.3, 6.4, 6.5
Faceted Versions of LTS Cone plots
```{r}
# Buildings Energy: Figure 6.4

p = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 15, 16, "United States", 0, 15, title = "Buildings Sector Final Energy", "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Electricity', 'Non-Electric'))) +
  theme(plot.title = element_blank())
p
ggsave(filename = "output/leep/cone_uncertainty/Fig6.4_LTS_cone_buildings_facet.svg",p, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.4_LTS_cone_buildings_facet.png",p, width = 7, height = 5, units = "in")

# Transportation Energy: Figure 6.3
p3 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 11, 12, "United States", 0, 30, title = "Transportation Sector Final Energy" , "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Fuels'))) +
  theme(plot.title = element_blank())
p3
ggsave(filename = "output/leep/cone_uncertainty/Fig6.3_LTS_cone_transport_facet.svg",p3, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.3_LTS_cone_transport_facet.png",p3, width = 7, height = 5, units = "in")

# Industrial Energy: Figure 6.5
p4 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 13, 14, "United States", 0, 23, title = "Industrial Sector Final Energy", "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Fuels'))) +
  theme(plot.title = element_blank())
p4
ggsave(filename = "output/leep/cone_uncertainty/Fig6.5_LTS_cone_industry_facet.svg", p4, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.5_LTS_cone_industry_facet.png", p4, width = 7, height = 5, units = "in")

# # Economy-wide Emissions
# p5 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 9, 10, "United States", -100, 2500, title = "Economy-Wide Combustions Emissions by Sector", "median", facet = TRUE) +
#   facet_grid(~factor(variable_rename, levels=c('Electricity', 'Transportation', 'Buildings', 'Industry')))
# # p5
# ggsave(filename = "output/leep/cone_uncertainty/Fig6.2_LTS_cone_emissions_facet.svg", p5, width = 7, height = 5, units = "in")
# ggsave(filename = "output/leep/cone_uncertainty/Fig6.2_LTS_cone_emissions_facet.png", p5, width = 7, height = 5, units = "in")
  

# filler = data.frame("model" = c("NA"), "scenario" = c("NA"), "year" = c(2020), variable = c("Emissions|CO2|Energy|Supply|Electricity"),
#                variable_rename = c("Electricity"), unit = c("Mt CO2/yr"), value = c(-200))
  
# Economy-wide Indirect Emissions
# p6 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 17, 18, "United States", 
#                             -100, 2500, "median", facet = TRUE) +
#   theme(axis.text.y = element_blank(), plot.title = element_blank(), axis.title.y = element_blank()) +
#   facet_grid(~factor(variable_rename, levels = c('Electricity', 'Transportation', 'Buildings', 'Industry')))
# p6

# p6a = filler %>% ggplot() +
#   geom_point(aes(x = year, y = value)) +
#   labs(y = "Mt CO2/yr") +
#   scale_y_continuous(limits = c(-100, 2500)) +
#   scale_x_continuous(limits = c(2005, 2050), 
#                      breaks = c(2005, 2021, 2030, 2040, 2050), labels = c(2005, 2021, 2030, 2040, 2050)) +
#   facet_grid(~factor(variable_rename, levels = c('Electricity', 'Transportation', 'Buildings', 'Industry'))) +
#   theme_emf() +
#   theme(axis.ticks = element_blank(), axis.title.x = element_blank(),
#         axis.text.x = element_text(angle = 45, hjust = 1))
# # p6a
# 
# p6b = (p6a | p6) +
#   plot_annotation(title = "Economy-Wide Emissions from Electricity Used", theme = theme(plot.title = element_text(hjust = 0.5))) +
#   plot_layout(widths = c(1,3)) +
#   theme(plot.margin = margin(0,0,0,0))
  
#p6b
#ggsave(filename = "output/leep/cone_uncertainty/Fig6.2A_LTS_cone_indirect_emissions_facet.svg", p6b, width = 7, height = 5, units = "in")

  
```

```{r}
#supporting data for cone plots
dta1 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 15, "United States")
dta2 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 16, "United States")
dta = rbind(dta1, dta2)
dta %>% write.csv("output/data/SW/Fig6.4_LTS_cone_buildings_facet.csv", row.names = FALSE)

dta1 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 11, "United States")
dta2 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 12, "United States")
dta = rbind(dta1, dta2)
dta %>% write.csv("output/data/SW/Fig6.3_LTS_cone_transport_facet.csv", row.names = FALSE)

dta1 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 13, "United States")
dta2 = data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, 14, "United States")
dta = rbind(dta1, dta2)
dta %>% write.csv("output/data/SW/Fig6.4_LTS_cone_industry_facet.csv", row.names = FALSE)

```


```{r, eval = FALSE}
# data table for LTS plots -- Needs to be updated
leep_models = c("USREP-ReEDS", "EPS-EI", "GCAM-CGS", "GCAM-PNNL", "GCAM-USA", "Haiku-RFF", "IPM-NRDC",
                "IPM-EPA", "MARKAL-NETL", "NEMS-RHG", "NEMS-RHG", "OP-NEMS", "REGEN-EPRI", "RIO-REPEAT",
                "ReEDS-NREL", "Scout-LEEP", "EIA-LTS", "EIA-STEO", "IEA")

clean_data10 = clean_data %>% mutate(
  variable = case_when(
    (model == "GCAM-LTS" & variable == "Emissions|CO2|Energy|Demand|Industry") ~
      "Emissions|CO2|Energy|Demand|Industry and Fuel Production",
    TRUE ~ variable
  )
)

lts_data_table = function(focus, leep_models) {
  print(focus)
  dta_lts = clean_data10 %>% 
    filter(variable == focus, model == "GCAM-LTS", scenario == "LTS.Mid1", year %in% c(2030, 2035)) %>%
    group_by(year, unit) %>%
    summarize(median = median(value)) %>%
    mutate(scenario = "NZ2050")
  
  dta_leep = clean_data10 %>% 
    filter(variable == focus, model %in% leep_models, year %in% c(2030, 2035), scenario == "IRA") %>%
    group_by(year, unit) %>%
    summarize(median = median(value)) %>%
    mutate(scenario = "IRA")
  
  dta_combo = rbind(dta_lts, dta_leep) %>%
    mutate(variable = focus) %>%
    select(scenario, variable, year, unit, median) %>%
    pivot_wider(names_from = scenario, values_from = c(median)) %>%
    data.frame() %>%
    rename(median_IRA = IRA) %>%
    rename(median_NZ2050 = NZ2050) %>%
    mutate(diff_median = median_IRA - median_NZ2050) %>%
    # #mutate(diff_mean = mean_IRA - mean_NZ2050) %>%
    mutate(pct_diff_median = diff_median / median_NZ2050)
    # #mutate(pct_diff_mean = diff_mean / mean_NZ2050)
  return(dta_combo)
}

t = lts_data_table("Final Energy|Buildings|NonElectric", leep_models)

# Emissions
tab = rbind(lts_data_table("Emissions|CO2|Energy|Demand|Buildings", leep_models), 
      lts_data_table("Emissions|CO2|Energy|Demand|Industry and Fuel Production", leep_models),
      lts_data_table("Emissions|CO2|Energy|Demand|Transportation", leep_models), 
      lts_data_table("Emissions|CO2|Energy|Supply|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Emissions_LTS_table.csv", row.names = FALSE)

# Final Energy Transport
tab = rbind(lts_data_table("Final Energy|Transportation|Fossil", leep_models),
            lts_data_table("Final Energy|Transportation|Alternative Fuels", leep_models),
            lts_data_table("Final Energy|Transportation|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Transportation_Energy_LTS_table.csv", row.names = FALSE)

# Final Energy Buildings
tab = rbind(lts_data_table("Final Energy|Buildings|Electricity", leep_models),
      lts_data_table("Final Energy|Buildings|NonElectric", leep_models))
print(tab)
write.csv(tab, "output/Buildings_Energy_LTS_table.csv", row.names = FALSE)

# Final Energy Industry
tab = rbind(lts_data_table("Final Energy|Industry|Fossil", leep_models),
            lts_data_table("Final Energy|Industry|Alternative Energy", leep_models), 
            lts_data_table("Final Energy|Industry|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Industrial_Energy_LTS_table.csv", row.names = FALSE)


```

Overlaid Versions of LTS cone plots
```{r, eval = FALSE}
  # p = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 1, 2, "United States", 0, 15, "mean", facet = FALSE)
  # p
  # ggsave(filename = "output/leep/cone_uncertainty/Fig19_LTS_cone_buildings.svg",p, width = 7, height = 5, units = "in")
  # # p2 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 3, 4, "United States", -1000, 2500, "mean", facet = FALSE)
  # # p2
  # # ggsave(filename = "output/leep/cone_uncertainty/LTS_cone_emissions_old.svg",p2, width = 7, height = 5, units = "in")
  # p3 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 5, 6, "United States", 0, 30, "mean", facet = FALSE)
  # p3
  # ggsave(filename = "output/leep/cone_uncertainty/Fig18_LTS_cone_transport.svg",p3, width = 7, height = 5, units = "in")
  # p4 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 7, 8, "United States", 0, 25, "mean", facet = FALSE)
  # p4
  # ggsave(filename = "output/leep/cone_uncertainty/Fig20_LTS_cone_industry.svg",p4, width = 7, height = 5, units = "in")
  # p5 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 3, 4, "United States", -1000, 2500, "mean", facet = FALSE)
  # p5
  # ggsave(filename = "output/leep/cone_uncertainty/Fig17_LTS_cone_emissions_new.svg",p5, width = 7, height = 5, units = "in")
```

## Figure 6.2
```{r}
# LTS Cone plot for economy-wide emissions

# buildings cone
mid = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 23, 24, "United States", -100, 2500, "Buildings", 8, "median", facet = TRUE) +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
mid

# transportation cone
left = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 21, 22, "United States", -100, 2500, "Transportation", 8, "median", facet = TRUE)
left

# industry cone
right = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 25, 26, "United States", -100, 2500, "Industrial", 8, "median", facet = TRUE) +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
right

# electric sector cone
top = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 19, 20, "United States", -100, 2500, "Electric Sector CO2 Emissions", 12, "median", facet = FALSE)
top

# put 'em all together
bottom = (left | mid | right) + plot_annotation(title = "Direct and Indirect CO2 Emissions", theme = theme(plot.title = element_text(hjust = 0.5, size = 12), plot.margin = margin(0,0,0,0)))
bottom

combined = (wrap_elements(top) / wrap_elements(bottom))
combined

ggsave(filename = "output/leep/cone_uncertainty/Fig6.2NEW_LTS_cone_indirect_emissions_TOTAL.svg", 
       combined, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.2NEW_LTS_cone_indirect_emissions_TOTAL.png", 
       combined, width = 7, height = 5, units = "in")

# supporting data
dta = data.frame()
for (i in c(seq(19,26,by = 1))) {
  dta = rbind(dta, data_from_graph("cone_uncertainty", config, clean_data, figmap_leep_cone, i, "United States"))
}
dta %>% write.csv("output/data/SW/Fig6.2NEW_LTS_cone_indirect_emissions_TOTAL.csv", row.names = FALSE)

```


```{r, eval = FALSE}
# uncertainty plot - DEFUNCT
model_labels = FALSE

clean_data2 = clean_data %>% duplicate_historical_data("EIA-STEO",2020, criteria = TRUE) %>% mutate(alpha = 1)
fig = print_graph("time_series", config, clean_data2, figmap_leep_timeseries, 116, "United States") +
   scale_alpha(range = c(0.6, 1), guide = "none")
dta = data_from_graph("time_series", config, clean_data, figmap_leep_timeseries, 116, "United States")
#fig

sens = dot_plots_sens("time_series", config, clean_data2, figmap_leep_timeseries, 116, "United States", 0, 6000, "Emissions", metric = "median", 
                      labels = model_labels, historic_coord = c(2015,5000), iralow_coord = c(2030, 4400), 
                      irahigh_coord = c(2027, 2200))
print(sens$full)

ggsave(filename = "output/leep/time_series/Fig1.4_emis_sensitivity.svg",sens$full, width = 7, height = 5, units = "in")
```

## Figure 3.4
```{r}
# EV share plot
scen_map = read.csv("./data-raw/scenario-mapping.csv") %>% select(datasrc, model, scenario, model_new, scenario_new)

raw = data_raw %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new) %>%
  filter(unit != "thousands") %>%
  filter(!(model == "IEA" & year >= 2022))

iea_2022 = raw %>% filter(model == "IEA", year == 2021) %>% mutate(year = 2022)
clean_data4 = rbind(raw, iea_2022) %>% filter(unit != "thousands") %>% mutate(value = 100 * value) %>%
  filter(model != "EIA-LTS") %>% 
  duplicate_historical_data("IEA",2022, criteria = TRUE) %>% mutate(
    variable = case_when(
      variable %in% c("Energy Service|Transportation|Passenger|BEV|Sales Share",
                      "Energy Service|Transportation|Passenger|FCEV|Sales Share",
                      "Energy Service|Transportation|Passenger|HEV|Sales Share",
                      "Energy Service|Transportation|Freight|BEV|Sales Share",
                      "Energy Service|Transportation|Freight|FCEV|Sales Share",
                      "Energy Service|Transportation|Passenger|PHEV|Sales Share") ~ 
        "Energy Service|Transportation|EV|Sales Share")) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1,
    model == "GCAM-PNNL" ~ 1,
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    TRUE ~ 0.8)
  )

fig = print_graph("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States")
dta = data_from_graph("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States")
#fig

      # annotate("text", x = 2015, y = 8, label = "Historic", color = "black", alpha = 1) +
      # annotate("text", x = 2030, y = 16, label = "No IRA", color = "#0388B3", alpha = 1) +
      # annotate("text", x = 2027, y = 45, label = "IRA", color = "#F28063", alpha = 1) +
p = dot_plots("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States", 0, 100, "EV Share", metric = "mean", hist_year = 2022, historic_coord = c(2015,8), preira_coord = c(2030, 16), ira_coord = c(2027, 45))
print(p$full)
print(p$stats)


ggsave(filename = "output/leep/time_series/Fig3.4_ev_share.svg",p$full, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/time_series/Fig3.4_ev_share.png",p$full, width = 7, height = 5, units = "in")

# supporting data
dta = data_from_graph("time_series", config, clean_data4, figmap_leep_cone, 118, "United States")
dta %>% write.csv("output/data/SW/Fig3.4_ev_share.csv", row.names = FALSE)
```


## Figure 3.2
```{r}

# clean_data5 = data_raw %>% filter(grepl("GHGI",variable)) %>% 
#   select(-c(datasrc,Model,Scenario,Region,Variable,Unit,...34,...35)) %>%
#   gather("year","value","2020":"2018") %>%
#   filter(year >= 1990 & year <= 2021) %>%
#   mutate(year = as.factor(year), datasrc = "x")


fig = print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 3, "United States", 
                  level_var = c("Other", "Pipelines", 
                                "Water", "Aircraft", "MHD Trucks", "LD Trucks", "Passenger Cars")) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), plot.title = element_blank()) +
  bottom1

fig
dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 3, "United States")
#dta

# iea_2022 = clean_data %>% filter(model == "IEA", year == 2021) %>% mutate(year = 2022)
# clean_data3 = rbind(clean_data, iea_2022)
# clean_data3 = clean_data3 %>% filter(model != "EIA-LTS") %>% 
#   duplicate_historical_data("IEA",2022) %>% 
#   mutate(value = 100 * value)
# 
# fig = print_graph("time_series", config, clean_data3, figmap_leep_timeseries, 118, "United States")
# dta = data_from_graph("time_series", config, clean_data3, figmap_leep_timeseries, 118, "United States")
# fig
# 
# p = dot_plots("time_series", config, clean_data3, figmap_leep_timeseries, 118, "United States", 0, 2, "EV Share", metric = "mean")
# print(p$full)
# print(p$stats)


ggsave(filename = "output/leep/stacked_bar/Fig3.2_trans_co2.svg",fig, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig3.2_trans_co2.png",fig, width = 7, height = 5, units = "in")

# supporting data
dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 3, "United States")
dta %>% write.csv("output/data/SW/Fig3.2_trans_co2.csv", row.names = FALSE)
```

## Figure 2.4 (and ES2)
```{r}
# capacity addition plot

ymin = -40
ymax = 130

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

fig = print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States") +
  geom_hline(yintercept = 0, linewidth = 0.25, color = "black") +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  scale_y_continuous(limits = c(ymin, ymax)) +
  ggtitle("Historical Annual Capacity Changes") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 10),
        axis.text.x = element_text(angle = 45))

dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States")

#fig

dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 6, "United States")
dta_ttl = dta4 %>% 
  mutate(temp = case_when(
    grepl("Additions",variable) ~ "Capacity Additions",
    TRUE ~ "Capacity Retirements")) %>%
  group_by(model, scenario, region, datasrc, unit, temp) %>%
  summarize(value = sum(value)) %>% 
  select(-temp) %>%
  mutate(variable_rename = "Total")

dta4 = rbind(dta4,dta_ttl) %>% mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal"))) %>%
  mutate(stagger = case_when((variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value >= 0)) ~ -0.1,
                             (variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value < 0)) ~ 0.1,
                             TRUE ~ 0))

stats = dta4 %>% group_by(variable_rename, stagger) %>% summarize(mean = mean(value), median = median(value))

dotplot2 = dta4 %>% ggplot() + 
  geom_point(aes(x = (as.numeric(variable_rename) + stagger), y = value, color = variable_rename), shape = 16, size = 2) + 
  #geom_point(data = stats, aes(x = variable_rename, y = median, color = variable_rename), shape = 3, size = 2) +
  geom_segment(data = stats, aes(x = as.numeric(variable_rename) - 0.25 + stagger, xend = as.numeric(variable_rename) + 0.25 + stagger, 
                                 y = median, yend = median, color = variable_rename), linewidth = 0.5) +
  geom_hline(yintercept = 0, linewidth = 0.25, color = "black") +
  scale_x_continuous(breaks = seq(1,10), labels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal")) +
  scale_y_continuous(limits = c(ymin, ymax)) +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  ggtitle("Average Annual Capacity Changes (2021-2035)") +
  theme_emf() +
  theme(plot.title = element_text(hjust = 0.5, size = 10), axis.text.y = element_blank(),
        axis.title.y = element_blank(), axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
#dotplot2
  

combined = 
  fig + dotplot2 + 
  plot_annotation(theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(widths = c(1,1)) +
    theme(plot.margin = margin(0,0,0,0))
    # bottom1
combined


ggsave(filename = "output/leep/stacked_bar/Fig2.4_capacity.svg",combined, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig2.4_capacity.png",combined, width = 7, height = 5, units = "in")
print(stats)

#suporting data for plot
dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States")
dta %>% write.csv("output/data/SW/Fig2.4_capacity_bars.csv", row.names = FALSE)
dta4 %>% write.csv("output/data/SW/Fig2.4_capacity_dots.csv", row.names = FALSE)

```


## Figure 5.3
```{r}
# industrial final energy plots

clean_data6 = clean_data %>% duplicate_historical_data("EIA-LTS", 2020) #%>%
  # filter(model != "GCAM-PNNL")

p1 = dot_plots("time_series", config, clean_data6, figmap_leep_timeseries, 119, "United States", 0, 30, "Industrial Final Energy: Fossil", metric = "median", historic_coord = c(2015,15), preira_coord = c(2030, 16), ira_coord = c(2027, 25))
p1$full = p1$full + theme(plot.title = element_blank())
print(p1$full)
ggsave(filename = "output/leep/time_series/Fig5.3_industrial_energy_fossil.svg",p1$full, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/time_series/Fig5.3_industrial_energy_fossil.png",p1$full, width = 7, height = 5, units = "in")
print(p1$stats)

# p2 = dot_plots("time_series", config, clean_data6, figmap_leep_timeseries, 120, "United States", 0, 5, "Industrial Final Energy: Fossil", metric = "median", historic_coord = c(2015,3.2), preira_coord = c(2030, 3), ira_coord = c(2027, 4))
# p2$full = p2$full + theme(plot.title = element_blank())
# print(p2$full)
# ggsave(filename = "output/leep/time_series/Fig5.4_industrial_energy_elec.svg",p2$full, width = 7, height = 5, units = "in")
# print(p2$stats)
# 
# p3 = dot_plots("time_series", config, clean_data6, figmap_leep_timeseries, 121, "United States", 0, 5, "Industrial Final Energy: Fossil", metric = "median", historic_coord = c(2015,3.2), preira_coord = c(2032, .75), ira_coord = c(2027, .6))
# p3$full = p3$full + theme(plot.title = element_blank())
# print(p3$full)
# ggsave(filename = "output/leep/time_series/Fig5.5_industrial_energy_alternative.svg",p3$full, width = 7, height = 5, units = "in")
# print(p3$stats)
# 
# 
# dta = data_from_graph("time_series", config, clean_data, figmap_leep_timeseries, 119, "United States")
# View(dta)

# supporting data for plot
dta = data_from_graph("time_series", config, clean_data6, figmap_leep_timeseries, 119, "United States")
dta %>% write.csv("output/data/SW/Fig5.3_industrial_energy_fossil.csv", row.names = FALSE)



```


## Old figure - defunct
```{r, eval = FALSE}
# old version of figure 1.1 - DEFUNCT
#print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 7, "United States")
dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 7, "United States") %>%
  mutate(variable_rename2 = case_when(
    grepl("Commercial", variable) ~ "Buildings",
    grepl("Residential", variable) ~ "Buildings",
    grepl("Industry", variable) ~ "Industrial",
    grepl("Electricity", variable) ~ "Electricity Generation",
    grepl("Transportation", variable) ~ "Transportation",
    TRUE ~ "Unknown")
  ) %>%
  mutate(variable_rename2 = factor(variable_rename2, levels = c("Buildings", "Industrial", "Transportation", "Electricity Generation")))

totals = dta %>% group_by(variable_rename2, year) %>% summarize(value = sum(value)) %>%
  mutate(value = round(value,0))

dta2 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 8, "United States") %>%
  mutate(variable_rename2 = case_when(
      grepl("Commercial", variable) ~ "Buildings",
      grepl("Residential", variable) ~ "Buildings",
      grepl("Industry", variable) ~ "Industrial",
      grepl("Electricity", variable) ~ "Electricity Generation",
      grepl("Transportation", variable) ~ "Transportation",
      TRUE ~ "Unknown")
    )
eg = data.frame("variable_rename2" = c("Electricity Generation", "Electricity Generation"), "value" = c(0,0), 
                "variable_rename" = c("Indirect", "Indirect"), year = c(2005, 2021))
dta2 = rbind(dta2,eg) %>%
  mutate(variable_rename2 = factor(variable_rename2, levels = c("Buildings", "Industrial", "Transportation", "Electricity Generation")))

totals2 = dta2 %>% group_by(variable_rename2, year) %>% summarize(value = sum(value)) %>%
  mutate(value = round(value,0))

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

p1 = dta %>% ggplot() +
  geom_bar(aes(x = variable_rename2, y = value, fill = variable_rename), position = "stack", stat = "identity") + 
  geom_text(data = totals, aes(x = variable_rename2, y = value, label = value), vjust = -0.4, stat = "identity", size = 3) +
  facet_grid(cols = vars(year)) +
  scale_y_continuous(limits = c(0, 2600)) +
  scale_subpalette(subpalettes, "Emissions Direct") +
  theme_emf() + 
  labs(y = "MMT CO2") +
  theme(axis.text.x = element_blank(), plot.margin = margin(0,0,0,0),
        axis.title.x = element_blank(), axis.ticks = element_blank())
#p1

p2 = dta2 %>% ggplot() +
  geom_bar(aes(x = variable_rename2, y = value, fill = variable_rename), position = "stack", stat = "identity") + 
  geom_text(data = totals2, aes(x = variable_rename2, y = value, label = value), vjust = -0.4, stat = "identity", size = 3) +
  facet_grid(cols = vars(year)) +
  scale_y_continuous(limits = c(0, 2600)) +
  scale_subpalette(subpalettes, "Emissions Direct") +
  # scale_x_discrete(breaks = c("Buildings", "Industrial", "Transportation", "Electricity Generation"), 
  #                  labels = c("Buildings", "Industrial", "Transportation", "Electricity Generation")) +
  theme_emf() + 
  labs(y = "MMT CO2") +
  theme(axis.text.x = element_text(angle = 45, size = 7, hjust = 1),
        axis.title.x = element_blank(), axis.ticks = element_blank(),
        strip.text.x = element_blank(), plot.margin = margin(0,0,0,0))
#p2

combined = p1 / p2 +
  plot_annotation(title = "Emissions from Fossil Fuel Combustion by Sector and Fuel Type", 
                  theme = theme(plot.title = element_text(hjust = 0.5))) +
  plot_layout(guides = "collect")
combined
ggsave(filename = "output/leep/stacked_bar/Fig1.1_emissions.svg",combined, width = 7, height = 5, units = "in")


  

```

More

## Figures 2.6 and 2.7
```{r}
clean_data7 = clean_data %>% duplicate_historical_data("EPA",2021, criteria = TRUE) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1,
    model == "GCAM-PNNL" ~ 1,
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    TRUE ~ 0.8)
  ) %>%
  filter(value > 1e-4)

nox = print_graph("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States") +
  scale_alpha(range = c(0.6, 1), guide = "none")
#nox

sox = print_graph("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States") +
  scale_alpha(range = c(0.6, 1), guide = "none")
#sox

nox_full = dot_plots("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States", 0, 3, "Power Sector NOx Emissions", metric = "median", 
                     historic_coord = c(2015,1.8), preira_coord = c(2030, 0.95), ira_coord = c(2029, 0.15))
print(nox_full$full)
print(nox_full$stats)
ggsave(filename = "output/leep/time_series/Fig2.6_nox.svg",nox_full$full, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/time_series/Fig2.6_nox.png",nox_full$full, width = 7, height = 5, units = "in")

sox_full = dot_plots("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States", 0, 5, "Power Sector SO2 Emissions", metric = "median", 
                     historic_coord = c(2017,2), preira_coord = c(2030, 1.2), ira_coord = c(2029, 0.12))
print(sox_full$full)
print(sox_full$stats)
ggsave(filename = "output/leep/time_series/Fig2.7_sox.svg",sox_full$full, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/time_series/Fig2.7_sox.png",sox_full$full, width = 7, height = 5, units = "in")



dta1 = data_from_graph("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States")
dta2 = data_from_graph("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States")
dta1 %>% write.csv("output/data/SW/Fig2.6_nox.csv", row.names = FALSE)
dta2 %>% write.csv("output/data/SW/Fig2.7_sox.csv", row.names = FALSE)

# View(dta)
```


## New versions of Figure 1.1, 3.1, 4.1, 5.1
```{r}
# Figure 1.1
subpalettes = create_subpalettes(figmap_leep_stackbar, config)
subpalettes$`Emissions Stack`[["Electricity Generation"]] = "#0388B3"
subpalettes$`Emissions Stack`[["Other Sectors"]] = "#DEDEDE"
subpalettes$`Emissions Stack`[["Non-CO2 GHGs"]] = "#469990"

emis_stack = function(dta, title, econwide = FALSE) {
  totals = dta %>% group_by(year) %>%
    summarize(value = sum(value))
  
  dta = dta %>% group_by(year, variable_rename) %>%
    summarize(value = sum(value))
  
  if (econwide) {
    bar_code = geom_bar(aes(x = year, y = value, fill = variable_rename), position = position_stack(), stat = "identity")
  } else {
    bar_code = geom_bar(aes(x = year, y = value, fill = variable_rename, 
                            color = variable_rename, alpha = variable_rename), position = position_stack(reverse = TRUE), stat = "identity")
  }
  
  p = dta %>% ggplot() +
    bar_code +
    #geom_text(aes(x = year, y = value, label = round(value, 0), fill = variable_rename), size = 2.5, position = position_stack(vjust = 0.5, reverse = FALSE)) +
    #geom_text(data = totals, aes(x = year, y = value, label = round(value, 0)), vjust = -0.4, stat = "identity", size = 2.5) +
    scale_x_continuous(breaks = c(2005, 2021), labels = c(2005, 2021)) +
    labs(y = "Mt CO2/yr", title = title) +
    scale_subpalette(subpalettes, "Emissions Stack") +
    theme_emf() + 
    theme(axis.ticks = element_blank(), axis.title.x = element_blank(), plot.title = element_blank()) + 
    bottom1
    
  return(p)  
}

dta1 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct", "Industry: Indirect", "Buildings: Direct", 
                                             "Buildings: Indirect", "Transportation: Direct", "Transportation: Indirect")))

# dta_nonghg = clean_data %>% 
#   filter(scenario == "Historic", model == "EPA-GHGI", year >= 2005,
#          (grepl("CH4", variable) | grepl("F-Gasses", variable) | grepl("NO2", variable))) %>%
#   mutate(variable = "Emissions|Non-CO2", variable_rename = "Non-CO2 GHGs")
# 
# dta1a = rbind(dta1, dta_nonghg) %>%
#   mutate(variable_rename = factor(variable_rename, 
#                                 levels = c("Non-CO2 GHGs",
#                                            "Industry: Indirect", "Industry: Direct", "Buildings: Indirect", 
#                                            "Buildings: Direct", "Transportation: Indirect", "Transportation: Direct")))
  

p1 = emis_stack(dta1, "Economy-Wide CO2 Emissions", econwide = TRUE)
p1
ggsave(filename = "output/leep/stacked_bar/Fig1.1_emis.svg",p1, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig1.1_emis.png",p1, width = 7, height = 5, units = "in")

# p1a = emis_stack(dta1a, "Economy-Wide GHG Emissions")
# p1a
# ggsave(filename = "output/leep/stacked_bar/Fig1.1.2_emis_ghg.svg",p1a, width = 7, height = 5, units = "in")

# 3.1
dta2 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Transportation: Direct" ~ variable_rename,
    variable_rename == "Transportation: Indirect" ~ variable_rename,
    TRUE ~ "Other Sectors"
  )) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Transportation: Direct", "Transportation: Indirect", "Other Sectors")))

p2 = emis_stack(dta2, "Transportation CO2 Emissions") + 
  scale_fill_manual(values = c("Other Sectors" = "white", "Transportation: Indirect" = subpalettes$`Emissions Stack`[["Transportation: Indirect"]], "Transportation: Direct" = subpalettes$`Emissions Stack`[["Transportation: Direct"]])) + 
  scale_color_manual(values = c("Other Sectors" = "#CECECE", "Transportation: Indirect" = subpalettes$`Emissions Stack`[["Transportation: Indirect"]], "Transportation: Direct" = subpalettes$`Emissions Stack`[["Transportation: Direct"]])) +
  scale_alpha_manual(values = c("Other Sectors" = 0.5, "Transportation: Indirect" = 1, "Transportation: Direct" = 1))
p2
ggsave(filename = "output/leep/stacked_bar/Fig3.1_emis_trans.svg",p2, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig3.1_emis_trans.png",p2, width = 7, height = 5, units = "in")


# 4.1
dta3 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Buildings: Direct" ~ variable_rename,
    variable_rename == "Buildings: Indirect" ~ variable_rename,
    TRUE ~ "Other Sectors"
  )) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Buildings: Direct", "Buildings: Indirect","Other Sectors")))

p3 = emis_stack(dta3, "Buildings CO2 Emissions") + 
  scale_fill_manual(values = c("Other Sectors" = "white", "Buildings: Indirect" = subpalettes$`Emissions Stack`[["Buildings: Indirect"]], "Buildings: Direct" = subpalettes$`Emissions Stack`[["Buildings: Direct"]])) +
  scale_color_manual(values = c("Other Sectors" = "#CECECE", "Buildings: Indirect" = subpalettes$`Emissions Stack`[["Buildings: Indirect"]], "Buildings: Direct" = subpalettes$`Emissions Stack`[["Buildings: Direct"]])) +
  scale_alpha_manual(values = c("Other Sectors" = 0.5, "Buildings: Indirect" = 1, "Buildings: Direct" = 1))
p3
ggsave(filename = "output/leep/stacked_bar/Fig4.1_emis_build.svg",p3, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig4.1_emis_build.png",p3, width = 7, height = 5, units = "in")


# 5.1
dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Industry: Direct" ~ variable_rename,
    variable_rename == "Industry: Indirect" ~ variable_rename,
    TRUE ~ "Other Sectors"
  )) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct","Industry: Indirect", "Other Sectors")))

p4 = emis_stack(dta4, "Industrial CO2 Emissions") + 
  scale_fill_manual(values = c("Other Sectors" = "white", "Industry: Indirect" = subpalettes$`Emissions Stack`[["Industry: Indirect"]], "Industry: Direct" = subpalettes$`Emissions Stack`[["Industry: Direct"]])) +
  scale_color_manual(values = c("Other Sectors" = "#CECECE", "Industry: Indirect" = subpalettes$`Emissions Stack`[["Industry: Indirect"]], "Industry: Direct" = subpalettes$`Emissions Stack`[["Industry: Direct"]])) +
  scale_alpha_manual(values = c("Other Sectors" = 0.5, "Industry: Indirect" = 1, "Industry: Direct" = 1))
p4
ggsave(filename = "output/leep/stacked_bar/Fig5.1_emis_ind.svg",p4, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/stacked_bar/Fig5.1_emis_ind.png",p4, width = 7, height = 5, units = "in")


# # 2.1 (MAYBE)
# dta5 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
#   mutate(variable_rename = case_when(
#     variable_rename == "Industry: Indirect" ~ "Electricity Generation",
#     variable_rename == "Buildings: Indirect" ~ "Electricity Generation",
#     variable_rename == "Transportation: Indirect" ~ "Electricity Generation",
#     TRUE ~ "Other Sectors"
#   )) %>%
#   mutate(variable_rename = factor(variable_rename, 
#                                   levels = c("Other Sectors", "Electricity Generation")))
# 
# p5 = emis_stack(dta5, "Electric Sector Emissions")
# p5
# ggsave(filename = "output/leep/stacked_bar/Fig2.1_emis_elec.svg",p5, width = 7, height = 5, units = "in")


# supporting data for figures
dta1 %>% write.csv("output/data/SW/Fig1.1_emis.csv", row.names = FALSE)


```
## Figure not used - co2 vs. non co2 historical emissions
```{r}
# Didn't end up using this graph
subpalettes = create_subpalettes(figmap_leep_stackbar, config)
subpalettes$`Total GHGs4`[["CO2"]] = "#0388B3"

dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 13, "United States")
diff = dta %>% mutate(value = case_when(
    variable == "Emissions|Non-CO2 GHG" ~ -value, 
    TRUE ~ value
  )) %>%
  group_by(year) %>% summarize(value = sum(value)) %>%
  mutate(variable = "Emissions|CO2", unit = "Mt CO2e/yr", variable_rename = "CO2")
dta2 = rbind(dta,diff) %>% filter(variable != "Emissions|GHG") %>%
  mutate(variable_rename = factor(variable_rename, levels = c("NonCO2","CO2")))

totals = dta2 %>% group_by(year) %>% summarize(value = sum(value))

p = dta2 %>% ggplot() +
  geom_bar(aes(x = year, y = value, fill = variable_rename), position = position_stack(reverse = FALSE), stat = "identity") +
  geom_text(aes(x = year, y = value, fill = variable_rename, label = round(value, 0)), position = position_stack(reverse = FALSE, vjust = 0.5), stat = "identity") +
  geom_text(data = totals, aes(x = year, y = value, label = round(value, 0)), vjust = -0.4, stat = "identity") +
  scale_subpalette(subpalettes, "Total GHGs4") +
  scale_x_continuous(breaks = c(2005, 2021), labels = c(2005, 2021)) +
  scale_y_continuous(limits = c(0, 8000)) +
  labs(y = "Mt CO2e/yr", title = "Total Historic GHG Emissions: 2005, 2021") +
  theme_emf() + 
  theme(axis.ticks = element_blank(), axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5))
p

ggsave(filename = "output/leep/stacked_bar/Fig1.1a_emis_nonco2ghg.svg",p, width = 7, height = 5, units = "in")


```
## Figure 2.5
```{r}
# electric sector emissions sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High")
panel2_scens = c() # Economic Growth
panel3_scens = c("Low Gas Price","High Gas Price", "Core") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Core") # Technology Cost
panel5_scens = c("Constrained Deployment", "Core") # Deployment Constraints

sens_dta = clean_data %>% filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
                                 year %in% c(2030, 2035)) #%>% 
#  mutate(year = factor(year))

print(max(sens_dta$value))
print(min(sens_dta$value))

filler = data.frame(year = c(203), value = c(-200), scenario = c(""), model = c("NA"))

sens_dta_panel1 = sens_dta %>% filter(scenario %in% panel1_scens) %>%
  filter(model %in% c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI")) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))
sens_dta_panel2 = sens_dta %>% filter(scenario %in% panel3_scens) %>% mutate(value = -200) %>%
  bind_rows(filler)
sens_dta_panel3 = sens_dta %>% filter(scenario %in% panel3_scens) %>%
  bind_rows(filler)
sens_dta_panel4 = sens_dta %>% filter(scenario %in% panel4_scens) %>% 
  bind_rows(filler)
sens_dta_panel5 = sens_dta %>% filter(scenario %in% panel5_scens) %>%
  bind_rows(filler)

sens_dot_plot = function(dta, title, far_left = FALSE, single = FALSE, ymin = 0, ymax = 0, ira_coord = c(0,0), low_coord = c(0,0), high_coord = c(0,0)) {
  if (far_left) {
    point_code = geom_point(aes(x = year + stagger, y = value, color = scenario), shape = 1, size = 2)
  } else {
    point_code = geom_point(aes(x = year, y = value), shape = 1, size = 2)
  }
  
  if (far_left) {
    stats = dta %>% 
      mutate(scenario = case_when(scenario == "Core" ~ "IRA", TRUE ~ scenario)) %>%
      group_by(year, stagger, scenario) %>%
      summarize(median = median(value))
    if (single) {
      width = 0.2
      left_margin = 11.5
    } else {
      width = 0.5
      left_margin = 0.5
    }
    segment_code = geom_segment(data = stats, 
                                aes(x = year + stagger - width, xend = year + stagger + width, 
                                    y = median, yend = median, color = scenario), 
                                linewidth = 0.5)
  } else {
    dta$stagger = 0
    stats = dta %>% 
      mutate(scenario = case_when(scenario == "Core" ~ "IRA", TRUE ~ scenario)) %>%
      group_by(year, stagger) %>%
      summarize(median = median(value))
    segment_code = geom_segment(aes(x = year, xend = year, y = -5000, yend = -5000))
    left_margin = 0.5
  }
  
  stats = dta %>% 
    mutate(scenario = case_when(scenario == "Core" ~ "IRA", TRUE ~ scenario)) %>%
    group_by(year, stagger, scenario) %>%
    summarize(median = median(value))
  
  p = dta %>% ggplot() +
    point_code + 
    segment_code +
    scale_x_continuous(breaks = c(2030, 2035), labels = c(2030, 2035), limits = c(2028, 2037)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    ggtitle(title) + 
    theme(axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5, size = 8), axis.ticks = element_blank(),
          plot.margin = margin(0.7,1,0.7,left_margin))
  
  if (!far_left) {
    p = p + 
      geom_text_repel(aes(x = year, y = value, label = scenario), size = 2, hjust = -0.2) +
      theme(axis.text.y = element_blank(), axis.title.y = element_blank(),)
    opt_label = "Optimistic Emissions"
    pes_label = "Pessimistic Emissions"
  } else {
    p = p +
      labs(y = "Mt CO2/yr") +
      #scale_subpalette(subpalettes, "Sensitivity Dots") +
      scale_color_manual(values = c("IRA" = "black", "IRA.Low" = "#42d4f4", "IRA.High" = "#883192"), guide = "none")
    opt_label = "Optimistic Emissions"
    pes_label = "Pessimistic Emissions"
  }
  
  if(sum(ira_coord) != 0) {
     p = p +
      annotate("text", x = ira_coord[1], y = ira_coord[2], size = 2.5,
               label = "Core", color = "black", alpha = 1, hjust = -0.2)
  }
  if(sum(low_coord) != 0) {
    p = p +
      annotate("text", x = low_coord[1], y = low_coord[2], size = 2.5,
               label = pes_label, color = "#42d4f4", alpha = 1, hjust = -0.2)
  }
  if(sum(high_coord) != 0) {
    p = p +
      annotate("text", x = high_coord[1], y = high_coord[2], size = 2.5,
               label = opt_label, color = "#883192", alpha = 1, hjust = -0.2)
  }
  
  return(list(
    "plot" = p,
    "stats" = stats
    ))
}


p1 = sens_dot_plot(sens_dta_panel1, title = "IRA Implementation", ymin = 0, ymax = 1600, far_left = TRUE, 
                   ira_coord = c(2030,1020), low_coord = c(2028.7, 1200), high_coord = c(2030, 620))
# p1
#p2 = sens_dot_plot(sens_dta_panel2)
#p2
p3 = sens_dot_plot(sens_dta_panel3, title = "Natural Gas Price", ymin = 0, ymax = 1600,)
# p3
p4 = sens_dot_plot(sens_dta_panel4, title = "Technology Cost", ymin = 0, ymax = 1600,)
# p4
p5 = sens_dot_plot(sens_dta_panel5, title = "Constrained Deployment", ymin = 0, ymax = 1600,)
# p5

combined = (p1$plot | p3$plot | p4$plot | p5$plot) +
  plot_annotation(title = "Electric Sector CO2 Emissions", 
                  theme = theme(plot.title = element_blank()))
  
combined

ggsave(filename = "output/leep/dots/Fig2.5_elec_sensitivity_dots.svg",combined, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/dots/Fig2.5_elec_sensitivity_dots.png",combined, width = 7, height = 5, units = "in")

# supporting data for figure
dta = bind_rows(sens_dta_panel1, sens_dta_panel3, sens_dta_panel4, sens_dta_panel5)
dta %>% write.csv("output/data/SW/Fig2.5_elec_sensitivity_dots.csv", row.names = FALSE)


#View(sens_dta)
```

# Figure 1.4 (plus a few extras without figure numbers at the moment)
```{r}
# sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High")
model_list = c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI") # models with all three (low,mid,high) cases

sens_dta_econ = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                 year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

# print(max(sens_dta$value))
# print(min(sens_dta$value))

#  mutate(year = factor(year))

sens_dta_trans = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Transportation", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_build = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_ind = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Industry and Fuel Production", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

p7 = sens_dot_plot(sens_dta_econ, title = "Economy-Wide CO2 Emissions", ymin = 0, ymax = 5000, far_left = TRUE, single = TRUE, 
                   ira_coord = c(2030,4050), low_coord = c(2028, 4220), 
                   high_coord = c(2030.6, 4070))
p7$plot = p7$plot + theme(plot.title = element_blank(), plot.margin = margin(2,2,2,2))
p7$plot

ggsave(filename = "output/leep/dots/Fig1.4_econwide_sensitivity_dots.svg",p7$plot, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/dots/Fig1.4_econwide_sensitivity_dots.png",p7$plot, width = 7, height = 5, units = "in")


p8 = sens_dot_plot(sens_dta_trans, title = "Transportation CO2 Emissions", ymin = 0, ymax = 2000, far_left = TRUE, single = TRUE,
                   ira_coord = c(2030,1550), low_coord = c(2028.0, 1640), 
                   high_coord = c(2030.6, 1550))
p8$plot = p8$plot + theme(plot.title = element_blank(), plot.margin = margin(2,2,2,2))
p8$plot
ggsave(filename = "output/leep/dots/FigX_trans_sensitivity_dots.svg",p8$plot, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/dots/FigX_trans_sensitivity_dots.png",p8$plot, width = 7, height = 5, units = "in")


p9 = sens_dot_plot(sens_dta_build, title = "Buildings CO2 Emissions", ymin = 0, ymax = 750, far_left = TRUE, single = TRUE,
                   ira_coord = c(2030,600), low_coord = c(2028.0, 625), 
                   high_coord = c(2030.6, 600))
p9$plot = p9$plot + theme(plot.title = element_blank(), plot.margin = margin(2,2,2,2))
p9$plot
ggsave(filename = "output/leep/dots/FigY_build_sensitivity_dots.svg",p9$plot, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/dots/FigY_build_sensitivity_dots.png",p9$plot, width = 7, height = 5, units = "in")


p10 = sens_dot_plot(sens_dta_ind, title = "Industrial CO2 Emissions", ymin = 0, ymax = 1250, far_left = TRUE, single = TRUE,
                    ira_coord = c(2030,1050), low_coord = c(2028.0, 1060), 
                    high_coord = c(2030.4, 1040))
p10$plot = p10$plot + theme(plot.title = element_blank(), plot.margin = margin(2,2,2,2))
p10$plot
ggsave(filename = "output/leep/dots/FigZ_ind_sensitivity_dots.svg",p10$plot, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/dots/FigZ_ind_sensitivity_dots.png",p10$plot, width = 7, height = 5, units = "in")

sens_dta_econ %>% write.csv("output/data/SW/Fig1.4_econwide_sensitivity_dots.csv", row.names = FALSE)


```

summary tables
```{r}
print("Economy-wide Energy emissions sensitivity stats")
print(p7$stats %>% data.frame() %>% select(-stagger))

print("Electricity emissions sensitivity stats")
print(p1$stats %>% data.frame() %>% select(-stagger))

print("Transportation emissions sensitivity stats")
print(p8$stats %>% data.frame() %>% select(-stagger))

print("Buildings emissions sensitivity stats")
print(p9$stats %>% data.frame() %>% select(-stagger))

print("Industrial emissions sensitivity stats")
print(p10$stats %>% data.frame() %>% select(-stagger))

```


```{r}
# function for spaghetti plots + dot plots
dot_plots_but_with_lines = function(plot_type, config, emf_data_long, figmap, figure_num, reg, ymin, ymax, plot_title, metric, labels = FALSE, hist_year = 2021, historic_coord = c(0,0), preira_coord = c(0,0), ira_coord = c(0,0)) {
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # make the spagetti plot
  fig = print_graph(plot_type, config, emf_data_long, figmap, figure_num, reg)
  # update the axis range
  fig = fig + scale_y_continuous(limits = c(ymin, ymax)) +
      scale_x_continuous(breaks = c(2005,2010, hist_year, 2025, 2030, 2035), labels = c(2005, 2010, hist_year, 2025, 2030, 2035)) +
      scale_alpha(range = c(0.6, 1), guide = "none") + 
      annotate("text", x = historic_coord[1], y = historic_coord[2], label = "Historic", color = "black", alpha = 1) +
      annotate("text", x = preira_coord[1], y = preira_coord[2], label = "No IRA", color = "#F28063", alpha = 1) +
      annotate("text", x = ira_coord[1], y = ira_coord[2], label = "IRA", color = "#0388B3", alpha = 1) +
      theme(legend.position = "none", plot.title = element_blank())
  
  if (labels) {
    label_data = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
      filter(year == 2035)
    print(unique(label_data$model))
    fig = fig + 
      geom_text(data = label_data, aes(x = year + 0.25, y = value, label = model, color = scenario), size = 2, hjust = 0) +
      #geom_text_repel(data = label_data, aes(label = model), size = 2, hjust = 0) +
      scale_x_continuous(limits = c(NA,2037))
  }
  
  # pull the data from the graph and filter/summarize for 2030/2035
  df_30 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  df_35 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  
  df_lines_30 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2030)) %>% 
    group_by(model, year) %>%
    summarize(min = min(value), 
              max = max(value)) %>%
    mutate(diff = max - min) %>%
    mutate(median = median(diff)) %>%
    arrange(desc(max)) %>%
    data.frame() %>%
    mutate(stagger = row_number()) %>%
    mutate(stagger = stagger - 1) %>%
    mutate(stagger = stagger / max(stagger)) %>%
    mutate(stagger = stagger - 0.5)
  View(df_lines_30)

  df_lines_35 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2035)) %>% 
    group_by(model, year) %>%
    summarize(min = min(value), 
              max = max(value)) %>%
    mutate(diff = max - min) %>%
    mutate(median = median(diff)) %>%
    arrange(desc(max)) %>%
    data.frame() %>%
    mutate(stagger = row_number()) %>%
    mutate(stagger = stagger - 1) %>%
    mutate(stagger = stagger / max(stagger)) %>%
    mutate(stagger = stagger - 0.5)
  View(df_lines_35)

    
  # these are the summary stats we'll eventually want to overlay on the plot to highlight the efficacy of the IRA
  preira_mean_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean
  ira_mean_30 = df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  preira_mean_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean
  ira_mean_35 = df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  preira_med_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median
  ira_med_30 = df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  preira_med_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median
  ira_med_35 = df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  
  # calculate raw differences
  mean_diff_30 = preira_mean_30 - ira_mean_30
  mean_diff_35 = preira_mean_35 - ira_mean_35
  med_diff_30 = preira_med_30 - ira_med_30
  med_diff_35 = preira_med_35 - ira_med_35
  
  # calculate percent differences
  mean_pctdiff_30 = mean_diff_30 / preira_mean_30
  mean_pctdiff_35 = mean_diff_35 / preira_mean_35
  med_pctdiff_30 = med_diff_30 / preira_med_30
  med_pctdiff_35 = med_diff_35 / preira_med_35
  
  # stick em all in a data frame
  stats = 0
  # stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"),
  #                    "No IRA mean" = c(preira_mean_30, preira_mean_35, preira_med_30, preira_med_35),
  #                    "IRA mean" = c(ira_mean_30, ira_mean_35, ira_med_30, ira_med_35),
  #                    "difference" = c(mean_diff_30, mean_diff_35, med_diff_30, med_diff_35),
  #                    "percent difference" = c(mean_pctdiff_30, mean_pctdiff_35, med_pctdiff_30, med_pctdiff_35))

  # still not entirely sure what this does...
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario),
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = mean, color = scenario), 
                          label = "Avg", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = median, color = scenario), 
                          label = "Med", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  }
  
  # dot plot for 2030
  dots_30 = ggplot() +
    # geom_point(data = df_30, aes(x = year, y = value, color = scenario), 
    #            shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    geom_segment(data = df_lines_30, aes(x = year + stagger, xend = year + stagger, y = min, yend = max), color = "black",
                                    size = 0.5) +
    # geom_segment(data = df_lines_30, aes(x = year - 0.5, xend = year + 0.5, y = median, yend = median), color = "black",
    #              size = 1) +
    # #segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029, 2031)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # grapes
  # dot plot for 2035
  dots_35 = ggplot() +
    # geom_point(data = df_35, aes(x = year, y = value, color = scenario), 
    #            shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    geom_segment(data = df_lines_35, aes(x = year + stagger, xend = year + stagger, y = min, yend = max), color = "black",
                                    size = 0.5) +
    # geom_segment(data = df_lines_35, aes(x = year - 0.5, xend = year + 0.5, y = median, yend = median), color = "black",
    #              size = 1) +
    # segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034, 2036)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # combine all the plots
  final = fig + dots_30 + dots_35 + 
    plot_annotation(title = plot_title, theme = theme(plot.title = element_blank())) +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
  # return the full plot + the components + the summary stats
  return(list(
    full = final,
    line = fig,
    dot1 = dots_30,
    dot2 = dots_35,
    stats = stats
  ))
}

p = dot_plots_but_with_lines("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States", 
                             0, 5, "Power Sector SO2 Emissions", metric = "median",
                             historic_coord = c(2017,2), preira_coord = c(2030, 1.2), ira_coord = c(2029, 0.12) )

p = dot_plots_but_with_lines("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States",
                             0, 100, "EV Share", metric = "mean", hist_year = 2022, historic_coord = c(2015,8), preira_coord = c(2030, 16), ira_coord = c(2027, 45))

p$full

```
```{r}
# percentage difference figures for appendix

# Figure 2.6: nox
pct_diff_graph = function(plot_type, config, dta, figmap, fignum, region, exclude_models = c()) {
  dta = dta %>% filter(!model %in% exclude_models) %>%
    filter(year >= 2025) %>%
    mutate(alpha = case_when(
      model == "USREP-ReEDS" ~ 1,
      model == "GCAM-PNNL" ~ 1,
      model == "IPM-EPA" ~ 1,
      scenario == "Historic" ~ 1,
      TRUE ~ 0.8)
    )
  
  dta_copy = dta %>% filter(year == 2025) %>%
    mutate(value = 0, year = 2021)
  
  dta = rbind(dta, dta_copy)
  
  p = print_graph(plot_type, config, dta, figmap, fignum, region) +
    scale_alpha(range = c(0.6, 1), guide = "none") + 
    geom_segment(aes(x = 2010, xend = 2021, y = 0, yend = 0), color = "black", linewidth = 1) +
    scale_x_continuous(breaks = c(2010, 2021, 2025, 2030, 2035), labels = c(2010, 2021, 2025, 2030, 2035)) +
    labs(y = "% difference from No IRA") +
    theme(plot.title = element_blank(), axis.ticks = element_blank(),
          axis.text.x = element_text(angle = 0, hjust = 0.5))
    

  
  return(p)
  
}

# Figure 2.6: NOx
p1 = pct_diff_graph("time_series", config, clean_data, figmap_leep_timeseries, 125, "United States")
p1
ggsave(filename = "output/leep/Pct_diff/Fig2.6_pctdiff.svg",p1, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/Pct_diff/Fig2.6_pctdiff.png",p1, width = 7, height = 5, units = "in")


# Figure 2.7: Sox
p2 = pct_diff_graph("time_series", config, clean_data, figmap_leep_timeseries, 126, "United States")
p2
ggsave(filename = "output/leep/Pct_diff/Fig2.7_pctdiff.svg",p2, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/Pct_diff/Fig2.7_pctdiff.png",p2, width = 7, height = 5, units = "in")


# Figure 5.3: Industrial Final Energy
p3 = pct_diff_graph("time_series", config, clean_data, figmap_leep_timeseries, 124, "United States")
p3
ggsave(filename = "output/leep/Pct_diff/Fig5.3_pctdiff.svg",p3, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/Pct_diff/Fig5.3_pctdiff.png",p3, width = 7, height = 5, units = "in")


```
```{r}
# medians table for appendix
medians_table_annual = function(plot_type, config, data, figmap, plot_num, region, models_to_exclude = c()) {
  med_dta = data_from_graph(plot_type, config, data, figmap, plot_num, region) %>%
    filter(year >= 2021) %>% duplicate_historical_data("EPA-GHGI", 2021, criteria = TRUE) %>%
    filter(scenario != "Historic")
  if (length(models_to_exclude) > 0) {
    med_dta = med_dta %>% filter(!(model %in% models_to_exclude))
  }
  
  med_dta = med_dta %>% 
    select(model, scenario, unit, year, variable, value) %>%
    distinct() %>%
    pivot_wider(names_from = year, values_from = value, names_prefix = "value_") %>%
    mutate(
      value_2022 = value_2021 + 1 * ((value_2025 - value_2021) / 4),
      value_2023 = value_2021 + 2 * ((value_2025 - value_2021) / 4),
      value_2024 = value_2021 + 3 * ((value_2025 - value_2021) / 4),
      value_2026 = value_2025 + 1 * ((value_2030 - value_2025) / 5),
      value_2027 = value_2025 + 2 * ((value_2030 - value_2025) / 5),
      value_2028 = value_2025 + 3 * ((value_2030 - value_2025) / 5),
      value_2029 = value_2025 + 4 * ((value_2030 - value_2025) / 5),
      value_2031 = value_2030 + 1 * ((value_2035 - value_2030) / 5),
      value_2032 = value_2030 + 2 * ((value_2035 - value_2030) / 5),
      value_2033 = value_2030 + 3 * ((value_2035 - value_2030) / 5),
      value_2034 = value_2030 + 4 * ((value_2035 - value_2030) / 5),
    ) %>%
    pivot_longer(cols = starts_with("value_"), names_to = "year", names_prefix = "value_", values_to = "value") %>%
    arrange(model, scenario, year) %>%
    mutate(value = round(value)) %>%
    group_by(year, scenario, variable, unit) %>%
    summarize(min = min(value), max = max(value), median = median(value)) %>%
    data.frame()
  
  dta_ira = med_dta %>% filter(scenario == "IRA")
  dta_noira = med_dta %>% filter(scenario == "No IRA")
  dta_final = dta_noira %>% left_join(
    select(dta_ira, c(year, median)),
    by = "year"
  ) %>%
    rename(No.IRA.median = median.x, IRA.median = median.y) %>%
    mutate(difference = IRA.median - No.IRA.median,
           pct.difference = round((IRA.median - No.IRA.median) / No.IRA.median,3))
  
  return(dta_final)
}

m_EW = medians_table_annual("time_series", config, clean_data, figmap_leep_timeseries, 9, "United States")
m_EW %>% write.csv('output/data/appendix/economy_wide_emissions.csv', row.names = FALSE)

m_elec = medians_table_annual("time_series", config, clean_data, figmap_leep_timeseries, 4, "United States")
m_elec %>% write.csv('output/data/appendix/electric_sector_emissions.csv', row.names = FALSE)




m1 = medians_table("time_series", config, clean_data, figmap_leep_timeseries, 9, "United States")
View(m1)

m2 = medians_table("time_series", config, clean_data, figmap_leep_timeseries, 4, "Unites States")
View(m2)

```
