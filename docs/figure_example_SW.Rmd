---
title: "Figure Examples"
output: html_document
date: "2023-05-10"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("./packages.R")
  library(patchwork)
  library(egg)
  library(ggbreak)
  devtools::load_all()
}
```

```{r}
tar_load(config)
tar_load(clean_data)
tar_load(data_min)
tar_load(data_raw)
# tar_load(clean_data_index)
tar_load(figmap_leep_cone)
tar_load(figmap_leep_timeseries)
tar_load(figmap_leep_stackbar)

clean_data = clean_data %>% mutate(value = case_when(
    (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Buildings") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value) / 2,
    (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Industry") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value) / 2,
    (model == "OP-NEMS-LTS" & scenario == "LTS.High" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Transportation") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.High" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value) / 2,
    
    (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Buildings") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Buildings"),"value"]$value) / 2,
    (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Industry") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Industry"),"value"]$value) / 2,
    (model == "OP-NEMS-LTS" & scenario == "LTS.Low" & year == 2025 & variable == "Emissions|CO2|Energy|Demand|Transportation") ~ (clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2020 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value + clean_data[(clean_data$model == "OP-NEMS-LTS" & clean_data$scenario == "LTS.Low" & clean_data$year == 2030 & clean_data$variable == "Emissions|CO2|Energy|Demand|Transportation"),"value"]$value) / 2,
  TRUE ~ value
))

# data_cdr = data.frame("model" = rep("EIA-LTS",16), "year" = seq(2005,2020,by = 1), "unit" = rep("Mt CO2/yr",16), "scenario" = rep("Historic",16),
#                         "datasrc" = rep("LTS_data_small.xlsx",16), variable = rep("Emissions|CO2|CDR",16), region = "United States",
#                         "value" = rep(0,16))
# clean_data = rbind(clean_data,data_cdr)
```


```{r}
# This function does a bunch of stuff
# Calls the main functions to print a spagetti plot
# Then makes some dot plots to show the distributions: one for 2030, one for 2035
# The inputs are the same as for the print_graph() function, plus some new ones:
#   ymin and ymax: to manually set the y axis limits so that the axes line up across plots
#   plot_title: manually set the plot title of the combined plot
#   metric: what centrality metric to show on the dot plots: "mean" or "median"
dot_plots = function(plot_type, config, emf_data_long, figmap, figure_num, reg, ymin, ymax, plot_title, metric) {
  # make the spagetti plot
  fig = print_graph(plot_type, config, emf_data_long, figmap, figure_num, reg)
  # update the axis range
  fig = fig + scale_y_continuous(limits = c(ymin, ymax)) +
      scale_alpha(range = c(0.6, 1), guide = "none") + 
      annotate("text", x = 2015, y = 8, label = "Historic", color = "black", alpha = 1) +
      annotate("text", x = 2030, y = 16, label = "Pre-IRA", color = "#0388B3", alpha = 1) +
      annotate("text", x = 2027, y = 45, label = "IRA", color = "#F28063", alpha = 1) +
      theme(legend.position = "none")
  
  # pull the data from the graph and filter/summarize for 2030/2035
  df_30 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  df_35 = data_from_graph(plot_type, config, emf_data_long, figmap, figure_num, reg) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value, na.rm = TRUE),
           median = median(value, na.rm = TRUE))
  
  # these are the summary stats we'll eventually want to overlay on the plot to highlight the efficacy of the IRA
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "Reference","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "Reference","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "Reference","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "Reference","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))

  # still not entirely sure what this does...
  subpalettes = create_subpalettes(figmap_leep_timeseries, config)
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = mean, yend = mean, color = scenario),
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = mean, color = scenario), 
                          label = "Avg", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, 
                                   aes(x = year - 0.04, xend = year + 0.04, y = median, yend = median, color = scenario), 
                                   size = 1)
    text_code = geom_text(data = df_stat_30, aes(x = year - 0.08, y = median, color = scenario), 
                          label = "Med", size = 3, hjust = 0.5, angle = 90, position = position_dodge2(width = 0.05))
  }
  
  # dot plot for 2030
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # combine all the plots
  final = fig + dots_30 + dots_35 + 
    plot_annotation(title = plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
  # return the full plot + the components + the summary stats
  return(list(
    full = final,
    line = fig,
    dot1 = dots_30,
    dot2 = dots_35,
    stats = stats
  ))
}

# p = dot_plots("time_series", config, clean_data, figmap_leep_timeseries, 4, "United States", 0, 2500, "Emissions|CO2|Energy|Demand|Electricity", metric = "median")
# print(p$full)
# print(p$stats)

```
```{r}
duplicate_historical_data <- function(data_long, hist_model, hist_year) {
  # short circuit
  if (hist_model == "none") {
    return(data_long)
  }

  # this is the data we'll stamp for every model
  copy_data = data_long %>% filter(model == hist_model, year == hist_year)
  # this is all the historical data, don't lose it
  hist_data = data_long %>% filter(model == hist_model & year <= hist_year)
  # temporary data_long which will be appended many times
  data_in = data_long %>% filter(year >= hist_year & model != hist_model)
  
  data_wide = data_in %>% left_join(select(copy_data,c(value,year,variable,region)), by = c("year", "variable","region")) %>%
    mutate(value = case_when(
      year == hist_year & !is.na(value.y) ~ value.y,
      TRUE ~ value.x
    )) %>%
    select(-c(value.x,value.y))
  
  data_final = rbind(data_wide, hist_data)                        

  # the end
  return(data_final)
}

# remove all historical data and replace with EIA-LTS 2020 data for connectivity purposes
# clean_data2 = clean_data %>% duplicate_historical_data("EIA-LTS",2020)
```


```{r}
lts_coneplot_with_dots = function(config, data, figmap, lts_fignum, leep_fignum, region, ymin, ymax, metric = "mean", facet = FALSE) {
  # update the historical data (is this even necessary anymore?)
  # data2 = data %>% duplicate_historical_data("EIA-LTS",2020)
  
  # make the LTS cone plot
  fig1 = print_graph("cone_uncertainty", config, data, figmap, lts_fignum, region) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
  
  # extract points and summary statistics for 2030 and 2035
  df_30 = data_from_graph("cone_uncertainty", config, data, figmap, leep_fignum, region) %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = data_from_graph("cone_uncertainty", config, data, figmap, leep_fignum, region) %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  if (facet) {
    dash_len = 2.0
  } else {
    dash_len = 0.5
  }
  
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - dash_len, xend = year + dash_len, y = mean, yend = mean, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - dash_len, xend = year + dash_len, y = mean, yend = mean, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - dash_len, xend = year + dash_len, y = median, yend = median, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - dash_len, xend = year + dash_len, y = median, yend = median, 
                                                          color = variable_rename), position = position_dodge2(width = 0.5), linewidth = 1)
  }

  
  fig2 = fig1 +
    geom_point(data = df_30, aes(x = year, y = value, color = variable_rename), shape = 1, size = 2, position = position_dodge(width = 1)) +
    segment_code_30 +
    geom_point(data = df_35, aes(x = year, y = value, color = variable_rename), shape = 1, size = 2, position = position_dodge(width = 1)) +
    segment_code_35 +
    bottom1
  return(fig2)
  
}

```

Faceted Versions
```{r}
# Buildings Energy
  p = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 15, 16, "United States", 0, 15, "mean", facet = TRUE) +
    facet_grid(~factor(variable_rename, levels=c('Electricity', 'NonElectric')))
  p
  ggsave(filename = "output/leep/cone_uncertainty/Fig19_LTS_cone_buildings_facet.svg",p, width = 7, height = 5, units = "in")
  
# Transportation Energy
  p3 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 11, 12, "United States", 0, 30, "mean", facet = TRUE)
  p3 + facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Fuels')))
  ggsave(filename = "output/leep/cone_uncertainty/Fig18_LTS_cone_transport_facet.svg",p3, width = 7, height = 5, units = "in")
  
# Industrial Energy
  p4 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 13, 14, "United States", 0, 25, "mean", facet = TRUE) +
    facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Energy')))
  p4
  ggsave(filename = "output/leep/cone_uncertainty/Fig20_LTS_cone_industry_facet.svg",p4, width = 7, height = 5, units = "in")

# Economy-wide Emissions
  p5 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 9, 10, "United States", -1000, 2500, "mean", facet = TRUE) +
    facet_grid(~factor(variable_rename, levels=c('Electricity', 'Transportation', 'Buildings', 'Industry')))
  p5
  ggsave(filename = "output/leep/cone_uncertainty/Fig17_LTS_cone_emissions_facet_Fig17.svg",p5, width = 7, height = 5, units = "in")
```
Overlaid Versions
```{r}
  p = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 1, 2, "United States", 0, 15, "mean", facet = FALSE)
  p
  ggsave(filename = "output/leep/cone_uncertainty/Fig19_LTS_cone_buildings.svg",p, width = 7, height = 5, units = "in")
  # p2 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 3, 4, "United States", -1000, 2500, "mean", facet = FALSE)
  # p2
  # ggsave(filename = "output/leep/cone_uncertainty/LTS_cone_emissions_old.svg",p2, width = 7, height = 5, units = "in")
  p3 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 5, 6, "United States", 0, 30, "mean", facet = FALSE)
  p3
  ggsave(filename = "output/leep/cone_uncertainty/Fig18_LTS_cone_transport.svg",p3, width = 7, height = 5, units = "in")
  p4 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 7, 8, "United States", 0, 25, "mean", facet = FALSE)
  p4
  ggsave(filename = "output/leep/cone_uncertainty/Fig20_LTS_cone_industry.svg",p4, width = 7, height = 5, units = "in")
  p5 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 3, 4, "United States", -1000, 2500, "mean", facet = FALSE)
  p5
  ggsave(filename = "output/leep/cone_uncertainty/Fig17_LTS_cone_emissions_new.svg",p5, width = 7, height = 5, units = "in")
```


```{r}
# uncertainty plot
clean_data2 = clean_data %>% duplicate_historical_data("EIA-STEO",2020)
fig = print_graph("time_series", config, clean_data2, figmap_leep_timeseries, 16, "United States")
dta = data_from_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")
fig
ggsave(filename = "output/leep/time_series/Fig3.1_emis_sensitivity.svg",fig, width = 7, height = 5, units = "in")
```
```{r}
# EV share plot
scen_map = read.csv("./data-raw/scenario-mapping.csv") %>% select(datasrc, model, scenario, model_new, scenario_new)

raw = data_raw %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new) %>%
  filter(unit != "thousands") %>%
  filter(!(model == "IEA" & year >= 2022))

iea_2022 = raw %>% filter(model == "IEA", year == 2021) %>% mutate(year = 2022)
clean_data4 = rbind(raw, iea_2022) %>% filter(unit != "thousands") %>% mutate(value = 100 * value) %>%
  filter(model != "EIA-LTS") %>% 
  duplicate_historical_data("IEA",2022) %>% mutate(
    variable = case_when(
      variable %in% c("Energy Service|Transportation|Passenger|BEV|Sales Share",
                      "Energy Service|Transportation|Passenger|FCEV|Sales Share",
                      "Energy Service|Transportation|Passenger|HEV|Sales Share",
                      "Energy Service|Transportation|Freight|BEV|Sales Share",
                      "Energy Service|Transportation|Freight|FCEV|Sales Share",
                      "Energy Service|Transportation|Passenger|PHEV|Sales Share") ~ 
        "Energy Service|Transportation|EV|Sales Share")) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1,
    model == "GCAM-PNNL" ~ 1,
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    TRUE ~ 0.8)
  )

fig = print_graph("time_series", config, clean_data4, figmap_leep_timeseries, 18, "United States")
dta = data_from_graph("time_series", config, clean_data4, figmap_leep_timeseries, 18, "United States")
fig

p = dot_plots("time_series", config, clean_data4, figmap_leep_timeseries, 18, "United States", 0, 100, "EV Share", metric = "mean")
print(p$full)
print(p$stats)


ggsave(filename = "output/leep/time_series/Fig9_ev_share.svg",p$full, width = 7, height = 5, units = "in")
```

```{r}
# uncertainty plot
#tar_load(data_min)

clean_data5 = data_raw %>% filter(grepl("GHGI",variable)) %>% 
  select(-datasrc) %>%
  gather("year","value","2020":"2018") %>%
  filter(year >= 1990 & year <= 2021) %>%
  mutate(year = as.factor(year), datasrc = "x")


fig = print_graph("stacked_bar", config, clean_data5, figmap_leep_stackbar, 3, "United States", level_var = c("Lubricants", "Motorcycles", "Buses", "Pipelines", "Rail", "Water", "Aircraft", "MHD Trucks", "LD Trucks", "Passenger Cars")) +
  bottom1

fig
dta = data_from_graph("stacked_bar", config, clean_data5, figmap_leep_stackbar, 3, "United States")
dta

# iea_2022 = clean_data %>% filter(model == "IEA", year == 2021) %>% mutate(year = 2022)
# clean_data3 = rbind(clean_data, iea_2022)
# clean_data3 = clean_data3 %>% filter(model != "EIA-LTS") %>% 
#   duplicate_historical_data("IEA",2022) %>% 
#   mutate(value = 100 * value)
# 
# fig = print_graph("time_series", config, clean_data3, figmap_leep_timeseries, 18, "United States")
# dta = data_from_graph("time_series", config, clean_data3, figmap_leep_timeseries, 18, "United States")
# fig
# 
# p = dot_plots("time_series", config, clean_data3, figmap_leep_timeseries, 18, "United States", 0, 2, "EV Share", metric = "mean")
# print(p$full)
# print(p$stats)


ggsave(filename = "output/leep/stacked_bar/Fig6_trans_co2.svg",fig, width = 7, height = 5, units = "in")
```


```{r}
# capacity addition plot

ymin = -25
ymax = 125
plot_title = "Capacity Additions Temp"

fig = print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States") +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  scale_y_continuous(limits = c(ymin, ymax)) +
  theme(plot.title = element_blank(), legend.position = "none")

fig

# var_map = data.frame("variable" = c("Capacity Additions|Electricity|Coal|w/ CCS",
#                                     "Capacity Additions|Electricity|Coal|w/o CCS",
#                                     "Capacity Additions|Electricity|Gas|w/ CCS",
#                                     "Capacity Additions|Electricity|Gas|w/o CCS",
#                                     "Capacity Additions|Electricity|Hydro",
#                                     "Capacity Additions|Electricity|Nuclear",
#                                     "Capacity Additions|Electricity|Solar",
#                                     "Capacity Additions|Electricity|Wind",
#                                     "Capacity Additions|Electricity|Storage Capacity",
#                                     "Capacity Retirements|Electricity|Coal|w/ CCS",
#                                     "Capacity Retirements|Electricity|Coal|w/o CCS",
#                                     "Capacity Retirements|Electricity|Gas|w/ CCS",
#                                     "Capacity Retirements|Electricity|Gas|w/o CCS",
#                                     "Capacity Retirements|Electricity|Hydro",
#                                     "Capacity Retirements|Electricity|Nuclear",
#                                     "Capacity Retirements|Electricity|Solar",
#                                     "Capacity Retirements|Electricity|Wind",
#                                     "Capacity Retirements|Electricity|Storage Capacity"),
#                      "variable_rename" = c("Coal CCS", "Coal", "Gas CCS", "Gas", "Hydro", "Nuclear",
#                                       "Solar", "Wind", "Storage",
#                                       "Coal CCS", "Coal", "Gas CCS", "Gas", "Hydro", "Nuclear",
#                                       "Solar", "Wind", "Storage"))
# 
# dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States")
# dta
# dta2 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 5, "United States") %>%
#   mutate(unit = "GW/yr") %>%
#   group_by(model, scenario, variable, region, datasrc, unit) %>%
#   summarize(value = mean(value)) %>%
#   mutate(value = case_when(
#     grepl("Retire",variable) ~ -1 * value,
#     TRUE ~ value
#   )) %>% left_join(var_map, by = "variable") %>%
#   group_by(model, scenario, region, datasrc, unit, variable_rename) %>%
#   summarize(value = sum(value))
# 
# dta_ttl = dta2 %>% group_by(model, scenario, region, datasrc, unit) %>%
#   summarize(value = sum(value)) %>% 
#   mutate(variable_rename = "Total")
# 
# dta3 = rbind(dta2, dta_ttl) %>%
#   mutate(variable_rename = factor(variable_rename, levels = c("Total", "Solar", "Wind", "Nuclear", "Hydro", "Storage", "Coal", "Coal CCS", "Gas", "Gas CCS")))
# 
# stats = dta3 %>% group_by(variable_rename) %>% summarize(mean = mean(value), median = median(value))

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

# dotplot = dta3 %>% ggplot() +
#   geom_point(aes(x = variable_rename, y = value, color = variable_rename), shape = 1, size = 2) + 
#   #geom_point(data = stats, aes(x = variable_rename, y = median, color = variable_rename), shape = 3, size = 2) +
#   geom_segment(data = stats, aes(x = as.numeric(variable_rename) - 0.2, xend = as.numeric(variable_rename) + 0.2, y = median, yend = median, color = variable_rename), linewidth = 0.5) +
#   scale_y_continuous(limits = c(ymin, ymax)) +
#   scale_subpalette(subpalettes, "Capacity Additions2") +
#   theme_emf() +
#   theme(plot.title = element_blank(), axis.text.y = element_blank(),
#         axis.title.y = element_blank(), axis.ticks = element_blank(),
#         axis.title.x = element_blank(),
#         axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "None")
# dotplot

dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 6, "United States")
dta_ttl = dta4 %>% group_by(model, scenario, region, datasrc, unit) %>%
  summarize(value = sum(value)) %>% 
  mutate(variable_rename = "Total")

dta4 = rbind(dta4,dta_ttl) %>% mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Total", "Solar", "Wind", "Nuclear", "Hydro", "Storage", "Coal", "Coal CCS", "Gas", "Gas CCS")))
stats = dta4 %>% group_by(variable_rename) %>% summarize(mean = mean(value), median = median(value))

dotplot2 = dta4 %>% ggplot() + 
  geom_point(aes(x = variable_rename, y = value, color = variable_rename), shape = 1, size = 2) + 
  #geom_point(data = stats, aes(x = variable_rename, y = median, color = variable_rename), shape = 3, size = 2) +
  geom_segment(data = stats, aes(x = as.numeric(variable_rename) - 0.2, xend = as.numeric(variable_rename) + 0.2, 
                                 y = median, yend = median, color = variable_rename), linewidth = 0.5) +
  scale_y_continuous(limits = c(ymin, ymax)) +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  theme_emf() +
  theme(plot.title = element_blank(), axis.text.y = element_blank(),
        axis.title.y = element_blank(), axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
dotplot2
  

combined = 
  fig + dotplot2 + 
  plot_annotation(title = "Capacity Additions", theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(widths = c(1,1)) +
    theme(plot.margin = margin(0,0,0,0))
    # bottom1
combined


ggsave(filename = "output/leep/stacked_bar/Fig5_capacity.svg",combined, width = 7, height = 5, units = "in")
print(stats)
```
