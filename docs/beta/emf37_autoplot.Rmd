---
title: "EMF37 Default Model Comparison Plots"
author: ""
date: "`r Sys.Date()`"
output:  
  html_document:
    toc: true
    toc_depth: 5
    theme: cerulean
    toc_float: 
      collapsed: true
      smooth_scroll: true
---

<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 20, 'padding-left': 20});
      });

    });
</script>


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```


```{r packages, include=FALSE}
source("packages.R")

library(knitr)
library(ggplot2)
library(plotly)
#library(DT)
library(ggthemes)
library(htmltools)
```


```{r data, include=FALSE}
tar_load(emf_data_long)

```


```{r dataprep, include=FALSE}

all_models <- unique(emf_data_long$model)

comp_models <- c("AEO2020", "EPS", "GCAM", "MARKAL-NETL", "USREP-ReEDS")
stopifnot(all(comp_models %in% all_models))
# first model in the list is the base against which others are compared.
# order determines faceting/color assignment order.

all_scenarios <- unique(emf_data_long$scenario)
core_scenarios <- c("NT.Ref", "0by50.Ref", "0by60.Ref", "0by80.Ref")
ref_scen <- "NT.Ref"

ref_long <- emf_data_long %>% 
  filter(scenario == "NT.Ref" | scenario %in% c("Historic", "STEO"), 
         model %in% comp_models) %>% 
  mutate(value = round(value, 2))

ref_summary <- emf_data_long %>% 
  filter(scenario == "NT.Ref", model %in% comp_models)

# ref_by_fuel <- ces_by_fuel %>% filter(str_detect(scenario, "^Ref"), model %in% comp_models)

# Variables included in EIA data
eia_var <- emf_data_long %>%
  filter(str_detect(model, 'AEO|EIA')) %>%
  distinct(variable) %>%
  pull(variable) %>%
  unique()

all_variables <- unique(emf_data_long$variable)

scenarios <- unique(emf_data_long$scenario)

mods <- unique(emf_data_long$model) %>% setdiff(c("AEO2020", "EIA_STEO", "EIA_Historic"))


# Run the required functions
source("R/autoplot_funs.R")

ref_data <- filter(emf_data_long, scenario %in% ref_scen & !is.na(value))
pol_data <- filter(emf_data_long, !scenario %in% ref_scen & !is.na(value))

```


&nbsp;

&nbsp;

# Figures

## Emissions

## {.tabset .tabset-pills}

### Compare scenarios across models {.tabset .tabset-pills}

#### Reference scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Identify the variables that we want to plot
emissions_var <- keep(all_variables, ~str_detect(.x, "Emissions"))

# Use plot functions to generate a list of plots and use htmltools::tagList to render the plots
list_of_plots <- lapply(
  emissions_var, plot_list_function_model_scenario, 
  plot_model = ref_data)  
htmltools::tagList(list_of_plots)
 
```

#### Policy scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}


# Use plot functions to generate a list of plots and use htmltools::tagList to render the plots 
list_of_plots <- lapply(
  emissions_var, plot_list_function_model_scenario, 
  plot_model = pol_data, 
  post_label = 'CO2 Emissions')  
 htmltools::tagList(list_of_plots)
```

### Compare scenarios within each model 

```{r, echo = FALSE, eval = TRUE, message = FALSE, fig.keep='all'}

# Create a list of titles and plots for each model
all_plots <- lapply(mods, function(y){
   header_model <- tags$h3(y)
   plot_model <- emf_data_long %>%
                  filter(model == y & !is.na(value)) 
   # Variable list
   var_list <- emissions_var[emissions_var %in% unique(plot_model$variable)]
   
   if(length(var_list) > 0){
     list_of_plots <- lapply(var_list, plot_list_function_scenario, plot_model = plot_model, post_label = 'CO2 Emissions')  
   } else {
     list_of_plots <- NULL
   }
      return(list(header_model, list_of_plots))
})
  
   htmltools::tagList(all_plots)
```

## Final Energy 

## {.tabset .tabset-pills} 

### Compare scenarios across models {.tabset .tabset-pills} 

#### Reference scenarios 

```{r, echo = FALSE, eval = TRUE, message = FALSE}
# Identify the variables that we want to plot
consumption_var <- all_variables[grepl('Final Energy', all_variables, ignore.case = TRUE) & !grepl('other|price', all_variables, ignore.case = TRUE)]
consumption_3_levels <- consumption_var[lapply(consumption_var, function (x) length(str_split(x, '\\|')[[1]])) %in% c(2, 3)]
var_list <- consumption_3_levels[consumption_3_levels %in% unique(emf_data_long$variable)]

# Generate list of plots    
list_of_plots <- lapply(
  var_list, plot_list_function_model_scenario, 
  plot_model = ref_data, 
  header_function = simple_header)

htmltools::tagList(list_of_plots)
```

#### Policy scenarios 

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Identify the variables that we want to plot   
var_list <- consumption_3_levels[consumption_3_levels %in% unique(pol_data$variable)]
    
list_of_plots <- lapply(
  var_list, plot_list_function_model_scenario, 
  plot_model = pol_data, 
  header_function = simple_header)

 htmltools::tagList(list_of_plots)
```

### Compare scenarios within each model  

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Create a list of titles and plots for each model
all_plots <- lapply(mods, function(y){
   header_model <- tags$h3(y)
   plot_model <- emf_data_long %>%
                  filter(model %in% c(y, 'EIA_Historic') & !is.na(value)) 
   
   var_list <- consumption_3_levels[consumption_3_levels %in% unique(plot_model$variable)]
   
   if(length(var_list) > 0 & ((y != 'EIA_Historic' & length(setdiff(unique(plot_model$model), 'EIA_Historic')) > 0) | (y == 'EIA_Historic' & length(setdiff(unique(plot_model$model), 'EIA_Historic')) == 0))){
     list_of_plots <- lapply(var_list, plot_list_function_scenario, plot_model = plot_model,
                             header_function = simple_header) 
     header_model <- header_model
   } else {
   #  header_model <- NULL
     list_of_plots <- NULL
   }
      return(list(header_model, list_of_plots))
})
  htmltools::tagList(all_plots)
```

## GDP

## {.tabset .tabset-pills}

### Compare scenarios across models {.tabset .tabset-pills}

#### Reference scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}
# Identify the variables that we want to plot
gdp_var <- eia_var[grepl('GDP', eia_var, ignore.case = TRUE) ]

# Generate the list of plots   
list_of_plots <- lapply(gdp_var, plot_list_function_model_scenario, plot_model = ref_data)  

 htmltools::tagList(list_of_plots)
```

#### Policy scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Generate the list of plots    
list_of_plots <- lapply(gdp_var, plot_list_function_model_scenario, plot_model = pol_data)  

 htmltools::tagList(list_of_plots)
```

### Compare scenarios within each model 

```{r, echo = FALSE, eval = TRUE, message = FALSE, fig.keep='all'}

# Create a list of titles and plots for each model
all_plots <- lapply(mods, function(y){
   header_model <- tags$h3(y)
   plot_model <- emf_data_long %>%
                  filter(model == y & !is.na(value)) 
   
   var_list <- gdp_var[gdp_var %in% unique(plot_model$variable)]
   
   if(length(var_list) > 0){
     list_of_plots <- lapply(var_list, plot_list_function_scenario, plot_model = plot_model)  
   } else {
     list_of_plots <- NULL
   }
      return(list(header_model, list_of_plots))
})
   htmltools::tagList(all_plots)
   
```

## Generation

## {.tabset .tabset-pills} 

### Compare scenarios across models {.tabset .tabset-pills} 

#### Reference scenarios 

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Identify the variables that we want to plot
generation_var <- all_variables[grepl('^Capacity', all_variables, ignore.case = TRUE) & !grepl('other', all_variables, ignore.case = TRUE)]
generation_3_levels <- generation_var[lapply(generation_var, function (x) length(str_split(x, '\\|')[[1]])) %in% c(2, 3)]

# Identify variables to plot    
var_list <- generation_3_levels[generation_3_levels %in% unique(ref_data$variable)]
 
# Generate list of plots   
list_of_plots <- lapply(var_list, plot_list_function_model_scenario, plot_model = ref_data, header_function = simple_header)  

 htmltools::tagList(list_of_plots)
```

#### Policy scenarios 

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Identify the variables that we want to plot
var_list <- generation_3_levels[generation_3_levels %in% unique(pol_data$variable)]
    
# List of plots 
list_of_plots <- lapply(var_list, plot_list_function_model_scenario, plot_model = pol_data, header_function = simple_header)

htmltools::tagList(list_of_plots)
```

### Compare scenarios within each model  

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Create a list of titles and plots for each model
all_plots <- lapply(mods, function(y){
   header_model <- tags$h3(y)
   plot_model <- emf_data_long %>%
                  filter(model %in% c(y, 'EIA_Historic') & !is.na(value)) 
 
   # Identify the variables that we want to plot  
   var_list <- generation_3_levels[generation_3_levels %in% unique(plot_model$variable)]
   
   if(length(var_list) > 0 & ((y != 'EIA_Historic' & length(setdiff(unique(plot_model$model), 'EIA_Historic')) > 0) | (y == 'EIA_Historic' & length(setdiff(unique(plot_model$model), 'EIA_Historic')) == 0))){
     list_of_plots <- lapply(var_list, plot_list_function_scenario, plot_model = plot_model, header_function = simple_header) 
     header_model <- header_model
   } else {
   #  header_model <- NULL
     list_of_plots <- NULL
   }
      return(list(header_model, list_of_plots))
})
  
htmltools::tagList(all_plots)
```

## Primary Energy

## {.tabset .tabset-pills}

### Compare scenarios across models {.tabset .tabset-pills}

#### Reference scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}
# Identify the variables that we want to plot
primary_var <- eia_var[grepl('Primary Energy', eia_var, ignore.case = TRUE) & !grepl('other', eia_var, ignore.case = TRUE)]
primary_2_levels <- primary_var[lapply(primary_var, function (x) length(str_split(x, '\\|')[[1]])) == 2]

# Generate list of plots    
list_of_plots <- lapply(
  primary_2_levels, plot_list_function_model_scenario, 
  plot_model = ref_data, 
  post_label = 'Primary Energy Consumption')  

 htmltools::tagList(list_of_plots)
```

#### Policy scenarios

```{r, echo = FALSE, eval = TRUE, message = FALSE}

# Generate list of plots    
list_of_plots <- lapply(
  primary_2_levels, plot_list_function_model_scenario, 
  plot_model = pol_data, 
  post_label = 'Primary Energy Consumption')  

 htmltools::tagList(list_of_plots)
```

### Compare scenarios within each model 

```{r, echo = FALSE, eval = TRUE, message = FALSE, fig.keep='all'}

# Create a list of titles and plots for each model
all_plots <- lapply(mods, function(y){
   header_model <- tags$h3(y)
   plot_model <- emf_data_long %>%
                  filter(model == y & !is.na(value)) 
   
   var_list <- primary_2_levels[primary_2_levels %in% unique(plot_model$variable)]
   
   if(length(var_list) > 0){
     list_of_plots <- lapply(var_list, plot_list_function_scenario, plot_model = plot_model, post_label = 'Primary Energy Consumption')  
   } else {
     list_of_plots <- NULL
   }
      return(list(header_model, list_of_plots))
})
  
   htmltools::tagList(all_plots)
```

