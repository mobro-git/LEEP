---
title: "model-comparison-plots"
author: "Jameel Alsalam and Ruying Gao"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 5
    theme: cerulean
    toc_float: 
      collapsed: true
      smooth_scroll: true
params:
  comp_models: !r c("AEO2020", "EIA_Historic", "EIA_STEO", "USREP-ReEDS v3-19.1.0", "EPS v3.2.1", "GCAM5.2-EMF37", "MARKAL.NETL.2020 v1.0")
  scenarios: !r c("NT.Ref", "0by50.Ref", "0by60.Ref", "0by80.Ref")
  cbbPalette: !r c("#000000", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7", "#F0E442")

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())

library(tidyverse)
library(here)
library(glue)
library(plotly)

nice_plot <- function(p) {
  name_p <- enquo(p) %>% as_label()
  filename_pdf <- here("output", "model-comparison", glue("{name_p}.pdf"))
  filename_p <- here("output", "model-comparison", glue("{name_p}.svg"))
  ggsave(filename = filename_pdf,
         plot = p)
  ggsave(filename = filename_p,
         plot = p)
  knitr::include_graphics(filename_p)
}

```

```{r data}
tar_load(emf_data_long)
stopifnot(exists("emf_data_long"))

for (scen in params$scenarios){
  assign(scen, emf_data_long %>%
  filter(scenario == scen,
         model %in% params$comp_models))
}

tar_load(emf_summary_long)
stopifnot(exists("emf_summary_long"))

for (scen in params$scenarios){
  assign(paste(scen, "_summary", sep = ""), emf_summary_long %>% 
  filter(scenario == scen, 
         model %in% params$comp_models))
}
```


```{r target variables}
var_list = list("Emissions|CO2|Energy", "Emissions|CO2|Energy|Supply|Electricity",
                "Final Energy|Electricity")
```


## Comparison of Reference Scenarios Between Models.

### Emissions CO2 Total

```{r}
# total co2 for each reference scenarios

df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Emissions|CO2|Energy") 
  assign(paste(scen, "_total_emissions", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_total_emissions", sep = "")), get)
df_list = do.call("rbind", df_list)
emissions_by_ref <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "CO2 Emissions from Energy in Reference Scenarios",
    x = "Year",
    y = "CO2 (Mt CO2/yr)"
  )
suppressWarnings(nice_plot(emissions_by_ref))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_total_emissions", sep = "")))
```

### Emissions CO2 Electricity

```{r}
# Electricity co2 for each reference scenarios

df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Emissions|CO2|Energy|Supply|Electricity") 
  assign(paste(scen, "_emissions_electricity", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_emissions_electricity", sep = "")), get)
df_list = do.call("rbind", df_list)

emissions_electricity_by_ref <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "CO2 Emissions from Electricity in Reference Scenarios",
    x = "Year",
    y = "CO2 (Mt CO2/yr)"
  )
suppressWarnings(nice_plot(emissions_electricity_by_ref))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_emissions_electricity", sep = "")))
```

### Final Energy Electricity

```{r}
# final energy for each reference scenarios 

df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Final Energy|Electricity") %>% 
   filter(year >= 2010)
  assign(paste(scen, "_final_energy_electricity", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_final_energy_electricity", sep = "")), get)
df_list = do.call("rbind", df_list)

consumption <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "Electricity Consumption (variable: Final Energy|Electricity)",
    x = "Year",
    y = "EJ/year"
  )
suppressWarnings(nice_plot(consumption))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_final_energy_electricity", sep = "")))

```


### Generation

```{r}
df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Secondary Energy|Electricity") 
  assign(paste(scen, "_2nd_energy_electricity", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_2nd_energy_electricity", sep = "")), get)
df_list = do.call("rbind", df_list)

generation <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "Electricity Generation in Reference Scenarios",
    x = "Year",
    y = "Generation (EJ/yr)"
  )
suppressWarnings(nice_plot(generation))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_2nd_energy_electricity", sep = ""))) 
```

```{r}
# suppressWarnings(nice_plot(ref_gen_by_fuel_facet_plot))
```

```{r}
# suppressWarnings(nice_plot(generation_patchwork))
```

### Capacity

```{r}
df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Capacity|Electricity") 
  assign(paste(scen, "_capacity_electricity", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_capacity_electricity", sep = "")), get)
df_list = do.call("rbind", df_list)

capacity <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "Electricity Capacity in Reference Scenarios",
    x = "Year",
    y = "Capacity (GW)"
  )
suppressWarnings(nice_plot(capacity))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_capacity_electricity", sep = ""))) 
```

```{r}
# suppressWarnings(nice_plot(ref_cap_by_fuel_facet_plot))
```



### New Capacity

```{r}
# fuel_types <- c("Biomass", "Coal", "Gas", "Geothermal",
#                    "Hydro", "Nuclear", "Solar", "Wind")
# capacity_additions_by_fuel <- sapply(fuel_types, function(x) 
#   paste("Capacity Additions|Electricity|", x, sep="")) 
# 
# labels = fuel_types
# names(labels) = as.character(capacity_additions_by_fuel)
# 
# ref_new_cap_by_fuel_facet_plot <- ref_long %>% 
#   filter(variable %in% capacity_additions_by_fuel) %>% 
#   ggplot(aes(x = year, y = value, 
#              color = model, linetype = scenario)) + 
#   geom_line(size = 1) +
#   facet_wrap(vars(variable), ncol = 3, labeller = labeller(variable = labels)) + 
#   scale_y_continuous(labels = scales::comma) +
#   labs(
#     title = "New Electricity Capacity in Reference Scenario, by Fuel Type and Model",
#     x = "Year",
#     y = "New Capacity (GW)",
#     color = "Model"
#   )
# suppressWarnings(nice_plot(ref_new_cap_by_fuel_facet_plot))
```


```{r}
# sub_fuel_types <- c("Coal", "Gas", "Solar", "Wind")
# capacity_additions_by_sub_fuel <- sapply(sub_fuel_types, function(x)
#   paste("\"\\bCapacity\\sAdditions[|]Electricity[|]", x, "|\"", sep=""))
# 
# combined = rep(list(NA), length(sub_fuel_types))
# for (fuel in sub_fuel_types) {
#   subplot = ref_long %>% 
#    filter(str_detect(variable, 
#                      paste("Capacity[ ]Additions[|]Electricity[|]", 
#                            fuel, "[|]", sep = ""))) %>% 
#     mutate(fuel = fuel)
#   assign(paste("p_", fuel, sep = ""), subplot)
# }
# df_list = lapply(sapply(sub_fuel_types, function(x) paste("p_", x, sep = "")), get)
# combined = do.call("rbind", df_list)
# 
# ref_new_cap_by_sub_fuel_plot <- combined %>%
#   ggplot(aes(x = year, y = value,
#              color = model, linetype = scenario)) +
#   geom_col(aes(fill = variable)) +
#   facet_wrap(vars(fuel), ncol = 3) +
#   scale_y_continuous(labels = scales::comma) +
#   labs(
#     title = "New Electricity Capacity in Reference Scenario, by Fuel Type and Model",
#     x = "Year",
#     y = "New Capacity (GW)",
#     color = "Model"
#   )
# suppressWarnings(nice_plot(ref_new_cap_by_sub_fuel_plot))
```


```{r}
# suppressWarnings(nice_plot(ref_new_cap_stack))
```


### Prices & Costs

```{r}
df_list = rep(list(NA), length(params$scenarios))

for (scen in params$scenarios) {
  subplot =  get(scen) %>% 
   filter(variable == "Price|Final Energy|Electricity") 
  assign(paste(scen, "_price_electricity", sep = ""), subplot)
}

df_list = lapply(sapply(params$scenarios, function(x) paste(x, "_price_electricity", sep = "")), get)
df_list = do.call("rbind", df_list)

price <- df_list %>%
  ggplot(aes(x = year, y = value,
             color = model)) +
  geom_point(aes(shape = model)) +
  scale_shape_manual(values=c(15, 16, 17, 18, 19, 20, 21)) + 
  theme(legend.position="bottom", aspect.ratio = 4) +
  scale_colour_manual(values=params$cbbPalette) + 
  scale_y_continuous(labels = scales::comma) +
  coord_cartesian(ylim = c(0, NA)) + 
  facet_wrap(vars(scenario), ncol = 4) +
  labs(
    title = "Price for Final Energy in Reference Scenarios",
    x = "Year",
    y = "Price (US$2018/GJ)"
  )
suppressWarnings(nice_plot(price))


### Remove dataframes 
# rm(df_list)
# rm(list = sapply(params$scenarios, function(x) paste(x, "_price_electricity", sep = ""))) 
```


```{r}

# suppressWarnings(nice_plot(ref_totalcost_plot))
```

```{r}
# suppressWarnings(nice_plot(ref_ces_share_plot))
  # tar_render(
  #   model_comparison_report,
  #   "docs/model-comparison-plots.Rmd",
  #   output_dir = "output",
  #   output_file = "model-comparison.html"
  # )
```




