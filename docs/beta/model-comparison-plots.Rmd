---
title: "model-comparison-plots"
author: "Jameel Alsalam and Ruying Gao"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 5
    theme: cerulean
    toc_float: 
      collapsed: true
      smooth_scroll: true
params:
  colors: !r c("#004949","#009292","#ff6db6","#ffb6db","#490092","#006ddb","#b66dff","#b6dbff", "#924900","#db6d00","#ffff6d", "#920000","#24ff24","#6db6ff", "#000000")
  shapes: !r rep(seq(15, 21, 1), 2)
          
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())

library(targets)
library(tidyverse)
library(here)
library(glue)
library(plotly)
library(data.table)
# devtools::install_github("zeehio/facetscales")
library(facetscales)
# devtools::install_github("thomasp85/patchwork")
library(patchwork)

tar_load(config)

devtools::load_all(".")

nice_plot_pdf <- function(p, name_p = p$labels$title) {
  if(is.null(name_p)) stop("You must supply text for filename portion of destination path, either as the name_p or title label for plot p.")
  name_p = clean_text_for_filename(name_p)
  filename_pdf <- here(config$output_folder, "model-comparison", glue("{name_p}.pdf"))
  ggsave(filename = filename_pdf,
         plot = p, device = "pdf")
}

nice_plot <- function(p, name_p = p$labels$title) {
  if(is.null(name_p)) stop("You must supply text for filename portion of destination path, either as the name_p or title label for plot p.")
  name_p = clean_text_for_filename(name_p)
  filename_p <- here(config$output_folder, "model-comparison", glue("{name_p}.svg"))
  ggsave(filename = filename_p,
         plot = p)
  knitr::include_graphics(filename_p)
}



```

# Basic Setup 

## Read in the necessary data
```{r data}
tar_load(config)
stopifnot(exists("config"))
config$main_scenarios = c("NT.Ref", "0by50.Ref", "0by60.Ref", "0by80.Ref")
config$models <- config$models[! config$models %in% c("AEO2020")]

tar_load(emf_data_long)
stopifnot(exists("emf_data_long"))

tar_load(emf_summary_long)
stopifnot(exists("emf_summary_long"))

# need at least enough colors for the models
stopifnot(length(params$colors) >= length(config$models))
model_color_palette <- params$colors[1:length(config$models)] %>% set_names(config$models)
model_shapes <- params$shapes[1:length(config$models)] %>% set_names(config$models)
```


# Part 1: Automated four-scenario variable plots

## Function to make the figures
```{r make_figure function}
# function to generate figures for a selected var
make_figure <- function(data, var, title_name, scenarios, models) {
  
  df_list <- data %>%
        filter(variable %in% var,
          scenario %in% scenarios,
         model %in% models)
  
  if (nrow(df_list) == 0) {
    print(paste('there is no observation for var ', var, sep = ""))
  } else {
      if (!(length(unique(df_list$unit))==1)) {
    print(paste('there are multiple units for var ', var, sep = ""))
      }
      
      figure <- df_list %>%
      mutate(val = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, val)) %>%
        ggplot(aes(x = year, y = value,
                   color = model)) +
        geom_point(aes(shape = model)) +
        geom_line(size = 1) +
        scale_shape_manual(values=model_shapes) +
        scale_colour_manual(values=model_color_palette) +
        theme(legend.position="bottom", aspect.ratio = 4) +
        scale_y_continuous(labels = scales::comma) +
        # coord_cartesian(ylim = c(0, NA)) +
        facet_wrap(vars(scenario), ncol = 4) +
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
  }

}

```


## Read in Variables, Make the figures

```{r make_figures}

var_list <- readr::read_csv("plot_mapping/vars_beta_round_plots.csv")
var_names <- var_list$variables
title_names <- var_list$figure_name

pdf(paste(config$output_folder,"/figures.pdf",sep=""))

for (i in 1:length(var_names)) {
  if (i%%10 == 0) {
    print(i)
  }
  print(make_figure(emf_data_long, var_names[i], title_names[i], config$main_scenarios, config$models))
}

dev.off()

make_figure(emf_data_long, var_names[1], title_names[1], config$main_scenarios, config$models)
```

# Part 2: Make the facet grid plots by scenario 

## Regular Function (all variables having the same y scale)
```{r make_facet_grid_by_model function}
# function to generate figures for a selected var

make_grid_by_scenario <- function(data, vars, var_names, scenarios, models, title_name, scale = "fixed") {

  df_list <- data %>% 
        filter(variable %in% vars,
          scenario %in% scenarios,
         model %in% models)
  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        endsWith(variable, "Coal") ~ 2,
        endsWith(variable, "Gas") ~ 3,
        endsWith(variable, "Oil") ~ 4,
        endsWith(variable, "Wind") ~ 5, 
        endsWith(variable, "Solar") ~ 6, 
        endsWith(variable, "Biomass") ~ 7, 
        endsWith(variable, "Others") ~ 8,
        str_detect(variable, "Buildings") ~ 8,
        str_detect(variable, "Industry") ~ 9,
        str_detect(variable, "Transportation") ~ 10,
        TRUE ~ 1)) %>%
        mutate(variable = fct_reorder(as.factor(variable), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = model)) +
        geom_point(aes(shape = model)) +
        geom_line(size = 1) +
        scale_shape_manual(values=model_shapes) +
        scale_colour_manual(values=model_color_palette) +
        theme(legend.position="bottom") +
        scale_y_continuous(labels = scales::comma) +
        coord_cartesian(xlim = c(NA, 2080)) +
        facet_grid(rows = vars(variable), cols = vars(scenario), 
                   labeller = labeller(variable = var_names), 
                   scales = scale) + 
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
}
```


## Modified regular function to generate the grids with/without CCS (all variables having the same y scale)
```{r make_facet_grid_by_model_w_CCS function}
# function to generate figures for a selected var

make_grid_by_scenario_w_CCS <- function(data, labels, label_names, scenarios, models, title_name, scale = "fixed") {

  df_list <- data %>% 
        filter(variable %in% vars,
          scenario %in% scenarios,
         model %in% models)
  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        endsWith(labels, "Coal") ~ 2,
        endsWith(labels, "Gas") ~ 3,
        endsWith(labels, "Oil") ~ 4,
        endsWith(labels, "Wind") ~ 5, 
        endsWith(labels, "Solar") ~ 6, 
        endsWith(labels, "Biomass") ~ 7, 
        endsWith(labels, "Others") ~ 8,
        str_detect(variable, "Buildings") ~ 8,
        str_detect(variable, "Industry") ~ 9,
        str_detect(variable, "Transportation") ~ 10,
        TRUE ~ 1)) %>%
        mutate(labels = fct_reorder(as.factor(labels), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = model)) +
        geom_line(aes(linetype = as.character(type)), size = 1) +
        scale_linetype_discrete(name = "variable", labels = c("1" = "Regular or without CCS", "2" = "with CCS"))+
        scale_shape_manual(values=model_shapes) +
        scale_colour_manual(values=model_color_palette) +
        theme(legend.position="right") +
        scale_y_continuous(labels = scales::comma) +
        coord_cartesian(xlim = c(NA, 2080)) +
        # coord_cartesian(ylim = c(0, NA)) +
        facet_grid(rows = vars(labels), cols = vars(scenario), 
                   labeller = labeller(labels = label_names), 
                   scales = scale) + 
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
}
```


## Helper function to generate dataframe that incorporates the "others" category, usually combining the renewables
```{r make_grid_by_scenario summation required}

generating_df_with_combined_data <- function(df, var_target, sum_over, name) {
  data <- df %>% filter(startsWith(variable, var_target))
  
  unit_dat = data %>% filter(variable %in% paste(var_target, sum_over, sep = "|"))
  
  if (length(unique(unit_dat$unit)) != 1) {
    print("there are multiple units.")
    print(unique(unit_dat$unit))
  }
  unit <- unique(unit_dat$unit)[1]
  
  
  others <- paste(var_target, sum_over, sep = "|") 
  
  others_data <- data %>% 
    filter(variable %in% others) %>% 
    group_by(model, scenario, year)  %>% 
    summarize("value" = sum(value)) %>% 
    mutate("variable" = name, "unit" = unit)

    # Combining the sum with the rest of the data
    data = rbind(others_data, data %>%
    select(model, scenario, year, variable, value, unit))
  
    return(data)
}

```


## Plots 


### Emissions|CO2|Energy
```{r grid plot Emissions Energy Supply}
var_target = "Emissions|CO2|Energy"
var_names = c("All", "Coal", "Gas", "Oil")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

#make_grid_by_scenario(emf_data_long, vars = vars, var_names, config$main_scenarios, config$models,"Emissions from energy supply over time")
make_grid_by_scenario(emf_data_long, vars = vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models,"Emissions from energy supply over time (NT v. 0by50,80)") %>%
  nice_plot()
```


### Emissions|CO2|Energy|Supply|Electricity
```{r grid plot Emissions Energy Supply Electricity}
var_target = "Emissions|CO2|Energy|Supply|Electricity"
var_names = c("All", "Coal", "Gas", "Oil")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

#make_grid_by_scenario(emf_data_long, vars = vars, var_names, config$main_scenarios, config$models,"Emissions from electricity supply over time")
make_grid_by_scenario(emf_data_long, vars = vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models,"Emissions from electricity supply over time (NT v. 0by50,80)") %>%
  nice_plot()
```

### Final Energy
```{r grid plot Final Energy}
## Check what variables are related to final energy
# final_energy <- emf_data_long %>% filter(startsWith(variable, "Final Energy"))
# print(unique(final_energy$variable))

var_target = "Final Energy"
var_names = c("All", "Buildings", "Industry", "Transportation")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

#make_grid_by_scenario(emf_data_long, vars = vars, var_names, config$main_scenarios, config$models[-(config$models=="GENeSYS-MOD/ANYMOD")],"Final energy over time")
make_grid_by_scenario(emf_data_long, vars = vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models[-(config$models=="GENeSYS-MOD/ANYMOD")],"Final energy over time (NT v. 0by50,80)") %>% nice_plot()
```


### Emissions|CO2|Energy|Demand
```{r grid plot Emissions Demand}
var_target = "Emisssions|CO2|Energy|Demand"
var_names = c("All", "Buildings", "Industry", "Transportation")
data = generating_df_with_combined_data(emf_data_long, var_target, c("Buildings", "Industry", "Transportation"), var_target)

vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

#make_grid_by_scenario(data, vars = vars, var_names, config$main_scenarios, config$models,"Emissions from energy demand over time")
make_grid_by_scenario(data, vars = vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models,"Emissions from energy demand over time (NT v. 0by50,80)") %>% nice_plot()
```


# Part 3: Make the facet grid plots by scenario with customized y scales for each subplot

## Function

```{r make_facet_grid_by_model_w_y_limits function}
# function to generate figures for a selected var

make_grid_by_scenario_w_y_limits <- function(data, vars, var_names, scenarios, models, title_name, scales_y, scale = "fixed", xmax = NA) {

  df_list <- data %>% 
        filter(variable %in% vars,
          scenario %in% scenarios,
         model %in% models)
  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        endsWith(variable, "Coal") ~ 2,
        endsWith(variable, "Gas") ~ 3,
        endsWith(variable, "Oil") ~ 4,
        endsWith(variable, "Biomass") ~ 5, 
        endsWith(variable, "Wind") ~ 6, 
        endsWith(variable, "Solar") ~ 7, 
        endsWith(variable, "Nuclear") ~ 8, 
        endsWith(variable, "Others") ~ 9,
        TRUE ~ 1)) %>%
        mutate(variable = fct_reorder(as.factor(variable), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = model)) +
        geom_point(aes(shape = model)) +
        geom_line(size = 1) +
        coord_cartesian(xlim = c(NA, xmax)) +
        scale_shape_manual(values=model_shapes) +
        scale_colour_manual(values=model_color_palette) +
        theme(legend.position="bottom") +
        facet_grid_sc(rows = vars(variable), cols = vars(scenario),
                   labeller = labeller(variable = var_names),
                   scales = list(y = scales_y)) +
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
      
}
```

## Function w/CCS considerations
```{r make_facet_grid_by_model_w_y_limits function}
# function to generate figures for a selected var

make_grid_by_scenario_w_y_limits_and_CCS <- function(data, labels, label_names, scenarios, models, title_name, scales_y, scale = "fixed", xmax = NA) {
  
  df_list = data %>% 
        filter(scenario %in% scenarios,
         model %in% models)
  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        endsWith(labels, "Coal") ~ 2,
        endsWith(labels, "Gas") ~ 3,
        endsWith(labels, "Oil") ~ 4,
        endsWith(labels, "Biomass") ~ 5, 
        endsWith(labels, "Wind") ~ 6, 
        endsWith(labels, "Solar") ~ 7, 
        endsWith(labels, "Nuclear") ~ 8, 
        endsWith(labels, "Others") ~ 9,
        TRUE ~ 1)) %>%
        mutate(labels = fct_reorder(as.factor(labels), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = model)) +
        coord_cartesian(xlim = c(NA, xmax)) +
        geom_line(aes(linetype = as.character(type)), size = 1) +
        scale_shape_manual(values=model_shapes) +
        scale_colour_manual(values=model_color_palette) +
        scale_linetype_discrete(name = "variable", labels = c("1" = "Regular or without CCS", "2" = "with CCS"))+
        theme(legend.position="right") +
        facet_grid_sc(rows = vars(labels), cols = vars(scenario),
                   labeller = labeller(labels = label_names),
                   scales = list(y = scales_y)) +
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
      
}
```

## Plots 

### Primary Energy

```{r primary energy}
# Selecting relevant variables 
var_target = "Primary Energy"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Nuclear", "Wind", "Solar", "Hydro", "Geothermal"), paste(var_target, "Others", sep= "|"))
var_names = c("All", "Coal", "Gas", "Oil", "Biomass", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

scales_y <- list(
  `Primary Energy` = scale_y_continuous(limits = c(0, 150), breaks = seq(0, 150, 50)),
  `Primary Energy|Coal` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Gas` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Oil` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Biomass` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Others` = scale_y_continuous(limits = c(0, 150), breaks = seq(0, 150, 50))
)


#make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, config$main_scenarios, config$models,"Primary Energy over time", scales_y, scale = "free_y")
make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, c("NT.Ref", "0by50.Ref"), 
                                 config$models,"Primary Energy over time (NT v. 0by50)", scales_y, scale = "free_y") %>% nice_plot()
make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models,"Primary Energy over time (NT v. 0by50,80)", scales_y, scale = "free_y") %>% nice_plot()
```

### Primary Energy (w/ CCS)

```{r primary energy w/CCS}
# Selecting relevant variables 
var_target = "Primary Energy"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Nuclear", "Wind", "Solar", "Hydro", "Geothermal"), paste(var_target, "Others", sep= "|"))

var_names = c("All", "Coal|w/ CCS", "Coal|w/o CCS", 
              "Gas|w/ CCS", "Gas|w/o CCS",
              "Oil", "Biomass", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

label_names = c("All", "Coal", "Gas", "Oil", "Biomass", "Others")
labels = sapply(label_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(label_names) = labels

data = data %>% 
  filter(variable %in% vars) %>%
  mutate(labels = case_when(
  str_detect(variable, "Coal") ~ paste(var_target, "Coal", sep = "|"),
  str_detect(variable, "Gas") ~ paste(var_target, "Gas", sep = "|"),
  variable %in% vars ~ variable,
), type = case_when(
  str_detect(variable, "w/ CCS") ~ 2,
  TRUE ~ 1
)) 

scales_y <- list(
  `Primary Energy` = scale_y_continuous(limits = c(0, 150), breaks = seq(0, 150, 50)),
  `Primary Energy|Coal` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Gas` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Oil` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Biomass` = scale_y_continuous(limits = c(0, 75), breaks = seq(0, 75, 25)),
  `Primary Energy|Others` = scale_y_continuous(limits = c(0, 150), breaks = seq(0, 150, 50))
)


make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, config$main_scenarios, config$models,"Primary Energy over time w/CCS", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, c("NT.Ref", "0by50.Ref"), config$models,"Primary Energy over time (NT v. 0by50) w/CCS", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
```

### Generation 
```{r Generation}
# ALl 
# Biomass, Coal, Gas, Oil, 
# sum geothermal, hydro, nuclears
# solar, wind

var_target = "Secondary Energy|Electricity"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Hydro", "Geothermal"), paste(var_target, "Others", sep= "|"))

var_names = c("All", "Coal", "Gas", "Biomass", "Solar", "Wind", "Nuclear", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

scales_y <- list(
  `Secondary Energy|Electricity` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Coal` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Gas` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Nuclear` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Biomass` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Solar` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Wind` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Others` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5))
)


make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, config$main_scenarios, config$models,"Secondary energy|Electricity over time", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, c("NT.Ref", "0by50.Ref"), config$models,"Secondary energy|Electricity over time (NT v. 0by50)", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
```


```{r Generation w and w/o CCS}

var_target = "Secondary Energy|Electricity"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Hydro", "Geothermal"), 
                                        paste(var_target, "Others", sep= "|"))

var_names = c("All", "Coal|w/ CCS", "Coal|w/o CCS", 
              "Gas|w/ CCS", "Gas|w/o CCS",
             "Biomass", "Solar", "Wind", "Nuclear", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

label_names = c("All", "Coal", "Gas", "Biomass", "Solar", "Wind", "Nuclear", "Others")
labels = sapply(label_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(label_names) = labels

data = data %>% 
  filter(variable %in% vars) %>%
  mutate(labels = case_when(
  str_detect(variable, "Coal") ~ paste(var_target, "Coal", sep = "|"),
  str_detect(variable, "Gas") ~ paste(var_target, "Gas", sep = "|"),
  variable %in% vars ~ variable,
), type = case_when(
  str_detect(variable, "w/ CCS") ~ 2,
  TRUE ~ 1
)) 

scales_y <- list(
  `Secondary Energy|Electricity` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Coal` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Gas` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Nuclear` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Biomass` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)),
  `Secondary Energy|Electricity|Solar` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Wind` = scale_y_continuous(limits = c(0, 50), breaks = seq(0, 50, 10)),
  `Secondary Energy|Electricity|Others` = scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5))
)

make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, config$main_scenarios, config$models,"Secondary energy|Electricity over time w/ CCS", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, c("NT.Ref", "0by50.Ref"), config$models,"Secondary energy|Electricity over time (NT v. 0by50, w/ CCS)", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
```

```{r Generating Capacity}
var_target = "Capacity|Electricity"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Nuclear", "Hydro", "Geothermal"), 
                                        paste(var_target, "Others", sep= "|"))

var_names = c("All", "Coal", "Gas", "Oil", "Biomass", "Solar", "Wind", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

scales_y <- list(
  `Capacity|Electricity` = scale_y_continuous(limits = c(0, 15000), breaks = seq(0, 15000, 5000)),
  `Capacity|Electricity|Coal` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Gas` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Oil` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Biomass` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Solar` = scale_y_continuous(limits = c(0, 7500), breaks = seq(0, 7500, 2500)),
  `Capacity|Electricity|Wind` = scale_y_continuous(limits = c(0, 7500), breaks = seq(0, 7500, 2500)),
  `Capacity|Electricity|Others` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000))
)

make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, config$main_scenarios, config$models,"Generating Capacity over time", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
make_grid_by_scenario_w_y_limits(data, vars = vars, var_names, c("NT.Ref", "0by50.Ref"), config$models,"Generating capacity over time (NT v. 0by50)", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
```



```{r Generating Capacity w w/o CCS}
var_target = "Capacity|Electricity"
data = generating_df_with_combined_data(emf_data_long, var_target, c("Nuclear", "Hydro", "Geothermal"), 
                                        paste(var_target, "Others", sep= "|"))

var_names = c("All", "Coal|w/ CCS", "Coal|w/o CCS", 
              "Gas|w/ CCS", "Gas|w/o CCS",
              "Oil", "Biomass", "Solar", "Wind", "Others")
vars = sapply(var_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(var_names) = vars

label_names = c("All", "Coal", "Gas", "Oil", "Biomass", "Solar", "Wind", "Others")
labels = sapply(label_names, function(x) {if (x == "All") {var_target} else {paste(var_target, x, sep = "|")}})
names(label_names) = labels


data = data %>% 
  filter(variable %in% vars) %>% 
  mutate(labels = case_when(
  str_detect(variable, "Coal") ~ paste(var_target, "Coal", sep = "|"),
  str_detect(variable, "Gas") ~ paste(var_target, "Gas", sep = "|"),
  variable %in% vars ~ variable,
), type = case_when(
  str_detect(variable, "w/ CCS") ~ 2,
  TRUE ~ 1
)) 

scales_y <- list(
  `Capacity|Electricity` = scale_y_continuous(limits = c(0, 15000), breaks = seq(0, 15000, 5000)),
  `Capacity|Electricity|Coal` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Gas` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Oil` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Biomass` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000)),
  `Capacity|Electricity|Solar` = scale_y_continuous(limits = c(0, 7500), breaks = seq(0, 7500, 2500)),
  `Capacity|Electricity|Wind` = scale_y_continuous(limits = c(0, 7500), breaks = seq(0, 7500, 2500)),
  `Capacity|Electricity|Others` = scale_y_continuous(limits = c(0, 2500), breaks = seq(0, 2500, 1000))
)

make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, config$main_scenarios, config$models,"Capacity over time w/ CCS", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
make_grid_by_scenario_w_y_limits_and_CCS(data, labels = labels, label_names, c("NT.Ref", "0by50.Ref"), config$models,"Capacity over time (NT v. 0by50, w/ CCS)", scales_y, scale = "free_y", xmax = 2080) %>% nice_plot()
```

# Part 4: Make facet grid by model 

## Function 

```{r make_facet_grid_by_model function}
# function to generate figures for a selected var

make_grid_by_model <- function(data, vars, var_names, scenarios, models, title_name) {

  df_list <- data %>% 
        filter(variable %in% vars,
          scenario %in% scenarios,
         model %in% models)

  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        variable == "Final Energy|Percent Electricity" ~ 1,
        str_detect(variable, "Buildings") ~ 2,
        str_detect(variable, "Industry") ~ 3,
        str_detect(variable, "Transportation") ~ 4)) %>%
        mutate(variable = fct_reorder(as.factor(variable), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = scenario)) +
        geom_point(aes(shape = scenario)) +
        geom_line(size = 1) +
        scale_shape_manual(values=params$shapes) +
        scale_colour_manual(values=params$colors) +
        theme(legend.position="bottom") +
        scale_y_continuous(labels = scales::comma) +
        coord_cartesian(ylim = c(0, NA)) +
        facet_grid(rows = vars(variable), cols = vars(model), labeller = labeller(variable = var_names)) + 
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
}
```


```{r make_facet_grid_stacked_by_model function}
# function to generate figures for a selected var

# **** work in progress ****
# Plot gridded by model, stacked time-series with emissions 
#     (coal, gas, oil, [maybe include process emission & non-CO2 in special version] )

# Plot gridded by model, stacked bar with capacity by technology, y-axis years 2020,30,40,50

make_grid_stacked_by_model <- function(data, vars, var_names, scenarios, models, title_name) {

  df_list <- data %>% 
        filter(variable %in% vars,
          scenario %in% scenarios,
         model %in% models)

  
    if (!(length(unique(df_list$unit))==1)) {
    print('there are multiple units for the variables')
    }
  
      figure <- df_list %>%
      mutate(colval = case_when(
        startsWith(scenario, "NT") ~ 1,
        startsWith(scenario, "0by50") ~ 2,
        startsWith(scenario, "0by60") ~ 3,
        startsWith(scenario, "0by80") ~ 4)) %>%
        mutate(scenario = fct_reorder(scenario, colval)) %>%
        mutate(rowval = case_when(
        variable == "Final Energy|Percent Electricity" ~ 1,
        str_detect(variable, "Buildings") ~ 2,
        str_detect(variable, "Industry") ~ 3,
        str_detect(variable, "Transportation") ~ 4)) %>%
        mutate(variable = fct_reorder(as.factor(variable), rowval)) %>%
        ggplot(aes(x = year, y = value,
                   color = scenario)) +
        geom_point(aes(shape = scenario)) +
        geom_line(size = 1) +
        scale_shape_manual(values=params$shapes) +
        scale_colour_manual(values=params$colors) +
        theme(legend.position="bottom") +
        scale_y_continuous(labels = scales::comma) +
        coord_cartesian(ylim = c(0, NA)) +
        facet_grid(rows = vars(variable), cols = vars(model), labeller = labeller(variable = var_names)) + 
        labs(
          title = title_name,
          x = "Year",
          y = unique(df_list$unit)[1]
        )
      figure
}
```


## Plot

### Percent Electricity 

```{r percent electricity}


vars = c("Final Energy|Percent Electricity", "Final Energy|Buildings|Percent Electricity", 
         "Final Energy|Industry|Percent Electricity", "Final Energy|Transportation|Percent Electricity")
var_names = c("All", "Buildings", "Industry", "Transportation")
names(var_names) = vars

# make_grid_by_model(emf_data_long, vars, var_names, config$main_scenarios, c("EPAUS9r-TIMES", "EPS", "GCAM"), "Electricity Percent of Final Energy")
# make_grid_by_model(emf_data_long, vars, var_names, c("NT.Ref", "0by50.Ref"), c("EPAUS9r-TIMES", "EPS", "GCAM"), "Electricity Percent of Final Energy (NT vs 0by50)")

make_grid_by_scenario(emf_data_long, vars, var_names, config$main_scenarios, config$models, "Electricity Percent of Final Energy") %>% nice_plot()
make_grid_by_scenario(emf_data_long, vars, var_names, c("NT.Ref", "0by50.Ref"), config$models, "Electricity Percent of Final Energy (NT v. 0by50)") %>% nice_plot()
make_grid_by_scenario(emf_data_long, vars, var_names, c("NT.Ref", "0by50.Ref", "0by80.Ref"), config$models, "Electricity Percent of Final Energy (NT v. 0by50,80)") %>% nice_plot()
```



