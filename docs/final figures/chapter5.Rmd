---
title: "Chapter 5: Industry"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## 5.1 co2 emissions from the industrial sector in the us compared to economy-wide co2 emissions

```{r}
fig_no = 5.1

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Industry: Direct" ~ variable_rename,
    variable_rename == "Industry: Indirect" ~ variable_rename,
    TRUE ~ "Other Sectors"
  )) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct","Industry: Indirect", "Other Sectors")))

p4 = emis_stack(dta4, "Industrial CO2 Emissions", figmap_leep_stackbar, config) + 
  scale_fill_manual(values = c("Other Sectors" = "white", "Industry: Indirect" = subpalettes$`Emissions Stack`[["Industry: Indirect"]], "Industry: Direct" = subpalettes$`Emissions Stack`[["Industry: Direct"]])) +
  scale_color_manual(values = c("Other Sectors" = "#CECECE", "Industry: Indirect" = subpalettes$`Emissions Stack`[["Industry: Indirect"]], "Industry: Direct" = subpalettes$`Emissions Stack`[["Industry: Direct"]])) +
  scale_alpha_manual(values = c("Other Sectors" = 0.5, "Industry: Indirect" = 1, "Industry: Direct" = 1))
p4

dta4 = clean_supplemental_data(dta4, fig_no)


saveall(p4, dta4, fig_no)
```

## 5.2

## 5.x Emissions breakout pie chart

```{r}
pie = readxl::read_xlsx("data-extra/industry_piechart.xlsx")
pie1 = pie %>% filter(Table == 1) %>%
  rename(value = `% Energy-related Emissions`) %>%
  mutate(value = round(value*100,0))

ggplot(data = pie1, aes(x = "", y = value, fill = Industry)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_brewer(palette = "Dark2") +
  blank_theme +
  geom_text(aes(label = paste(value,"%",sep=""), x = 1.2),
            position = position_stack(vjust = 0.5),
            size=4)
# TODO: turn into horizontal bar chart with labels for %, maybe labels for industry too?

# ggplot() +
#   geom_bar(data = pie1, aes(x=value,y=1,fill=Industry,position="fill"))
```

## 5.3 industry total co2 emissions 

```{r}
fig_no = 5.3

Ind_data = spg_clean(
  21, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)

IndSpg = spg2(
  Ind_data,
  "",
  expression(paste("Industry C", O[2], "Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2500,
  c(0, 500, 1000, 1500, 2000, 2500),
  scales::comma, 
  1, 
  c(2015, 1550), 
  c(2030, 1575), 
  c(2020, 750), 
  config, 
  figmap_leep_timeseries) 

IndDot = dotted(IndSpg$data, IndSpg$figure, "median", 0, 2500, config, figmap_leep_timeseries)
IndDot

IndTab = html(IndSpg$data, "Industry CO<sub>2<sub>")
IndDot

IndSpg$data = clean_supplemental_data(IndSpg$data, fig_no)

delta = delta(28, c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"), config, clean_data, figmap_leep_timeseries)
saveall(delta$figure, delta$df, paste(fig_no, "delta"))

savefig(IndDot, fig_no)
savedata(IndSpg$data, fig_no)
IndTab
```


## 5.x energy used in the industry sector, by fuel, over time (NO LONGER IN USE)

```{r}
# fig_no = 5.3
# 
# clean_data6 = clean_data %>% duplicate_historical_data("EIA-LTS", 2020)
# 
# p1 = dot_plots("time_series", config, clean_data6, figmap_leep_timeseries, 119, "United States", 0, 30, "Industrial Final Energy: Fossil", metric = "median", historic_coord = c(2015,17), preira_coord = c(2030, 16), ira_coord = c(2027, 23), ylab = "Final Energy (Quads)")
# p1$full = p1$full + theme(plot.title = element_blank())
# p1$full
# 
# dta = data_from_graph("time_series", config, clean_data6, figmap_leep_timeseries, 119, "United States")
# dta = clean_supplemental_data(dta, fig_no)
# 
# saveall(p1$full, dta, fig_no)
```
