---
title: "Chapter 2: Electricity"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## F2.1 co2 emissions from the power sector in the us, compared to economy-wide co2 emissions

```{r}
fig_no = 2.1

data <- clean_data %>%
  filter(model == "EPA-GHGI") %>%
  filter(year >= 2005) %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Coal"|
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Oil" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Coal" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Gas" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Oil") %>%
  mutate(variable_rename = case_when(
    grepl("Demand", variable) ~ "Other Sectors",
    grepl("Coal", variable) ~ "Coal", 
    grepl("Gas", variable) ~ "Gas", 
    grepl("Oil", variable) ~ "Petroleum",
  )) %>%
  group_by(year, variable_rename) %>%
  summarise(value = sum(value)) %>%
  mutate(alpha = case_when(
    variable_rename == "Other Sectors" ~ 0.5, 
    T ~ 1))

data$variable_rename <- factor(data$variable_rename, level = c("Other Sectors", "Coal", "Gas", "Petroleum"))

fig = ggplot(data, aes(fill = variable_rename, y = value, alpha = alpha, x = year, color = variable_rename)) + 
  geom_bar(position = "stack", stat = "identity") + 
  theme_emf() +
  labs(title = "",
         x = "",
         y = expression(paste("Power Sector Emissions (Mt C", O[2], "/yr)"))) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 6000), labels = scales::comma) +
    scale_x_continuous(breaks = c(2005, 2021)) + 
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") +
    scale_alpha(range = c(0.6, 1), guide = F)+
  scale_color_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "#DEDEDE")) +
  scale_fill_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "#DEDEDE")) +
  theme(axis.ticks = element_blank())
fig

saveall(fig, data, fig_no)
```

## F2.2 us electricity generation and capacity shares by fuel type, 2021

```{r}
fig_no = 2.2

clean_data10 = clean_data %>% 
  filter(datasrc == 'EIA-EPA-bistline_historic.csv') %>%
  mutate(value = case_when(unit == "Quads" ~ value * 293.07, TRUE ~ value),
         unit = case_when(unit == "Quads" ~ "TWh", TRUE ~ unit))


fig = print_graph("stacked_bar", config, clean_data10, figmap_leep_stackbar, 14, "United States", 
                  level_var = c("Other", "Renewables", "Nuclear", "Oil", "Natural Gas", "Coal")) +
  labs(y = expression("Electricity Generation (TWh)")) +
  scale_y_continuous(expand = c(0,0), limits = c(0,4500), labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), plot.title = element_blank(),
        axis.ticks = element_blank()) +
  bottom1
fig

df = data_from_graph("stacked_bar", config, clean_data10, figmap_leep_stackbar, 14, "United States")

df = clean_supplemental_data(df, fig_no)

saveall(fig, df, fig_no)
```

## F2.3 us power sector co2 emissions

```{r}
fig_no = 2.3

Elec_data = spg_clean(
  98,
  c("Scout-LEEP"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

ElecSpg = spg2(
  Elec_data, 
  "",
  expression(paste("Power Sector Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2500,
  c(0, 500, 1000, 1500, 2000, 2500),
  scales::comma, 
  1,
  c(2015, 2250), 
  c(2027.5, 1750), 
  c(2023, 650), 
  config,
  figmap_leep_timeseries) 

ElecDot = dotted(ElecSpg$data, ElecSpg$figure, "median", 0, 2500, config, figmap_leep_timeseries)
ElecDot
ElecSpg$data = clean_supplemental_data(ElecSpg$data, fig_no)
saveall(ElecDot,ElecSpg$data, fig_no)

delta = delta(26, "", config, clean_data, figmap_leep_timeseries)
delta
saveall(delta$figure, delta$df, paste(fig_no, "delta"))

ElecTab = html(ElecSpg$data, "Electricity CO<sub>2<sub>")
ElecTab

fig_no = "ES.1"
saveall(ElecDot, ElecSpg$data, fig_no)
saveall(delta$figure, delta$df, paste(fig_no, "delta"))
```

## F2.4 generation by model and difference from no ira

```{r}
fig_no = 2.4
# placeholder for figure shane is working on
```

## F2.5 historical and projected capacity additions by technology

```{r}
fig_no = 2.5

# capacity addition plot

ymin = -40
ymax = 130

subpalettes = create_subpalettes(figmap_leep_stackbar, config)
sp = subpalettes$`Capacity Additions2`

dta3 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States") %>%
  mutate(temp = case_when(
      grepl("Additions",variable) ~ "Capacity Additions",
      TRUE ~ "Capacity Retirements")) %>%
  mutate(variable_rename = factor(variable_rename, levels = c("Solar", "Wind", "Storage", "Nuclear", 
                                             "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal", "Other")))
fig = dta3 %>% ggplot() +
  #print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States") +
  geom_bar(aes(x = year, y = value, fill = variable_rename, color = variable_rename, alpha = temp,
               group = interaction(variable_rename, temp), width = 0.75),
           position="stack", stat="identity", linewidth = 0.25) +
  theme_emf() +
  geom_hline(yintercept = 0, linewidth = 0.5, color = "black") +
  labs(y = expression("Avg. Annual Capacity Change (GW/yr)")) +
  scale_fill_manual(drop = F, breaks = c("Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", 
                               "Coal CCS", "Coal", "Other"),
                    values = c(sp[["Solar"]], sp[["Wind"]], sp[["Storage"]], sp[["Nuclear"]], sp[["Hydro"]],
                               sp[["Gas CCS"]], sp[["Gas"]], sp[["Coal CCS"]], sp[["Coal"]], sp[["Other"]])) +
  scale_color_manual(drop = F, breaks = c("Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", 
                               "Coal CCS", "Coal", "Other"),
                    values = c(sp[["Solar"]], sp[["Wind"]], sp[["Storage"]], sp[["Nuclear"]], sp[["Hydro"]],
                               sp[["Gas CCS"]], sp[["Gas"]], sp[["Coal CCS"]], sp[["Coal"]], sp[["Other"]])) +
  scale_y_continuous(limits = c(ymin, ymax)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_alpha_manual(values = c(0.6,1), breaks = c("Capacity Retirements", "Capacity Additions"), guide = F) +
  ggtitle("Historical Annual Capacity Changes") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5, size = 10),
        axis.text.x = element_text(angle = 0, hjust = 0.5, size = 6), axis.ticks = element_blank(),
        axis.title.x = element_blank())

#dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States")

#fig

# dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 6, "United States")
# dta_ttl = dta4 %>% 
#   mutate(temp = case_when(
#     grepl("Additions",variable) ~ "Capacity Additions",
#     TRUE ~ "Capacity Retirements")) %>%
#   group_by(model, scenario, region, datasrc, unit, temp) %>%
#   summarize(value = sum(value)) %>% 
#   select(-temp) %>%
#   mutate(variable_rename = "Total")
# 
# dta4 = rbind(dta4,dta_ttl) %>% mutate(variable_rename = factor(variable_rename, 
#                                   levels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal"))) %>%
#   mutate(stagger = case_when((variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value >= 0)) ~ -0.1,
#                              (variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value < 0)) ~ 0.1,
#                              TRUE ~ 0))
# 
# stats = dta4 %>% group_by(variable_rename, stagger) %>% summarize(mean = mean(value), median = median(value))

# dotplot2 = dta4 %>% ggplot() + 
#   geom_point(aes(x = (as.numeric(variable_rename) + stagger), y = value, color = variable_rename), shape = 16, size = 2) + 
#   #geom_point(data = stats, aes(x = variable_rename, y = median, color = variable_rename), shape = 3, size = 2) +
#   geom_segment(data = stats, aes(x = as.numeric(variable_rename) - 0.25 + stagger, xend = as.numeric(variable_rename) + 0.25 + stagger, 
#                                  y = median, yend = median, color = variable_rename), linewidth = 0.5) +
#   geom_hline(yintercept = 0, linewidth = 0.25, color = "black") +
#   scale_x_continuous(breaks = seq(1,10), labels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal")) +
#   scale_y_continuous(limits = c(ymin, ymax)) +
#   scale_subpalette(subpalettes, "Capacity Additions2") +
#   ggtitle("Average Annual Capacity Changes (2021-2035)") +
#   theme_emf() +
#   theme(plot.title = element_text(hjust = 0.5, size = 10), axis.text.y = element_blank(),
#         axis.title.y = element_blank(), axis.ticks = element_blank(),
#         axis.title.x = element_blank(),
#         axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
# #dotplot2

dta5 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 19, "United States") %>% 
  mutate(temp = case_when(
    grepl("Additions",variable) ~ "Capacity Additions",
    TRUE ~ "Capacity Retirements")) %>%
  mutate(value = case_when((model == "USREP-ReEDS") & (temp == "Capacity Retirements") ~ -1 * value, 
                           (model == "NEMS-OP") & (temp == "Capacity Retirements") ~ -1 * value, 
                           TRUE ~ value)) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Solar", "Wind", "Storage", "Nuclear", 
                                             "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal", "Other")))

filler_row = data.frame("model" = c(""), value = 0)
dta5 = bind_rows(dta5, filler_row) %>%
  mutate(model = factor(model, levels = c("RIO-REPEAT", "EPS-EI", "NEMS-RHG", "NEMS-OP", "GCAM-CGS", "ReEDS-NREL", "GCAM-PNNL", "REGEN-EPRI", "Haiku-RFF", "IPM-EPA", "NEMS-EIA", "USREP-ReEDS", "IPM-NRDC", "MARKAL-NETL"
                                          ,"")))

stats = dta5 %>% group_by(model, temp) %>% 
  summarize(sum = sum(value), mean = mean(value), median = median(value))  

fig2 = dta5 %>% ggplot() +
  geom_bar(aes(x = model, y = value, fill = variable_rename, color = variable_rename, alpha = temp,
               group = interaction(variable_rename, temp), width = 0.75),
           position="stack", stat="identity", linewidth = 0.25) +
  theme_emf() +
  geom_hline(yintercept = 0, linewidth = 0.5, color = "black") +
  geom_segment(aes(x = "", xend = "", y = 2, yend = 35), linewidth = 0.3, 
               arrow = arrow(type = "closed", angle = 20, length = unit(3, "points"))) +
  geom_segment(aes(x = "", xend = "", y = -2, yend = -35), linewidth = 0.3, 
               arrow = arrow(type = "closed", angle = 20, length = unit(3, "points"))) +
  annotate("text", x = "", y = 2, size = 2,
               label = "Additions", color = "black", alpha = 1, hjust = 1, vjust = -0.5, angle = -90) + 
  annotate("text", x = "", y = -2, size = 2,
               label = "Retirements", color = "black", alpha = 1, hjust = 0, vjust = -0.5, angle = -90) + 
  scale_fill_manual(drop = F, breaks = c("Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", 
                               "Coal CCS", "Coal", "Other"),
                    values = c(sp[["Solar"]], sp[["Wind"]], sp[["Storage"]], sp[["Nuclear"]], sp[["Hydro"]],
                               sp[["Gas CCS"]], sp[["Gas"]], sp[["Coal CCS"]], sp[["Coal"]], sp[["Other"]])) +
  scale_color_manual(drop = F, breaks = c("Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", 
                               "Coal CCS", "Coal", "Other"),
                    values = c(sp[["Solar"]], sp[["Wind"]], sp[["Storage"]], sp[["Nuclear"]], sp[["Hydro"]],
                               sp[["Gas CCS"]], sp[["Gas"]], sp[["Coal CCS"]], sp[["Coal"]], sp[["Other"]])) +
  scale_y_continuous(limits = c(ymin, ymax)) +
  scale_alpha_manual(values = c(0.6,1), breaks = c("Capacity Retirements", "Capacity Additions"), guide = F) +
  ggtitle("Avg. Annual Capacity Changes (2021-35)") +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5, size = 10),
        axis.text.x = element_text(angle = 90, hjust = 1, size = 6), axis.ticks = element_blank(),
        axis.text.y = element_blank(), axis.title.y = element_blank(), axis.title.x = element_blank())

fig2

combined = 
  #fig + dotplot2 + 
  (fig + fig2) +
  plot_annotation(theme = theme(legend.position = "bottom", 
                                plot.title = element_text(hjust = 0.5))) +
  plot_layout(widths = c(3,2), guides = "collect") +
  theme(plot.margin = margin(0,0,0,0))
combined

savefig(combined, fig_no)

print(stats)

dta3 = clean_supplemental_data(dta3, fig_no)
dta5 = clean_supplemental_data(dta5, fig_no)

savedata(dta3, paste0(fig_no,"hist"))
savedata(dta5, paste0(fig_no, "proj"))
```

## F2.6 sensitivity of electric sector emissions

```{r}
fig_no = 2.6
# stagger by model
# remove gray dot
# shorten labels

# electric sector emissions sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High")
panel2_scens = c("Low Growth", "High Growth", "IRA") # Economic Growth
panel3_scens = c("Low Energy Price","High Energy Price", "Core", "IRA") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Constrained Deployment", "Core", "IRA") # Technology Cost and deployment constraints
panel5_scens = c("Pess-IRA.Adv", "Opt-IRA.Adv", "Core", "IRA") # Combos

sens_dta = clean_data %>% filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
                                 year %in% c(2030, 2035)) #%>% 
#  mutate(year = factor(year))

print(max(sens_dta$value))
print(min(sens_dta$value))

filler = data.frame(year = c(2035), value = c(-200), scenario = c(""), model = c("NA"))

sens_dta_panel1 = sens_dta %>% filter(scenario %in% panel1_scens) %>%
  filter(model %in% c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI",
                      "USREP-ReEDS", "ReEDS-NREL")) %>%
  filter(!(model == "ReEDS-NREL" & datasrc == "bistline_ira_tall.csv")) %>%
  mutate(scenario = case_when(scenario == "Core" ~ "IRA", TRUE ~ scenario)) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_panel2 = sens_dta %>% filter(scenario %in% panel2_scens) %>% 
  filter(model == "GCAM-PNNL") %>% 
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Growth" ~ "High",
    scenario == "Low Growth" ~ "Low",
    TRUE ~ scenario
  ))
  bind_rows(filler)

sens_dta_panel3 = sens_dta %>% filter(scenario %in% panel3_scens) %>%
  filter(model %in% c("ReEDS-NREL", "GCAM-PNNL")) %>% 
  filter(datasrc != "bistline_ira_tall.csv") %>%
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Energy Price" ~ "High",
    scenario == "Low Energy Price" ~ "Low",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "ReEDS-NREL" ~ paste0("R.",scenario),
  #                          model == "GCAM-PNNL" ~ paste0("GP.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "ReEDS-NREL" ~ 0.4,
                             model == "GCAM-PNNL" ~ -0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)

sens_dta_panel4 = sens_dta %>% filter(scenario %in% panel4_scens) %>% 
  filter(model %in% c("ReEDS-NREL", "USREP-ReEDS")) %>% 
  filter(datasrc != "bistline_ira_tall.csv") %>%
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Constrained Deployment" ~ "Constr",
    scenario == "All Advanced" ~ "All-Adv",
    scenario == "Adv Battery/Renew" ~ "Adv Renew",
    scenario == "Cons Battery/Renew" ~ "Cons Renew",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "ReEDS-NREL" ~ paste0("R.",scenario),
  #                             model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                             TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "ReEDS-NREL" ~ -0.4,
                             model == "USREP-ReEDS" ~ +0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)
  
sens_dta_panel5 = sens_dta %>% filter(scenario %in% panel5_scens) %>%
  filter(model %in% c("USREP-ReEDS","NEMS-OP")) %>% 
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Pess-IRA.Adv" ~ "Pess-Adv",
    scenario == "Opt-IRA.Adv" ~ "Opt-Adv",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                          model == "NEMS-OP" ~ paste0("ON.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "NEMS-OP" ~ -0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)

p1 = sens_dot_plot(sens_dta_panel1, title = "\nIRA Implementation", 
                   figmap_leep_timeseries, config, 
                   ymin = 0, ymax = 1600, far_left = TRUE, 
                   ira_coord = c(2030.1,965), low_coord = c(2028.7, 1190), 
                   high_coord = c(2030, 190))
# p1
p2 = sens_dot_plot(sens_dta_panel2, title = "\nEconomic Growth", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
#p2
p3 = sens_dot_plot(sens_dta_panel3, title = "\nEnergy Price", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p3
p4 = sens_dot_plot(sens_dta_panel4, title = "\nTechnology", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p4
p5 = sens_dot_plot(sens_dta_panel5, title = "Combined Technology\n + Implementation", 
                   figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p5

# annotations
# "EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI","USREP-ReEDS", "ReEDS-NREL"
p1$plot = p1$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "EPS-EI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1535, size = 3,
             label = "GCAM-CGS", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 1475, size = 3,
             label = "ReEDS-NREL", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1415, size = 3,
             label = "REGEN-EPRI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1355, size = 3,
             label = "RIO-REPEAT", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1295, size = 3,
             label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0)

p2$plot = p2$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0)

p3$plot = p3$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "GCAM-PNNL (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "ReEDS-NREL (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

p4$plot = p4$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "ReEDS-NREL (L)", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

p5$plot = p5$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "NEMS-OP (L)", color = "#A1A1A1", alpha = 1, hjust = 0) +
    annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

combined = (p1$plot | p4$plot | p5$plot | p2$plot | p3$plot ) +
  plot_annotation(title = "Electric Sector CO2 Emissions", 
                  theme = theme(plot.title = element_blank()))
  
combined

dta = bind_rows(sens_dta_panel1, sens_dta_panel2,
                sens_dta_panel3, sens_dta_panel4, sens_dta_panel5)

dta = dta %>% mutate(figure_num = fig_no) %>%
  select(-stagger, -datasrc)

saveall(combined, dta, fig_no)
```

### T2.1 Display Table

```{r}
metric = "absolute"
#metric = "percent"
#metric = "percent_2005"

historic_emissions = (clean_data %>%
  filter(model == "EPA-GHGI",
         scenario == "Historic",
         variable == "Emissions|CO2|Energy|Supply|Electricity",
         year == 2005))$value

panel1_summ = sens_dta_panel1 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "IRA.High" ~ "Optimistic",
                              scenario == "IRA.Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  panel1_summ = panel1_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  panel1_summ = panel1_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  panel1_summ = panel1_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

panel1_summ = panel1_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Optimistic" = "opt", "Pessimistic" = "pess"))

panel2_summ = sens_dta_panel2 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  panel2_summ = panel2_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  panel2_summ = panel2_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}else if (metric == "percent_2005") {
  panel2_summ = panel2_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

panel2_summ = panel2_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Growth" = "opt", "Low Growth" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel3_summ = sens_dta_panel3 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  panel3_summ = panel3_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  panel3_summ = panel3_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  panel3_summ = panel3_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

panel3_summ = panel3_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Price" = "opt", "Low Price" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel4_summ = sens_dta_panel4 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Adv Renew" ~ "Optimistic",
                              scenario == "Cons Renew" ~ "Pessimistic",
                              scenario == "Constr" ~ "Constr",
                              scenario == "All-Adv" ~ "AllAdv",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic),
         value_Constr = case_when(is.na(value_Constr) ~ value_Core
                                            , TRUE ~ value_Constr))

if (metric == "absolute") {
  panel4_summ = panel4_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core,
             diff_constr = value_Constr - value_Core,
             diff_alladv = value_AllAdv - value_Core)
} else if (metric == "percent") {
  panel4_summ = panel4_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core,
             diff_constr = (value_Constr - value_Core) / value_Core,
             diff_alladv = (value_AllAdv - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  panel4_summ = panel4_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions,
             diff_constr = (value_Constr - value_Core) / historic_emissions,
             diff_alladv = (value_AllAdv - value_Core) / historic_emissions)
}

panel4_summ = panel4_summ %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T),
            constr_median = median(diff_constr, na.rm = T),
            constr_min = min(diff_constr, na.rm = T),
            constr_max = max(diff_constr, na.rm = T),
            alladv_median = median(diff_alladv, na.rm = T),
            alladv_min = min(diff_alladv, na.rm = T),
            alladv_max = max(diff_alladv, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_","constr_","alladv_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value)  %>%
  mutate(opt = case_when((opt == Inf | opt == -Inf) ~ NA, TRUE ~ opt),
         pess = case_when((pess == Inf | pess == -Inf) ~ NA, TRUE ~ pess),
         constr = case_when((constr == Inf | constr == -Inf) ~ NA, TRUE ~ constr),
         alladv = case_when((alladv == Inf | alladv == -Inf) ~ NA, TRUE ~ alladv)) %>%
  rename(c("Adv Renew" = "opt", "Cons Renew" = "pess", "Constrained" = "constr",
           "All Adv" = "alladv")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel5_summ = sens_dta_panel5 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Opt-Adv" ~ "Optimistic",
                              scenario == "Pess-Adv" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic))

if (metric == "absolute") {
  panel5_summ = panel5_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  panel5_summ = panel5_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  panel5_summ = panel5_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

panel5_summ = panel5_summ %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Opt-Adv" = "opt", "Pess-Adv" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

all_panels = cbind(panel1_summ, panel4_summ, panel5_summ, panel2_summ, panel3_summ)
# all_panels %>% write.csv("./output/final_figures/data/Fig2.6_Summary.csv", row.names = FALSE)
# 
# all_panels = add_header_row(flextable(all_panels), values = c("", "IRA Implementation", "Technology", "Combined Technology + Implementation", "Economic Growth", "Energy Price"),
#   colwidths = c(4,2,4,2,2,2), top = TRUE)
# 
# all_panels = add_header_row(all_panels, values = c("","Difference from IRA Moderate Scenario (negative is reduced emissions)"), colwidths = c(4,12)) 
# 
# all_panels

#  pivot_longer(cols = starts_with("value_"), names_to = "year", names_prefix = "value_", values_to = "value") %>%

```

part 2
```{r}
fig_no = "2.6.1"

# all_panels is created in the previous code chunk
all_panels = cbind(panel1_summ, panel4_summ, panel5_summ, panel2_summ, panel3_summ)
all_panels = all_panels %>% 
  mutate(metric = case_when(
    metric == "min" ~ "Min",
    metric == "max" ~ "Max",
    metric == "median" ~ "Median"
  )) %>%
  mutate(metric = factor(metric, levels = c("Min", "Median", "Max"))) %>%
  rename("Year" = "year", "Metric" = "metric") %>%
  arrange(Year, Metric)

all_panels = all_panels %>% data.frame() %>% select(-c(variable, unit))
#all_panels$Pess.Adv[1] = ""
all_panels$Year[1] = ""
all_panels$Year[3] = ""
all_panels$Year[4] = ""
all_panels$Year[6] = ""
all_panels

#gt(rowname_col = "year") %>%

all_panels_gt = all_panels %>% gt() %>% 
  tab_header(
    title = gt::html("Electric Sector CO<sub>2</sub> Emissions (Mt CO<sub>2</sub>/yr)")
  ) %>%
  tab_spanner(label = gt::html("IRA <br> Implementation"), columns = c(Optimistic, Pessimistic)) %>%
  tab_spanner(label = gt::html("<br>Technology"), columns = c(All.Adv, Constrained, Adv.Renew, Cons.Renew)) %>%
  tab_spanner(label = gt::html("Implementation <br> + Tech"), columns = c(Opt.Adv, Pess.Adv)) %>%
  tab_spanner(label = gt::html("Economic <br> Growth"), columns = c(High.Growth, Low.Growth)) %>%
  tab_spanner(label = gt::html("Energy <br> Prices"), columns = c(High.Price, Low.Price)) %>%
  cols_label(All.Adv = gt::html("All<br>Advanced"),
             Constrained = "Constrained",
             Cons.Renew = gt::html("Conservative<br>Renewables"),
             Adv.Renew = gt::html("Advanced<br>Renewables"),
             Opt.Adv = gt::html("Optimistic<br>+ Advanced"),
             Pess.Adv = gt::html("Pessimistic<br>+ Advanced"),
             High.Growth = "High",
             Low.Growth = "Low",
             High.Price = "High",
             Low.Price = "Low"
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "all", color = "#F2F2F2"),
      cell_fill(color = "#F2F2F2", alpha = NULL)
    ), locations = cells_body()
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "bottom", color = "#DCDCDC", weight = "2px")
    ), 
    locations = cells_body(rows = c(3))
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "normal", align = "center")
    ), locations = cells_column_labels()
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ), locations = cells_column_spanners()
  ) %>% tab_style(
    style = list(
      cell_text(weight = "bold", align = "right")
    ), locations = cells_body(columns = 1:2)
  ) %>% tab_style(
    style = list(
      cell_text(align = "center")
    ), locations = cells_body(columns = 3:14)
  ) %>% sub_missing(columns = 3:14, missing_text = "-")

if (metric == "percent" | metric == "percent_2005") {
  all_panels_gt = all_panels_gt %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:14)
} else if (metric == "absolute") {
  all_panels_gt = all_panels_gt %>% fmt_number(decimals = 1, use_seps = TRUE, columns = 3:14)
}

#%>% opt_stylize(style = 6, color = "blue")
  
  #tab_row_group(label = "2030", rows = 1:3) %>%
  #tab_row_group(label = "2035", rows = 4:6)

all_panels_gt

all_panels_gt %>% 
  gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".html"))

all_panels_gt %>% 
  gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".png"),
         vheight = 1000, vwidth = 1500)


```

## F2.7 nox and so2 emissions

```{r}
fig_no= 2.7

# nox
clean_data_nox = spg_clean(ts_map_ID = 122, drop = c("ReEDS-NREL"), histsrc = "EPA", 
                           config = config, clean_data = clean_data, figmap_leep_timeseries = figmap_leep_timeseries)
output = spg2(df = clean_data_nox, title = "", yname = expression(paste("Emissions (Mt N",O[x],"/yr)")),
              gd = "none", ymin = 0, ymax = 5, 
              ybreaks = waiver(), yax_format = waiver(), annotate = 1, 
              historic_coord = c(2016,1.8), preira_coord = c(2030, 0.95), ira_coord = c(2029, 0.15), 
              config = config, figmap_leep_timeseries = figmap_leep_timeseries)
figure = output$figure
nox_data = output$data
nox_full = dotted(clean_data_nox, figure, "median", ymin = 0, ymax = 5, 
                config = config, figmap_leep_timeseries = figmap_leep_timeseries)

#so2
clean_data_sox = spg_clean(ts_map_ID = 123, drop = c("ReEDS-NREL"), histsrc = "EPA", 
                           config = config, clean_data = clean_data, figmap_leep_timeseries = figmap_leep_timeseries)
output = spg2(df = clean_data_sox, title = "", yname = expression(paste("Emissions (Mt S", O[x], "/yr)")), 
                                                                        gd = "none", ymin = 0, ymax = 5, 
              ybreaks = waiver(), yax_format = waiver(), annotate = 1, 
              historic_coord = c(2020,2), preira_coord = c(2030, 1.2), ira_coord = c(2029, 0.12), 
              config = config, figmap_leep_timeseries = figmap_leep_timeseries)
figure = output$figure
sox_data = output$data
sox_full = dotted(clean_data_sox, figure, "median", ymin = 0, ymax = 5, 
                config = config, figmap_leep_timeseries = figmap_leep_timeseries)

# combined
left = nox_full + theme(plot.margin = margin(0,0,0,0))
right = sox_full + theme(plot.margin = margin(0,0,0,0))

combined = (wrap_elements(left) | wrap_elements(right)) +     
    plot_annotation(title = "NOx                                                                                     SO2", 
                  theme = theme(plot.title = element_text(hjust = 0.5, size = 10))) +
  theme(plot.margin = margin(0,0,0,0))
combined

full_data = rbind(nox_data,sox_data) %>%
  select(model,scenario,unit,region,variable_rename,year,value)

saveall(combined, full_data, fig_no)
```
