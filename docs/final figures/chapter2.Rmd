---
title: "Chapter 2: Electricity"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## 2.1 co2 emissions from the power sector in the us, compared to economy-wide co2 emissions

```{r}
fig_no = 2.1

data <- clean_data %>%
  filter(model == "EPA-GHGI") %>%
  filter(year >= 2005) %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Coal"|
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Oil" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Coal" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Gas" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Oil") %>%
  mutate(variable_rename = case_when(
    grepl("Demand", variable) ~ "Other Sectors",
    grepl("Coal", variable) ~ "Coal", 
    grepl("Gas", variable) ~ "Gas", 
    grepl("Oil", variable) ~ "Petroleum",
  )) %>%
  group_by(year, variable_rename) %>%
  summarise(value = sum(value)) %>%
  mutate(alpha = case_when(
    variable_rename == "Other Sectors" ~ 0.5, 
    T ~ 1))

data$variable_rename <- factor(data$variable_rename, level = c("Other Sectors", "Coal", "Gas", "Petroleum"))

fig = ggplot(data, aes(fill = variable_rename, y = value, alpha = alpha, x = year, color = variable_rename)) + 
  geom_bar(position = "stack", stat = "identity") + 
  theme_emf() +
  labs(title = "",
         x = "",
         y = expression(paste("Emissions (Mt C", O[2], "/yr)"))) +
    scale_y_continuous(limits = c(0, 6000), labels = scales::comma) +
    scale_x_continuous(breaks = c(2005, 2021)) + 
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") +
    scale_alpha(range = c(0.6, 1), guide = F)+
  scale_color_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "#DEDEDE")) +
  scale_fill_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "#DEDEDE")) 
fig

saveall(fig, data, fig_no)
```

## 2.2 us electricity generation and capacity shares by fuel type, 2021

```{r}
fig_no = 2.2

clean_data10 = clean_data %>% 
  filter(datasrc == 'EIA-EPA-bistline_historic.csv') %>%
  mutate(value = case_when(unit == "Quads" ~ value * 293.07, TRUE ~ value),
         unit = case_when(unit == "Quads" ~ "TWh", TRUE ~ unit))


fig = print_graph("stacked_bar", config, clean_data10, figmap_leep_stackbar, 14, "United States", 
                  level_var = c("Other", "Renewables", "Nuclear", "Oil", "Natural Gas", "Coal")) +
  labs(y = "Seconary Energy (TWh)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), plot.title = element_blank()) +
  bottom1
fig

df = data_from_graph("stacked_bar", config, clean_data10, figmap_leep_stackbar, 14, "United States")

df = clean_supplemental_data(df, fig_no)

saveall(fig, df, fig_no)
```

## 2.3 us power sector co2 emissions

```{r}
fig_no = 2.3

ElecSpg = spg(
  98,
  "EPA-GHGI",
  "",
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  c("Scout-LEEP"),
  0,
  2500,
  c(0, 500, 1000, 1500, 2000, 2500),
  scales::comma) +
  annotate("text", x = 2015, y = 2250, label = "Historical", color = "black") + 
  annotate("text", x = 2027.5, y = 1750, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2023, y = 650, label = "IRA", color = "#0388B3")

ElecDot = dotted(ElecSpg$data, ElecSpg, "median", 0, 2500)
ElecDot

ElecTab = html(ElecSpg$data, "Electricity CO<sub>2<sub>")
ElecTab

ElecSpg$data = clean_supplemental_data(ElecSpg$data, fig_no)

savedata(ElecSpg$data, fig_no)
savefig(ElecDot, fig_no)
```

## 2.4 us power sector generation from high and low/zero emitting generation

```{r}
fig_no = 2.4

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

ymin = 0
ymax = 2600
metric = "median"

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

low <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

high <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

individual <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

##### All Total #####
df_21 = total %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = total %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = total %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

data_total <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

dots_Total = ggplot(data = data_total, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Total Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

savedata(data_total, paste(fig_no, "Total"))

##### Low Total #####

df_21 = low %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))

df_30 = low %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  
df_35 = low %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  
mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

data_Low <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Low = ggplot(data = data_Low, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Low or Zero Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Low, paste(fig_no, "Low"))

##### High Total #####
df_21 = high %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = high %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))

df_35 = high %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

data_High <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_High = ggplot(data = data_High, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"High Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_High, paste(fig_no, "High"))

##### Nuclear #####
df_21 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Nuclear <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Nuclear = ggplot(data = data_Nuclear, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Nuclear") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Nuclear, paste(fig_no, "Nuclear"))

##### Solar #####
df_21 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Solar <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Solar = ggplot(data = data_Solar, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Solar") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Solar, paste(fig_no, "Solar"))

##### Wind #####

df_21 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Wind <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Wind = ggplot(data = data_Wind, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Wind") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Wind, paste(fig_no, "Wind"))

##### CCS #####

df_21 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_CCS <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_CCS = ggplot(data = data_CCS, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"CCS") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_CCS, paste(fig_no, "CCS"))

##### Coal #####
df_21 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Coal <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Coal = ggplot(data = data_Coal, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Coal") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Coal, paste(fig_no, "Coal"))

##### Gas #####
df_21 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Gas <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Gas = ggplot(data = data_Gas, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Natural Gas") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Gas, paste(fig_no, "Gas"))

##### Other #####
df_21 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Other <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Other = ggplot(data = data_Other, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Other") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Other, paste(fig_no, "Other"))

##### Final #####
final = (dots_Total | dots_Low | dots_High) / (dots_Wind | dots_Solar | dots_Nuclear | dots_CCS) / (dots_Coal | dots_Gas | dots_Other) 

final = final + 
  plot_layout(
  guides = "collect"
) & theme(legend.position = "bottom")
final

savefig(final, fig_no)
```

### Table 2.4 Total

```{r}

title = "Total Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)


IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)


IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Low

```{r}

title = "Low Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 High

```{r}

title = "High Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Wind

```{r}

title = "Wind Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Wind")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Solar

```{r}

title = "Solar Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Solar")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Nuclear

```{r}

title = "Nuclear Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Nuclear")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 CCS

```{r}

title = "CCS Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "CCS")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Coal

```{r}

title = "Coal Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Coal")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Gas

```{r}

title = "Nautural Gas Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Natural Gas")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Other

```{r}

title = "Other Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Other")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

## 2.5 historical and projected capacity additions by technology

```{r}
fig_no = 2.5

# capacity addition plot

ymin = -40
ymax = 130

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

fig = print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States") +
  geom_hline(yintercept = 0, linewidth = 0.25, color = "black") +
  labs(y = "Capacity Change (GW/yr)") +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  scale_y_continuous(limits = c(ymin, ymax)) +
  ggtitle("Historical Annual Capacity Changes") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size = 10),
        axis.text.x = element_text(angle = 45))

dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 4, "United States")

#fig

dta4 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 6, "United States")
dta_ttl = dta4 %>% 
  mutate(temp = case_when(
    grepl("Additions",variable) ~ "Capacity Additions",
    TRUE ~ "Capacity Retirements")) %>%
  group_by(model, scenario, region, datasrc, unit, temp) %>%
  summarize(value = sum(value)) %>% 
  select(-temp) %>%
  mutate(variable_rename = "Total")

dta4 = rbind(dta4,dta_ttl) %>% mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal"))) %>%
  mutate(stagger = case_when((variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value >= 0)) ~ -0.1,
                             (variable_rename %in% c("Coal", "Nuclear", "Gas", "Total") & (value < 0)) ~ 0.1,
                             TRUE ~ 0))

stats = dta4 %>% group_by(variable_rename, stagger) %>% summarize(mean = mean(value), median = median(value))

dotplot2 = dta4 %>% ggplot() + 
  geom_point(aes(x = (as.numeric(variable_rename) + stagger), y = value, color = variable_rename), shape = 16, size = 2) + 
  #geom_point(data = stats, aes(x = variable_rename, y = median, color = variable_rename), shape = 3, size = 2) +
  geom_segment(data = stats, aes(x = as.numeric(variable_rename) - 0.25 + stagger, xend = as.numeric(variable_rename) + 0.25 + stagger, 
                                 y = median, yend = median, color = variable_rename), linewidth = 0.5) +
  geom_hline(yintercept = 0, linewidth = 0.25, color = "black") +
  scale_x_continuous(breaks = seq(1,10), labels = c("Total", "Solar", "Wind", "Storage", "Nuclear", "Hydro", "Gas CCS", "Gas", "Coal CCS", "Coal")) +
  scale_y_continuous(limits = c(ymin, ymax)) +
  scale_subpalette(subpalettes, "Capacity Additions2") +
  ggtitle("Average Annual Capacity Changes (2021-2035)") +
  theme_emf() +
  theme(plot.title = element_text(hjust = 0.5, size = 10), axis.text.y = element_blank(),
        axis.title.y = element_blank(), axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
#dotplot2
  

combined = 
  fig + dotplot2 + 
  plot_annotation(theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(widths = c(1,1)) +
    theme(plot.margin = margin(0,0,0,0))
    # bottom1
combined

savefig(combined, fig_no)

print(stats)

dta = clean_supplemental_data(dta, fig_no)
dta4 = clean_supplemental_data(dta4, fig_no)

savedata(dta, paste0(fig_no,"bars"))
savedata(dta4, paste0(fig_no, "dots"))
```

## 2.6 sensitivity of electric sector emissions

```{r}
fig_no = 2.6
# stagger by model
# remove gray dot
# shorten labels

# electric sector emissions sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High")
panel2_scens = c("Low Growth", "High Growth", "IRA") # Economic Growth
panel3_scens = c("Low Energy Price","High Energy Price", "Core", "IRA") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Constrained Deployment", "Core", "IRA") # Technology Cost and deployment constraints
panel5_scens = c("Pess-IRA.Adv", "Opt-IRA.Adv", "Core", "IRA") # Combos

sens_dta = clean_data %>% filter(variable == "Emissions|CO2|Energy|Supply|Electricity",
                                 year %in% c(2030, 2035)) #%>% 
#  mutate(year = factor(year))

print(max(sens_dta$value))
print(min(sens_dta$value))

filler = data.frame(year = c(2035), value = c(-200), scenario = c(""), model = c("NA"))

sens_dta_panel1 = sens_dta %>% filter(scenario %in% panel1_scens) %>%
  filter(model %in% c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI",
                      "USREP-ReEDS", "ReEDS-NREL")) %>%
  filter(!(model == "ReEDS-NREL" & datasrc == "bistline_ira_tall.csv")) %>%
  mutate(scenario = case_when(scenario == "Core" ~ "IRA", TRUE ~ scenario)) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_panel2 = sens_dta %>% filter(scenario %in% panel2_scens) %>% 
  filter(model == "GCAM-PNNL") %>% 
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Growth" ~ "High",
    scenario == "Low Growth" ~ "Low",
    TRUE ~ scenario
  ))
  bind_rows(filler)

sens_dta_panel3 = sens_dta %>% filter(scenario %in% panel3_scens) %>%
  filter(model %in% c("ReEDS-NREL", "GCAM-PNNL")) %>% 
  filter(datasrc != "bistline_ira_tall.csv") %>%
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Energy Price" ~ "High",
    scenario == "Low Energy Price" ~ "Low",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "ReEDS-NREL" ~ paste0("R.",scenario),
  #                          model == "GCAM-PNNL" ~ paste0("GP.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "ReEDS-NREL" ~ 0.4,
                             model == "GCAM-PNNL" ~ -0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)

sens_dta_panel4 = sens_dta %>% filter(scenario %in% panel4_scens) %>% 
  filter(model %in% c("ReEDS-NREL", "USREP-ReEDS")) %>% 
  filter(datasrc != "bistline_ira_tall.csv") %>%
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Constrained Deployment" ~ "Constr",
    scenario == "All Advanced" ~ "All-Adv",
    scenario == "Adv Battery/Renew" ~ "Adv Renew",
    scenario == "Cons Battery/Renew" ~ "Cons Renew",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "ReEDS-NREL" ~ paste0("R.",scenario),
  #                             model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                             TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "ReEDS-NREL" ~ -0.4,
                             model == "USREP-ReEDS" ~ +0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)
  
sens_dta_panel5 = sens_dta %>% filter(scenario %in% panel5_scens) %>%
  filter(model %in% c("USREP-ReEDS","OP-NEMS")) %>% 
  mutate(scenario = case_when((scenario == "IRA" | scenario == "Core") ~ "Mod", 
                              TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Pess-IRA.Adv" ~ "Pess-Adv",
    scenario == "Opt-IRA.Adv" ~ "Opt-Adv",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                          model == "OP-NEMS" ~ paste0("ON.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "OP-NEMS" ~ -0.4,
                             TRUE ~ 0.0))
  bind_rows(filler)

p1 = sens_dot_plot(sens_dta_panel1, title = "\nIRA Implementation", 
                   figmap_leep_timeseries, config, 
                   ymin = 0, ymax = 1600, far_left = TRUE, 
                   ira_coord = c(2030.1,965), low_coord = c(2028.7, 1190), 
                   high_coord = c(2030, 190))
# p1
p2 = sens_dot_plot(sens_dta_panel2, title = "\nEconomic Growth", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
#p2
p3 = sens_dot_plot(sens_dta_panel3, title = "\nEnergy Price", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p3
p4 = sens_dot_plot(sens_dta_panel4, title = "\nTechnology", figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p4
p5 = sens_dot_plot(sens_dta_panel5, title = "Combined Technology\n + Implementation", 
                   figmap_leep_timeseries, config, ymin = 0, ymax = 1600,)
# p5

# annotations
# "EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI","USREP-ReEDS", "ReEDS-NREL"
p1$plot = p1$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "EPS-EI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1535, size = 3,
             label = "GCAM-CGS", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 1475, size = 3,
             label = "ReEDS-NREL", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1415, size = 3,
             label = "REGEN-EPRI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1355, size = 3,
             label = "RIO-REPEAT", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1295, size = 3,
             label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0)

p2$plot = p2$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0)

p3$plot = p3$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "GCAM-PNNL (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "ReEDS-NREL (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

p4$plot = p4$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "ReEDS-NREL (L)", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

p5$plot = p5$plot + 
  annotate("text", x = 2028.4, y = 1595, size = 3,
               label = "OP-NEMS (L)", color = "#A1A1A1", alpha = 1, hjust = 0) +
    annotate("text", x = 2028.4, y = 1535, size = 3,
               label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0)

combined = (p1$plot | p4$plot | p5$plot | p2$plot | p3$plot ) +
  plot_annotation(title = "Electric Sector CO2 Emissions", 
                  theme = theme(plot.title = element_blank()))
  
combined

dta = bind_rows(sens_dta_panel1, sens_dta_panel2,
                sens_dta_panel3, sens_dta_panel4, sens_dta_panel5)

dta = dta %>% mutate(figure_num = fig_no) %>%
  select(-stagger, -datasrc)

saveall(combined, dta, fig_no)
```


### table for Figure 2.6
```{r}
panel1_summ = sens_dta_panel1 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "IRA.High" ~ "Optimistic",
                              scenario == "IRA.Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Optimistic" = "opt", "Pessimistic" = "pess"))

panel2_summ = sens_dta_panel2 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Growth" = "opt", "Low Growth" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel3_summ = sens_dta_panel3 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Price" = "opt", "Low Price" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel4_summ = sens_dta_panel4 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Adv Renew" ~ "Optimistic",
                              scenario == "Cons Renew" ~ "Pessimistic",
                              scenario == "Constr" ~ "Constr",
                              scenario == "All-Adv" ~ "AllAdv",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic),
         value_Constr = case_when(is.na(value_Constr) ~ value_Core
                                            , TRUE ~ value_Constr)) %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core,
         diff_constr = value_Constr - value_Core,
         diff_alladv = value_AllAdv - value_Core) %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T),
            constr_median = median(diff_constr, na.rm = T),
            constr_min = min(diff_constr, na.rm = T),
            constr_max = max(diff_constr, na.rm = T),
            alladv_median = median(diff_alladv, na.rm = T),
            alladv_min = min(diff_alladv, na.rm = T),
            alladv_max = max(diff_alladv, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_","constr_","alladv_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value)  %>%
  mutate(opt = case_when((opt == Inf | opt == -Inf) ~ NA, TRUE ~ opt),
         pess = case_when((pess == Inf | pess == -Inf) ~ NA, TRUE ~ pess),
         constr = case_when((constr == Inf | constr == -Inf) ~ NA, TRUE ~ constr),
         alladv = case_when((alladv == Inf | alladv == -Inf) ~ NA, TRUE ~ alladv)) %>%
  rename(c("Adv Renew" = "opt", "Cons Renew" = "pess", "Constrained" = "constr",
           "All Adv" = "alladv")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

panel5_summ = sens_dta_panel5 %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Opt-Adv" ~ "Optimistic",
                              scenario == "Pess-Adv" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic)) %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Opt-Adv" = "opt", "Pess-Adv" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

all_panels = cbind(panel1_summ, panel4_summ, panel5_summ, panel2_summ, panel3_summ)
all_panels %>% write.csv("./output/final_figures/data/Fig2.6_Summary.csv", row.names = FALSE)

all_panels = add_header_row(flextable(all_panels), values = c("", "IRA Implementation", "Technology", "Combined Technology + Implementation", "Economic Growth", "Energy Price"),
  colwidths = c(4,2,4,2,2,2), top = TRUE)

all_panels = add_header_row(all_panels, values = c("","Difference from IRA Moderate Scenario (negative is reduced emissions)"), colwidths = c(4,12)) 

all_panels

#  pivot_longer(cols = starts_with("value_"), names_to = "year", names_prefix = "value_", values_to = "value") %>%

```

## 2.7a nox emissions

```{r}
fig_no = "2.7a"

clean_data7 = clean_data %>% duplicate_historical_data("EPA",2021, criteria = TRUE) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1,
    model == "GCAM-PNNL" ~ 1,
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    TRUE ~ 0.8)
  ) %>%
  filter(value > 1e-4)

nox = print_graph("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States") +
  scale_alpha(range = c(0.6, 1), guide = "none")
#nox

nox_full = dot_plots("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States", 0, 5, 
                     "Power Sector NOx Emissions", metric = "median", 
                     historic_coord = c(2015,1.8), preira_coord = c(2030, 0.95), ira_coord = c(2029, 0.15), ylab = "Emissions (Mt NOx/yr)")
print(nox_full$full)
print(nox_full$stats)

dta1 = data_from_graph("time_series", config, clean_data7, figmap_leep_timeseries, 122, "United States")
dta1 = clean_supplemental_data(dta1, fig_no)
```

## 2.7b so2 emissions

```{r}
fig_no = "2.7b"

sox = print_graph("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States") +
  scale_alpha(range = c(0.6, 1), guide = "none")
#sox

sox_full = dot_plots("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States", 0, 5, "Power Sector SO2 Emissions", metric = "median", 
                     historic_coord = c(2019,2), preira_coord = c(2030, 1.2), ira_coord = c(2029, 0.12), ylab = "Emissions (Mt SOx/yr)")
print(sox_full$full)
print(sox_full$stats)

dta2 = data_from_graph("time_series", config, clean_data7, figmap_leep_timeseries, 123, "United States")
dta2 = clean_supplemental_data(dta2, fig_no)
```

## 2.7 nox and sox in one figure
```{r}
fig_no= 2.7
left = nox_full$full + theme(plot.margin = margin(0,0,0,0))
right = sox_full$full + theme(plot.margin = margin(0,0,0,0))

combined = (wrap_elements(left) | wrap_elements(right)) +     
    plot_annotation(title = "NOx                                                                                     SO2", 
                  theme = theme(plot.title = element_text(hjust = 0.5, size = 10))) +
  theme(plot.margin = margin(0,0,0,0))
combined

dta3 = rbind(dta1,dta2)

saveall(combined, dta3, fig_no)
```
