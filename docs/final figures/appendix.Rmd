---
title: "Appendix"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(figmap_leep_diffbar)
targets::tar_load(data_raw)
targets::tar_load(data_min)

# palettes
subpalettes = create_subpalettes(figmap_leep_timeseries, config)
```

# Appendix A

## Emissions Summary Tables

```{r}
tab_a1 = summary_tables(
  table_no = "A1 Economy-Wide Emissions",
  var = "Emissions|CO2",
  suffix = "Economy-wide emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)
tab_a1

tab_a2 = summary_tables(
  table_no = "A2 Power Sector Emissions",
  var = "Emissions|CO2|Energy|Supply|Electricity",
  suffix = "Power sector emissions",
  drop_mod = c("Scout-LEEP"),
  drop_datasrc = c("ReEDS_compiled.csv"), # remove duplicate values for ReEDS-NREL - basically same values
  data = clean_data,
  config = config
)

tab_a3 = summary_tables(
  table_no = "A3 Transportation Emissions",
  var = "Emissions|CO2|Energy|Demand|Transportation|Total",
  suffix = "Transportation emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)

tab_a4 = summary_tables(
  table_no = "A4 Buildings Emissions",
  var = "Emissions|CO2|Energy|Demand|Buildings|Total",
  suffix = "Buildings emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Haiku-RFF"),
  data = clean_data,
  config = config
)

tab_a5 = summary_tables(
  table_no = "A5 Industry Emissions",
  var = "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
  suffix = "Industry emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)
```

## Table ES1 - for lack of a better place to put it

```{r}
fig_no = "ES.1"

tab_es1_ew = summary_tables(
  table_no = "ES1 Economy-Wide Emissions",
  var = "Emissions|CO2",
  suffix = "Economy-wide emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  short_circuit = TRUE,
  data = clean_data,
  config = config
)

ew_ira = (tab_es1_ew$IRA) %>% 
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

ew_noira = (tab_es1_ew$noIRA) %>%
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

tab_es1_elec = summary_tables(
  table_no = "ES1 Power Sector Emissions",
  var = "Emissions|CO2|Energy|Supply|Electricity",
  suffix = "Power sector emissions",
  drop_mod = c("Scout-LEEP"),
  drop_datasrc = c("ReEDS_compiled.csv"), # remove duplicate values for ReEDS-NREL - basically same values
  short_circuit = TRUE,
  data = clean_data,
  config = config
)

elec_ira = (tab_es1_elec$IRA) %>% 
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

elec_noira = (tab_es1_elec$noIRA) %>%
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

es1_full = bind_cols(bind_rows(ew_noira, elec_noira), bind_rows(ew_ira, elec_ira), 
                     data.frame("sector" = c("a","a","b","b"))) %>%
  select(-year...5)
                       
                       
                       
  #                      expression(paste("Economy-Wide C", O[2], " from Energy Use")),
  #                                            expression(paste("Economy-Wide C", O[2], " from Energy Use")), 
  #                                            expression(paste("Power Sector C", O[2])), 
  #                                            expression(paste("Power Sector C", O[2]))))) %>%
  # select(-year...5)

colnames(es1_full) = c("Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r", "Sector")
es1_full = es1_full %>% group_by(Sector)

table_es1 = es1_full %>% gt() %>%
  tab_header(
    title = gt::html("Multi-model range of emission reductions<br>(% reduction from 2005)")
  ) %>%
  tab_spanner(label = "No IRA", columns = c(Min, Median, Max)) %>%
  tab_spanner(label = "IRA", columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
  cols_label() %>% 
  tab_row_group(label = gt::html("Economy-Wide CO<sub>2</sub> from Energy Use"),
                rows = 1:2, id = "ew") %>%
  tab_row_group(label = gt::html("Power Sector CO<sub>2</sub>"),
                rows = 3:4, id = "elec") %>%
  row_group_order(groups = c("ew","elec")) %>%
  tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(1,4))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold")
      ), locations = cells_body(columns = c(1))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "normal", color = "black", align = "left"),
        cell_fill(color = "#C9C9C9")
      ), locations = cells_row_groups()
    ) %>% fmt_number(decimals = 0, use_seps = TRUE, columns = 2:7)

table_es1

table_es1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table_es1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))


```

# Appendix D

## Emissions reudctions by end use type from scout modeling

```{r}
fig_no = "D.1"

data <- read.csv("./data-extra/scout_buildings_IRA_scenario_emissions_wedges.csv")

data_sort <- data %>%
  filter(year <= 2035) %>%
  filter(year >= 2025) %>%
  mutate(scenario = case_when(
    scenario == "IRA-Low" ~ "Low", 
    scenario == "IRA-Central" ~ "Central", 
    scenario == "IRA-High" ~ "High"
  )) %>%
  rename(Reference = `Reference.Building.Emissions`,
         Total = `Total.Building.Emissions`, 
         Power = `Power.Supply.Decarbonization`, 
         WaterHeating = `Water.Heating`, 
         HVAC = HVAC.Env) %>%
  pivot_longer(
    cols = c(Reference, Total, Power, Other, WaterHeating, HVAC), names_to = "variable_rename"
  )
  
ref <- data_sort[data_sort$variable_rename == "Reference",]

data_sort$scenario <- factor(data_sort$scenario, levels = c("Low", "Central", "High"))
data_sort$variable_rename <- factor(data_sort$variable_rename, levels = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"))

fin = ggplot(data = data_sort[data_sort$variable_rename != "Reference",] , aes(x=year, y=value, fill = variable_rename)) +
  geom_area() +
  facet_grid(~scenario) +
  labs(title = "",
         x = "",
         y = expression(paste("Emissions (Mt C", O[2], "/yr)")),
         color = "") +
    scale_y_continuous(limits = c(0, 1500), labels = scales::comma, expand = c(0,0)) +
    theme_emf() +
    scale_x_continuous(breaks = c(2025, 2030, 2035)) + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") + 
  guides(fill = guide_legend(nrow = 2)) + 
  scale_fill_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("HVAC", "WaterHeating", "Other", "Power", "Total") 
  ) + 
  geom_line(data = data_sort[data_sort$variable_rename == "Reference",],  aes(x=year, y=value, color = variable_rename),linetype="dashed") +
  scale_color_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","ower", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("Reference") 
  )
fin

data_sort = data_sort %>% mutate(figure_num = fig_no)

saveall(fin, data_sort, fig_no, wd = 9)
```

# Appendix F

## Emissions

### Economy-Wide

```{r}
fig_no = "F.1.EconWideEmis"

ts_map_ID = 99
pd_map_ID = 25
ad_map_ID = 3
drop = ""
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 2950
ymax = 5050
brk = c(3000, 4000, 5000)

fig = four_corners("Economy-wide CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Electricity

```{r}
fig_no = "F.2.ElecEmis"

ts_map_ID = 98
pd_map_ID = 26
ad_map_ID = 4
drop = ""
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 300
ymax = 1650
brk = c(400, 800, 1200, 1600)

fig = four_corners("Electricity CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Transportation

```{r}
fig_no = "F.3.TranEmis"

ts_map_ID = 19
pd_map_ID = 27
ad_map_ID = 5
drop = c("IPM-EPA","IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 1150
ymax = 1900
brk = c(1200, 1500, 1800)

fig = four_corners("Transportation CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Building

```{r}
fig_no = "F.4.BuilEmis"

ts_map_ID = 23
pd_map_ID = 29
ad_map_ID = 7
drop = c("IPM-EPA", "IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 400
ymax = 1800
brk = c(400, 800, 1200, 1600)

fig = four_corners("Buildings CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Industry

```{r}
fig_no = "F.5.IndEmis"

ts_map_ID = 21
pd_map_ID = 28
ad_map_ID = 6
drop = c("IPM-EPA", "IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 500
ymax = 1600
brk = c(500, 1000, 1500)

fig = four_corners("Industry CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)

```

## Primary Energy

### Coal

```{r}
fig_no = "F.6.Coal"

ts_map_ID = 94
pd_map_ID = 32
ad_map_ID = 20
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 0
ymax = 20
brk = c(0, 5, 10, 15, 20)

fig = four_corners("Emissions from Coal",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Gas

```{r}
fig_no = "F.7.Gas"

ts_map_ID = 93
pd_map_ID = 31
ad_map_ID = 21
drop = c("EIAinEMF37.csv", "RIO-REPEAT")
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 20
ymax = 35
brk = c(20, 25, 30, 35)

fig = four_corners("Emissions from Gas",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Petroleum

```{r}
fig_no = "F.8.Petrol"

ts_map_ID = 92
pd_map_ID = 30
ad_map_ID = 22
drop = "EIAinEMF37.csv"
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 20
ymax = 40
brk = c(20, 30, 40)

fig = four_corners("Emissions from Petroleum", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

## Generation

### Nuclear

```{r}
fig_no = "F.9.NuclearGen"

ts_map_ID = 91
pd_map_ID = 80
ad_map_ID = 8
drop = "EIAinEMF37.csv"
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 850
brk = c(0, 200, 400, 600, 800)

fig = four_corners("Electricity Generation from Nuclear", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Solar

```{r}
fig_no = "F.10.SolarGen"

ts_map_ID = 90
pd_map_ID = 79
ad_map_ID = 9
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 100
ymax = 2200
brk = c(500, 1000, 1500, 2000)

fig = four_corners("Electricity Generation from Solar", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Wind

```{r}
fig_no = "F.11.WindGen"

ts_map_ID = 89
pd_map_ID = 78
ad_map_ID = 10
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 350
ymax = 2600
brk = c(500, 1000, 1500, 2000, 2500)

fig = four_corners("Electricity Generation from Wind", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### CCS

```{r}
fig_no = "F.12.CCSGen"

#there is no historic data here so gotta do a lil manual work
ts_map_ID = 85
pd_map_ID = 76
ad_map_ID = 14
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
unit = "Generation (Quads)"
ymin = 0
ymax = 5
brk = c(0, 1, 2, 3, 4, 5)

#Time Series Dataframe
ts_df = data_from_graph(
  "time_series",
  config,
  clean_data,
  figmap_leep_timeseries,
  ts_map_ID,
  "United States"
) %>%
  filter(!model %in% drop) %>%
  filter(!datasrc %in% drop) %>%
  filter(year >= 2021) %>%
  filter(year <= 2021 &
           model == histsrc |
           year > 2021 & scenario != "Historic") %>%
  group_by(model, scenario, year, variable_rename) %>%
  summarize(value = sum(value)) %>%
  pivot_wider(names_from = year, values_from = value)

ts_df = ts_df %>%
  mutate(`2021` = 0) %>%
  pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))

noIRAmedians = ts_df[ts_df$scenario == "No IRA", ] %>%
  filter(year == 2030 | year == 2035) %>%
  group_by(year) %>%
  summarize(median = median(value))

IRAmedians = ts_df[ts_df$scenario == "IRA", ] %>%
  filter(year == 2030 | year == 2035) %>%
  group_by(year) %>%
  summarize(median = median(value))

NoIRAfigure = ggplot(ts_df[ts_df$scenario == "No IRA",], aes(year, value, color = model)) +
  geom_line(size = 0.75) +
  scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
  theme_emf() +
  scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
  labs(title = "No IRA",
       y = unit,
       x = element_blank()) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_point(aes(x = 2021, y = ts_df$value[ts_df$year == 2021][1]), color = "black") +
  geom_point(
    data = noIRAmedians,
    aes(x = year, y = median),
    color = "black",
    shape = 16,
    size = 2
  )

IRAfigure = ggplot(ts_df[ts_df$scenario == "IRA",], aes(year, value, color = model)) +
  geom_line(size = 0.75) +
  scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
  theme_emf() +
  scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
  labs(title = "IRA",
       y = unit,
       x = element_blank()) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_point(aes(x = 2021, y = ts_df$value[ts_df$year == 2021][1]), color = "black") +
  geom_point(
    data = IRAmedians,
    aes(x = year, y = median),
    color = "black",
    shape = 16,
    size = 2
  )

#Percent Difference

pdfigure = pd(pd_map_ID, "", expression(paste("Percent Difference (%)")), "none", drop)

#Absolute Difference
adfigure = ad(diff_ID = ad_map_ID, "", expression(paste("Absolute Difference (Quads)")), "none", drop)

fig = (NoIRAfigure |
         IRAfigure) / (adfigure$figure | pdfigure$figure) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Electricity Generation from Coal with CCS")

fig

# TODO: This entire figure is broken and saves off data that doesnt exist. I fixed the figure, but the whole thing should be rewritten to fit the format of the rest of the figures and actually output the correct data

write.csv(
  fig$ts_df,
  file = paste("output/final_figures/data/Fig", fig_no, "a_Scen.csv", sep =
                 ""),
  row.names = FALSE
)
write.csv(
  fig$pd_df,
  file = paste(
    "output/final_figures/data/Fig",
    fig_no,
    "b_PercDiff.csv",
    sep = ""
  ),
  row.names = FALSE
)
write.csv(
  fig$ad_df,
  file = paste(
    "output/final_figures/data/Fig",
    fig_no,
    "c_AbsDiff.csv",
    sep = ""
  ),
  row.names = FALSE
)

savefig(fig, fig_no)
```

### Coal

```{r}
fig_no = "F.13.CoalGen"

ts_map_ID = 82
pd_map_ID = 71
ad_map_ID = 17
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 1100
brk = c(0, 250, 500, 750, 1000)


fig = four_corners("Coal Generation", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Gas

```{r}
fig_no = "F.14.GasGen"

ts_map_ID = 81
pd_map_ID = 70
ad_map_ID = 18
drop = c("EIAinEMF37.csv", "NEMS-EIA")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 2500
brk = c(0, 500, 1000, 1500, 2000, 2500)


fig = four_corners("Electricity Generation from Gas", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Other

```{r}
fig_no = "F.15.OtherGen"

ts_map_ID = 88
pd_map_ID = 77
ad_map_ID = 11
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 250
ymax = 500
brk = c(250, 375, 500)


fig = four_corners("Electricity Generation from Other", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

abdata = fig$ts_df %>%
  group_by(model, year) %>%
  summarize(abdif = value[scenario == "IRA"] - value[scenario == "No IRA"])

  hist <- abdata %>%
    group_by(model) %>%
    slice(1) %>%
    mutate(scenario = "Historic",
           diff = 0,
           year = 2021)
  
    medians = abdata %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(abdif))
    
    abdata <- rbind(abdata, hist)

adfigure = ggplot() +
    geom_line(data = abdata,
              aes(
                x = year,
                y = abdif,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA")+
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    labs(title = "",
         x = "",
         y = "Absolute Difference (TWh)") 

pbdata = fig$ts_df %>%
  group_by(model, year) %>%
  summarize(pbdif = (value[scenario == "IRA"] - value[scenario == "No IRA"])/value[scenario=="No IRA"])

  hist <- pbdata %>%
    group_by(model) %>%
    slice(1) %>%
    mutate(scenario = "Historic",
           diff = 0,
           year = 2021)
  
    medians = pbdata %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(pbdif))
    
    pbdata <- rbind(pbdata, hist)

pdfigure = ggplot() +
    geom_line(data = pbdata,
              aes(
                x = year,
                y = pbdif,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA")+
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    labs(title = "",
         x = "",
         y = "Percent Difference (%)") 

  #Time Series Dataframe
  df = fig$ts_df
  noIRAmedians = df[df$scenario == "No IRA",] %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  IRAmedians = df[df$scenario == "IRA",] %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  NoIRAfigure = ggplot(df[df$scenario == "No IRA", ], aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = brk) + 
    labs(title = "No IRA",
         y = paste0(metric," (",unit,")"),
         x = element_blank()) +
    theme(legend.position = "right",
         plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = df$value[df$year == 2021][1]), color = "black") +
    geom_point(
      data = noIRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )

  IRAfigure = ggplot(df[df$scenario == "IRA", ], aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
    labs(title = "IRA",
         y = paste0(metric," (",unit,")"),
         x = element_blank()) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = df$value[df$year == 2021][1]), color = "black") +
    geom_point(
      data = IRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )
  
  figure = (NoIRAfigure | IRAfigure) / (adfigure | pdfigure) + 
    plot_layout(guides = "collect") +
    plot_annotation(title = "Electricity Generation from Other")
  
  savefig(figure, fig_no)
```

### Electricity generation by model

```{r}
fig_no = "F.16.Generation"

exclude_models = c()

clean_data15 = clean_data %>%
  mutate(value = case_when(
    unit == "Quads" ~ value * 293.07107,
    TRUE ~ value
  )) %>% mutate(unit = case_when(
    unit == "Quads" ~ "TWh",
    TRUE ~ unit
  )) %>%
  filter(!(model %in% exclude_models))

clean_data_hist_ira = clean_data15 %>%
  filter(model == "EIA",
         scenario == "Historic",
         datasrc == "EIA-EPA-bistline_historic.csv",
         year == 2021) %>%
  mutate(scenario = "IRA", year = 2035)

clean_data_hist_noira = clean_data15 %>%
  filter(model == "EIA",
         scenario == "Historic",
         datasrc == "EIA-EPA-bistline_historic.csv",
         year == 2021) %>%
  mutate(scenario = "No IRA", year = 2035)

clean_data15 = bind_rows(clean_data15, clean_data_hist_noira, clean_data_hist_ira)

models_alph = sort(unique(clean_data15$model))

dta = data_from_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 18, "United States")

model_renamer = c(
  "EIA" = "2021",
  "EIA-LTS" = "EIA-LTS",
  "EIA-STEO" = "EIA-STEO",
  "EPA-ATR" = "EPA-ATR",
  "EPS-EI" = "EPS-EI",
  "GCAM-CGS" = "GCAM-CGS",
  "GCAM-PNNL" = "GCAM-PNNL",
  "Haiku-RFF" = "Haiku-RFF",
  "IPM-EPA" = "IPM-EPA",
  "IPM-NRDC" = "IPM-NRDC",
  "MARKAL-NETL" = "MARKAL-NETL",
  "NEMS-EIA" = "NEMS-EIA",
  "NEMS-OP" = "NEMS-OP",
  "NEMS-RHG" = "NEMS-RHG",
  "ReEDS-NREL" = "ReEDS-NREL",
  "REGEN-EPRI" = "REGEN-EPRI",
  "RIO-REPEAT" = "RIO-REPEAT",
  "Scout-LEEP" = "Scout-LEEP",
  "USREP-ReEDS" = "USREP-ReEDS"
)

p = print_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 18, "United States",
                level_mod = models_alph) +
  facet_grid(scenario ~ model, switch = "x",labeller = labeller(
    model = model_renamer)) + 
    scale_x_continuous(breaks = c(2030, 2035), labels = c("2030", "2035"), position = "top") + 
  scale_y_continuous(expand = c(0,0), labels = scales::comma, limits = c(0,6500),
                     name = expression("Electricity Generation (TWh)")) +
  theme(axis.ticks = element_blank(), 
        strip.text.x = element_text(face = "plain", angle = 90, hjust = 1, size = 7),
        axis.text.x = element_text(hjust = 0, vjust = 0.5),
        plot.title = element_blank())


p

saveall(p, dta, fig_no)
```

### Electricity capacity by model

```{r}
fig_no = "F.17.Capacity"

p = print_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 15, "United States",
                level_mod = models_alph) +
  facet_grid(scenario ~ model, switch = "x",labeller = labeller(
    model = model_renamer)) + 
  scale_x_continuous(breaks = c(2030, 2035), labels = c("2030", "2035"), position = "top") + 
  scale_y_continuous(expand = c(0,0), labels = scales::comma, 
                     name = expression("Electricity Capacity (GW)")) +
  theme(axis.ticks = element_blank(), 
        strip.text.x = element_text(face = "plain", angle = 90, hjust = 1, size = 7),
        axis.text.x = element_text(hjust = 0, vjust = 0.5))

dta = data_from_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 15, "United States")

p

saveall(p, dta, fig_no)


```

### EV Share

```{r}
fig_no = "F.18.EvSalesShare"

subpalettes_ev = create_subpalettes(figmap_leep_timeseries, config)
# TODO: NEMS-OP should only have reporting every 5 years

# clean_data_evshare = spg_clean(ts_map_ID = 118, drop = c(""), histsrc = "EPA-ATR",
#                            config = config, clean_data = clean_data4, figmap_leep_timeseries = figmap_leep_timeseries)
scen_map = read.csv("./data-raw/scenario-mapping.csv") %>% select(datasrc, model, scenario, model_new, scenario_new)
raw = data_raw %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new) %>%
  filter(unit != "thousands") %>%
  filter(!(model == "EPA-ATR" & year >= 2022))

atr_2022 = raw %>% filter(model == "EPA-ATR", year == 2021) %>% mutate(year = 2022)
nems = data_min %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  filter(model == "NEMS-OP",
         scenario %in% c("IRA", "No IRA"),
         datasrc != "LTS_data_small.xlsx",
         grepl("Sales Share", variable),
         unit == "%") %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new)

clean_data_evshare = rbind(raw, atr_2022, nems) %>%
  filter(unit != "thousands") %>%
  mutate(value = 100 * value) %>%
  filter(model != "EIA-LTS") %>%
  duplicate_historical_data("EPA-ATR", 2022, criteria = TRUE) %>% mutate(
    variable = case_when(
      variable %in% c(
        "Energy Service|Transportation|Passenger|BEV|Sales Share",
        # "Energy Service|Transportation|Passenger|FCEV|Sales Share",
        # "Energy Service|Transportation|Passenger|HEV|Sales Share",
        # "Energy Service|Transportation|Freight|BEV|Sales Share",
        # "Energy Service|Transportation|Freight|FCEV|Sales Share",
        "Energy Service|Transportation|Passenger|PHEV|Sales Share",
        "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share"
        ) ~
        "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share")) %>%
  group_by(model, scenario, unit, datasrc, year, region, variable) %>%
  summarize(value = sum(value)) %>%
  filter(!(is.na(variable))) %>%
  filter(year <= 2035) %>%
#  filter(!(model %in% c("NEMS-OP-LTS"))) %>%
  filter(!(datasrc %in% c("LTS_data_small.xlsx"))) %>%
  mutate(variable_rename = variable) %>%
  mutate(alpha = case_when(
      model == "USREP-ReEDS" ~ 1,
      model == "GCAM-PNNL" ~ 1,
      model == "IPM-EPA" ~ 1,
      scenario == "Historic" ~ 1,
      T ~ 1
  )) %>%
  mutate(value = case_when(year == 2022 & model == "NEMS-OP" ~ 100 * atr_2022$value[1],
                           TRUE ~ value))

clean_data_evshare = clean_data_evshare %>%
  filter(year >= 2021) %>%
  filter(year %in% c(2021, 2025, 2030, 2035))

hist = clean_data_evshare %>%
  group_by(model) %>%
  slice(1) %>%
  ungroup %>%
  mutate(year = 2021) %>%
  mutate(value = value[scenario == "Historic"][1]) %>%
  mutate(scenario = "Historic")

EV_IRA = clean_data_evshare %>%
  filter(scenario != "No IRA")

EV_IRA = rbind(EV_IRA, hist)

EV_noIRA = clean_data_evshare %>%
  filter(scenario != "IRA")

EV_noIRA = rbind(EV_noIRA, hist)

  noIRAmedians = EV_noIRA %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  IRAmedians = EV_IRA %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  NoIRAfigure = ggplot(EV_noIRA, aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes_ev, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(0, 85), breaks = c(0, 20, 40, 60, 80)) +
    labs(title = "No IRA",
         y = expression(`EV Sales Share (%)`),
         x = element_blank()) +
    theme(legend.position = "right",
         plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = EV_noIRA$value[EV_noIRA$year == 2021][1]), color = "black") +
    geom_point(
      data = noIRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )

  IRAfigure = ggplot(EV_IRA, aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes_ev, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(0, 85), breaks = c(0, 20, 40, 60, 80)) +
    labs(title = "IRA",
         y = expression(`EV Sales Share (%)`),
         x = element_blank()) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = EV_IRA$value[EV_IRA$year == 2021][1]), color = "black") +
    geom_point(
      data = IRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )

dif = rbind(EV_IRA, EV_noIRA)

dif_hist = dif %>%
  filter(scenario == "Historic") %>%
  slice(1) %>%
  ungroup() %>%
  mutate(value = 0) %>%
  select(model, year, value) %>%
  mutate(name = "historic")

dif = dif %>%
  filter(scenario != "Historic") %>%
  pivot_wider(names_from = scenario, values_from = value) %>%
  mutate(absdif = IRA - `No IRA`) %>%
  mutate(pdif = ((IRA - `No IRA`) / IRA) * 100) %>%
  ungroup() %>%
  select(model, year, absdif, pdif)

dif_clean = dif %>%
  pivot_longer(cols = c(absdif, pdif))

dif_fin = rbind(dif_clean, dif_hist)

df = dif_fin %>%
  filter(name != "pdif")

medians = df %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(value))


EV_abdif_figure = ggplot() +
    geom_line(data = df,
              aes(
                x = year,
                y = value,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes_ev, "Emissions|CO2|Percent difference from No IRA") +
    labs(title = "",
         x = "",
         y = expression(`Absolute Difference (%)`)) +
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035))

df = dif_fin %>%
  filter(name != "absdif")

medians = df %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(value))


EV_pdif_figure = ggplot() +
    geom_line(data = df,
              aes(
                x = year,
                y = value,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes_ev, "Emissions|CO2|Percent difference from No IRA") +
    labs(title = "",
         x = "",
         y = expression(`Percent Difference (%)`)) +
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035))

  figure = (NoIRAfigure | IRAfigure) / (EV_abdif_figure | EV_pdif_figure)+
    plot_layout(guides = "collect") +
    plot_annotation(title = "EV Sales Share")

savefig(figure, fig_no)

```

## Gas and Coal generation capacity factors

### Generation

```{r}
fig_no = "F.19"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

exclude_models_bistline = c(
  "ReEDS-NREL",
  "IPM-ERA"
)

generation_data_bis = clean_data %>%
  filter(datasrc == "bistline_ira_tall.csv", 
         !(model %in% exclude_models_bistline),
  variable %in% c(
    #"Secondary Energy|Electricity|Coal|w/ CCS",
    "Secondary Energy|Electricity|Coal|w/o CCS",
    #"Secondary Energy|Electricity|Gas|w/ CCS",
    "Secondary Energy|Electricity|Gas|w/o CCS"
  )) %>%
  mutate(variable = case_when(
    grepl("Coal",variable) ~ "Secondary Energy|Electricity|Coal",
    TRUE ~ "Secondary Energy|Electricity|Gas"
  )) %>% group_by(model, scenario, unit, year, datasrc, variable, region) %>%
  summarize(value = sum(value)) %>% ungroup()

generation_data_other = clean_data %>%
  filter(variable %in% c("Secondary Energy|Electricity|Coal", 
                         "Secondary Energy|Electricity|Gas"))

generation_data = bind_rows(generation_data_bis, generation_data_other) %>%
  filter(year %in% c(2030, 2035),
         !(model %in% exclude_models),
         scenario %in% c("IRA","No IRA","Core")) %>%
  # convert from quads to TWh
  mutate(value = value * 293.07107,
         unit = "TWh") %>%
  mutate(scenario = case_when(
    scenario == "Core" ~ "IRA",
    TRUE ~ scenario
  )) %>%
  select(-c(region, datasrc, unit)) %>%
  mutate(variable = case_when(
    variable == "Secondary Energy|Electricity|Coal" ~ "Coal",
    TRUE ~ "Gas"
  )) %>%
  pivot_wider(names_from = c("scenario", "year"), values_from = value) %>%
  arrange(model, variable) %>% 
  select(c("model", "variable", "No IRA_2030", "No IRA_2035", "IRA_2030", "IRA_2035")) %>%
  group_by(variable)
  
  #pivot_wider(names_from = model, values_from = value) %>%
  #group_by(variable)
colnames(generation_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")

generation_table = gt_elec_table(generation_data, "Electricity Generation (TWh)", percent = FALSE)
generation_table

generation_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
generation_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
```

### Capacity

```{r}
fig_no = "F.20"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

exclude_models_bistline = c(
  "ReEDS-NREL",
  "IPM-ERA"
)

capacity_data_bis = clean_data %>%
  filter(datasrc == "bistline_ira_tall.csv", 
         !(model %in% exclude_models_bistline),
  variable %in% c(
   #"Capacity|Electricity|Coal|w/ CCS",
    "Capacity|Electricity|Coal|w/o CCS",
   #"Capacity|Electricity|Gas|w/ CCS",
    "Capacity|Electricity|Gas|w/o CCS"
  )) %>%
  mutate(variable = case_when(
    grepl("Coal",variable) ~ "Capacity|Electricity|Coal",
    TRUE ~ "Capacity|Electricity|Gas"
  )) %>% group_by(model, scenario, unit, year, datasrc, variable, region) %>%
  summarize(value = sum(value)) %>% ungroup()

capacity_data_other = clean_data %>%
  filter(variable %in% c("Capacity|Electricity|Coal", 
                         "Capacity|Electricity|Gas"))

capacity_data = bind_rows(capacity_data_bis, capacity_data_other) %>%
  filter(year %in% c(2030, 2035),
         !model %in% exclude_models,
         scenario %in% c("IRA","No IRA","Core")) %>%
  mutate(scenario = case_when(
    scenario == "Core" ~ "IRA",
    TRUE ~ scenario
  )) %>%
  select(-c(region, datasrc, unit)) %>%
  mutate(variable = case_when(
    variable == "Capacity|Electricity|Coal" ~ "Coal",
    TRUE ~ "Gas"
  )) %>%
  pivot_wider(names_from = c("scenario", "year"), values_from = value) %>%
  arrange(model, variable) %>% 
  select(c("model", "variable", "No IRA_2030", "No IRA_2035", "IRA_2030", "IRA_2035")) %>%
  group_by(variable)
  
colnames(capacity_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")

capacity_table = gt_elec_table(capacity_data, "Electricity Generation Capacity (GW)", percent = FALSE)

capacity_table

capacity_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
capacity_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
```

### Capacity Factor

```{r}
fig_no = "F.21"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

# need to run the 2 above code chunks first

# generation in TWh
generation_data_temp = generation_data
colnames(generation_data_temp) = c("Model", "Generation.Fuel",
                            "Gen.NoIRA.2030","Gen.NoIRA.2035","Gen.IRA.2030","Gen.IRA.2035")
# capacity in GW
capacity_data_temp = capacity_data
colnames(capacity_data_temp) = c("Model", "Generation.Fuel",
                            "Cap.NoIRA.2030","Cap.NoIRA.2035","Cap.IRA.2030","Cap.IRA.2035")

cf_data = generation_data_temp %>% inner_join(capacity_data_temp, 
                                              by = c("Model", "Generation.Fuel")) %>%
  mutate(CF.NoIRA.2030 = ((1000 * Gen.NoIRA.2030) / (8760 * Cap.NoIRA.2030)),
         CF.NoIRA.2035 = ((1000 * Gen.NoIRA.2035) / (8760 * Cap.NoIRA.2035)),
         CF.IRA.2030 = ((1000 * Gen.IRA.2030) / (8760 * Cap.IRA.2030)),
         CF.IRA.2035 = ((1000 * Gen.IRA.2035) / (8760 * Cap.IRA.2035))) %>%
  select(-c("Cap.NoIRA.2030","Cap.NoIRA.2035","Cap.IRA.2030","Cap.IRA.2035",
            "Gen.NoIRA.2030","Gen.NoIRA.2035","Gen.IRA.2030","Gen.IRA.2035")) %>%
  filter(!(Model %in% exclude_models))

colnames(cf_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")
 
cf_data$"2035\r"[cf_data$Model == "GCAM-CGS" & cf_data$Generation.Fuel == "Coal"] = 0

cf_table = gt_elec_table(cf_data, "Electricity Generation Capacity Factors (%)", 
                         percent = TRUE, 
                         footnote_text = "GCAM-CGS coal generation and capacity are beneath 
                         rounding tolerance, so CF has been set to 0%.",
                         footnote_column = 6, footnote_row = 3)
cf_table

cf_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
cf_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
```

# Appendix G

## Electrification Figure

```{r}
fig_no = "G.1"

elc = readxl::read_xlsx("data-extra/electrification_compiled.xlsx") %>%
  rename(value = value100) %>%
  select(-variable) %>%
  rename(variable = variable_rename) %>%
  mutate(variable = case_when(
    variable == "Total" ~ "Economy-Wide",
    TRUE~variable
  ))

vars = c("Final Energy|Percent Electricity", 
         "Final Energy|Buildings|Percent Electricity",
         "Final Energy|Industry and Fuel Production|Percent Electricit+",
         "Final Energy|Transportation|Percent Electricity")

ref_elc = clean_data %>%
  filter(variable %in% c(vars, "Final Energy|Industry|Percent Electricity") & 
           year == 2020 & 
           model == "AEO2021") %>%
  mutate(value = case_when(
    variable == "Final Energy|Buildings|Percent Electricity" ~ 0.47, # number from Chioke, our number is wrong
    variable == "Final Energy|Industry|Percent Electricity" ~ 0.13, # number calculated from AEO 2021, ~3 quads elc ~25 quads total
    TRUE~value)) %>%
  mutate(variable = case_when(
    variable == "Final Energy|Industry|Percent Electricity" ~ "Final Energy|Industry and Fuel Production|Percent Electricity",
    TRUE~variable
  )) %>%
  select(model,scenario,year,value,variable) %>%
  mutate(
    value = value * 100,
    variable = case_when(
      variable == "Final Energy|Percent Electricity" ~ "Economy-Wide",
      variable == "Final Energy|Buildings|Percent Electricity" ~ "Buildings",
      variable == "Final Energy|Industry and Fuel Production|Percent Electricity" ~ "Industry",
      variable == "Final Energy|Transportation|Percent Electricity" ~ "Transportation",
      TRUE ~ variable
    ))

elc_raw = rbind(elc, ref_elc) 

hist = ref_elc %>% select(year, variable, value) %>%
  pivot_wider(names_from = "year", values_from = "value")

replace_hist = elc_raw %>%
  filter(model != "AEO2021") %>%
  full_join(hist, by = c("variable")) %>%
  select(model,scenario,variable,`2020`) %>%
  pivot_longer(cols = `2020`, names_to = "year", values_to = "value") %>%
  distinct()

elc_ts = rbind(elc_raw, replace_hist) %>%
  filter(model != "AEO2021" &
           year <= 2035) %>%
  mutate(variable = factor(variable, levels = c("Economy-Wide", "Transportation", "Buildings", "Industry")))

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

elc_ts = elc_ts %>%
  mutate(alpha = 1) %>%
  filter(!model %in% "REGEN-EPRI") %>%
  mutate(year = as.numeric(year))

Econ_ts = elc_ts %>%
  filter(variable == "Economy-Wide") %>%
  mutate(variable_rename = "Economy-Wide")

EconSpg = spg3(df = Econ_ts, 
               title = "Economy-Wide", 
               yname = "% Electricity of Final Energy",
               gd = "none", 
               ymin = 0,
               ymax = 70, 
               ybreaks = c(0, 20, 40, 60), 
               yax_format = scales::comma, 
               annotate = 0, 
               c(2025, 0),
               c(2025, 0), 
               c(2025, 0), 
               config = config, 
               figmap_leep_timeseries = figmap_leep_timeseries)

savedata(EconSpg$data, paste0(fig_no, "EconWide"))

EconDot = dotted(EconSpg$data, EconSpg$figure, "median", 0, 70, config, figmap_leep_timeseries)

Tran_ts = elc_ts %>%
  filter(variable == "Transportation")%>%
  mutate(variable_rename = "Transportation")

TranSpg = spg3(df = Tran_ts, 
               title = "Transportation", 
               yname = "",
               gd = "none", 
               ymin = 0,
               ymax = 70, 
               ybreaks = c(0, 20, 40, 60), 
               yax_format = NULL, 
               annotate = 0, 
               c(2025, 0),
               c(2025, 0), 
               c(2025, 0), 
               config = config, 
               figmap_leep_timeseries = figmap_leep_timeseries)

savedata(TranSpg$data, paste0(fig_no, "Transportation"))

TranDot = dotted(TranSpg$data, TranSpg$figure, "median", 0, 70, config, figmap_leep_timeseries)

Buil_ts = elc_ts %>%
  filter(variable == "Buildings")%>%
  mutate(variable_rename = "Buildings")

BuilSpg = spg3(df = Buil_ts, 
               title = "Buildings", 
               yname = "",
               gd = "none", 
               ymin = 0,
               ymax = 70, 
               ybreaks = c(0, 20, 40, 60), 
               yax_format = NULL, 
               annotate = 0, 
               c(2025, 0),
               c(2025, 0), 
               c(2025, 0), 
               config = config, 
               figmap_leep_timeseries = figmap_leep_timeseries)

savedata(BuilSpg$data, paste0(fig_no, "Buildings"))

BuilDot = dotted(BuilSpg$data, BuilSpg$figure, "median", 0, 70, config, figmap_leep_timeseries)

Ind_ts = elc_ts %>%
  filter(variable == "Industry")%>%
  mutate(variable_rename = "Industry")

IndSpg = spg3(df = Ind_ts, 
               title = "Industry", 
               yname = "",
               gd = "none", 
               ymin = 0,
               ymax = 70, 
               ybreaks = c(0, 20, 40, 60), 
               yax_format = NULL, 
               annotate = 0, 
               c(2025, 0),
               c(2025, 0), 
               c(2025, 0), 
               config = config, 
               figmap_leep_timeseries = figmap_leep_timeseries)

savedata(IndSpg$data, paste0(fig_no, "Industry"))

IndDot = dotted(IndSpg$data, IndSpg$figure, "median", 0, 70, config, figmap_leep_timeseries)

Full = (EconDot | TranDot | BuilDot | IndDot)
Full

savefig(Full, fig_no, wd = 9, ht = 4)
```

## Tables

### % Share Tables

```{r}
per_share_wb <- createWorkbook()

stats = elc_ts %>%
  filter(year != 2020) %>%
  mutate(year = as.character(year)) %>%
  group_by(scenario, variable, year) %>%
  summarise(Median = round(median(value),2),
            Min = round(min(value),2),
            Max = round(max(value),2)) %>%
  rename(Sector = variable,
         Year = year)

total = stats %>%
  filter(Sector == "Economy-Wide") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
total

write_sheet(total, per_share_wb, "Total")

transportation = stats %>%
  filter(Sector == "Transportation") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
transportation

write_sheet(transportation, per_share_wb, "Transportation")

buildings = stats %>%
  filter(Sector == "Buildings") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
buildings

write_sheet(buildings, per_share_wb, "Buildings")

industry = stats %>%
  filter(Sector == "Industry") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
industry

write_sheet(industry, per_share_wb, "Industry")

all = rbind(total, transportation, buildings, industry) %>%
  mutate(`IRA` = `IRA`/100,
         `No IRA` = `No IRA`/100)

write_sheet(all, per_share_wb, "All")

saveWorkbook(per_share_wb, file = paste("output/final_figures/data/",fig_no,"share.xlsx",sep=")"), overwrite = TRUE)
```

```{R}
# display table for appendix G1
fig_no = "G1 Electricity Share.1"
tab_dta = all %>% 
  data.frame() %>%
  pivot_wider(names_from = Statistic, values_from = c(IRA, No.IRA)) %>%
  select(c(Sector, Year, No.IRA_Min, No.IRA_Median, No.IRA_Max, IRA_Min, IRA_Median, IRA_Max))
colnames(tab_dta) = c("Sector", "Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r")
col_names = c("","No IRA", "IRA")

table1 = tab_dta %>% gt() %>%
    tab_header(
      title = gt::html("Summary of Electricity Share (%) of Final Energy")
    ) %>%
    tab_spanner(label = col_names[2], columns = c(Min, Median, Max)) %>%
    tab_spanner(label = col_names[3], columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
    cols_label() %>%
    tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(1:3, 7:9))
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "all", color = "white"),
        cell_fill(color = "white", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(4:6, 10:12))
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(2,5))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold", align = "left")
      ), locations = cells_body(columns = 1:2)
    ) %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:8)
    
table1

table1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
```

### % Difference in Share IRA vs No IRA Tables

```{r}
diff_wb <- createWorkbook()

stats_per = elc_ts %>%
  filter(year != 2020) %>%
  pivot_wider(names_from = "scenario", values_from = "value") %>%
  mutate(
    pp_diff = round((`IRA` - `No IRA`),2),
    per_diff = round(((pp_diff/`No IRA`)*100),2)) %>%
  select(model,year,variable,pp_diff,per_diff) %>%
  pivot_longer(cols = 4:5, names_to = "stat", values_to = "value") %>%
  group_by(year,variable,stat) %>%
  summarise(
    Median = median(value),
    Min = min(value),
    Max = max(value)
  ) %>%
  rename(indicator = stat) %>%
  pivot_longer(cols = 4:6, names_to = "stat", values_to = "value") %>%
  pivot_wider(names_from = "indicator", values_from = "value") %>%
  rename(`Percentage Point Difference` = pp_diff,
         `Percent Difference` = per_diff,
         Year = year,
         Statistic = stat,
         Sector = variable) %>%
  select(Sector, Year, Statistic, `Percent Difference`, `Percentage Point Difference`)

total_per = stats_per %>% filter(Sector == "Economy-Wide")
total_per

write_sheet(total_per, diff_wb, "Economy-Wide")

transportation_per = stats_per %>% filter(Sector == "Transportation")
transportation_per

write_sheet(transportation_per, diff_wb, "Transportation")

buildings_per = stats_per %>% filter(Sector == "Buildings")
buildings_per

write_sheet(buildings_per, diff_wb, "Buildings")

industry_per = stats_per %>% filter(Sector == "Industry")
industry_per

write_sheet(industry_per, diff_wb, "Industry")

all_per = rbind(total_per, transportation_per, buildings_per, industry_per) %>%
  mutate(`Percent Difference` = `Percent Difference`/100,
         `Percentage Point Difference` = paste(`Percentage Point Difference`, "pp"))

write_sheet(all_per, diff_wb, "All")

saveWorkbook(per_share_wb, file = paste("output/final_figures/data/",fig_no,"differences.xlsx",sep=")"), overwrite = TRUE)
```

```{R}
# display table for appendix G2
fig_no = "G1 Electricity Share.2"
tab_dta = all_per %>% 
  data.frame() %>%
  pivot_wider(names_from = Statistic, values_from = c(Percent.Difference, Percentage.Point.Difference)) %>%
  select(c(Sector, Year, Percent.Difference_Min, Percent.Difference_Median, Percent.Difference_Max,
           Percentage.Point.Difference_Min, Percentage.Point.Difference_Median,
           Percentage.Point.Difference_Max))
colnames(tab_dta) = c("Sector", "Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r")
col_names = c("","Percent Difference", "Percentage Point Difference")

table2 = tab_dta %>% gt() %>%
    tab_header(
      title = gt::html("Differences in Electricity Share of Final Energy Between IRA and No IRA Scenarios")
    ) %>%
    tab_spanner(label = col_names[2], columns = c(Min, Median, Max)) %>%
    tab_spanner(label = col_names[3], columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
    cols_label() %>%
    tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(1:3, 7:9))
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "all", color = "white"),
        cell_fill(color = "white", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(4:6, 10:12))
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(2,5))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold", align = "left")
      ), locations = cells_body(columns = 1:2)
    ) %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:8)
    
table2

table2 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table2 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))

```

# Appendix H

## EconWide Direct/Indirect

```{r}
fig_no = "H.1"

Econ_data = spg_clean(
  99,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

Elec_data = spg_clean(
  98,
  c("Scout-LEEP"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

Econ_merge = merge(Econ_data, Elec_data, by = c("model", "scenario", "year")) %>%
  select(model, scenario, year, 
         Econ = value.x, 
         Power = value.y) %>%
  mutate(value = Econ - Power) %>%
  select(model, scenario, year, value) %>%
  mutate(alpha = 1) %>%
  mutate(variable_rename = "Non-Electricity")
  

EconSpg = spg2(
  Econ_merge,
  "Non-Electricity",
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  4000,
  c(0, 2000, 4000),
  scales::comma,
  1,
  c(2015, 3000),
  c(2027.5, 3900),
  c(2022, 2800),
  config,
  figmap_leep_timeseries)

EconDot = dotted(EconSpg$data, EconSpg$figure, "median", 0, 4000, config, figmap_leep_timeseries)

savedata(EconSpg$data, paste(fig_no, "EconWide"))

EconTab = html(EconSpg$data, "Non-Electricity")
EconTab
  
ElecSpg = spg2(Elec_data,
  expression("Electricity"),
  "",
  gd = "none",
  0,
  4000,
  c(0, 2000, 4000),
  NULL,
  0, 
  c(2015, 3000), 
  c(2027.5, 3900), 
  c(2022, 3800), 
  config, 
  figmap_leep_timeseries)

savedata(ElecSpg$data, paste(fig_no, "Electricity"))

ElecTab = html(ElecSpg$data, "Electricity")

ElecTab

ElecDot = dotted(ElecSpg$data, ElecSpg$figure, "median", 0, 4000, config, figmap_leep_timeseries)

fig = EconDot | ElecDot

savefig(fig, fig_no)
```

## Transportation Direct/Indirect
```{r}
fig_no = "H.2"

Dir_data = spg_clean(
  97, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)

DirSpg = spg2(
  Dir_data,
  expression(paste("Direct Combustion")),
  expression(paste("Emissions(Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2000,
  c(0, 500, 1000, 1500, 2000),
  scales::comma, 
  1, 
  c(2015, 1900), 
  c(2030, 1850), 
  c(2022.5, 1300), 
  config,
  figmap_leep_timeseries)

DirDot = dotted(DirSpg$data, DirSpg$figure, "median", 0, 2000, config, figmap_leep_timeseries)

DirTab = html(DirSpg$data, "Direct Transportation CO2")
DirTab

IndDir_data = spg_clean(
  18, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries
)


IndDirSpg = spg2(
  IndDir_data,
  expression(paste("Indirect from Electricity")),
  "",
  gd = "none",
  0,
  2000,
  c(0, 500, 1000, 1500, 2000),
  NULL, 
  0, 
  c(2015, 1000), 
  c(2030, 1000), 
  c(2022.5, 1000), 
  config,
  figmap_leep_timeseries)

IndDirDot = dotted(IndDirSpg$data, IndDirSpg$figure, "median", 0, 2000, config, figmap_leep_timeseries)

IndDirTab = html(IndDirSpg$data, "Indirect Transportation CO2")
IndDirTab


fig = DirDot | IndDirDot

savefig(fig, fig_no)
savedata(DirSpg$data, paste(fig_no, "Direct"))
savedata(IndDirSpg$data, paste(fig_no, "Indirect"))
```

## Building Direct/Indirect

```{r}
fig_no = "H.3"

Dir_data = spg_clean(
  95, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)

DirSpg = spg2(
  Dir_data,
  expression(paste("Direct Combustion")),
  expression(paste("Emissions(Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2000,
  c(0, 500, 1000, 1500, 2000),
  scales::comma, 
  1, 
  c(2013, 750), 
  c(2030, 800), 
  c(2022.5, 350), 
  config,
  figmap_leep_timeseries)

DirDot = dotted(DirSpg$data, DirSpg$figure, "median", 0, 2000, config, figmap_leep_timeseries)

DirTab = html(DirSpg$data, "Direct Building CO2")
DirTab

IndDir_data = spg_clean(
  22, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries
)


IndDirSpg = spg2(
  IndDir_data,
  expression(paste("Indirect from Electricity")),
  "",
  gd = "none",
  0,
  2000,
  c(0, 500, 1000, 1500, 2000),
  NULL, 
  0, 
  c(2015, 1000), 
  c(2030, 1000), 
  c(2022.5, 1000), 
  config,
  figmap_leep_timeseries)

IndDirDot = dotted(IndDirSpg$data, IndDirSpg$figure, "median", 0, 2000, config, figmap_leep_timeseries)

IndDirTab = html(IndDirSpg$data, "Indirect Building CO2")
IndDirTab


fig = DirDot | IndDirDot

savefig(fig, fig_no)
savedata(DirSpg$data, paste(fig_no, "Direct"))
savedata(IndDirSpg$data, paste(fig_no, "Indirect"))
```

## Industry Direct/Indirect

```{r}
fig_no = "H.4"

Dir_data = spg_clean(
  96, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)

DirSpg = spg2(
  Dir_data,
  expression(paste("Direct Combustion")),
  expression(paste("Emissions(Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  1500,
  c(0, 500, 1000, 1500),
  scales::comma, 
  1, 
  c(2015, 1000), 
  c(2030, 1300), 
  c(2022.5, 650), 
  config,
  figmap_leep_timeseries)

DirDot = dotted(DirSpg$data, DirSpg$figure, "median", 0, 1500, config, figmap_leep_timeseries)

DirTab = html(DirSpg$data, "Direct Industry CO2")
DirTab

IndDir_data = spg_clean(
  20, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries
)


IndDirSpg = spg2(
  IndDir_data,
  expression(paste("Indirect from Electricity")),
  "",
  gd = "none",
  0,
  1500,
  c(0, 500, 1000, 1500),
  NULL, 
  0, 
  c(2015, 1000), 
  c(2030, 1000), 
  c(2022.5, 1000), 
  config,
  figmap_leep_timeseries)

IndDirDot = dotted(IndDirSpg$data, IndDirSpg$figure, "median", 0, 1500, config, figmap_leep_timeseries)

IndDirTab = html(IndDirSpg$data, "Indirect Industry CO2")
IndDirTab


fig = DirDot | IndDirDot

savefig(fig, fig_no)
savedata(DirSpg$data, paste(fig_no, "Direct"))
savedata(IndDirSpg$data, paste(fig_no, "Indirect"))
```

# Appendix I Generation dot plots

## with 2021

```{r}
fig_no = "I.1"

subpalettes = create_subpalettes(figmap_leep_timeseries, config)
names(subpalettes$`Emissions|CO2|Energy|Demand|Industry`) = c("2021", "No IRA", "IRA")

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

ymin = 0
ymax = 2600
metric = "median"

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))

low <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))

high <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))

individual <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))

##### All Total #####
df_21 = total %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = total %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = total %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_total <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 


dots_Total = ggplot(data = data_total, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Total Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

savedata(data_total, paste(fig_no, "Total"))

##### Low Total #####

df_21 = low %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))

df_30 = low %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  
df_35 = low %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  
mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_Low <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Low = ggplot(data = data_Low, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Low or Zero Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Low, paste(fig_no, "Low"))

##### High Total #####
df_21 = high %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = high %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))

df_35 = high %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_High <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_High = ggplot(data = data_High, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"High Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_High, paste(fig_no, "High"))

##### Nuclear #####
df_21 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Nuclear <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Nuclear = ggplot(data = data_Nuclear, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Nuclear") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Nuclear, paste(fig_no, "Nuclear"))

##### Solar #####
df_21 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Solar <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Solar = ggplot(data = data_Solar, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Solar") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Solar, paste(fig_no, "Solar"))

##### Wind #####

df_21 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Wind <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Wind = ggplot(data = data_Wind, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Wind") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Wind, paste(fig_no, "Wind"))

##### CCS #####

df_21 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_CCS <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_CCS = ggplot(data = data_CCS, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"CCS") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_CCS, paste(fig_no, "CCS"))

##### Coal #####
df_21 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Coal <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Coal = ggplot(data = data_Coal, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Coal") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Generation (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Coal, paste(fig_no, "Coal"))

##### Gas #####
df_21 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Gas <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Gas = ggplot(data = data_Gas, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Natural Gas") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Gas, paste(fig_no, "Gas"))

##### Other #####
df_21 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value)) %>%
  mutate(scenario = "2021") %>%
  mutate(median = median(median)) %>%
  mutate(mean = mean(mean))
  

df_30 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Other <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) 

dots_Other = ggplot(data = data_Other, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_hline(data = df_stat_21, aes(yintercept = median, color = scenario, alpha = 0.5) ) +
    facet_wrap(~"Other") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Other, paste(fig_no, "Other"))

##### Final #####
final = (dots_Total | dots_Low | dots_High) / (dots_Wind | dots_Solar | dots_Nuclear | dots_CCS) / (dots_Coal | dots_Gas | dots_Other) 

final = final + 
  plot_layout(
  guides = "collect"
) & theme(legend.position = "bottom")
final

savefig(final, fig_no, wd = 8)

```

### Tables

```{r}
title = "I.Total Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)


IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)


IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

```{r}

title = "I.Low Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.High Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Wind Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Wind")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Solar Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Solar")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Nuclear Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Nuclear")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.CCS Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "CCS")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Coal Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Coal")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Nautural Gas Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Natural Gas")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

```{r}

title = "I.Other Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Other")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

## Differences

```{r}
fig_no = "I.2"

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

ymin = -2000
ymax = 2000
metric = "median"

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  )) %>% ungroup()

total = total %>%
  pivot_wider(
    names_from = scenario, values_from = value
  ) %>%
  mutate(abs_dif = IRA - `No IRA`)

low <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  )) %>% ungroup()

low = low %>%
  pivot_wider(
    names_from = scenario, values_from = value
  ) %>%
  mutate(abs_dif = IRA - `No IRA`)

high <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))%>% ungroup()

high = high %>%
  pivot_wider(
    names_from = scenario, values_from = value
  ) %>%
  mutate(abs_dif = IRA - `No IRA`)


individual <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 1
  ))%>% ungroup()

individual = individual %>%
  pivot_wider(
    names_from = scenario, values_from = value
  ) %>%
  mutate(abs_dif = IRA - `No IRA`)

##### All Total #####

df_30 = total %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif)) %>%
  mutate(scenario = "IRA")
  

df_35 = total %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  
# 
# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_total <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")


dots_Total = ggplot(data = data_total, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    facet_wrap(~"Total Generation") +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Difference in Generation (TWh) from No IRA") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

savedata(data_total, paste(fig_no, "Total"))

##### Low Total #####


df_30 = low %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  
df_35 = low %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  
# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_Low <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Low = ggplot(data = data_Low, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Low or Zero Emitting Generation") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Low, paste(fig_no, "Low"))

##### High Total #####
 
  

df_30 = high %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")

df_35 = high %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

data_High <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_High = ggplot(data = data_High, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"High Emitting Generation") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_High, paste(fig_no, "High"))

##### Nuclear #####
 
  

df_30 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Nuclear <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Nuclear = ggplot(data = data_Nuclear, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Nuclear") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Nuclear, paste(fig_no, "Nuclear"))

##### Solar #####
 
  

df_30 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Solar <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Solar = ggplot(data = data_Solar, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Solar") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Solar, paste(fig_no, "Solar"))

##### Wind #####
 
  

df_30 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Wind <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Wind = ggplot(data = data_Wind, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Wind") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Difference in Generation (TWh) from No IRA") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Wind, paste(fig_no, "Wind"))

##### CCS #####
 
  

df_30 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_CCS <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_CCS = ggplot(data = data_CCS, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"CCS") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_CCS, paste(fig_no, "CCS"))

##### Coal #####
 
  

df_30 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Coal <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Coal = ggplot(data = data_Coal, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Coal") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    labs(y = "Difference in Generation (TWh) from No IRA") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.x = element_blank(),
          axis.title.y = element_text(size = 7),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Coal, paste(fig_no, "Coal"))

##### Gas #####
 
  

df_30 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Gas <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Gas = ggplot(data = data_Gas, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Natural Gas") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Gas, paste(fig_no, "Gas"))

##### Other #####
 
  

df_30 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

df_35 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  summarise(mean = mean(abs_dif),
            median = median(abs_dif))%>%
  mutate(scenario = "IRA")
  

# mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
# mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
# 
# median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
# median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
# 
# stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
#                    "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_30, df_35) 

 

data_Other <- data %>%
  mutate(axe = case_when(
    year == 2030 ~ 1, 
    year == 2035 ~ 2
  )) %>%
  mutate(scenario = "IRA")

dots_Other = ggplot(data = data_Other, aes(x = axe, y = abs_dif)) +
  geom_point(aes(alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    geom_hline(aes(yintercept=0), color = "#9E9E9E", size = 0.75) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = c(-2000, -1000, 0, 1000, 2000), labels = scales::comma) +
    facet_wrap(~"Other") +
    scale_x_continuous(breaks = c(1,2), labels = c("2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)
savedata(data_Other, paste(fig_no, "Other"))

##### Final #####
final = (dots_Total | dots_Low | dots_High) / (dots_Wind | dots_Solar | dots_Nuclear | dots_CCS) / (dots_Coal | dots_Gas | dots_Other) 

final = final + 
  plot_layout(
  guides = "collect"
) & theme(legend.position = "bottom")
final

savefig(final, fig_no, wd = 8)

```


## Appendix alpha - capital costs
```{r} 
fig_no = "alpha.1"
dta = read_csv("./data-extra/ira_comparison_raw/costs_raw.csv")
#View(dta)

subpalettes = create_subpalettes(figmap_leep_timeseries, config)
subpalettes$`Sox pct diff`[["NREL 2022 ATB"]] = "black"
subpalettes$`Sox pct diff`[["NREL 2022 ATB - Con."]] = "black"
subpalettes$`Sox pct diff`[["NREL 2022 ATB - Mod."]] = "black"
subpalettes$`Sox pct diff`[["NREL 2022 ATB - Adv."]] = "black"


tech_renamer = c(
  "Utility-Scale Solar PV" = "Solar PV",
  "Wind Onshore" = "Onshore Wind",
  "NGCC with CCS" = "NGCC with CCS",
  "NGCC" = "NGCC",
  "Battery Storage (4-Hour)" = "Battery (4-Hour)",
  "Coal CCS Retrofit" = "Coal with CCS"
)

dta = dta %>%
  pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "value") %>%
  mutate(version = case_when(
    model == "NREL 2022 ATB - Adv." ~ "Advanced",
    model == "NREL 2022 ATB - Mod." ~ "Moderate",
    model == "NREL 2022 ATB - Con." ~ "Conservative",
    TRUE ~ "Moderate"
  )) %>%
  mutate(model = case_when(
    model == "NREL 2022 ATB - Adv." ~ "NREL 2022 ATB - Adv.",
    model == "NREL 2022 ATB - Mod." ~ "NREL 2022 ATB - Mod.",
    model == "NREL 2022 ATB - Con." ~ "NREL 2022 ATB - Con.",
    TRUE ~ model
  ))

dta_top = dta %>%
  filter(!(variable %in% c("NGCC with CCS", "Coal CCS Retrofit"))) %>%
  filter(!is.na(value))

dta_bottom = dta %>%
  filter((variable %in% c("NGCC with CCS", "Coal CCS Retrofit"))) %>%
  filter(!is.na(value))

p = dta_top %>% ggplot() +
  geom_line(aes(x = year, y = value, color = model, linetype = version, group = interaction(model, version)),
            linewidth = 1) +
  scale_y_continuous(name = expression("Capital Cost (2020$/kW)"), labels = scales::comma) +
  scale_subpalette(subpalettes, "Sox pct diff") +
  scale_linetype_manual(values = c("longdash","solid","dotted"), breaks = c("Advanced", "Moderate", "Conservative"), guide = FALSE) +
  facet_grid(. ~ variable, labeller = labeller(variable = tech_renamer)) +
  theme_emf() +
  theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(), strip.text.x = element_text(face = "plain"))
        
p

p2 = dta_bottom %>% ggplot() +
  geom_line(aes(x = year, y = value, color = model, linetype = version, group = interaction(model, version)),
            linewidth = 1) +
  scale_y_continuous(name = expression("Capital Cost (2020$/kW)"), labels = scales::comma) +
  scale_subpalette(subpalettes, "Sox pct diff") +
  scale_linetype_manual(values = c("longdash","solid","dotted"), breaks = c("Advanced", "Moderate", "Conservative"), guide = FALSE) +
  facet_grid(. ~ variable, labeller = labeller(variable = tech_renamer), scales = "free_y") +
  theme_emf() +
  theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(), strip.text.x = element_text(face = "plain"))

p2

savefig(p,fig_no)
fig_no = "alpha.2"
savefig(p2,fig_no)
```



