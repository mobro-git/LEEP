---
title: "Appendix"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(figmap_leep_diffbar)

# palettes
subpalettes = create_subpalettes(figmap_leep_timeseries, config)
```

# Appendix A


## Emissions Summary Tables

```{r}
tab_a1 = summary_tables(
  table_no = "A1 Economy-Wide Emissions",
  var = "Emissions|CO2",
  suffix = "Economy-wide emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)
tab_a1

tab_a2 = summary_tables(
  table_no = "A2 Power Sector Emissions",
  var = "Emissions|CO2|Energy|Supply|Electricity",
  suffix = "Power sector emissions",
  drop_mod = c("Scout-LEEP"),
  drop_datasrc = c("ReEDS_compiled.csv"), # remove duplicate values for ReEDS-NREL - basically same values
  data = clean_data,
  config = config
)

tab_a3 = summary_tables(
  table_no = "A3 Transportation Emissions",
  var = "Emissions|CO2|Energy|Demand|Transportation|Total",
  suffix = "Transportation emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)

tab_a4 = summary_tables(
  table_no = "A4 Buildings Emissions",
  var = "Emissions|CO2|Energy|Demand|Buildings|Total",
  suffix = "Buildings emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Haiku-RFF"),
  data = clean_data,
  config = config
)

tab_a5 = summary_tables(
  table_no = "A5 Industry Emissions",
  var = "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
  suffix = "Industry emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  data = clean_data,
  config = config
)
```
## Table ES1 - for lack of a better place to put it
```{r}
fig_no = "ES.1"

tab_es1_ew = summary_tables(
  table_no = "ES1 Economy-Wide Emissions",
  var = "Emissions|CO2",
  suffix = "Economy-wide emissions",
  drop_mod = c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  short_circuit = TRUE,
  data = clean_data,
  config = config
)

ew_ira = (tab_es1_ew$IRA) %>% 
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

ew_noira = (tab_es1_ew$noIRA) %>%
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

tab_es1_elec = summary_tables(
  table_no = "ES1 Power Sector Emissions",
  var = "Emissions|CO2|Energy|Supply|Electricity",
  suffix = "Power sector emissions",
  drop_mod = c("Scout-LEEP"),
  drop_datasrc = c("ReEDS_compiled.csv"), # remove duplicate values for ReEDS-NREL - basically same values
  short_circuit = TRUE,
  data = clean_data,
  config = config
)

elec_ira = (tab_es1_elec$IRA) %>% 
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

elec_noira = (tab_es1_elec$noIRA) %>%
  select(year, min_diff_2005, median_diff_2005, max_diff_2005) %>%
  filter(year %in% c(2030, 2035))

es1_full = bind_cols(bind_rows(ew_noira, elec_noira), bind_rows(ew_ira, elec_ira), 
                     data.frame("sector" = c("a","a","b","b"))) %>%
  select(-year...5)
                       
                       
                       
  #                      expression(paste("Economy-Wide C", O[2], " from Energy Use")),
  #                                            expression(paste("Economy-Wide C", O[2], " from Energy Use")), 
  #                                            expression(paste("Power Sector C", O[2])), 
  #                                            expression(paste("Power Sector C", O[2]))))) %>%
  # select(-year...5)

colnames(es1_full) = c("Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r", "Sector")
es1_full = es1_full %>% group_by(Sector)

table_es1 = es1_full %>% gt() %>%
  tab_header(
    title = gt::html("Multi-model range of emission reductions<br>(% reduction from 2005)")
  ) %>%
  tab_spanner(label = "No IRA", columns = c(Min, Median, Max)) %>%
  tab_spanner(label = "IRA", columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
  cols_label() %>% 
  tab_row_group(label = gt::html("Economy-Wide CO<sub>2</sub> from Energy Use"),
                rows = 1:2, id = "ew") %>%
  tab_row_group(label = gt::html("Power Sector CO<sub>2</sub>"),
                rows = 3:4, id = "elec") %>%
  row_group_order(groups = c("ew","elec")) %>%
  tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(1,4))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold")
      ), locations = cells_body(columns = c(1))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "normal", color = "black", align = "left"),
        cell_fill(color = "#C9C9C9")
      ), locations = cells_row_groups()
    ) %>% fmt_number(decimals = 0, use_seps = TRUE, columns = 2:7)

table_es1

table_es1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table_es1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))


```

# Appendix D

## Emissions reudctions by end use type from scout modeling

```{r}
fig_no = "D.1"

data <- read.csv("./data-extra/scout_buildings_IRA_scenario_emissions_wedges.csv")

data_sort <- data %>%
  filter(year <= 2035) %>%
  filter(year >= 2025) %>%
  mutate(scenario = case_when(
    scenario == "IRA-Low" ~ "Low", 
    scenario == "IRA-Central" ~ "Central", 
    scenario == "IRA-High" ~ "High"
  )) %>%
  rename(Reference = `Reference.Building.Emissions`,
         Total = `Total.Building.Emissions`, 
         Power = `Power.Supply.Decarbonization`, 
         WaterHeating = `Water.Heating`, 
         HVAC = HVAC.Env) %>%
  pivot_longer(
    cols = c(Reference, Total, Power, Other, WaterHeating, HVAC), names_to = "variable_rename"
  )
  
ref <- data_sort[data_sort$variable_rename == "Reference",]

data_sort$scenario <- factor(data_sort$scenario, levels = c("Low", "Central", "High"))
data_sort$variable_rename <- factor(data_sort$variable_rename, levels = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"))

fin = ggplot(data = data_sort[data_sort$variable_rename != "Reference",] , aes(x=year, y=value, fill = variable_rename)) +
  geom_area() +
  facet_grid(~scenario) +
  labs(title = "",
         x = "",
         y = expression(paste("Emissions (Mt C", O[2], "/yr)")),
         color = "") +
    scale_y_continuous(limits = c(0, 1500), labels = scales::comma, expand = c(0,0)) +
    theme_emf() +
    scale_x_continuous(breaks = c(2025, 2030, 2035)) + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") + 
  guides(fill = guide_legend(nrow = 2)) + 
  scale_fill_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("HVAC", "WaterHeating", "Other", "Power", "Total") 
  ) + 
  geom_line(data = data_sort[data_sort$variable_rename == "Reference",],  aes(x=year, y=value, color = variable_rename),linetype="dashed") +
  scale_color_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","ower", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("Reference") 
  )
fin

data_sort = data_sort %>% mutate(figure_num = fig_no)

saveall(fin, data_sort, fig_no, wd = 9)
```

# Appendix F

## Emissions

### Economy-Wide

```{r}
fig_no = "Ap.1.EconWideEmis"

ts_map_ID = 99
pd_map_ID = 25
ad_map_ID = 3
drop = ""
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 2950
ymax = 5050
brk = c(3000, 4000, 5000)

fig = four_corners("Economy-wide CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Electricity

```{r}
fig_no = "Ap.2.ElecEmis"

ts_map_ID = 98
pd_map_ID = 26
ad_map_ID = 4
drop = ""
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 300
ymax = 1650
brk = c(400, 800, 1200, 1600)

fig = four_corners("Electricity CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Transportation

```{r}
fig_no = "Ap.3.TranEmis"

ts_map_ID = 19
pd_map_ID = 27
ad_map_ID = 5
drop = c("IPM-EPA","IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 1150
ymax = 1900
brk = c(1200, 1500, 1800)

fig = four_corners("Transportation CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Building

```{r}
fig_no = "Ap.4.BuilEmis"

ts_map_ID = 23
pd_map_ID = 29
ad_map_ID = 7
drop = c("IPM-EPA", "IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 400
ymax = 1800
brk = c(400, 800, 1200, 1600)

fig = four_corners("Buildings CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Industry

```{r}
fig_no = "Ap.5.IndEmis"

ts_map_ID = 21
pd_map_ID = 28
ad_map_ID = 6
drop = c("IPM-EPA", "IPM-NRDC")
histsrc = "EPA-GHGI"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 500
ymax = 1600
brk = c(500, 1000, 1500)

fig = four_corners("Industry CO2 Emissions",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)

```

## Primary Energy

### Coal

```{r} 
fig_no = "Ap.6.Coal"

ts_map_ID = 94
pd_map_ID = 32
ad_map_ID = 20
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 0
ymax = 20
brk = c(0, 5, 10, 15, 20)

fig = four_corners("Emissions from Coal",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Gas

```{r} 
fig_no = "Ap.7.Gas"

ts_map_ID = 93
pd_map_ID = 31
ad_map_ID = 21
drop = c("EIAinEMF37.csv", "RIO-REPEAT")
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 20
ymax = 35
brk = c(20, 25, 30, 35)

fig = four_corners("Emissions from Gas",ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Petroleum

```{r} 
fig_no = "Ap.8.Petrol"

ts_map_ID = 92
pd_map_ID = 30
ad_map_ID = 22
drop = "EIAinEMF37.csv"
histsrc = "EIA"
metric = "Emissions"
unit = "Mt CO2/yr"
ymin = 20
ymax = 40
brk = c(20, 30, 40)

fig = four_corners("Emissions from Petroleum", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

## Generation

### Nuclear

```{r} 
fig_no = "Ap.9.NuclearGen"

ts_map_ID = 91
pd_map_ID = 80
ad_map_ID = 8
drop = "EIAinEMF37.csv"
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 850
brk = c(0, 200, 400, 600, 800)

fig = four_corners("Electricity Generation from Nuclear", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Solar

```{r} 
fig_no = "Ap.10.SolarGen"

ts_map_ID = 90
pd_map_ID = 79
ad_map_ID = 9
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 100
ymax = 2200
brk = c(500, 1000, 1500, 2000)

fig = four_corners("Electricity Generation from Solar", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Wind

```{r} 
fig_no = "Ap.11.WindGen"

ts_map_ID = 89
pd_map_ID = 78
ad_map_ID = 10
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 350
ymax = 2600
brk = c(500, 1000, 1500, 2000, 2500)

fig = four_corners("Electricity Generation from Wind", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### CCS

```{r} 
fig_no = "Ap.12.CCSGen"

#there is no historic data here so gotta do a lil manual work
ts_map_ID = 85
pd_map_ID = 76
ad_map_ID = 14
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
unit = "Generation (Quads)"
ymin = 0
ymax = 5
brk = c(0, 1, 2, 3, 4, 5)

#Time Series Dataframe
ts_df = data_from_graph(
  "time_series",
  config,
  clean_data,
  figmap_leep_timeseries,
  ts_map_ID,
  "United States"
) %>%
  filter(!model %in% drop) %>%
  filter(!datasrc %in% drop) %>%
  filter(year >= 2021) %>%
  filter(year <= 2021 &
           model == histsrc |
           year > 2021 & scenario != "Historic") %>%
  group_by(model, scenario, year, variable_rename) %>%
  summarize(value = sum(value)) %>%
  pivot_wider(names_from = year, values_from = value)

ts_df = ts_df %>%
  mutate(`2021` = 0) %>%
  pivot_longer(cols = starts_with("20"),
               names_to = "year",
               values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))

noIRAmedians = ts_df[ts_df$scenario == "No IRA", ] %>%
  filter(year == 2030 | year == 2035) %>%
  group_by(year) %>%
  summarize(median = median(value))

IRAmedians = ts_df[ts_df$scenario == "IRA", ] %>%
  filter(year == 2030 | year == 2035) %>%
  group_by(year) %>%
  summarize(median = median(value))

NoIRAfigure = ggplot(ts_df[ts_df$scenario == "No IRA",], aes(year, value, color = model)) +
  geom_line(size = 0.75) +
  scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
  theme_emf() +
  scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
  labs(title = "No IRA",
       y = unit,
       x = element_blank()) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_point(aes(x = 2021, y = ts_df$value[ts_df$year == 2021][1]), color = "black") +
  geom_point(
    data = noIRAmedians,
    aes(x = year, y = median),
    color = "black",
    shape = 16,
    size = 2
  )

IRAfigure = ggplot(ts_df[ts_df$scenario == "IRA",], aes(year, value, color = model)) +
  geom_line(size = 0.75) +
  scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
  theme_emf() +
  scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
  labs(title = "IRA",
       y = unit,
       x = element_blank()) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_point(aes(x = 2021, y = ts_df$value[ts_df$year == 2021][1]), color = "black") +
  geom_point(
    data = IRAmedians,
    aes(x = year, y = median),
    color = "black",
    shape = 16,
    size = 2
  )

#Percent Difference

pdfigure = pd(pd_map_ID, "", expression(paste("Percent Difference (%)")), "none", drop)

#Absolute Difference
adfigure = ad(diff_ID = ad_map_ID, "", expression(paste("Absolute Difference (Quads)")), "none", drop)

fig = (NoIRAfigure |
         IRAfigure) / (adfigure$figure | pdfigure$figure) +
  plot_layout(guides = "collect") +
  plot_annotation(title = "Electricity Generation from Coal with CCS")

fig

# TODO: This entire figure is broken and saves off data that doesnt exist. I fixed the figure, but the whole thing should be rewritten to fit the format of the rest of the figures and actually output the correct data

write.csv(
  fig$ts_df,
  file = paste("output/final_figures/data/Fig", fig_no, "a_Scen.csv", sep =
                 ""),
  row.names = FALSE
)
write.csv(
  fig$pd_df,
  file = paste(
    "output/final_figures/data/Fig",
    fig_no,
    "b_PercDiff.csv",
    sep = ""
  ),
  row.names = FALSE
)
write.csv(
  fig$ad_df,
  file = paste(
    "output/final_figures/data/Fig",
    fig_no,
    "c_AbsDiff.csv",
    sep = ""
  ),
  row.names = FALSE
)

savefig(fig, fig_no)
```

### Coal

```{r} 
fig_no = "Ap.13.CoalGen"

ts_map_ID = 82
pd_map_ID = 71
ad_map_ID = 17
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 1100
brk = c(0, 250, 500, 750, 1000)


fig = four_corners("Coal Generation", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Gas

```{r} 
fig_no = "Ap.14.GasGen"

ts_map_ID = 81
pd_map_ID = 70
ad_map_ID = 18
drop = c("EIAinEMF37.csv", "NEMS-EIA")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 0
ymax = 2500
brk = c(0, 500, 1000, 1500, 2000, 2500)


fig = four_corners("Electricity Generation from Gas", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

fig$figure

write.csv(fig$ts_df, file = paste("output/final_figures/data/Fig",fig_no,"a_Scen.csv",sep=""), row.names = FALSE)
write.csv(fig$pd_df, file = paste("output/final_figures/data/Fig",fig_no,"b_PercDiff.csv",sep=""), row.names = FALSE)
write.csv(fig$ad_df, file = paste("output/final_figures/data/Fig",fig_no,"c_AbsDiff.csv",sep=""), row.names = FALSE)

savefig(fig$figure, fig_no)
```

### Other

```{r}
fig_no = "Ap.15.OtherGen"

ts_map_ID = 88
pd_map_ID = 77
ad_map_ID = 11
drop = c("EIAinEMF37.csv")
histsrc = "EIA"
metric = "Generation"
unit = "TWh"
ymin = 250
ymax = 500
brk = c(250, 375, 500)


fig = four_corners("Electricity Generation from Other", ts_map_ID, pd_map_ID, ad_map_ID, drop, histsrc, metric, unit, fig_no, ymin, ymax, brk)

abdata = fig$ts_df %>%
  group_by(model, year) %>%
  summarize(abdif = value[scenario == "IRA"] - value[scenario == "No IRA"])

  hist <- abdata %>%
    group_by(model) %>%
    slice(1) %>%
    mutate(scenario = "Historic",
           diff = 0,
           year = 2021)
  
    medians = abdata %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(abdif))
    
    abdata <- rbind(abdata, hist)

adfigure = ggplot() +
    geom_line(data = abdata,
              aes(
                x = year,
                y = abdif,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA")+
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    labs(title = "",
         x = "",
         y = "Absolute Difference (TWh)") 

pbdata = fig$ts_df %>%
  group_by(model, year) %>%
  summarize(pbdif = (value[scenario == "IRA"] - value[scenario == "No IRA"])/value[scenario=="No IRA"])

  hist <- pbdata %>%
    group_by(model) %>%
    slice(1) %>%
    mutate(scenario = "Historic",
           diff = 0,
           year = 2021)
  
    medians = pbdata %>%
    filter(year %in% c(2030, 2035)) %>%
    group_by(year) %>%
    summarize(median = median(pbdif))
    
    pbdata <- rbind(pbdata, hist)

pdfigure = ggplot() +
    geom_line(data = pbdata,
              aes(
                x = year,
                y = pbdif,
                group = model,
                color = model
              ),
              size = 0.75) +
    geom_point(aes(x = 2021, y = 0), color = "black") +
    geom_point(
      data = medians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    ) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA")+
    theme_emf() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.spacing.x = unit(4, "mm"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    labs(title = "",
         x = "",
         y = "Percent Difference (%)") 

  #Time Series Dataframe
  df = fig$ts_df
  noIRAmedians = df[df$scenario == "No IRA",] %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  IRAmedians = df[df$scenario == "IRA",] %>%
    filter(year == 2030 | year == 2035) %>%
    group_by(year) %>%
    summarize(median = median(value))

  NoIRAfigure = ggplot(df[df$scenario == "No IRA", ], aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = brk) + 
    labs(title = "No IRA",
         y = paste0(metric," (",unit,")"),
         x = element_blank()) +
    theme(legend.position = "right",
         plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = df$value[df$year == 2021][1]), color = "black") +
    geom_point(
      data = noIRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )

  IRAfigure = ggplot(df[df$scenario == "IRA", ], aes(year, value, color = model)) +
    geom_line(size = 0.75) +
    scale_subpalette(subpalettes, "Emissions|CO2|Percent difference from No IRA") +
    theme_emf() +
    scale_x_continuous(breaks = c(2021, 2025, 2030, 2035)) +
    scale_y_continuous(limits = c(ymin, ymax), breaks = brk) +
    labs(title = "IRA",
         y = paste0(metric," (",unit,")"),
         x = element_blank()) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_point(aes(x = 2021, y = df$value[df$year == 2021][1]), color = "black") +
    geom_point(
      data = IRAmedians,
      aes(x = year, y = median),
      color = "black",
      shape = 16,
      size = 2
    )
  
  figure = (NoIRAfigure | IRAfigure) / (adfigure | pdfigure) + 
    plot_layout(guides = "collect") +
    plot_annotation(title = "Electricity Generation from Other")
  
  savefig(figure, fig_no)
```

### Electricity generation by model
```{r}
# Appendix F: figure 16
fig_no = "Ap.16.Generation"

exclude_models = c()

clean_data15 = clean_data %>%
  mutate(value = case_when(
    unit == "Quads" ~ value * 293.07107,
    TRUE ~ value
  )) %>% mutate(unit = case_when(
    unit == "Quads" ~ "TWh",
    TRUE ~ unit
  )) %>%
  filter(!(model %in% exclude_models))

clean_data_hist_ira = clean_data15 %>%
  filter(model == "EIA",
         scenario == "Historic",
         datasrc == "EIA-EPA-bistline_historic.csv",
         year == 2021) %>%
  mutate(scenario = "IRA", year = 2035)

clean_data_hist_noira = clean_data15 %>%
  filter(model == "EIA",
         scenario == "Historic",
         datasrc == "EIA-EPA-bistline_historic.csv",
         year == 2021) %>%
  mutate(scenario = "No IRA", year = 2035)

clean_data15 = bind_rows(clean_data15, clean_data_hist_noira, clean_data_hist_ira)

models_alph = sort(unique(clean_data15$model))

dta = data_from_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 18, "United States")

model_renamer = c(
  "EIA" = "2021",
  "EIA-LTS" = "EIA-LTS",
  "EIA-STEO" = "EIA-STEO",
  "EPA-ATR" = "EPA-ATR",
  "EPS-EI" = "EPS-EI",
  "GCAM-CGS" = "GCAM-CGS",
  "GCAM-PNNL" = "GCAM-PNNL",
  "Haiku-RFF" = "Haiku-RFF",
  "IPM-EPA" = "IPM-EPA",
  "IPM-NRDC" = "IPM-NRDC",
  "MARKAL-NETL" = "MARKAL-NETL",
  "NEMS-EIA" = "NEMS-EIA",
  "NEMS-OP" = "NEMS-OP",
  "NEMS-RHG" = "NEMS-RHG",
  "ReEDS-NREL" = "ReEDS-NREL",
  "REGEN-EPRI" = "REGEN-EPRI",
  "RIO-REPEAT" = "RIO-REPEAT",
  "Scout-LEEP" = "Scout-LEEP",
  "USREP-ReEDS" = "USREP-ReEDS"
)

p = print_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 18, "United States",
                level_mod = models_alph) +
  facet_grid(scenario ~ model, switch = "x",labeller = labeller(
    model = model_renamer)) + 
    scale_x_continuous(breaks = c(2030, 2035), labels = c("2030", "2035"), position = "top") + 
  scale_y_continuous(expand = c(0,0), labels = scales::comma, limits = c(0,6500),
                     name = expression("Electricity Generation (TWh)")) +
  theme(axis.ticks = element_blank(), 
        strip.text.x = element_text(face = "plain", angle = 90, hjust = 1, size = 7),
        axis.text.x = element_text(hjust = 0, vjust = 0.5),
        plot.title = element_blank())


p

saveall(p, dta, fig_no)
```

### Electricity capacity by model
```{r}
# Appendix F: figure 17
fig_no = "Ap.17.Capacity"

p = print_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 15, "United States",
                level_mod = models_alph) +
  facet_grid(scenario ~ model, switch = "x",labeller = labeller(
    model = model_renamer)) + 
  scale_x_continuous(breaks = c(2030, 2035), labels = c("2030", "2035"), position = "top") + 
  scale_y_continuous(expand = c(0,0), labels = scales::comma, 
                     name = expression("Electricity Capacity (GW)")) +
  theme(axis.ticks = element_blank(), 
        strip.text.x = element_text(face = "plain", angle = 90, hjust = 1, size = 7),
        axis.text.x = element_text(hjust = 0, vjust = 0.5))

dta = data_from_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 15, "United States")

p

saveall(p, dta, fig_no)


```
### Electricity generation difference from noIRA
```{r}
# Appendix F: figure 18
fig_no = "2.4"

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

dta = data_from_graph("stacked_bar", config, clean_data15, figmap_leep_stackbar, 18, "United States")

dta_ira = dta %>% filter(scenario == "IRA") %>%
  ungroup() %>%
  select(model, year, variable_rename, value) %>%
  rename(value_ira = value)

dta_noira = dta %>% filter(scenario == "No IRA") %>%
  ungroup() %>%
  select(model, year, variable_rename, value) %>%
  rename(value_noira= value)

dta_full = dta_ira %>% inner_join(dta_noira, by = c("model", "year", "variable_rename")) %>%
  mutate(diff = value_ira - value_noira) %>%
  mutate(model = factor(model, levels = models_alph)) %>%
  pivot_longer(cols = c("value_ira", "value_noira", "diff"), names_to = "metric") %>%
  filter(metric != "value_noira") %>%
  mutate(metric = factor(metric, levels = c("value_ira", "diff")))
# pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%

facet_renamer = c(
  "value_ira" = "IRA",
  "diff" = "Difference from No IRA"
)

p = dta_full %>% ggplot() +
  geom_bar(aes(x = year, y = value, fill = variable_rename), 
           position="stack", stat="identity") + 
  geom_hline(yintercept = 0, color = "black", linewidth = 0.5) +
  scale_x_continuous(breaks = c(2030, 2035), labels = c("2030", "2035"), position = "top") + 
  scale_y_continuous(expand = expansion(mult = c(0.02,0.02)), labels = scales::comma, #limits = c(-3000, 7500),
                    name = expression("Difference in Generation from No IRA (TWh)")) +
  # facetted_pos_scales(
  #   y = list(
  #     metric == "value_ira" ~ scale_y_continuous(limits = c(0,6500), expand = expansion(mult = c(0.02, 0.02)), labels = scales::comma,
  #                                                name = expression("Difference in Generation from No IRA (TWh)")),
  #     metric == "diff" ~ scale_y_continuous(limits = c(-3100,6500))
  #   )) +
  scale_subpalette(subpalettes, "Electricity Generation") +
  facet_grid(metric ~ model, switch = "x", labeller = labeller(metric = facet_renamer, model = model_renamer), scales = "free_y") +
  theme_emf() + 
  theme(axis.ticks = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1),
        strip.text.x = element_text(face = "plain", angle = 90, hjust = 1, size = 7),
        axis.title.x = element_blank())

p

saveall(p, dta_full, fig_no)

```
```{r}
# Figure 2.4 - ira on top, differences on the bottom
```
-# Appendix G 6


## Electrification Figure

```{r}
elc = readxl::read_xlsx("data-extra/electrification_compiled.xlsx") %>%
  rename(value = value100) %>%
  select(-variable) %>%
  rename(variable = variable_rename) %>%
  mutate(variable = case_when(
    variable == "Total" ~ "Economy-Wide",
    TRUE~variable
  ))

vars = c("Final Energy|Percent Electricity", 
         "Final Energy|Buildings|Percent Electricity",
         "Final Energy|Industry and Fuel Production|Percent Electricit+",
         "Final Energy|Transportation|Percent Electricity")

ref_elc = clean_data %>%
  filter(variable %in% c(vars, "Final Energy|Industry|Percent Electricity") & 
           year == 2020 & 
           model == "AEO2021") %>%
  mutate(value = case_when(
    variable == "Final Energy|Buildings|Percent Electricity" ~ 0.47, # number from Chioke, our number is wrong
    variable == "Final Energy|Industry|Percent Electricity" ~ 0.13, # number calculated from AEO 2021, ~3 quads elc ~25 quads total
    TRUE~value)) %>%
  mutate(variable = case_when(
    variable == "Final Energy|Industry|Percent Electricity" ~ "Final Energy|Industry and Fuel Production|Percent Electricity",
    TRUE~variable
  )) %>%
  select(model,scenario,year,value,variable) %>%
  mutate(
    value = value * 100,
    variable = case_when(
      variable == "Final Energy|Percent Electricity" ~ "Economy-Wide",
      variable == "Final Energy|Buildings|Percent Electricity" ~ "Buildings",
      variable == "Final Energy|Industry and Fuel Production|Percent Electricity" ~ "Industry",
      variable == "Final Energy|Transportation|Percent Electricity" ~ "Transportation",
      TRUE ~ variable
    ))

elc_raw = rbind(elc, ref_elc) 

hist = ref_elc %>% select(year, variable, value) %>%
  pivot_wider(names_from = "year", values_from = "value")

replace_hist = elc_raw %>%
  filter(model != "AEO2021") %>%
  full_join(hist, by = c("variable")) %>%
  select(model,scenario,variable,`2020`) %>%
  pivot_longer(cols = `2020`, names_to = "year", values_to = "value") %>%
  distinct()

elc_ts = rbind(elc_raw, replace_hist) %>%
  filter(model != "AEO2021" &
           year <= 2035) %>%
  mutate(variable = factor(variable, levels = c("Economy-Wide", "Transportation", "Buildings", "Industry")))

ggplot() +
  geom_line(data = elc_ts, aes(x = year, y = value, color = scenario, group = interaction(model,scenario))) +
  facet_grid(~variable) +
  theme_emf() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_subpalette(subpalettes, "Final Energy") +
  labs(y = "% Electricity of Final Energy",
       x="")
# TODO: save off this data for the final report
# TODO: remove REGEN from industry, apples to oranges
```

## Tables

### % Share Tables

```{r}
per_share_wb <- createWorkbook()

stats = elc_ts %>%
  filter(year != 2020) %>%
  mutate(year = as.character(year)) %>%
  group_by(scenario, variable, year) %>%
  summarise(Median = round(median(value),2),
            Min = round(min(value),2),
            Max = round(max(value),2)) %>%
  rename(Sector = variable,
         Year = year)

total = stats %>%
  filter(Sector == "Economy-Wide") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
total

write_sheet(total, per_share_wb, "Total")

transportation = stats %>%
  filter(Sector == "Transportation") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
transportation

write_sheet(transportation, per_share_wb, "Transportation")

buildings = stats %>%
  filter(Sector == "Buildings") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
buildings

write_sheet(buildings, per_share_wb, "Buildings")

industry = stats %>%
  filter(Sector == "Industry") %>%
  pivot_longer(cols = 4:6, names_to = "Statistic", values_to = "value") %>%
  pivot_wider(names_from = "scenario", values_from = "value")
industry

write_sheet(industry, per_share_wb, "Industry")

all = rbind(total, transportation, buildings, industry) %>%
  mutate(`IRA` = `IRA`/100,
         `No IRA` = `No IRA`/100)

write_sheet(all, per_share_wb, "All")

saveWorkbook(per_share_wb, file = "output/final_figures/data/electrification_percentshare.xlsx", overwrite = TRUE)
```
```{R}
# display table for appendix G1
fig_no = "G1 Electricity Share.1"
tab_dta = all %>% 
  data.frame() %>%
  pivot_wider(names_from = Statistic, values_from = c(IRA, No.IRA)) %>%
  select(c(Sector, Year, No.IRA_Min, No.IRA_Median, No.IRA_Max, IRA_Min, IRA_Median, IRA_Max))
colnames(tab_dta) = c("Sector", "Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r")
col_names = c("","No IRA", "IRA")

table1 = tab_dta %>% gt() %>%
    tab_header(
      title = gt::html("Summary of Electricity Share (%) of Final Energy")
    ) %>%
    tab_spanner(label = col_names[2], columns = c(Min, Median, Max)) %>%
    tab_spanner(label = col_names[3], columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
    cols_label() %>%
    tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(1:3, 7:9))
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "all", color = "white"),
        cell_fill(color = "white", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(4:6, 10:12))
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(2,5))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold", align = "left")
      ), locations = cells_body(columns = 1:2)
    ) %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:8)
    
table1

table1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table1 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))

```
### % Difference in Share IRA vs No IRA Tables

```{r}
diff_wb <- createWorkbook()

stats_per = elc_ts %>%
  filter(year != 2020) %>%
  pivot_wider(names_from = "scenario", values_from = "value") %>%
  mutate(
    pp_diff = round((`IRA` - `No IRA`),2),
    per_diff = round(((pp_diff/`No IRA`)*100),2)) %>%
  select(model,year,variable,pp_diff,per_diff) %>%
  pivot_longer(cols = 4:5, names_to = "stat", values_to = "value") %>%
  group_by(year,variable,stat) %>%
  summarise(
    Median = median(value),
    Min = min(value),
    Max = max(value)
  ) %>%
  rename(indicator = stat) %>%
  pivot_longer(cols = 4:6, names_to = "stat", values_to = "value") %>%
  pivot_wider(names_from = "indicator", values_from = "value") %>%
  rename(`Percentage Point Difference` = pp_diff,
         `Percent Difference` = per_diff,
         Year = year,
         Statistic = stat,
         Sector = variable) %>%
  select(Sector, Year, Statistic, `Percent Difference`, `Percentage Point Difference`)

total_per = stats_per %>% filter(Sector == "Economy-Wide")
total_per

write_sheet(total_per, diff_wb, "Economy-Wide")

transportation_per = stats_per %>% filter(Sector == "Transportation")
transportation_per

write_sheet(transportation_per, diff_wb, "Transportation")

buildings_per = stats_per %>% filter(Sector == "Buildings")
buildings_per

write_sheet(buildings_per, diff_wb, "Buildings")

industry_per = stats_per %>% filter(Sector == "Industry")
industry_per

write_sheet(industry_per, diff_wb, "Industry")

all_per = rbind(total_per, transportation_per, buildings_per, industry_per) %>%
  mutate(`Percent Difference` = `Percent Difference`/100,
         `Percentage Point Difference` = paste(`Percentage Point Difference`, "pp"))

write_sheet(all_per, diff_wb, "All")

saveWorkbook(diff_wb, file = "output/final_figures/data/electrification_differences.xlsx", overwrite = TRUE)
```
```{R}
# display table for appendix G2
fig_no = "G1 Electricity Share.2"
tab_dta = all_per %>% 
  data.frame() %>%
  pivot_wider(names_from = Statistic, values_from = c(Percent.Difference, Percentage.Point.Difference)) %>%
  select(c(Sector, Year, Percent.Difference_Min, Percent.Difference_Median, Percent.Difference_Max,
           Percentage.Point.Difference_Min, Percentage.Point.Difference_Median,
           Percentage.Point.Difference_Max))
colnames(tab_dta) = c("Sector", "Year", "Min", "Median", "Max", "Min\r", "Median\r", "Max\r")
col_names = c("","Percent Difference", "Percentage Point Difference")

table2 = tab_dta %>% gt() %>%
    tab_header(
      title = gt::html("Differences in Electricity Share of Final Energy Between IRA and No IRA Scenarios")
    ) %>%
    tab_spanner(label = col_names[2], columns = c(Min, Median, Max)) %>%
    tab_spanner(label = col_names[3], columns = c(`Min\r`, `Median\r`, `Max\r`)) %>%
    cols_label() %>%
    tab_style(
      style = list(
        cell_borders(sides = "all", color = "#F2F2F2"),
        cell_fill(color = "#F2F2F2", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(1:3, 7:9))
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "all", color = "white"),
        cell_fill(color = "white", alpha = NULL),
        cell_text(align = "center")
      ), locations = cells_body(rows = c(4:6, 10:12))
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "normal", align = "center")
      ), locations = cells_column_labels()
    ) %>% tab_style(
      style = list(
        cell_fill(color = "black"),
        cell_text(color = "white", weight = "bold")
      ), locations = cells_column_spanners()
    ) %>% tab_style(
      style = list(
        cell_borders(sides = "right", color = "#DCDCDC", weight = "2px")
      ), locations = cells_body(columns = c(2,5))
    ) %>% tab_style(
      style = list(
        cell_text(weight = "bold", align = "left")
      ), locations = cells_body(columns = 1:2)
    ) %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:8)
    
table2

table2 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
table2 %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))

```


## Gas and Coal generation capacity factors
```{r}
# Table X.1: Gas and Coal generation
fig_no = "Ap.X.1"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

exclude_models_bistline = c(
  "ReEDS-NREL",
  "IPM-ERA"
)

generation_data_bis = clean_data %>%
  filter(datasrc == "bistline_ira_tall.csv", 
         !(model %in% exclude_models_bistline),
  variable %in% c(
    #"Secondary Energy|Electricity|Coal|w/ CCS",
    "Secondary Energy|Electricity|Coal|w/o CCS",
    #"Secondary Energy|Electricity|Gas|w/ CCS",
    "Secondary Energy|Electricity|Gas|w/o CCS"
  )) %>%
  mutate(variable = case_when(
    grepl("Coal",variable) ~ "Secondary Energy|Electricity|Coal",
    TRUE ~ "Secondary Energy|Electricity|Gas"
  )) %>% group_by(model, scenario, unit, year, datasrc, variable, region) %>%
  summarize(value = sum(value)) %>% ungroup()

generation_data_other = clean_data %>%
  filter(variable %in% c("Secondary Energy|Electricity|Coal", 
                         "Secondary Energy|Electricity|Gas"))

generation_data = bind_rows(generation_data_bis, generation_data_other) %>%
  filter(year %in% c(2030, 2035),
         !(model %in% exclude_models),
         scenario %in% c("IRA","No IRA","Core")) %>%
  # convert from quads to TWh
  mutate(value = value * 293.07107,
         unit = "TWh") %>%
  mutate(scenario = case_when(
    scenario == "Core" ~ "IRA",
    TRUE ~ scenario
  )) %>%
  select(-c(region, datasrc, unit)) %>%
  mutate(variable = case_when(
    variable == "Secondary Energy|Electricity|Coal" ~ "Coal",
    TRUE ~ "Gas"
  )) %>%
  pivot_wider(names_from = c("scenario", "year"), values_from = value) %>%
  arrange(model, variable) %>% 
  select(c("model", "variable", "No IRA_2030", "No IRA_2035", "IRA_2030", "IRA_2035")) %>%
  group_by(variable)
  
  #pivot_wider(names_from = model, values_from = value) %>%
  #group_by(variable)
colnames(generation_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")

generation_table = gt_elec_table(generation_data, "Electricity Generation (TWh)", percent = FALSE)
generation_table

# having trouble saving this as a png for some reason...
#generation_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
generation_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))
```
Next
```{r}
# Table X.2: Gas and Coal capacity
fig_no = "Ap.X.2"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

exclude_models_bistline = c(
  "ReEDS-NREL",
  "IPM-ERA"
)

capacity_data_bis = clean_data %>%
  filter(datasrc == "bistline_ira_tall.csv", 
         !(model %in% exclude_models_bistline),
  variable %in% c(
   #"Capacity|Electricity|Coal|w/ CCS",
    "Capacity|Electricity|Coal|w/o CCS",
   #"Capacity|Electricity|Gas|w/ CCS",
    "Capacity|Electricity|Gas|w/o CCS"
  )) %>%
  mutate(variable = case_when(
    grepl("Coal",variable) ~ "Capacity|Electricity|Coal",
    TRUE ~ "Capacity|Electricity|Gas"
  )) %>% group_by(model, scenario, unit, year, datasrc, variable, region) %>%
  summarize(value = sum(value)) %>% ungroup()

capacity_data_other = clean_data %>%
  filter(variable %in% c("Capacity|Electricity|Coal", 
                         "Capacity|Electricity|Gas"))

capacity_data = bind_rows(capacity_data_bis, capacity_data_other) %>%
  filter(year %in% c(2030, 2035),
         !model %in% exclude_models,
         scenario %in% c("IRA","No IRA","Core")) %>%
  mutate(scenario = case_when(
    scenario == "Core" ~ "IRA",
    TRUE ~ scenario
  )) %>%
  select(-c(region, datasrc, unit)) %>%
  mutate(variable = case_when(
    variable == "Capacity|Electricity|Coal" ~ "Coal",
    TRUE ~ "Gas"
  )) %>%
  pivot_wider(names_from = c("scenario", "year"), values_from = value) %>%
  arrange(model, variable) %>% 
  select(c("model", "variable", "No IRA_2030", "No IRA_2035", "IRA_2030", "IRA_2035")) %>%
  group_by(variable)
  
colnames(capacity_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")

capacity_table = gt_elec_table(capacity_data, "Electricity Generation Capacity (GW)", percent = FALSE)

capacity_table

# having trouble saving this as a png for some reason...
# capacity_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
capacity_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))


```

```{r}
# Table X.3: Gas and Coal capacity factors
fig_no = "Ap.X.3"

exclude_models = c(
  "AEO2020",
  "AEO2021",
  "AEO2022"
)

# need to run the 2 above code chunks first

# generation in TWh
generation_data_temp = generation_data
colnames(generation_data_temp) = c("Model", "Generation.Fuel",
                            "Gen.NoIRA.2030","Gen.NoIRA.2035","Gen.IRA.2030","Gen.IRA.2035")
# capacity in GW
capacity_data_temp = capacity_data
colnames(capacity_data_temp) = c("Model", "Generation.Fuel",
                            "Cap.NoIRA.2030","Cap.NoIRA.2035","Cap.IRA.2030","Cap.IRA.2035")

cf_data = generation_data_temp %>% inner_join(capacity_data_temp, 
                                              by = c("Model", "Generation.Fuel")) %>%
  mutate(CF.NoIRA.2030 = ((1000 * Gen.NoIRA.2030) / (8760 * Cap.NoIRA.2030)),
         CF.NoIRA.2035 = ((1000 * Gen.NoIRA.2035) / (8760 * Cap.NoIRA.2035)),
         CF.IRA.2030 = ((1000 * Gen.IRA.2030) / (8760 * Cap.IRA.2030)),
         CF.IRA.2035 = ((1000 * Gen.IRA.2035) / (8760 * Cap.IRA.2035))) %>%
  select(-c("Cap.NoIRA.2030","Cap.NoIRA.2035","Cap.IRA.2030","Cap.IRA.2035",
            "Gen.NoIRA.2030","Gen.NoIRA.2035","Gen.IRA.2030","Gen.IRA.2035")) %>%
  filter(!(Model %in% exclude_models))

colnames(cf_data) = c("Model", "Generation.Fuel", "2030", "2035", "2030\r", "2035\r")
 
cf_data$"2035\r"[cf_data$Model == "GCAM-CGS" & cf_data$Generation.Fuel == "Coal"] = 0

cf_table = gt_elec_table(cf_data, "Electricity Generation Capacity Factors (%)", 
                         percent = TRUE, 
                         footnote_text = "GCAM-CGS coal generation and capacity are beneath 
                         rounding tolerance, so CF has been set to 0%.",
                         footnote_column = 6, footnote_row = 3)
cf_table

# having trouble saving this as a png for some reason...
# capacity_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".png"))
cf_table %>% gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,".html"))




```

