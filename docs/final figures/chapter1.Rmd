---
title: "Chapter 1: Introduction and Economy-Wide"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all(here())
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## 1.1 economy-wide co2 emissions from fossil fuel combustion by sector

```{r}
fig_no = 1.1

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

subpalettes$`Emissions Stack`[["Electricity Generation"]] = "#0388B3"
subpalettes$`Emissions Stack`[["Other Sectors"]] = "#DEDEDE"
subpalettes$`Emissions Stack`[["Non-CO2 GHGs"]] = "#469990"

df = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct", "Industry: Indirect", "Buildings: Direct", 
                                             "Buildings: Indirect", "Transportation: Direct", "Transportation: Indirect")))

df = clean_supplemental_data(df, fig_no)
  
fig = emis_stack(df, "Economy-Wide CO2 Emissions", figmap_leep_stackbar, config, econwide = TRUE)
fig

saveall(fig, df, fig_no)
```

## 1.2 economy-wide, electricity, and sector co2 emissions

```{r}
fig_no = 1.2

Econ_data = spg_clean(
  99,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

EconSpg = spg2(Econ_data,
  expression(paste("Economy-Wide C", O[2])),
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  7000,
  c(0, 2000, 4000, 6000),
  scales::comma,
  1, 
  c(2015, 4900), 
  c(2027.5, 5500), 
  c(2022, 3800), 
  config, 
  figmap_leep_timeseries) 

EconTab = html(EconSpg$data, "Economy-Wide CO<sub>2<sub>")

Elec_data = spg_clean(
  98,
  c("Scout-LEEP"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

ElecSpg = spg2(Elec_data,
  expression(paste("Electricity C", O[2])),
  "",
  gd = "none",
  0,
  7000,
  c(0, 2000, 4000, 6000),
  NULL,
  0, 
  c(2015, 4900), 
  c(2027.5, 5500), 
  c(2022, 3800), 
  config, 
  figmap_leep_timeseries)

ElecTab = html(ElecSpg$data, "Electricity CO<sub>2<sub>")

Tran_data = spg_clean(
  19,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP"),  
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

TranSpg = spg2(Tran_data,
  expression(paste("Transportation C", O[2])),
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2500,
  c(0, 1250, 2500),
  scales::comma,
  0, 
  c(2015, 1250), 
  c(2027.5, 1250), 
  c(2022, 1250), 
  config, 
  figmap_leep_timeseries)

TranTab = html(TranSpg$data, "Transportation CO<sub>2<sub>")

Ind_data = spg_clean(
  21, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP"),
  "EPA-GHGI", 
  config,
  clean_data, 
  figmap_leep_timeseries)

IndSpg = spg2(
  Ind_data, 
  expression(paste("Industry C", O[2])),
  "",
  gd = "none",
  0,
  2500,
  c(0, 1250, 2500),
  NULL, 
  0, 
  c(2021, 1250), 
  c(2021, 1250), 
  c(2021, 1250), 
  config, 
  figmap_leep_timeseries)

IndTab = html(IndSpg$data, "Industry CO<sub>2<sub>")

Buil_data = spg_clean(
  23, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL"), 
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)

BuilSpg = spg2(
  Buil_data,
  expression(paste("Building C", O[2])),
  "",
  gd = "none",
  0,
  2500,
  c(0, 1250, 2500),
  NULL, 
  0, 
  c(2021, 1250), 
  c(2021, 1250), 
  c(2021, 1250), 
  config, 
  figmap_leep_timeseries)

BuilTab = html(BuilSpg$data, "Building CO<sub>2<sub>")

# TODO: put more spacing between the top two figures and the bottom three
fig = (EconSpg$figure | ElecSpg$figure) / (TranSpg$figure | BuilSpg$figure | IndSpg$figure) +
  plot_annotation(tag_levels = list(c("", "", "Sectoral Emissions: Direct + Indirect from Electricity", "", ""))) &
  theme(plot.tag.position = c(1.09, 1.1))
fig

savefig(fig, fig_no)

EconTab
ElecTab
TranTab
BuilTab
IndTab

EconSpg$data = clean_supplemental_data(EconSpg$data, fig_no)
ElecSpg$data = clean_supplemental_data(ElecSpg$data, fig_no)
TranSpg$data = clean_supplemental_data(TranSpg$data, fig_no)
BuilSpg$data = clean_supplemental_data(BuilSpg$data, fig_no)
IndSpg$data = clean_supplemental_data(IndSpg$data, fig_no)

savedata(EconSpg$data, paste(fig_no, "EconWide"))
savedata(ElecSpg$data, paste(fig_no, "Electricity"))
savedata(TranSpg$data, paste(fig_no, "Transportation"))
savedata(BuilSpg$data, paste(fig_no, "Buildings"))
savedata(IndSpg$data, paste(fig_no, "Industry"))
```
### 1.2.1
```{r}
fig_no = "1.2.1"

Econ_data = spg_clean(
  99,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

EconSpg = spg2(Econ_data,
  "",
  expression(paste("Economy-wide C", O[2], "Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  7000,
  c(0, 2000, 4000, 6000),
  scales::comma,
  1, 
  c(2015, 4900), 
  c(2027.5, 5500), 
  c(2022, 3800), 
  config, 
  figmap_leep_timeseries) 

EconDot = dotted(EconSpg$data, EconSpg$figure, "median", 0, 7000, config, figmap_leep_timeseries)
EconDot

delta = delta(25, c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"), config, clean_data, figmap_leep_timeseries)
delta
saveall(delta$figure, delta$df, paste(fig_no, "delta"))


EconTab = html(EconSpg$data, "Economy-Wide CO<sub>2<sub>")
EconSpg
EconDot
delta
EconTab

EconSpg$data = clean_supplemental_data(EconSpg$data, fig_no)
savedata(EconSpg$data, paste(fig_no, "EconWide"))
savefig(EconDot, fig_no)

fig_no = "ES.2"
savedata(EconSpg$data, fig_no)
savefig(EconDot, fig_no)
saveall(delta$figure, delta$df, paste(fig_no, "delta"))

```

## 1.3/ES.3 key indicators

```{r}
fig_no = 1.3
subpalettes = create_subpalettes(figmap_leep_timeseries, config)

indicators_econ = Econ_data %>% filter(year %in% c(2030, 2035))
indicators_econ_baseline = Econ_data %>% filter(year == 2005)

indicators_elec = Elec_data %>% filter(year %in% c(2030, 2035))
indicators_elec_baseline = Elec_data %>% filter(year == 2005)

indicators_tran = Tran_data %>% filter(year %in% c(2030, 2035))
indicators_tran_baseline = Tran_data %>% filter(year == 2005)

indicators_ind = Ind_data %>% filter(year %in% c(2030, 2035))
indicators_ind_baseline = Ind_data %>% filter(year == 2005)

indicators_buil = Buil_data %>% filter(year %in% c(2030, 2035))
indicators_buil_baseline = Buil_data %>% filter(year == 2005)

indicators_all = bind_rows(indicators_econ, indicators_elec, 
                           indicators_tran, indicators_ind, indicators_buil)
indicators_all_baseline = bind_rows(indicators_econ_baseline, 
                                    indicators_elec_baseline, indicators_tran_baseline,
                                    indicators_ind_baseline, indicators_buil_baseline)

variable_rename = data.frame("variable" = c("Emissions|CO2", "Emissions|CO2|Energy|Demand|Transportation|Total",
                                            "Emissions|CO2|Energy|Supply|Electricity",
                                            "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
                                            "Emissions|CO2|Energy|Demand|Buildings|Total"), 
                             "sector" = c("Economy-Wide", "Transportation", 
                                          "Electricity", "Industry", "Buildings"))

indicators_all = indicators_all %>% left_join(
  (indicators_all_baseline %>%
     mutate(value_2005 = value) %>%
     select(variable, value_2005)), 
  by = c("variable")) %>%
  # we're plotting reductions - so multiplying this by -1
  mutate(pct_diff = -100 * (value - value_2005) / value_2005) %>%
  left_join(variable_rename, by = "variable") %>%
  select(-variable) %>%
  mutate(category = interaction(sector, scenario)) %>%
  mutate(category = factor(category, levels = c(
    "Industry.No IRA", "Industry.IRA",
    "Buildings.No IRA", "Buildings.IRA",
    "Transportation.No IRA", "Transportation.IRA",
    "Electricity.No IRA", "Electricity.IRA",
    "Economy-Wide.No IRA", "Economy-Wide.IRA"
  ))) %>%
  mutate(scenario = factor(scenario, levels = c("IRA", "No IRA")))

indicators_summ = indicators_all %>% 
  group_by(category, year, sector, scenario) %>%
  summarize(min = min(pct_diff),
            max = max(pct_diff),
            median = median(pct_diff))

indicator_small = function(all_data, summary_data, filter_variable, subtitle = "", top = FALSE, bottom = FALSE) {
  data_small = all_data %>% filter(sector == filter_variable)
  summ_small = summary_data %>% filter(sector == filter_variable)
  p = data_small %>% 
    ggplot() +
      geom_point(aes(x = pct_diff, y = scenario, color = scenario), shape = 16, alpha = 0.8, size = 1) +
      geom_segment(data = summ_small,
                   aes(x = min, xend = max, y = scenario, yend = scenario, color = scenario),
                   alpha = 0.3, linewidth = 3) +
      geom_point(data = summ_small, aes(x = min, y = scenario, color = scenario),
                 shape = 16, size = 3) +
      geom_point(data = summ_small, aes(x = max, y = scenario, color = scenario),
                 shape = 16, size = 3) +
      geom_point(data = summ_small, aes(x = median, y = scenario, color = scenario),
                shape = "|", size = 1.5, stroke = 3.5) +
      geom_vline(xintercept = 50, color = "black", linewidth = 0.1, alpha = 0.4) +
      # scale_y_discrete(name = filter_variable) +
      ggtitle(subtitle) +
      scale_color_manual(values = c(subpalettes$`Economy-Wide Emissions`[['No IRA']], 
                                    subpalettes$`Economy-Wide Emissions`[['IRA']]), 
                         breaks = c("No IRA", "IRA")) +
      facet_grid(year ~ ., switch = "y") +
      theme_emf() +
      theme(axis.ticks = element_blank(), axis.text.y = element_blank(), 
            #axis.title.y = element_text(size = 8), 
            axis.title.y = element_blank(),
            plot.title = element_text(size = 10, hjust = 0, face = "bold", 
                                      margin = margin(0,0,1,0)),
            strip.text.y.left = element_text(size = 6, face = "plain", angle = 0),
            strip.text.y.right = element_text(size = 6, face = "plain", angle = 0),
            axis.text.x = element_text(face = "plain", size = 6),
            axis.title.x = element_text(face = "plain", size = 8),
            panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank(),
            panel.border = element_blank(),
            # axis.line.x = element_line(color = "#595959", linewidth = 0.25),
            axis.line.x = element_line(color = "white", linewidth = 0.25),
            plot.margin = margin(0,0,5,0))
  
  if (!(bottom)){
    p = p + theme(axis.title.x = element_blank()) +
          scale_x_continuous(limits = c(0,100), expand = c(0,0), position = "top",
                         name = expression("Percent Reduction from 2005 Levels (%)"))
  }
  if (!(top) & !(bottom)) {
    p = p + theme(axis.text.x = element_blank()) +
            scale_x_continuous(limits = c(0,100), expand = c(0,0), position = "bottom",
                         name = expression("Percent Reduction from 2005 Levels (%)"))
  }
  if (bottom) {
    p = p + scale_x_continuous(limits = c(0,100), expand = c(0,0), position = "bottom",
                         name = expression("Percent Reduction from 2005 Levels (%)"))
  }
  
  return(p)
}

p1 = indicator_small(indicators_all, indicators_summ, "Economy-Wide", bottom = FALSE, top = TRUE,
                     subtitle = expression(paste("Economy-Wide C",O[2], " Emissions Reductions")))
p2 = indicator_small(indicators_all, indicators_summ, "Electricity", 
                     subtitle = expression(paste("Electricity C", O[2], " Emissions Reductions")))
p3 = indicator_small(indicators_all, indicators_summ, "Transportation", 
                     subtitle = expression(paste("Transportation C", O[2], " Emissions Reductions (Direct + Indirect)")))
p4 = indicator_small(indicators_all, indicators_summ, "Buildings", 
                     subtitle = expression(paste("Buildings C", O[2], " Emissions Reductions (Direct + Indirect)")))
p5 = indicator_small(indicators_all, indicators_summ, "Industry", bottom = TRUE, top = FALSE,
                     subtitle = expression(paste("Industry C", O[2], " Emissions Reductions (Direct + Indirect)")))
p1
combined = (p1 / p2 / p3 / p4 / p5) +
  plot_layout(guides = "collect") +
#  annotate("segment", x = 50, xend = 50, y = 0, yend = 100, color = "blue") +
#  plot_annotation(theme = theme(legend.position = "top")) + 
  theme(plot.margin = margin(0, 0, 0, 0))

combined
saveall(combined, indicators_all, fig_no)
fig_no = "ES.3"
savefig(combined, fig_no)
```

## 1.4 fossil energy consumption by fuel

```{r}
fig_no = 1.4

Coal_data = spg_clean(
  ts_map_ID = 94,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

CoalSpg = spg2(
  Coal_data,
  expression(paste("Coal")),
  expression(paste("Primary Energy (Quads)")),
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  scales::comma,
  0,
  c(2010, 35),
  c(2027.5, 35),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

CoalDot = dotted(CoalSpg$data,
                 CoalSpg$figure,
                 "median",
                 0,
                 45,
                 config,
                 figmap_leep_timeseries)

CoalTab = html(CoalSpg$data, "Coal")

Gas_data = spg_clean(
  ts_map_ID = 93,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

GasSpg = spg2(
  Gas_data,
  expression(paste("Natural Gas")),
  "",
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL,
  1,
  c(2010, 35),
  c(2027.5, 35),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

GasDot = dotted(GasSpg$data,
                GasSpg$figure,
                "median",
                0,
                45,
                config,
                figmap_leep_timeseries)

GasTab = html(GasSpg$data, "Gas")

Petrol_data = spg_clean(
  ts_map_ID = 92,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

PetrolSpg = spg2(
  Petrol_data,
  expression(paste("Petroleum")),
  "",
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL,
  0,
  c(2010, 35),
  c(2027.5, 35),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

PetrolDot = dotted(PetrolSpg$data,
                   PetrolSpg$figure,
                   "median",
                   0,
                   45,
                   config,
                   figmap_leep_timeseries)

PetrolTab = html(PetrolSpg$data, "Petroleum")

fig = (CoalDot | GasDot | PetrolDot)
fig

savefig(fig, fig_no)

CoalTab
GasTab
PetrolTab

CoalSpg$data = clean_supplemental_data(CoalSpg$data, fig_no)
GasSpg$data = clean_supplemental_data(GasSpg$data, fig_no)
PetrolSpg$data = clean_supplemental_data(PetrolSpg$data, fig_no)

savedata(CoalSpg$data, paste(fig_no, "Coal"))
savedata(GasSpg$data, paste(fig_no, "Gas"))
savedata(PetrolSpg$data, paste(fig_no, "Petroleum"))
```

## 1.5 economy-wide co2 emissions sensitivities

```{r}
fig_no = 1.5

# sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High") # IRA Implementation
panel2_scens = c("Low Growth", "High Growth", "Core", "IRA") # Economic Growth
panel3_scens = c("Low Energy Price","High Energy Price", "Core", "IRA") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Constrained Deployment", "Core", "IRA") # Technology Cost and deployment constraints
panel5_scens = c("Pess-IRA.Adv", "Opt-IRA.Adv", "Core", "IRA") # Combined Technology and Implementation
model_list = c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI", "USREP-ReEDS") # models with all three (low,mid,high) cases

sens_dta_econ = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                 year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  )) %>% mutate(scenario = case_when(
    scenario == "Core" ~ "Mod",
    TRUE ~ scenario
  ))

sens_dta_econ_panel2 = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                             year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel2_scens,
         model == "GCAM-PNNL") %>%
  mutate(scenario = case_when(
    scenario == "IRA" ~ "Mod", TRUE ~ scenario
  )) %>%
  mutate(scenario = case_when(
    scenario == "High Growth" ~ "High",
    scenario == "Low Growth" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel3 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel3_scens) %>%
  filter(model %in% c("GCAM-PNNL")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Energy Price" ~ "High",
    scenario == "Low Energy Price" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel4 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel4_scens) %>%
  filter(model %in% c("USREP-ReEDS")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
    mutate(scenario = case_when(
    scenario == "All Advanced" ~ "All Adv",
    scenario == "Constrained Deployment" ~ "Constr",
    TRUE ~ scenario
  ))

sens_dta_econ_panel5 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel5_scens) %>%
  filter(model %in% c("NEMS-OP", "USREP-ReEDS")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Pess-IRA.Adv" ~ "Pess-Adv",
    scenario == "Opt-IRA.Adv" ~ "Opt-Adv",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                          model == "NEMS-OP" ~ paste0("ON.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "NEMS-OP" ~ -0.4,
                             TRUE ~ 0.0))

sens_dta_trans = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Transportation", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_build = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_ind = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Industry and Fuel Production", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

p7 = sens_dot_plot(sens_dta_econ, title = "\nIRA Implementation", figmap_leep_timeseries, config, 
                   ymin = 0, ymax = 5000, far_left = TRUE, single = FALSE, ps = FALSE,
                   ira_coord = c(2028.4,3220), low_coord = c(2031.3, 3760),
                   high_coord = c(2030.6, 4070))
#p7$plot

p7b = sens_dot_plot(sens_dta_econ_panel2, title = "\nEconomic Growth", figmap_leep_timeseries, config, 
                    ymin = 0, ymax = 5000)
p7c = sens_dot_plot(sens_dta_econ_panel3, title = "\nEnergy Price", figmap_leep_timeseries, config,
                    ymin = 0, ymax = 5000)
p7d = sens_dot_plot(sens_dta_econ_panel4, title = "\nTechnology", figmap_leep_timeseries, config, 
                    ymin = 0, ymax = 5000)
p7e = sens_dot_plot(sens_dta_econ_panel5, title = "Combined Technology\n + Implementation", figmap_leep_timeseries, config,
                    ymin = 0, ymax = 5000)
#p7b$plot


p7$plot = p7$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "EPS-EI", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "GCAM-CGS", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4695, size = 3,
             label = "REGEN-EPRI", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4545, size = 3,
             label = "RIO-REPEAT", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4395, size = 3,
             label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0)

p7b$plot = p7b$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7c$plot = p7c$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7d$plot = p7d$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

p7e$plot = p7e$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "NEMS-OP (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + #469990
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

fig = (p7$plot | p7d$plot | p7e$plot | p7b$plot | p7c$plot) +
  plot_annotation(title = "Economy-Wide Emissions",
                  theme = theme(plot.title = element_blank()))
fig

dta = bind_rows(sens_dta_econ, sens_dta_econ_panel2,
                sens_dta_econ_panel3, sens_dta_econ_panel4, sens_dta_econ_panel5)
dta = dta %>% mutate(figure_num = fig_no) %>%
  select(-stagger, -datasrc)

saveall(fig, dta, fig_no)
```

## 1.2.1 Display table
```{r}
#metric = "absolute"
metric = "percent"

econ_panel1_summ = sens_dta_econ %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "IRA.High" ~ "Optimistic",
                              scenario == "IRA.Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel1_summ = econ_panel1_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel1_summ = econ_panel1_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}

econ_panel1_summ = econ_panel1_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Optimistic" = "opt", "Pessimistic" = "pess"))

econ_panel2_summ = sens_dta_econ_panel2 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel2_summ = econ_panel2_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel2_summ = econ_panel2_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}

econ_panel2_summ = econ_panel2_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Growth" = "opt", "Low Growth" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel3_summ = sens_dta_econ_panel3 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel3_summ = econ_panel3_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel3_summ = econ_panel3_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}

econ_panel3_summ = econ_panel3_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Price" = "opt", "Low Price" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel4_summ = sens_dta_econ_panel4 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "All Adv" ~ "Optimistic",
                              scenario == "Constr" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel4_summ = econ_panel4_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel4_summ = econ_panel4_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}

econ_panel4_summ = econ_panel4_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_", "pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("All-Adv" = "opt", "Constr" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel5_summ = sens_dta_econ_panel5 %>%
  filter(!is.na(variable)) %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Opt-Adv" ~ "Optimistic",
                              scenario == "Pess-Adv" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic))

if (metric == "absolute") {
  econ_panel5_summ = econ_panel5_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel5_summ = econ_panel5_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
}

econ_panel5_summ = econ_panel5_summ %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Opt-Adv" = "opt", "Pess-Adv" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

all_panels = cbind(econ_panel1_summ, econ_panel4_summ, econ_panel5_summ, econ_panel2_summ, econ_panel3_summ)
# all_panels %>% write.csv("./output/final_figures/data/Fig1.4_Summary.csv", row.names = FALSE)
# 
# 
# all_panels = add_header_row(flextable(all_panels), values = c("", "IRA Implementation", "Technology", "Combined Technology + Implementation", "Economic Growth", "Energy Price"),
#   colwidths = c(4,2,2,2,2,2), top = TRUE)
# 
# all_panels = add_header_row(all_panels, values = c("","Difference from IRA Moderate Scenario (negative is reduced emissions)"), colwidths = c(4,10))
# 
# all_panels
```


```{r}
fig_no = "1.2.1"

# all_panels is created in the previous code chunk
all_panels = all_panels %>% 
  mutate(metric = case_when(
    metric == "min" ~ "Min",
    metric == "max" ~ "Max",
    metric == "median" ~ "Median"
  )) %>%
  mutate(metric = factor(metric, levels = c("Min", "Median", "Max"))) %>%
  rename("Year" = "year", "Metric" = "metric") %>%
  arrange(Year, Metric)

all_panels = all_panels %>% data.frame() %>% select(-c(variable, unit)) #%>%
  #mutate_if(is.numeric, round)
#all_panels$Pess.Adv[1] = ""
all_panels$Year[1] = ""
all_panels$Year[3] = ""
all_panels$Year[4] = ""
all_panels$Year[6] = ""
all_panels

#gt(rowname_col = "year") %>%

all_panels_gt = all_panels %>% gt() %>% 
  tab_header(
    title = gt::html("Economy-wide CO<sub>2</sub> Emissions (Mt CO<sub>2</sub>/yr)")
  ) %>%
  tab_spanner(label = gt::html("IRA <br> Implementation"), columns = c(Optimistic, Pessimistic)) %>%
  tab_spanner(label = gt::html("<br>Technology"), columns = c(All.Adv, Constr)) %>%
  tab_spanner(label = gt::html("Implementation <br> + Tech"), columns = c(Opt.Adv, Pess.Adv)) %>%
  tab_spanner(label = gt::html("Economic <br> Growth"), columns = c(High.Growth, Low.Growth)) %>%
  tab_spanner(label = gt::html("Energy <br> Prices"), columns = c(High.Price, Low.Price)) %>%
  cols_label(All.Adv = "Advanced",
             Constr = "Constrained",
             High.Growth = "High",
             Low.Growth = "Low",
             High.Price = "High",
             Low.Price = "Low"
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "all", color = "#F2F2F2"),
      cell_fill(color = "#F2F2F2", alpha = NULL)
    ), locations = cells_body()
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "bottom", color = "#DCDCDC", weight = "2px")
    ), 
    locations = cells_body(rows = c(3))
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "normal")
    ), locations = cells_column_labels()
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ), locations = cells_column_spanners()
  ) %>% tab_style(
    style = list(
      cell_text(weight = "bold", align = "right")
    ), locations = cells_body(columns = 1:2)
  ) %>% tab_style(
    style = list(
      cell_text(align = "center")
    ), locations = cells_body(columns = 3:12)
  ) 

if (metric == "percent") {
  all_panels_gt = all_panels_gt %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:12)
} else if (metric == "absolute") {
  all_panels_gt = all_panels_gt %>% fmt_number(decimals = 1, use_seps = TRUE, columns = 3:12)
}

#%>% opt_stylize(style = 6, color = "blue")
  
  #tab_row_group(label = "2030", rows = 1:3) %>%
  #tab_row_group(label = "2035", rows = 4:6)

all_panels_gt

all_panels_gt %>% 
  gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".html"))

all_panels_gt %>% 
  gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".png"))


```

## 1.x Playing around with arrows
```{r, eval = FALSE}
# Economy-wide emissions
clean_data12 = clean_data %>% duplicate_historical_data("EPA-GHGI", 2021, criteria = TRUE)
p = dot_plots_but_with_arrows("time_series", config, clean_data12, figmap_leep_timeseries, 99,
                              "United States", 0, 6000, "Economy-wide Emissions",
                              metric = "median", historic_coord = c(2017,5540),
                              preira_coord = c(2030, 4750), ira_coord = c(2029, 3230) )
p$full

p2 = dot_plots_but_with_arrows("time_series", config, clean_data12,
                               figmap_leep_timeseries, 98,
                              "United States", 0, 2600, "Economy-wide Emissions",
                              metric = "median", historic_coord = c(2017,2100),
                              preira_coord = c(2030, 1520), ira_coord = c(2029, 300) )
p2$full
```
