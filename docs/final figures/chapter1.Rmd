---
title: "Chapter 1: Introduction and Economy-Wide"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all(here())
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)

# temporary filter on clean data
clean_data = clean_data %>%
  filter(!(model == "IPM-EPA" & year == 2025))
```

## F1.1 e-w co2 emissions from fossil fuel combustion and industrial processes by sector

```{r}
fig_no = "1.1.ewco2_direct_indirect"

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

subpalettes$`Emissions Stack`[["Electricity Generation"]] = "#0388B3"
subpalettes$`Emissions Stack`[["Other Sectors"]] = "#DEDEDE"
subpalettes$`Emissions Stack`[["Non-CO2 GHGs"]] = "#469990"

df = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct", "Industry: Indirect", "Buildings: Direct", 
                                             "Buildings: Indirect", "Transportation: Direct", "Transportation: Indirect")))

df = clean_supplemental_data(df, fig_no)
  
fig = emis_stack(df, "Economy-Wide CO2 Emissions", figmap_leep_stackbar, config, econwide = TRUE)
fig

saveall(fig, df, fig_no)
```

## F1.2 economy-wide co2 emissions

```{r}
fig_no = "1.2.ewco2_projection"

Econ_data = spg_clean(
  99,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)

EconSpg = spg2(Econ_data,
  "",
  expression(paste("Economy-wide C", O[2], " Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  6500,
  c(0, 2000, 4000, 6000),
  scales::comma,
  1, 
  c(2015, 4900), 
  c(2027.5, 5500), 
  c(2022, 3800), 
  config, 
  figmap_leep_timeseries) 

EconDot = dotted(EconSpg$data, EconSpg$figure, "median", 0, 7000, config, figmap_leep_timeseries)
EconDot
EconSpg$data = clean_supplemental_data(EconSpg$data, fig_no)
saveall(EconDot, EconSpg$data, fig_no)

delta = delta(25, c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"), config, clean_data, figmap_leep_timeseries)
delta
saveall(delta$figure, delta$df, paste(fig_no, "delta"), wd = 3.012, ht = 3)

EconTab = html(EconSpg$data, "Economy-Wide CO2")
EconTab
```

## F1.3/ES.2 key indicators

```{r}
fig_no = "1.3.summary_ranges"

Elec_data = spg_clean(
  98,
  c("Scout-LEEP"),
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)
ElecTab = html(Elec_data, "Electricity CO2")

Tran_data = spg_clean(
  19,
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP"),  
  "EPA-GHGI",
  config,
  clean_data,
  figmap_leep_timeseries
)
TranTab = html(Tran_data, "Transportation CO2")

Ind_data = spg_clean(
  21, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP"),
  "EPA-GHGI", 
  config,
  clean_data, 
  figmap_leep_timeseries)
IndTab = html(Ind_data, "Industry CO2")

Buil_data = spg_clean(
  23, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL"), 
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries)
BuilTab = html(Buil_data, "Building CO2")

EconSpg$data = clean_supplemental_data(EconSpg$data, fig_no)
Elec_data = clean_supplemental_data(Elec_data, fig_no)
Tran_data = clean_supplemental_data(Tran_data, fig_no)
Buil_data = clean_supplemental_data(Buil_data, fig_no)
Ind_data = clean_supplemental_data(Ind_data, fig_no)

savedata(EconSpg$data, paste(fig_no, "EconWide"))
savedata(Elec_data, paste(fig_no, "Electricity"))
savedata(Tran_data, paste(fig_no, "Transportation"))
savedata(Buil_data, paste(fig_no, "Buildings"))
savedata(Ind_data, paste(fig_no, "Industry"))

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

indicators_econ = Econ_data %>% filter(year %in% c(2030, 2035))
indicators_econ_baseline = Econ_data %>% filter(year == 2005)

indicators_elec = Elec_data %>% filter(year %in% c(2030, 2035))
indicators_elec_baseline = Elec_data %>% filter(year == 2005)

indicators_tran = Tran_data %>% filter(year %in% c(2030, 2035))
indicators_tran_baseline = Tran_data %>% filter(year == 2005)

indicators_ind = Ind_data %>% filter(year %in% c(2030, 2035))
indicators_ind_baseline = Ind_data %>% filter(year == 2005)

indicators_buil = Buil_data %>% filter(year %in% c(2030, 2035))
indicators_buil_baseline = Buil_data %>% filter(year == 2005)

indicators_all = bind_rows(indicators_econ, indicators_elec, 
                           indicators_tran, indicators_ind, indicators_buil)
indicators_all_baseline = bind_rows(indicators_econ_baseline, 
                                    indicators_elec_baseline, indicators_tran_baseline,
                                    indicators_ind_baseline, indicators_buil_baseline)

variable_rename = data.frame("variable" = c("Emissions|CO2", "Emissions|CO2|Energy|Demand|Transportation|Total",
                                            "Emissions|CO2|Energy|Supply|Electricity",
                                            "Emissions|CO2|Energy|Demand|Industry and Fuel Production|Total",
                                            "Emissions|CO2|Energy|Demand|Buildings|Total"), 
                             "sector" = c("Economy-Wide", "Transportation", 
                                          "Electricity", "Industry", "Buildings"))

indicators_all = indicators_all %>% left_join(
  (indicators_all_baseline %>%
     mutate(value_2005 = value) %>%
     select(variable, value_2005)), 
  by = c("variable")) %>%
  # we're plotting reductions - so multiplying this by -1
  mutate(pct_diff = -100 * (value - value_2005) / value_2005) %>%
  left_join(variable_rename, by = "variable") %>%
  select(-variable) %>%
  mutate(category = interaction(sector, scenario)) %>%
  mutate(category = factor(category, levels = c(
    "Industry.No IRA", "Industry.IRA",
    "Buildings.No IRA", "Buildings.IRA",
    "Transportation.No IRA", "Transportation.IRA",
    "Electricity.No IRA", "Electricity.IRA",
    "Economy-Wide.No IRA", "Economy-Wide.IRA"
  ))) %>%
  mutate(scenario = factor(scenario, levels = c("IRA", "No IRA")))

indicators_summ = indicators_all %>% 
  group_by(category, year, sector, scenario) %>%
  summarize(min = min(pct_diff),
            max = max(pct_diff),
            median = median(pct_diff))

p1 = indicator_small(indicators_all, indicators_summ, "Economy-Wide", bottom = TRUE, top = FALSE,
                     subtitle = expression(paste("Economy-Wide C",O[2], " Emissions Reductions")))
p2 = indicator_small(indicators_all, indicators_summ, "Electricity", bottom = FALSE, top = TRUE,
                     subtitle = expression(paste("Electricity C", O[2], " Emissions Reductions")))
p3 = indicator_small(indicators_all, indicators_summ, "Transportation", 
                     subtitle = expression(paste("Transportation C", O[2], " Emissions Reductions (Direct + Indirect from Electricity)")))
p4 = indicator_small(indicators_all, indicators_summ, "Buildings", 
                     subtitle = expression(paste("Buildings C", O[2], " Emissions Reductions (Direct + Indirect from Electricity)")))
p5 = indicator_small(indicators_all, indicators_summ, "Industry", bottom = FALSE, top = FALSE,
                     subtitle = expression(paste("Industry C", O[2], " Emissions Reductions (Direct + Indirect from Electricity)")))

combined = (p2 / p3 / p4 / p5 / p1) +
  plot_layout(guides = "collect") +
#  annotate("segment", x = 50, xend = 50, y = 0, yend = 100, color = "blue") +
#  plot_annotation(theme = theme(legend.position = "top")) + 
  theme(plot.margin = margin(0, 0, 0, 0))
combined

indicators_all_clean = indicators_all %>% 
  select(model,scenario,unit,region,title_name.y,year,value,value_2005,pct_diff) %>% 
  rename(`percent diff 2005` = pct_diff)

EconTab
ElecTab
TranTab
BuilTab
IndTab

summary_IRA = indicators_summ %>%
  ungroup() %>%
  select(sector, scenario, year, min, median, max) %>%
  filter(scenario == "IRA") %>%
  select(sector, year,
         `IRA Min` = min, `IRA Median` = median, `IRA Max` = max)

summary_NoIRA = indicators_summ %>%
  ungroup() %>%
  select(sector, scenario, year, min, median, max) %>%
  filter(scenario == "No IRA")%>%
  select(sector, year,
         `No IRA Min` = min, `No IRA Median` = median, `No IRA Max` = max)

summary = merge(summary_IRA, summary_NoIRA, by = c("sector", "year"))

saveall(combined, indicators_all_clean, fig_no)
savedata(summary, paste(fig_no,"summary",sep="_"))

fig_no = "ES.2.summary_ranges"
saveall(combined, indicators_all_clean, fig_no)
savedata(summary, paste(fig_no,"summary",sep="_"))
```

## F1.4 fossil energy consumption by fuel

```{r}
fig_no = "1.4.fossilenergy"

Coal_data = spg_clean(
  ts_map_ID = 94,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

CoalSpg = spg2(
  Coal_data,
  expression(paste("Coal")),
  expression(paste("Primary Energy (Quads)")),
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  scales::comma,
  0,
  c(2010, 35),
  c(2027.5, 35),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

CoalDot = dotted(CoalSpg$data,
                 CoalSpg$figure,
                 "median",
                 0,
                 45,
                 config,
                 figmap_leep_timeseries)

CoalTab = html(CoalSpg$data, "Coal")

Gas_data = spg_clean(
  ts_map_ID = 93,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

GasSpg = spg2(
  Gas_data,
  expression(paste("Natural Gas")),
  "",
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL,
  1,
  c(2012, 35),
  c(2027.5, 37),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

GasDot = dotted(GasSpg$data,
                GasSpg$figure,
                "median",
                0,
                45,
                config,
                figmap_leep_timeseries)

GasTab = html(GasSpg$data, "Gas")

Petrol_data = spg_clean(
  ts_map_ID = 92,
  drop = c("RIO-REPEAT", "EIAinEMF37.csv"),
  histsrc = "EIA",
  config,
  clean_data,
  figmap_leep_timeseries
)

PetrolSpg = spg2(
  Petrol_data,
  expression(paste("Petroleum")),
  "",
  gd = "none",
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL,
  0,
  c(2010, 35),
  c(2027.5, 35),
  c(2022, 22.5),
  config,
  figmap_leep_timeseries
)

PetrolDot = dotted(PetrolSpg$data,
                   PetrolSpg$figure,
                   "median",
                   0,
                   45,
                   config,
                   figmap_leep_timeseries)

PetrolTab = html(PetrolSpg$data, "Petroleum")

fig = (CoalDot | GasDot | PetrolDot)
fig

savefig(fig, fig_no, wd = 8)

CoalTab
GasTab
PetrolTab

CoalSpg$data = clean_supplemental_data(CoalSpg$data, fig_no)
GasSpg$data = clean_supplemental_data(GasSpg$data, fig_no)
PetrolSpg$data = clean_supplemental_data(PetrolSpg$data, fig_no)

savedata(CoalSpg$data, paste(fig_no, "Coal"))
savedata(GasSpg$data, paste(fig_no, "Gas"))
savedata(PetrolSpg$data, paste(fig_no, "Petroleum"))
```

## F1.5 economy-wide co2 emissions sensitivities

```{r}
fig_no = "1.5.ew_sensitivities"

# sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High") # IRA Implementation
panel2_scens = c("Low Growth", "High Growth", "Core", "IRA") # Economic Growth
panel3_scens = c("Low Energy Price","High Energy Price", "Core", "IRA") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Constrained Deployment", "Core", "IRA") # Technology Cost and deployment constraints
panel5_scens = c("Pess-IRA.Adv", "Opt-IRA.Adv", "Core", "IRA") # Combined Technology and Implementation
model_list = c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI", "USREP-ReEDS") # models with all three (low,mid,high) cases

sens_dta_econ = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                 year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  )) %>% mutate(scenario = case_when(
    scenario == "Core" ~ "Mod",
    TRUE ~ scenario
  ))

sens_dta_econ_panel2 = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                             year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel2_scens,
         model == "GCAM-PNNL") %>%
  mutate(scenario = case_when(
    scenario == "IRA" ~ "Mod", TRUE ~ scenario
  )) %>%
  mutate(scenario = case_when(
    scenario == "High Growth" ~ "High",
    scenario == "Low Growth" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel3 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel3_scens) %>%
  filter(model %in% c("GCAM-PNNL")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Energy Price" ~ "High",
    scenario == "Low Energy Price" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel4 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel4_scens) %>%
  filter(model %in% c("USREP-ReEDS", "GCAM-PNNL")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
    mutate(scenario = case_when(
    scenario == "All Advanced" ~ "All Adv",
    scenario == "Constrained Deployment" ~ "Constr",
    TRUE ~ scenario
  )) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "GCAM-PNNL" ~ -0.4,
                             TRUE ~ 0.0))

sens_dta_econ_panel5 = clean_data %>%
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel5_scens) %>%
  filter(model %in% c("NEMS-OP", "USREP-ReEDS")) %>%
  mutate(scenario = case_when(scenario == "IRA" ~ "Mod", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Pess-IRA.Adv" ~ "Pess-Adv",
    scenario == "Opt-IRA.Adv" ~ "Opt-Adv",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                          model == "NEMS-OP" ~ paste0("ON.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "NEMS-OP" ~ -0.4,
                             TRUE ~ 0.0))

sens_dta_trans = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Transportation", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_build = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_ind = clean_data %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Industry and Fuel Production", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

p7 = sens_dot_plot(sens_dta_econ, title = "\nIRA Implementation", figmap_leep_timeseries, config, 
                   ymin = 0, ymax = 5000, far_left = TRUE, single = FALSE, ps = FALSE,
                   ira_coord = c(2028.4,3220), low_coord = c(2031.3, 3760),
                   high_coord = c(2030.6, 4070))
#p7$plot

p7b = sens_dot_plot(sens_dta_econ_panel2, title = "\nEconomic Growth", figmap_leep_timeseries, config, 
                    ymin = 0, ymax = 5000)
p7c = sens_dot_plot(sens_dta_econ_panel3, title = "\nEnergy Price", figmap_leep_timeseries, config,
                    ymin = 0, ymax = 5000)
p7d = sens_dot_plot(sens_dta_econ_panel4, title = "\nTechnology", figmap_leep_timeseries, config, 
                    ymin = 0, ymax = 5000)
p7e = sens_dot_plot(sens_dta_econ_panel5, title = "Combined Technology\n + Implementation", figmap_leep_timeseries, config,
                    ymin = 0, ymax = 5000)
#p7b$plot


p7$plot = p7$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "EPS-EI", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "GCAM-CGS", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4695, size = 3,
             label = "REGEN-EPRI", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4545, size = 3,
             label = "RIO-REPEAT", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4395, size = 3,
             label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0)

p7b$plot = p7b$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7c$plot = p7c$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7d$plot = p7d$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
           label = "GCAM-PNNL (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 4845, size = 3,
               label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

p7e$plot = p7e$plot +
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "NEMS-OP (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + #469990
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

fig = (p7$plot | p7d$plot | p7e$plot | p7c$plot | p7b$plot) +
  plot_annotation(title = "Economy-Wide Emissions",
                  theme = theme(plot.title = element_blank()))
fig

dta = bind_rows(sens_dta_econ, sens_dta_econ_panel2,
                sens_dta_econ_panel3, sens_dta_econ_panel4, sens_dta_econ_panel5)
dta = dta %>% mutate(figure_num = fig_no) %>%
  select(-stagger, -datasrc)

saveall(fig, dta, fig_no)
```

### T1.2.1 Display table

```{r}
#metric = "absolute"
#metric = "percent"
metric = "percent_2005"

historic_emissions = (clean_data %>%
  filter(model == "EPA-GHGI",
         scenario == "Historic",
         variable == "Emissions|CO2",
         year == 2005))$value

econ_panel1_summ = sens_dta_econ %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "IRA.High" ~ "Optimistic",
                              scenario == "IRA.Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel1_summ = econ_panel1_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel1_summ = econ_panel1_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  econ_panel1_summ = econ_panel1_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}
econ_panel1_summ = econ_panel1_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Optimistic" = "opt", "Pessimistic" = "pess"))

econ_panel2_summ = sens_dta_econ_panel2 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel2_summ = econ_panel2_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel2_summ = econ_panel2_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  econ_panel2_summ = econ_panel2_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

econ_panel2_summ = econ_panel2_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Growth" = "opt", "Low Growth" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel3_summ = sens_dta_econ_panel3 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel3_summ = econ_panel3_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel3_summ = econ_panel3_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  econ_panel3_summ = econ_panel3_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

econ_panel3_summ = econ_panel3_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Price" = "opt", "Low Price" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel4_summ = sens_dta_econ_panel4 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "All Adv" ~ "Optimistic",
                              scenario == "Constr" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_")

if (metric == "absolute") {
  econ_panel4_summ = econ_panel4_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel4_summ = econ_panel4_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  econ_panel4_summ = econ_panel4_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

econ_panel4_summ = econ_panel4_summ %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_", "pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("All-Adv" = "opt", "Constr" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel5_summ = sens_dta_econ_panel5 %>%
  filter(!is.na(variable)) %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Opt-Adv" ~ "Optimistic",
                              scenario == "Pess-Adv" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic))

if (metric == "absolute") {
  econ_panel5_summ = econ_panel5_summ %>%
      mutate(diff_opt = value_Optimistic - value_Core,
             diff_pess = value_Pessimistic - value_Core)
} else if (metric == "percent") {
  econ_panel5_summ = econ_panel5_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / value_Core,
             diff_pess = (value_Pessimistic - value_Core) / value_Core) 
} else if (metric == "percent_2005") {
  econ_panel5_summ = econ_panel5_summ %>%
      mutate(diff_opt = (value_Optimistic - value_Core) / historic_emissions,
             diff_pess = (value_Pessimistic - value_Core) / historic_emissions)
}

econ_panel5_summ = econ_panel5_summ %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  #mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Opt-Adv" = "opt", "Pess-Adv" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

all_panels = cbind(econ_panel1_summ, econ_panel4_summ, econ_panel5_summ, econ_panel3_summ, econ_panel2_summ)
# all_panels %>% write.csv("./output/final_figures/data/Fig1.4_Summary.csv", row.names = FALSE)
# 
# 
# all_panels = add_header_row(flextable(all_panels), values = c("", "IRA Implementation", "Technology", "Combined Technology + Implementation", "Economic Growth", "Energy Price"),
#   colwidths = c(4,2,2,2,2,2), top = TRUE)
# 
# all_panels = add_header_row(all_panels, values = c("","Difference from IRA Moderate Scenario (negative is reduced emissions)"), colwidths = c(4,10))
# 
# all_panels

fig_no = "1.2.1"

# all_panels is created in the previous code chunk
all_panels = all_panels %>% 
  mutate(metric = case_when(
    metric == "min" ~ "Min",
    metric == "max" ~ "Max",
    metric == "median" ~ "Median"
  )) %>%
  mutate(metric = factor(metric, levels = c("Min", "Median", "Max"))) %>%
  rename("Year" = "year", "Metric" = "metric") %>%
  arrange(Year, Metric)

all_panels = all_panels %>% data.frame() %>% select(-c(variable, unit)) 
#all_panels$Pess.Adv[1] = ""
all_panels$Year[1] = ""
all_panels$Year[3] = ""
all_panels$Year[4] = ""
all_panels$Year[6] = ""

# manually merging cells in the dumbest way possible
for (col_num in c(6,8,9,10,11,12)) {
  col = colnames(all_panels[col_num])
  for (row in c(1,3,4,6)) {
    all_panels[row,col] = NA
  }
}

all_panels

#gt(rowname_col = "year") %>%

all_panels_gt = all_panels %>% gt() %>% 
  tab_header(
    title = gt::html("Economy-wide Incremental CO<sub>2</sub> Emissions (Mt CO<sub>2</sub>/yr) Relative to 2005 Levels")
  ) %>%
  tab_spanner(label = gt::html("IRA <br> Implementation"), columns = c(Optimistic, Pessimistic)) %>%
  tab_spanner(label = gt::html("<br>Technology"), columns = c(All.Adv, Constr)) %>%
  tab_spanner(label = gt::html("Implementation <br> + Tech"), columns = c(Opt.Adv, Pess.Adv)) %>%
  tab_spanner(label = gt::html("Economic <br> Growth"), columns = c(High.Growth, Low.Growth)) %>%
  tab_spanner(label = gt::html("Energy <br> Prices"), columns = c(High.Price, Low.Price)) %>%
  cols_label(All.Adv = "Advanced",
             Constr = "Constrained",
             High.Growth = "High",
             Low.Growth = "Low",
             High.Price = "High",
             Low.Price = "Low"
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "all", color = "#F2F2F2"),
      cell_fill(color = "#F2F2F2", alpha = NULL)
    ), locations = cells_body()
  ) %>% tab_style(
    style = list(
      cell_borders(sides = "bottom", color = "#DCDCDC", weight = "2px")
    ), 
    locations = cells_body(rows = c(3))
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "normal")
    ), locations = cells_column_labels()
  ) %>% tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ), locations = cells_column_spanners()
  ) %>% tab_style(
    style = list(
      cell_text(weight = "bold", align = "right")
    ), locations = cells_body(columns = 1:2)
  ) %>% tab_style(
    style = list(
      cell_text(align = "center")
    ), locations = cells_body(columns = 3:12)
  ) %>% sub_missing(columns = 3:12, missing_text = "")

if(metric == "percent_2005") {
  all_panels_gt = all_panels_gt %>%
    tab_header(title = gt::html(
      "Economy-wide CO<sub>2</sub> Emissions Changes (percentage points of 2005 emissions) Relative to the IRA Moderate Scenario")
  )
}

if (metric == "percent" | metric == "percent_2005") {
  all_panels_gt = all_panels_gt %>% fmt_number(decimals = 1, scale_by = 100, 
                                               use_seps = TRUE, columns = 3:12)
  #all_panels_gt = all_panels_gt %>% fmt_percent(decimals = 1, use_seps = TRUE, columns = 3:12)
} else if (metric == "absolute") {
  all_panels_gt = all_panels_gt %>% fmt_number(decimals = 1, use_seps = TRUE, columns = 3:12)
}

#%>% opt_stylize(style = 6, color = "blue")
  
  #tab_row_group(label = "2030", rows = 1:3) %>%
  #tab_row_group(label = "2035", rows = 4:6)

all_panels_gt

all_panels_gt %>% 
  gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".html"))

#all_panels_gt %>% 
#   gtsave(paste0("./output/final_figures/display_tables/Table",fig_no,"_",metric,".png"), vwidth = 1500, vheight = 1000)
```
