---
title: "Chapter 1: Introduction and Economy-Wide"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all(here())
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## 1.1 economy-wide co2 emissions from fossil fuel combustion by sector

```{r}
fig_no = 1.1

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

subpalettes$`Emissions Stack`[["Electricity Generation"]] = "#0388B3"
subpalettes$`Emissions Stack`[["Other Sectors"]] = "#DEDEDE"
subpalettes$`Emissions Stack`[["Non-CO2 GHGs"]] = "#469990"

df = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Industry: Direct", "Industry: Indirect", "Buildings: Direct", 
                                             "Buildings: Indirect", "Transportation: Direct", "Transportation: Indirect")))

fig = emis_stack(df, "Economy-Wide CO2 Emissions", econwide = TRUE)
fig

saveall(fig, df, fig_no)
```

## 1.2 economy-wide, electricity, and sector co2 emissions

```{r}
fig_no = 1.2

EconSpg = spg(
  99,
  "EPA-GHGI",
  expression(paste("Economy-Wide C", O[2])),
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  0,
  7000,
  c(0, 2000, 4000, 6000),
  scales::comma) + 
  annotate("text", x = 2015, y = 4900, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 5500, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022, y = 3800, label = "IRA", color = "#0388B3")

EconTab = html(EconSpg$data, "Economy-Wide CO<sub>2<sub>")

ElecSpg = spg(
  98,
  "EPA-GHGI",
  expression(paste("Electricity C", O[2])),
  "",
  gd = "none",
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  0,
  7000,
  c(0, 2000, 4000, 6000),
  NULL)

ElecTab = html(ElecSpg$data, "Electricity CO<sub>2<sub>")

TranSpg = spg(
  19,
  "EPA-GHGI",
  expression(paste("Transportation C", O[2])),
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "USREP-ReEDS"),
  0,
  2500,
  c(0, 1250, 2500),
  scales::comma)

TranTab = html(TranSpg$data, "Transportation CO<sub>2<sub>")

IndSpg = spg(
  21,
  "EPA-GHGI",
  expression(paste("Industry C", O[2])),
  "",
  gd = "none",
  c("IPM-NRDC", "IPM-EPA", "GCAM-PNNL"),
  0,
  2500,
  c(0, 1250, 2500),
  NULL)

IndTab = html(IndSpg$data, "Industry CO<sub>2<sub>")

BuilSpg = spg(
  23,
  "EPA-GHGI",
  expression(paste("Building C", O[2])),
  "",
  gd = "none",
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "MARKAL-NETL", "GCAM-PNNL"),
  0,
  2500,
  c(0, 1250, 2500),
  NULL)
BuilTab = html(BuilSpg$data, "Building CO<sub>2<sub>")

fig = (EconSpg | ElecSpg) / (TranSpg | BuilSpg | IndSpg) + 
  plot_annotation(tag_levels = list(c("", "", "Sectoral Emissions: Direct + Indirect from Electricity", "", ""))) & 
  theme(plot.tag.position = c(1.09, 1.1))
fig

savefig(fig, fig_no)

EconTab
ElecTab
TranTab
BuilTab
IndTab

savedata(EconSpg$data, paste(fig_no, "EconWide"))
savedata(ElecSpg$data, paste(fig_no, "Electricity"))
savedata(TranSpg$data, paste(fig_no, "Transportation"))
savedata(BuilSpg$data, paste(fig_no, "Buildings"))
savedata(IndSpg$data, paste(fig_no, "Industry"))
```

## 1.3 fossil energy consumption by fuel

```{r}
fig_no = 1.3

CoalSpg = spg(
  94,
  "EIA",
  expression(paste("Coal")),
  expression(paste("Primary Energy (Quads)")),
  gd = "none",
  c("RIO-REPEAT","EIAinEMF37.csv"),
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  scales::comma)

CoalDot = dotted(CoalSpg$data, CoalSpg, "median", 0, 45)

CoalTab = html(CoalSpg$data, "Coal")

GasSpg = spg(
  93,
  "EIA",
  expression(paste("Gas")),
  "",
  gd = "none",
  c("RIO-REPEAT","EIAinEMF37.csv"),
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL)+
  annotate("text", x = 2010, y = 35, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 35, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022, y = 22.5, label = "IRA", color = "#0388B3")

GasDot = dotted(GasSpg$data, GasSpg, "median", 0, 45)

GasTab = html(GasSpg$data, "Gas")

PetrolSpg = spg(
  92,
  "EIA",
  expression(paste("Petroleum")),
  "",
  gd = "none",
  c("RIO-REPEAT","EIAinEMF37.csv"),
  0,
  45,
  c(0, 10, 20 , 30 , 40),
  NULL)

PetrolDot = dotted(PetrolSpg$data, PetrolSpg, "median", 0, 45)

PetrolTab = html(PetrolSpg$data, "Petroleum")

fig = (CoalDot | GasDot | PetrolDot) 
fig

savefig(fig, fig_no)

CoalTab
GasTab
PetrolTab

savedata(CoalSpg$data, paste(fig_no, "Coal"))
savedata(GasSpg$data, paste(fig_no, "Gas"))
savedata(PetrolSpg$data, paste(fig_no, "Petroleum"))
```

## 1.4 economy-wide co2 emissions sensitivities

```{r}
fig_no = 1.4

# change dot labels to "Energy Price"
# pessimistic emis label location
# 

# sensitivity dot plots
panel1_scens = c("Core","IRA", "IRA.Low","IRA.High") # IRA Implementation
panel2_scens = c("Low Growth", "High Growth", "Core", "IRA") # Economic Growth
panel3_scens = c("Low Energy Price","High Energy Price", "Core", "IRA") # Energy Prices
panel4_scens = c("All Advanced", "Adv Battery/Renew", "Cons Battery/Renew", "Constrained Deployment", "Core", "IRA") # Technology Cost and deployment constraints
panel5_scens = c("Pess-IRA.Adv", "Opt-IRA.Adv", "Core", "IRA") # Combined Technology and Implementation
model_list = c("EPS-EI", "GCAM-CGS","RIO-REPEAT","REGEN-EPRI", "USREP-ReEDS") # models with all three (low,mid,high) cases

sens_dta_econ = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                 year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_econ_panel2 = clean_data %>% filter(variable == "Emissions|CO2|Energy",
                                             year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel2_scens, 
         model == "GCAM-PNNL") %>%
  mutate(scenario = case_when(
    scenario == "IRA" ~ "Core", TRUE ~ scenario
  )) %>%
  mutate(scenario = case_when(
    scenario == "High Growth" ~ "High",
    scenario == "Low Growth" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel3 = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel3_scens) %>% 
  filter(model %in% c("GCAM-PNNL")) %>% 
  mutate(scenario = case_when(scenario == "IRA" ~ "Core", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "High Energy Price" ~ "High",
    scenario == "Low Energy Price" ~ "Low",
    TRUE ~ scenario
  ))

sens_dta_econ_panel4 = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel4_scens) %>% 
  filter(model %in% c("USREP-ReEDS")) %>% 
  mutate(scenario = case_when(scenario == "IRA" ~ "Core", TRUE ~ scenario)) %>%
    mutate(scenario = case_when(
    scenario == "All Advanced" ~ "All Adv",
    TRUE ~ scenario
  ))

sens_dta_econ_panel5 = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy", year %in% c(2030, 2035)) %>%
  filter(scenario %in% panel5_scens) %>%
  filter(model %in% c("OP-NEMS", "USREP-ReEDS")) %>% 
  mutate(scenario = case_when(scenario == "IRA" ~ "Core", TRUE ~ scenario)) %>%
  mutate(scenario = case_when(
    scenario == "Pess-IRA.Adv" ~ "Pess-Adv",
    scenario == "Opt-IRA.Adv" ~ "Opt-Adv",
    TRUE ~ scenario
  )) %>%
  # mutate(scenario = case_when(model == "USREP-ReEDS" ~ paste0("UR.",scenario),
  #                          model == "OP-NEMS" ~ paste0("ON.",scenario),
  #                          TRUE ~ scenario)) %>%
  mutate(stagger = case_when(model == "USREP-ReEDS" ~ 0.4,
                             model == "OP-NEMS" ~ -0.4,
                             TRUE ~ 0.0))
  

sens_dta_trans = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Transportation", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_build = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

sens_dta_ind = clean_data %>% 
  filter(variable == "Emissions|CO2|Energy|Demand|Industry and Fuel Production", year %in% c(2030, 2035)) %>% 
  filter(scenario %in% panel1_scens) %>%
  filter(model %in% model_list) %>%
  mutate(stagger = case_when(
    scenario == "IRA.Low" ~ -0.7,
    scenario == "IRA.High" ~ 0.7,
    TRUE ~ 0
  ))

p7 = sens_dot_plot(sens_dta_econ, title = "\nIRA Implementation", ymin = 0, ymax = 5000, far_left = TRUE, single = FALSE, 
                   ira_coord = c(2028.4,3220), low_coord = c(2031.3, 3760), 
                   high_coord = c(2030.6, 4070))
#p7$plot

p7b = sens_dot_plot(sens_dta_econ_panel2, title = "\nEconomic Growth", ymin = 0, ymax = 5000)
p7c = sens_dot_plot(sens_dta_econ_panel3, title = "\nEnergy Price", ymin = 0, ymax = 5000)
p7d = sens_dot_plot(sens_dta_econ_panel4, title = "\nTechnology", ymin = 0, ymax = 5000)
p7e = sens_dot_plot(sens_dta_econ_panel5, title = "Combined Technology\n + Implementation", ymin = 0, ymax = 5000)
#p7b$plot


p7$plot = p7$plot + 
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "EPS-EI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "GCAM-CGS", color = "#A1A1A1", alpha = 1, hjust = 0) +
  annotate("text", x = 2028.4, y = 4695, size = 3,
             label = "REGEN-EPRI", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 4545, size = 3,
             label = "RIO-REPEAT", color = "#A1A1A1", alpha = 1, hjust = 0) + 
  annotate("text", x = 2028.4, y = 4395, size = 3,
             label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0)

p7b$plot = p7b$plot + 
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7c$plot = p7c$plot + 
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "GCAM-PNNL", color = "#A1A1A1", alpha = 1, hjust = 0) #3cb44b

p7d$plot = p7d$plot + 
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "USREP-ReEDS", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

p7e$plot = p7e$plot + 
  annotate("text", x = 2028.4, y = 4995, size = 3,
               label = "OP-NEMS (L)", color = "#A1A1A1", alpha = 1, hjust = 0) + #469990
  annotate("text", x = 2028.4, y = 4845, size = 3,
             label = "USREP-ReEDS (R)", color = "#A1A1A1", alpha = 1, hjust = 0) #FFF362

fig = (p7$plot | p7d$plot | p7e$plot | p7b$plot | p7c$plot) +
  plot_annotation(title = "Economy-Wide Emissions", 
                  theme = theme(plot.title = element_blank()))
fig

dta = bind_rows(sens_dta_panel1, sens_dta_panel2,
                sens_dta_panel3, sens_dta_panel4, sens_dta_panel5)


saveall(fig, dta, fig_no)
```

### table for Figure 1.4
```{r}
econ_panel1_summ = sens_dta_econ %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "IRA.High" ~ "Optimistic",
                              scenario == "IRA.Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Optimistic" = "opt", "Pessimistic" = "pess"))

econ_panel2_summ = sens_dta_econ_panel2 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Growth" = "opt", "Low Growth" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel3_summ = sens_dta_econ_panel3 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "High" ~ "Optimistic",
                              scenario == "Low" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt),
            pess_median = median(diff_pess),
            pess_min = min(diff_pess),
            pess_max = max(diff_pess)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("High Price" = "opt", "Low Price" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel4_summ = sens_dta_econ_panel4 %>%
  select(-c(datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "All Adv" ~ "Optimistic",
                              scenario == "Cons" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(diff_opt = value_Optimistic - value_Core) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt),
            opt_min = min(diff_opt),
            opt_max = max(diff_opt)) %>%
  pivot_longer(cols = starts_with(c("opt_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("All-Adv" = "opt")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

econ_panel5_summ = sens_dta_econ_panel5 %>%
  filter(!is.na(variable)) %>%
  select(-c(stagger,datasrc,region)) %>%
  mutate(scenario = case_when(scenario == "Opt-Adv" ~ "Optimistic",
                              scenario == "Pess-Adv" ~ "Pessimistic",
                              TRUE ~ "Core")) %>%
  pivot_wider(names_from = scenario, values_from = value, names_prefix = "value_") %>%
  mutate(value_Optimistic = case_when(is.na(value_Optimistic) ~ value_Core
                                            , TRUE ~ value_Optimistic),
         value_Pessimistic = case_when(is.na(value_Pessimistic) ~ value_Core
                                            , TRUE ~ value_Pessimistic)) %>%
  mutate(diff_opt = value_Optimistic - value_Core,
         diff_pess = value_Pessimistic - value_Core) %>%
  replace_with_na(replace = list(diff_opt = c(0), diff_pess = c(0),
                             diff_constr = c(0), diff_alladv = c(0))) %>%
  group_by(variable, unit, year) %>%
  summarize(opt_median = median(diff_opt, na.rm = T),
            opt_min = min(diff_opt, na.rm = T),
            opt_max = max(diff_opt, na.rm = T),
            pess_median = median(diff_pess, na.rm = T),
            pess_min = min(diff_pess, na.rm = T),
            pess_max = max(diff_pess, na.rm = T)) %>%
  pivot_longer(cols = starts_with(c("opt_","pess_")), names_to = c("scen","metric"), names_sep = "_") %>%
  mutate(value = round(value,1)) %>%
  pivot_wider(names_from = scen, values_from = value) %>%
  rename(c("Opt-Adv" = "opt", "Pess-Adv" = "pess")) %>%
  data.frame() %>%
  select(-c(variable,unit,year,metric))

all_panels = cbind(econ_panel1_summ, econ_panel4_summ, econ_panel5_summ, econ_panel2_summ, econ_panel3_summ)
all_panels %>% write.csv("./output/final_figures/data/Fig1.4_Summary.csv", row.names = FALSE)


all_panels = add_header_row(flextable(all_panels), values = c("", "IRA Implementation", "Technology", "Combined Technology + Implementation", "Economic Growth", "Energy Price"),
  colwidths = c(4,2,1,2,2,2), top = TRUE)

all_panels = add_header_row(all_panels, values = c("","Difference from IRA Core Scenario (negative is reduced emissions)"), colwidths = c(4,9)) 

all_panels


```



## 1.x Playing around with arrows
```{r, eval = FALSE}
# Economy-wide emissions
clean_data12 = clean_data %>% duplicate_historical_data("EPA-GHGI", 2021, criteria = TRUE)
p = dot_plots_but_with_arrows("time_series", config, clean_data12, figmap_leep_timeseries, 99,
                              "United States", 0, 6000, "Economy-wide Emissions", 
                              metric = "median", historic_coord = c(2017,5540), 
                              preira_coord = c(2030, 4750), ira_coord = c(2029, 3230) )
p$full

p2 = dot_plots_but_with_arrows("time_series", config, clean_data12, 
                               figmap_leep_timeseries, 98,
                              "United States", 0, 2600, "Economy-wide Emissions", 
                              metric = "median", historic_coord = c(2017,2100), 
                              preira_coord = c(2030, 1520), ira_coord = c(2029, 300) )
p2$full
```
