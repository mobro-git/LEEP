---
title: "LEEP Report Figures and Data"
date: "`r Sys.time()`"
output: 
  html_document:
    toc: true
    toc_float: true
params:
  mode: NULL
  format: "svg"
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE, warning = FALSE, message = FALSE, tidy = TRUE, cache = FALSE, paged.print=TRUE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
source("packages.R")
devtools::load_all(here())

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)

# create workbook for saving figure data
# data_wb <- createWorkbook()

# format toggle
format <- "svg"
format <- params$format

# palettes
subpalettes = create_subpalettes(figmap_leep_timeseries, config)
```

# Chapter 1 - Introduction / Economy-Wide

##  Fig 1.2

```{r}
fig_no = 1.2

metric = "median"
ymin = 0

# economy-wide
ymax = 7000

df <- data_from_graph("time_series", config, clean_data, figmap_leep_timeseries, 15, "United States") %>%
  filter(year <= 2021 & model == "EPA-GHGI" | year > 2021 & scenario != "Historic")%>%
  pivot_wider(names_from = year, values_from = value) %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "Haiku-RFF" )

df <- df %>%
  mutate(
    `2021` = case_when(
      is.na(`2021`) & variable_rename == "Total Emissions" ~ df$`2021`[df$variable_rename == "Total Emissions" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Electricity" ~ df$`2021`[df$variable_rename == "Electricity" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Transportation" ~ df$`2021`[df$variable_rename == "Transportation" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Industry" ~ df$`2021`[df$variable_rename == "Industry" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Buildings" ~ df$`2021`[df$variable_rename == "Buildings" & df$model == "EPA-GHGI"], 
      T ~ `2021`
    )
  )

df <- df %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  )) %>%
  mutate(year = as.numeric(year)) %>%
  filter(!is.na(value))

All <- df %>% 
  filter(variable_rename == "Total Emissions")

Electricity <- df %>% 
  filter(variable_rename == "Electricity") 

A = ggplot(data = All, aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.5, aes(alpha = alpha)) +
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = expression(paste("Economy-Wide C", O[2], " Emissions")),
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0,6200), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_alpha(range = c(0.6, 1), guide = F) + 
  annotate("text", x = 2015, y = 4900, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 5500, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022, y = 3800, label = "IRA", color = "#0388B3")

B = ggplot(data = Electricity, aes(year, value, color = scenario, group = interaction(model, scenario), alpha = alpha)) + 
  geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust=1))+
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0,2500), labels = scales::comma) +
  labs(title = "Electricity",
       x = element_blank(),
         y = expression(paste("Mt C", O[2], "/yr")))+ 
  scale_alpha(range = c(0.4, 1), guide = F) 

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "USREP-ReEDS")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


J = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) +
  geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  scale_y_continuous(limits = c(0, 2500), labels = scales::comma) +
  labs(title = "Transportation",
       x = element_blank(),
         y = expression(paste("Mt C", O[2], "/yr")))+ 
  scale_alpha(range = c(0.4, 1), guide = F) 

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


K = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) + geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none", 
        axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(  title = "Buildings",
       x = element_blank(),
         y = element_blank()) + 
  scale_alpha(range = c(0.4, 1), guide = F) + 
  ylim(0,2500)


fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
   pivot_wider(names_from = year, values_from = value) %>%
   filter(!model == "IPM-NRDC",
          !model == "IPM-EPA")


fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


L = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) +geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none", 
        axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(  title = "Industry",
       x = element_blank(),
         y = element_blank()) + 
  scale_alpha(range = c(0.4, 1), guide = F) + 
  ylim(0,2500)


final = (A|B) / (J|K|L) + plot_annotation(tag_levels = list(c("", "", "Sectoral Emissions: Direct + Indirect Electricity", "", ""))) & theme(plot.tag.position = c(1.0, 1.1))

final

savefig(final, fig_no, format, wd = 8)
```

### Table 1.2 Econ

```{r}

title = "Economy Wide Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 15, "United States")

fig$data <- fig$data %>%
  filter(variable == "Emissions|CO2")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 1.2 Power

```{r}

title = "Power Sector Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 11, "United States")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 1.2 Transportaiton

```{r}

title = "Total Transportation Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL", 
         !model == "USREP-ReEDS")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

### Table 1.2 Buildings

```{r}

title = "Total Building Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

### Table 1.2 Industry

```{r}

title = "Total Industry Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

## Fig 1.3

```{r}
fig_no = 1.3
##### Data #####
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 10, "United States")

metric = "median"
ymin = 0
ymax = 45

fig$data <- fig$data %>%
  filter(
    year <= 2021 & scenario == "Historic" | year > 2021 & scenario != "Historic"
  )%>%
  filter(scenario == "Historic" & model == "EIA" & datasrc != "EIAinEMF37.csv" | scenario != "Historic") %>% 
  pivot_wider(names_from = year, values_from = value) %>%
  filter(!model == "RIO-REPEAT")
  

fig$data <- fig$data %>%
  mutate(
    `2021` = case_when(
      is.na(`2021`) & variable_rename == "Coal" ~ fig$data$`2021`[fig$data$variable_rename == "Coal" & fig$data$model == "EIA"],
      is.na(`2021`) & variable_rename == "Gas" ~ fig$data$`2021`[fig$data$variable_rename == "Gas" & fig$data$model == "EIA"], 
      is.na(`2021`) & variable_rename == "Oil" ~ fig$data$`2021`[fig$data$variable_rename == "Oil" & fig$data$model == "EIA"], 
      T ~ `2021`
    )
  ) %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") 

fig$data <- fig$data %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  )) %>%
  mutate(value = value*0.94782, 
         unit = "Quads") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Oil" ~ "Petroleum", 
    T ~ variable_rename
  ))

##### Coal #####
fig_coal = ggplot(data = fig$data[fig$data$variable_rename=="Coal",], aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75, aes(alpha = alpha)) + 
  facet_grid(~variable_rename) +
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(         x = "",
         y = fig$data$unit,
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position = "none") +
    theme(panel.spacing.x = unit(4, "mm")) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.6, 1), guide = F)

df_30 = fig$data[fig$data$variable_rename=="Coal",] %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data[fig$data$variable_rename=="Coal",] %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  
# print("Coal")
# print(stats)
# print(df_stat_30) 
# print(df_stat_35)  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30_coal = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
  scale_alpha(range = c(0.6, 1), guide = F)
  
  # dot plot for 2035
  dots_35_coal = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
  scale_alpha(range = c(0.6, 1), guide = F)
  

  
  
##### Oil #####

fig_oil = ggplot(data = fig$data[fig$data$variable_rename=="Petroleum",], aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75, aes(alpha = alpha)) + 
  facet_grid(~variable_rename) +
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(x = "",
         y = element_blank(),
         color = "") +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position = "none", axis.text.y = element_blank()) +
    theme(panel.spacing.x = unit(4, "mm")) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
    ylim(ymin,ymax)+
  scale_alpha(range = c(0.6, 1), guide = F)
  
  df_30 = fig$data[fig$data$variable_rename=="Petroleum",] %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data[fig$data$variable_rename=="Petroleum",] %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  
# print("Oil")
# print(stats)
# print(df_stat_30) 
# print(df_stat_35) 

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30_oil = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
  scale_alpha(range = c(0.6, 1), guide = F)
  
  # dot plot for 2035
  dots_35_oil = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
  scale_alpha(range = c(0.6, 1), guide = F)

  
##### Gas #####
fig_gas = ggplot(data = fig$data[fig$data$variable_rename=="Gas",], aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75, aes(alpha = alpha)) + 
  facet_grid(~variable_rename) +
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(x = "",
         y = element_blank(),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1), legend.position = "none", axis.text.y = element_blank()) +
    theme(panel.spacing.x = unit(4, "mm")) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.6, 1), guide = F) +
  annotate("text", x = 2010, y = 35, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 35, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022, y = 22.5, label = "IRA", color = "#0388B3")

df_30 = fig$data[fig$data$variable_rename=="Gas",] %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data[fig$data$variable_rename=="Gas",] %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  
# print("Gas")
# print(stats)
# print(df_stat_30) 
# print(df_stat_35) 

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.1, xend = year + 0.1, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30_gas = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_30 +
    #text_code +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0)) +
  scale_alpha(range = c(0.6, 1), guide = F)
  
  # dot plot for 2035
  dots_35_gas = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.2)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
  scale_alpha(range = c(0.6, 1), guide = F)

final_coal = fig_coal + dots_30_coal + dots_35_coal +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

final_gas = fig_gas + dots_30_gas + dots_35_gas + 
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
final_oil = fig_oil + dots_30_oil + dots_35_oil + 
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))



final = (final_coal | final_gas | final_oil)


print(final)

ggsave(filename = paste("output/final_figures/",format,"/Fig",fig_no,".",format,sep=""), 
       plot = final, width = 7, height = 5, units = "in")
```

### Table 1.3 Coal

```{r}

title = "Coal Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 10, "United States")

fig$data <- fig$data %>%
  filter(variable_rename == "Coal")

base <- fig$data %>%
  filter(year == 2005 & model == "EIA")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

### Table 1.3 Gas

```{r}

title = "Gas Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 10, "United States")

fig$data <- fig$data %>%
  filter(variable_rename == "Gas")

base <- fig$data %>%
  filter(year == 2005 & model == "EIA")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

### Table 1.3 Oil

```{r}

title = "Oil Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 10, "United States")

fig$data <- fig$data %>%
  filter(variable_rename == "Oil")

base <- fig$data %>%
  filter(year == 2005 & model == "EIA")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

# Chapter 2 - Electricity

## Fig 2.1

```{r}
fig_no = 2.1

data <- clean_data %>%
  filter(model == "EPA-GHGI") %>%
  filter(year >= 2005) %>%
  filter(variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Coal"|
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Commercial|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Buildings|Residential|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Coal" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Industry|Oil" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Gas" |
         variable == "Emissions|CO2|Energy|Demand|Transportation|Oil" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Coal" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Gas" |
         variable == "Emissions|CO2|Energy|Supply|Electricity|Oil") %>%
  mutate(variable_rename = case_when(
    grepl("Demand", variable) ~ "Other Sectors",
    grepl("Coal", variable) ~ "Coal", 
    grepl("Gas", variable) ~ "Gas", 
    grepl("Oil", variable) ~ "Petroleum",
  )) %>%
  group_by(year, variable_rename) %>%
  summarise(value = sum(value)) %>%
  mutate(alpha = case_when(
    variable_rename == "Other Sectors" ~ 0.5, 
    T ~ 1))

data$variable_rename <- factor(data$variable_rename, level = c("Other Sectors", "Coal", "Gas", "Petroleum"))

fig = ggplot(data, aes(fill = variable_rename, y = value, alpha = alpha, x = year, color = variable_rename)) + 
  geom_bar(position = "stack", stat = "identity") + 
  theme_emf() +
  labs(title = "",
         x = "",
         y = expression(paste("Mt C", O[2], "/yr"))) +
    scale_y_continuous(limits = c(0, 6000), labels = scales::comma) +
    scale_x_continuous(breaks = c(2005, 2021)) + 
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") +
    scale_alpha(range = c(0.6, 1), guide = F)+
  scale_color_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "black")) +
  scale_fill_manual(breaks = c( "Coal", "Gas", "Petroleum", "Other Sectors"), 
                     values = c( "#003052", "#BC8F73", "#733D3D", "white")) 

print(fig)

ggsave(filename = paste("output/final_figures/",format,"/Fig",fig_no,".",format,sep=""), 
       plot = final, width = 7, height = 5, units = "in")
```

## Fig 2.3

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 11, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      is.na(`2021`) ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"],
      T ~ `2021`
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))
  

fig = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75, aes(alpha = alpha)) +  
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "",
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
    scale_alpha(range = c(0.6, 1), guide = F)+
  annotate("text", x = 2015, y = 2250, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 1750, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2023, y = 650, label = "IRA", color = "#0388B3")

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0)) +
    scale_alpha(range = c(0.6, 1), guide = F)
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
    scale_alpha(range = c(0.6, 1), guide = F)

final = fig + dots_30 + dots_35 +
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)


ggsave(filename = "output/final_figures/Fig2.3.svg", plot = final,width = 7, height = 5, units = "in")

ggsave(filename = "output/final_figures/Fig2.3.png", plot = final,width = 7, height = 5, units = "in")
```

### Table 2.3

```{r}

title = "Power Sector Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 11, "United States")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

## Fig 2.4

```{r}
##### Data #####
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

ymin = 0
ymax = 2600
metric = "median"

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

low <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

high <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))

individual <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))




##### All Total #####
df_21 = total %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = total %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = total %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_total <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Total = ggplot(data = data_total, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Total Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "TWh") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Low Total #####
df_21 = low %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = low %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = low %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Low <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Low = ggplot(data = data_Low, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Low or Zero Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### High Total #####
df_21 = high %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = high %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))

df_35 = high %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_High <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_High = ggplot(data = data_High, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"High Emitting Generation") +
    scale_y_continuous(limits = c(ymin, 6500), breaks = c(0, 3250 , 6500)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Nuclear #####
df_21 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Nuclear", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Nuclear <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Nuclear = ggplot(data = data_Nuclear, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Nuclear") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Solar #####
df_21 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Solar", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Solar <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Solar = ggplot(data = data_Solar, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Solar") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Wind #####

df_21 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Wind", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Wind <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Wind = ggplot(data = data_Wind, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Wind") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "TWh") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### CCS #####

df_21 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "CCS", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_CCS <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_CCS = ggplot(data = data_CCS, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"CCS") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Coal #####
df_21 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Coal", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Coal <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Coal = ggplot(data = data_Coal, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Coal") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600), labels = scales::comma) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    labs(y = "TWh") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Gas #####
df_21 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Natural Gas", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Gas <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Gas = ggplot(data = data_Gas, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Natural Gas") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Other #####
df_21 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2021))
df_stat_21 = df_21 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = individual[individual$variable_rename == "Other", ] %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2030, 2035, 2030, 2035), "metric" = c("mean","mean","median","median"), 
                   "difference" = c(mean_diff_30, mean_diff_35,median_diff_30, median_diff_35))

data = rbind(df_21, df_30, df_35) 

 

data_Other <- data %>%
  mutate(axe = case_when(
    year == 2021 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  mutate(scenario = case_when(
    year == 2021 ~ "Historic", 
    T ~ scenario)
  )

dots_Other = ggplot(data = data_Other, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = -0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
    facet_wrap(~"Other") +
    scale_y_continuous(limits = c(ymin, 2600), breaks = c(0, 1300 , 2600)) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2021", "2030", "2035")) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_blank(), 
          axis.text.y = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none", 
          plot.margin = margin(0,0,0,0)) + 
  scale_alpha(range = c(0.6, 1), guide = F)

##### Final #####
final = (dots_Total | dots_Low | dots_High) / (dots_Wind | dots_Solar | dots_Nuclear | dots_CCS) / (dots_Coal | dots_Gas | dots_Other) 

final = final + 
  plot_layout(
  guides = "collect"
) & theme(legend.position = "bottom")
final

ggsave(filename = "output/final_figures/Fig2.4.svg", plot = final,width = 9, height = 8, units = "in")

ggsave(filename = "output/final_figures/Fig2.4.png", plot = final,width = 9, height = 8, units = "in")
```

### Table 2.4 Total

```{r}

title = "Total Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)


IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)


IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Low

```{r}

title = "Low Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "CCS" | 
         variable_rename == "Other" |
         variable_rename == "Nuclear" |
         variable_rename == "Solar" |
         variable_rename == "Wind"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_Low")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 High

```{r}

title = "High Emitting Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  filter(variable_rename == "Coal" |
         variable_rename == "Natural Gas" |
         variable_rename == "Oil"
) %>%
  group_by(scenario, model, year) %>%
  summarise(value = sum(value)) %>%
  mutate(variable_rename = "Total_High")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Wind

```{r}

title = "Wind Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Wind")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Solar

```{r}

title = "Solar Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Solar")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Nuclear

```{r}

title = "Nuclear Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Nuclear")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 CCS

```{r}

title = "CCS Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "CCS")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Coal

```{r}

title = "Coal Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Coal")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Gas

```{r}

title = "Nautural Gas Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Natural Gas")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table 2.4 Other

```{r}

title = "Other Electricity Generation"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 16, "United States")

fig$data <- fig$data %>%
  filter(year == 2005 | year == 2021 | year == 2030 | year == 2035)%>%
  filter(!model == "EIA") %>%
  filter(!model == "EIA-STEO") %>%
  mutate(value = value/0.0036, 
         unit = "TWh")

total <- fig$data %>%
  mutate(
    variable_rename = case_when(variable_rename == "Oil" ~ "Other", 
                                T ~ variable_rename)
  ) %>%
  group_by(year, variable_rename, model, scenario) %>%
  summarise(value = sum(value)) %>%
  filter(variable_rename == "Other")

base <- total %>%
  filter(year == 2005 & model == "EIA-LTS")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (TWh)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (TWh)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (TWh)`)

NoIRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (TWh)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- total %>%
  filter(year == 2021 | year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (TWh)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (TWh)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)/NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (TWh)` = case_when(
            year == 2021 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2021 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2021 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (TWh)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (TWh)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (TWh)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)



IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA$`Absolute Level (TWh)` = round(IRA$`Absolute Level (TWh)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (TWh)` = round(IRA$`Reductions from No IRA (TWh)`,3)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

# Chapter 3 - Transportation

## Fig 3.3

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

metric = "median"
ymin = 0
ymax = 2100

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "USREP-ReEDS")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


fig = ggplot(data = fig$data, aes(year, value, alpha = alpha, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75) + 
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "",
         x = "",
         y = expression(paste("Mt ", CO[2], "/yr", sep = "")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.4, 1), guide = F) + 
  annotate("text", x = 2015, y = 2000, label = "Historic", color = "black") + 
  annotate("text", x = 2030, y = 2100, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2025, y = 1250, label = "IRA", color = "#0388B3")

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))

final = fig + dots_30 + dots_35 + 
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)

ggsave(filename = "output/final_figures/Fig3.3.svg", plot = final,width = 7, height = 5, units = "in")

ggsave(filename = "output/final_figures/Fig3.3.png", plot = final,width = 7, height = 5, units = "in")
```

### Table 3.3

```{r}

title = "Total Transportation Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL", 
         !model == "USREP-ReEDS")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

## Fig 3.5

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 24, "United States")

ymin = 0
ymin = 700
metric = "median"

data <- fig$data %>%
  filter(year == 2025 | year == 2030 | year == 2035)%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))%>%
  mutate(value = value/0.0036, 
         unit = "TWh")

df_25 = data %>%
  filter(year %in% c(2025))
df_stat_25 = df_25 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = data %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = data %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_25 = df_stat_30[df_stat_25$scenario == "No IRA","mean"]$mean - df_stat_25[df_stat_25$scenario == "IRA","mean"]$mean
median_diff_25 = df_stat_35[df_stat_25$scenario == "No IRA","median"]$median - df_stat_25[df_stat_25$scenario == "IRA","median"]$median

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2025, 2030, 2035, 2025,  2030, 2035), "metric" = c("mean","mean", "mean", "median", "median","median"), 
                   "difference" = c(mean_diff_25, mean_diff_30, mean_diff_35, median_diff_25, median_diff_30, median_diff_35))

data = rbind(df_25, df_30, df_35) 

print("Light-Duty Vehicles")

data <- data %>%
  mutate(axe = case_when(
    year == 2025 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  filter(scenario == "No IRA" | scenario == "IRA")



A = ggplot(data = data, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_25, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2025", "2030", "2035")) +
    theme_emf() +
    labs(y = "TWh") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom") + 
  scale_alpha(range = c(0.6, 1), guide = F) + 
  ylim(0, 700)

print(A)

ggsave(filename = "output/final_figures/Fig3.5.svg", plot = A,width = 7, height = 5, units = "in")

ggsave(filename = "output/final_figures/Fig3.5.png", plot = A,width = 7, height = 5, units = "in")
```

### Table 3.5

```{r}

title = "Light Duty Vehicles"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 24, "United States")

fig$data <- fig$data %>%
   mutate(value = value/0.0036)

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

# Chapter 4 - Buildings

## Fig 4.2

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


A = ggplot(data = fig$data, aes(year, value, alpha = alpha, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75) + 
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = expression(paste("Total Building C", O[2], " Emissions")),
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.4, 1), guide = F) + 
  annotate("text", x = 2015, y = 2250, label = "Historic", color = "black") + 
  annotate("text", x = 2030, y = 1675, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022.5, y = 1000, label = "IRA", color = "#0388B3")

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  Adots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  Adots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))

Adone =  A + Adots_30 + Adots_35 + 
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))


fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 14, "United States")


metric = "median"
ymin = 0
ymax = 1750

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))
  

B = ggplot(data = fig$data, aes(year, value, color = scenario, alpha = alpha, group = interaction(model, scenario))) + 
  geom_line(size = 1) + 
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "Direct Combustion",
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() + 
  
    theme(axis.text.x = element_text(angle = 45, hjust=1))+
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.4, 1), guide = F)
    
df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  Bdots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0)) + 
    scale_alpha(range = c(0.6, 1), guide=F)
  
  # dot plot for 2035
  Bdots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+ 
    scale_alpha(range = c(0.6, 1), guide=F)


fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 22, "United States")

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


C = ggplot(data = fig$data, aes(year, value, alpha = alpha, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75) + 
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "Indirect from Electricity",
         x = "",
         y = "",
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1), 
          axis.text.y = element_blank()) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_alpha(range = c(0.4, 1), guide = F)

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  Cdots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  Cdots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  Bdone =  B + Bdots_30 + Bdots_35 + 
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))
  
  Cdone =  C + Cdots_30 + Cdots_35 + 
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

final = (Adone) / (Bdone | Cdone)

print(final)

#total, direct, indirect
ggsave(filename = "output/final_figures/Fig4.2b.svg", plot = final,width = 7, height = 5, units = "in")
ggsave(filename = "output/final_figures/Fig4.2b.png", plot = final,width = 7, height = 5, units = "in")

#total only
ggsave(filename = "output/final_figures/Fig4.2.svg", plot = Adone,width = 7, height = 5, units = "in")
ggsave(filename = "output/final_figures/Fig4.2.png", plot = Adone,width = 7, height = 5, units = "in")

```

### Table 4.2 Total

```{r}

title = "Total Building Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```

### Table 4.2 Direct

```{r}

title = "Direct Building Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 14, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

### Table 4.2 Indirect

```{r}

title = "Indirect Building Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 22, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

## Fig 4.3

```{r}
#need real data and color directions

data <- read.csv("./data-extra/scout_buildings_IRA_scenario_emissions_wedges.csv")

data_sort <- data %>%
  filter(year <= 2035) %>%
  filter(year >= 2025) %>%
  mutate(scenario = case_when(
    scenario == "IRA-Low" ~ "IRA-Pessimistic", 
    scenario == "IRA-Central" ~ "IRA-Core", 
    scenario == "IRA-High" ~ "IRA-Optimistic"
  )) %>%
  rename(Reference = `Reference.Building.Emissions`,
         Total = `Total.Building.Emissions`, 
         Power = `Power.Supply.Decarbonization`, 
         WaterHeating = `Water.Heating`, 
         HVAC = HVAC.Env) %>%
  pivot_longer(
    cols = c(Reference, Total, Power, Other, WaterHeating, HVAC), names_to = "variable_rename"
  )
  
ref <- data_sort[data_sort$variable_rename == "Reference",]

data_sort$scenario <- factor(data_sort$scenario, levels = c("IRA-Pessimistic", "IRA-Core", "IRA-Optimistic"))
data_sort$variable_rename <- factor(data_sort$variable_rename, levels = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"))


fin = ggplot(data = data_sort[data_sort$variable_rename != "Reference",] , aes(x=year, y=value, fill = variable_rename)) +
  geom_area() +
  facet_grid(~scenario) +
  labs(title = "",
         x = "",
         y = expression(Mt ~ CO[2]),
         color = "") +
    scale_y_continuous(limits = c(0, 1500), labels = scales::comma) +
    theme_emf() +
    scale_x_continuous(breaks = c(2025, 2030, 2035)) + 
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "bottom") + 
  guides(fill = guide_legend(nrow = 2)) + 
  scale_fill_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("HVAC", "WaterHeating", "Other", "Power", "Total") 
  ) + 
  
  geom_line(data = data_sort[data_sort$variable_rename == "Reference",],  aes(x=year, y=value, color = variable_rename),linetype="dashed") +
  scale_color_manual(name = "", 
    labels = c("HVAC/Env", "Water Heating", "Other" , "Power Supply Decarbonizaiton", "Total Building Emissions", "Reference"),
    breaks = c("HVAC", "WaterHeating", "Other","Power", "Total", "Reference"), 
    values = c("#75FF8E", '#f58231', "#FFF362",  '#42d4f4', "#DEDEDE", "#767684"),
    limits = c("Reference") 
  )
fin

ggsave(filename = "output/final_figures/Fig4.3.svg", plot = fin,width = 8, height = 5, units = "in")

ggsave(filename = "output/final_figures/Fig4.3.png", plot = fin,width = 8, height = 5, units = "in")
```

# Chapter 5 - Industry

## Fig 5.2

```{r}
## TODO: Need to fix gcam-pnnl industry emissions and energy w/ new variables for supply

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

metric = "median"
ymin = 0
ymax = 1600

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


fig = ggplot(data = fig$data, aes(year, value, alpha = alpha, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75) + 
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "",
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_x_continuous() + 
  scale_alpha(range = c(0.4, 1), guide = F) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  annotate("text", x = 2015, y = 1550, label = "Historic", color = "black") + 
  annotate("text", x = 2030, y = 1575, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2020, y = 750, label = "IRA", color = "#0388B3")

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  

  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))

final = fig + dots_30 + dots_35 + 
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)

ggsave(filename = "output/final_figures/Fig5.2.svg", plot = final,width = 7, height = 5, units = "in")

ggsave(filename = "output/final_figures/Fig5.2.png", plot = final,width = 7, height = 5, units = "in")

```

### Table 5.2

```{r}

title = "Total Industry Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

# Chapter 6 - Pathways to Net-Zero Emissions in 2050

## Figs 6.3, 6.4, 6.5
Faceted Versions of LTS Cone plots
```{r}
# Buildings Energy: Figure 6.4

p = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 15, 16, "United States", 0, 15, title = "Buildings Sector Final Energy", "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Electricity', 'Non-Electric'))) +
  theme(plot.title = element_blank())
p
ggsave(filename = "output/leep/cone_uncertainty/Fig6.4_LTS_cone_buildings_facet.svg",p, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.4_LTS_cone_buildings_facet.png",p, width = 7, height = 5, units = "in")

# Transportation Energy: Figure 6.3
p3 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 11, 12, "United States", 0, 30, title = "Transportation Sector Final Energy" , "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Fuels'))) +
  theme(plot.title = element_blank())
p3
ggsave(filename = "output/leep/cone_uncertainty/Fig6.3_LTS_cone_transport_facet.svg",p3, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.3_LTS_cone_transport_facet.png",p3, width = 7, height = 5, units = "in")

# Industrial Energy: Figure 6.5
p4 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 13, 14, "United States", 0, 23, title = "Industrial Sector Final Energy", "median", facet = TRUE) +
  facet_grid(~factor(variable_rename, levels=c('Fossil', 'Electricity', 'Alternative Fuels'))) +
  theme(plot.title = element_blank())
p4
ggsave(filename = "output/leep/cone_uncertainty/Fig6.5_LTS_cone_industry_facet.svg", p4, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.5_LTS_cone_industry_facet.png", p4, width = 7, height = 5, units = "in")

# # Economy-wide Emissions
# p5 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 9, 10, "United States", -100, 2500, title = "Economy-Wide Combustions Emissions by Sector", "median", facet = TRUE) +
#   facet_grid(~factor(variable_rename, levels=c('Electricity', 'Transportation', 'Buildings', 'Industry')))
# # p5
# ggsave(filename = "output/leep/cone_uncertainty/Fig6.2_LTS_cone_emissions_facet.svg", p5, width = 7, height = 5, units = "in")
# ggsave(filename = "output/leep/cone_uncertainty/Fig6.2_LTS_cone_emissions_facet.png", p5, width = 7, height = 5, units = "in")
  

# filler = data.frame("model" = c("NA"), "scenario" = c("NA"), "year" = c(2020), variable = c("Emissions|CO2|Energy|Supply|Electricity"),
#                variable_rename = c("Electricity"), unit = c("Mt CO2/yr"), value = c(-200))
  
# Economy-wide Indirect Emissions
# p6 = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 17, 18, "United States", 
#                             -100, 2500, "median", facet = TRUE) +
#   theme(axis.text.y = element_blank(), plot.title = element_blank(), axis.title.y = element_blank()) +
#   facet_grid(~factor(variable_rename, levels = c('Electricity', 'Transportation', 'Buildings', 'Industry')))
# p6

# p6a = filler %>% ggplot() +
#   geom_point(aes(x = year, y = value)) +
#   labs(y = "Mt CO2/yr") +
#   scale_y_continuous(limits = c(-100, 2500)) +
#   scale_x_continuous(limits = c(2005, 2050), 
#                      breaks = c(2005, 2021, 2030, 2040, 2050), labels = c(2005, 2021, 2030, 2040, 2050)) +
#   facet_grid(~factor(variable_rename, levels = c('Electricity', 'Transportation', 'Buildings', 'Industry'))) +
#   theme_emf() +
#   theme(axis.ticks = element_blank(), axis.title.x = element_blank(),
#         axis.text.x = element_text(angle = 45, hjust = 1))
# # p6a
# 
# p6b = (p6a | p6) +
#   plot_annotation(title = "Economy-Wide Emissions from Electricity Used", theme = theme(plot.title = element_text(hjust = 0.5))) +
#   plot_layout(widths = c(1,3)) +
#   theme(plot.margin = margin(0,0,0,0))
  
#p6b
#ggsave(filename = "output/leep/cone_uncertainty/Fig6.2A_LTS_cone_indirect_emissions_facet.svg", p6b, width = 7, height = 5, units = "in")

  
```

### data table for LTS plots -- Needs to be updated

```{r, eval = FALSE}

leep_models = c("USREP-ReEDS", "EPS-EI", "GCAM-CGS", "GCAM-PNNL", "GCAM-USA", "Haiku-RFF", "IPM-NRDC",
                "IPM-EPA", "MARKAL-NETL", "NEMS-RHG", "NEMS-RHG", "OP-NEMS", "REGEN-EPRI", "RIO-REPEAT",
                "ReEDS-NREL", "Scout-LEEP", "EIA-LTS", "EIA-STEO", "IEA")

clean_data10 = clean_data %>% mutate(
  variable = case_when(
    (model == "GCAM-LTS" & variable == "Emissions|CO2|Energy|Demand|Industry") ~
      "Emissions|CO2|Energy|Demand|Industry and Fuel Production",
    TRUE ~ variable
  )
)

lts_data_table = function(focus, leep_models) {
  print(focus)
  dta_lts = clean_data10 %>% 
    filter(variable == focus, model == "GCAM-LTS", scenario == "LTS.Mid1", year %in% c(2030, 2035)) %>%
    group_by(year, unit) %>%
    summarize(median = median(value)) %>%
    mutate(scenario = "NZ2050")
  
  dta_leep = clean_data10 %>% 
    filter(variable == focus, model %in% leep_models, year %in% c(2030, 2035), scenario == "IRA") %>%
    group_by(year, unit) %>%
    summarize(median = median(value)) %>%
    mutate(scenario = "IRA")
  
  dta_combo = rbind(dta_lts, dta_leep) %>%
    mutate(variable = focus) %>%
    select(scenario, variable, year, unit, median) %>%
    pivot_wider(names_from = scenario, values_from = c(median)) %>%
    data.frame() %>%
    rename(median_IRA = IRA) %>%
    rename(median_NZ2050 = NZ2050) %>%
    mutate(diff_median = median_IRA - median_NZ2050) %>%
    # #mutate(diff_mean = mean_IRA - mean_NZ2050) %>%
    mutate(pct_diff_median = diff_median / median_NZ2050)
    # #mutate(pct_diff_mean = diff_mean / mean_NZ2050)
  return(dta_combo)
}

t = lts_data_table("Final Energy|Buildings|NonElectric", leep_models)

# Emissions
tab = rbind(lts_data_table("Emissions|CO2|Energy|Demand|Buildings", leep_models), 
      lts_data_table("Emissions|CO2|Energy|Demand|Industry and Fuel Production", leep_models),
      lts_data_table("Emissions|CO2|Energy|Demand|Transportation", leep_models), 
      lts_data_table("Emissions|CO2|Energy|Supply|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Emissions_LTS_table.csv", row.names = FALSE)

# Final Energy Transport
tab = rbind(lts_data_table("Final Energy|Transportation|Fossil", leep_models),
            lts_data_table("Final Energy|Transportation|Alternative Fuels", leep_models),
            lts_data_table("Final Energy|Transportation|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Transportation_Energy_LTS_table.csv", row.names = FALSE)

# Final Energy Buildings
tab = rbind(lts_data_table("Final Energy|Buildings|Electricity", leep_models),
      lts_data_table("Final Energy|Buildings|NonElectric", leep_models))
print(tab)
write.csv(tab, "output/Buildings_Energy_LTS_table.csv", row.names = FALSE)

# Final Energy Industry
tab = rbind(lts_data_table("Final Energy|Industry|Fossil", leep_models),
            lts_data_table("Final Energy|Industry|Alternative Energy", leep_models), 
            lts_data_table("Final Energy|Industry|Electricity", leep_models))
print(tab)
write.csv(tab, "output/Industrial_Energy_LTS_table.csv", row.names = FALSE)


```

## Fig 6.2

```{r}
# LTS Cone plot for economy-wide emissions

# buildings cone
mid = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 23, 24, "United States", -100, 2500, "Buildings", 8, "median", facet = TRUE) +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
mid

# transportation cone
left = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 21, 22, "United States", -100, 2500, "Transportation", 8, "median", facet = TRUE)
left

# industry cone
right = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 25, 26, "United States", -100, 2500, "Industrial", 8, "median", facet = TRUE) +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank())
right

# electric sector cone
top = lts_coneplot_with_dots(config, clean_data, figmap_leep_cone, 19, 20, "United States", -100, 2500, "Electric Sector CO2 Emissions", 12, "median", facet = FALSE)
top

# put 'em all together
bottom = (left | mid | right) + plot_annotation(title = "Direct and Indirect CO2 Emissions", theme = theme(plot.title = element_text(hjust = 0.5, size = 12), plot.margin = margin(0,0,0,0)))
bottom

combined = (wrap_elements(top) / wrap_elements(bottom))
combined

ggsave(filename = "output/leep/cone_uncertainty/Fig6.2NEW_LTS_cone_indirect_emissions_TOTAL.svg", 
       combined, width = 7, height = 5, units = "in")
ggsave(filename = "output/leep/cone_uncertainty/Fig6.2NEW_LTS_cone_indirect_emissions_TOTAL.png", 
       combined, width = 7, height = 5, units = "in")

```


# Executive Summary

## Fig ES1

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 11, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      is.na(`2021`) ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"],
      T ~ `2021`
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year))%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  ))
  

fig = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.75, aes(alpha = alpha)) +  
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = "",
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
    scale_y_continuous(limits = c(ymin, ymax), labels = scales::comma) +
    theme_emf() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
    scale_alpha(range = c(0.6, 1), guide = F)+
  annotate("text", x = 2015, y = 2250, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 1750, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2023, y = 650, label = "IRA", color = "#0388B3")

df_30 = fig$data %>%
    filter(year %in% c(2030))
  df_stat_30 = df_30 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = fig$data %>%
    filter(year %in% c(2035))
  df_stat_35 = df_35 %>%
    group_by(scenario,year,variable_rename) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  
  mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
  mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean
  median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
  median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median
  # stick em all in a data frame
  stats = data.frame("year" = c(2030,2035,2030,2035), "metric" = c("mean","mean","median","median"), 
                     "difference" = c(mean_diff_30, mean_diff_35, median_diff_30, median_diff_35))
  
  # a few of the ggplot lines of code vary based on the year or on the metric chosen, so conditionally choose the right one here
  if (metric == "mean") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = mean, yend = mean, color = scenario),
                                   size = 1)
  } else if (metric == "median") {
    segment_code_30 = geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
    segment_code_35 = geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario), 
                                   size = 1)
  }
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_30 +
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(ymin, ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0)) +
    scale_alpha(range = c(0.6, 1), guide = F)
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.05)) +
    segment_code_35 +
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(ymin,ymax)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))+
    scale_alpha(range = c(0.6, 1), guide = F)

final = fig + dots_30 + dots_35 +
    plot_annotation(title =  fig$data$plot_title, theme = theme(plot.title = element_text(hjust = 0.5))) +
    plot_layout(guides = "collect", widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)


ggsave(filename = "output/final_figures/FigES1.svg", plot = final,width = 7, height = 5, units = "in")


ggsave(filename = "output/final_figures/FigES1.png", plot = final,width = 7, height = 5, units = "in")
```

### Table ES1

```{r}

title = "Power Sector Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 11, "United States")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

## Fig ES3

```{r}
fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 15, "United States")

metric = "median"
ymin = 0
ymax = 7000

df <- fig$data %>%
  filter(year <= 2021 & model == "EPA-GHGI" | year > 2021 & scenario != "Historic")%>%
  pivot_wider(names_from = year, values_from = value) %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "Haiku-RFF" )
  

df <- df %>%
  mutate(
    `2021` = case_when(
      is.na(`2021`) & variable_rename == "Total Emissions" ~ df$`2021`[df$variable_rename == "Total Emissions" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Electricity" ~ df$`2021`[df$variable_rename == "Electricity" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Transportation" ~ df$`2021`[df$variable_rename == "Transportation" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Industry" ~ df$`2021`[df$variable_rename == "Industry" & df$model == "EPA-GHGI"],
      
      is.na(`2021`) & variable_rename == "Buildings" ~ df$`2021`[df$variable_rename == "Buildings" & df$model == "EPA-GHGI"], 
      T ~ `2021`
    )
  )

df <- df %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  )) %>%
  mutate(year = as.numeric(year)) %>%
  filter(!is.na(value))

All <- df %>% 
  filter(variable_rename == "Total Emissions")

A = ggplot(data = All, aes(year, value, color = scenario, group = interaction(model, scenario))) + 
  geom_line(size = 0.5, aes(alpha = alpha)) +
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  labs(title = expression(paste("Economy-Wide C", O[2], " Emissions")),
         x = "",
         y = expression(paste("Mt C", O[2], "/yr")),
         color = "") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0,6200), labels = scales::comma) +
    theme_emf() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
    theme(panel.spacing.x = unit(4, "mm"), legend.position = "none") + 
  scale_alpha(range = c(0.6, 1), guide = F) + 
  annotate("text", x = 2015, y = 4900, label = "Historic", color = "black") + 
  annotate("text", x = 2027.5, y = 5500, label = "No IRA", color = "#F28063") + 
  annotate("text", x = 2022, y = 3800, label = "IRA", color = "#0388B3")

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "USREP-ReEDS")



fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


J = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) +
  geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0, 2500), breaks = c(0 , 1250, 2500), labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(title = "Transportation",
       x = element_blank(),
         y = expression(paste("Mt C", O[2], "/yr")))+ 
  scale_alpha(range = c(0.4, 1), guide = F) 

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
  pivot_wider(names_from = year, values_from = value)%>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


K = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) + geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none", 
        axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0, 2500), breaks = c(0 , 1250, 2500), labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(  title = "Buildings",
       x = element_blank(),
         y = element_blank()) + 
  scale_alpha(range = c(0.4, 1), guide = F)


fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

metric = "median"
ymin = 0
ymax = 2500

fig$data <- fig$data %>%
  filter(
    year <= 2021 & model == "EPA-GHGI" | year >= 2021 & scenario != "Historic"
  ) %>%
   pivot_wider(names_from = year, values_from = value) %>%
   filter(!model == "IPM-NRDC",
          !model == "IPM-EPA")


fig$data <- fig$data %>%
  mutate(
    `2021`= case_when(
      T ~ fig$data$`2021`[fig$data$model == "EPA-GHGI"]
    )
  )

fig$data <- fig$data %>%
  pivot_longer(cols = starts_with("20"), names_to = "year", values_to = "value") %>%
  filter(!is.na(value)) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))


L = ggplot(data = fig$data, aes(year, value, color = scenario, group = interaction(model, scenario))) +geom_line(size = 0.5, aes(alpha = alpha)) + 
  scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  theme_emf() +
  theme(legend.position = "none", 
        axis.text.y = element_blank()) +
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) +
  scale_y_continuous(limits = c(0, 2500), breaks = c(0 , 1250, 2500), labels = scales::comma) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(  title = "Industry",
       x = element_blank(),
         y = element_blank()) + 
  scale_alpha(range = c(0.4, 1), guide = F) 


final = (A) / (J|K|L) + plot_annotation(tag_levels = list(c("", "Sectoral CO2 Emissions: Direct + Indirect Electricity", "", ""))) & theme(plot.tag.position = c(1.0, 1.1))

final = A / (J | K | L) + 
    plot_layout(heights = c(25, 15, 15,15), widths = c(9, 3.2, 2.9, 2.9)) + plot_annotation(tag_levels = list(c("", "Sectoral Emissions: Direct + Indirect Electricity", "", ""))) & theme(plot.tag.position = c(1, 1.1))

final

ggsave(filename = "output/final_figures/FigES3.svg", plot = final,width = 8, height = 8, units = "in")

ggsave(filename = "output/final_figures/FigES3.png", plot = final,width = 8, height = 8, units = "in")


```

### Table ES3 Econ

```{r}

title = "Economy Wide Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 15, "United States")

fig$data <- fig$data %>%
  filter(variable == "Emissions|CO2")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)




```

### Table ES3  Transportaiton

```{r}

title = "Total Transportation Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 19, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL", 
         !model == "USREP-ReEDS")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

### Table ES3 Buildings

```{r}

title = "Total Building Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 23, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model =="ReEDS-NREL", 
         !model == "Scout-LEEP", 
         !model == "MARKAL-NETL", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)





```

### Table ES3 Industry

```{r}

title = "Total Industry Emissions"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 21, "United States")

fig$data <- fig$data %>%
  filter(!model == "IPM-NRDC", 
         !model == "IPM-EPA", 
         !model == "GCAM-PNNL")

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)

```

## Fig ES 4/6.1 DO NOT USE THIS ONE

```{r}
ghgi <- clean_data %>%
  filter(model == "EPA-GHGI") %>%
  filter(variable == "Emissions|GHG|Net")%>%
  filter(year >= 2005)

connect <- ghgi[ghgi$year == 2021,] %>%
  select(year, value)%>%
  mutate(ymin = value, 
         ymax = value, 
         med = value) %>%
  select(-value)

lts <- clean_data %>%
  filter(grepl("LTS", model)) %>%
  filter(grepl("Emissions", variable)) %>%
  filter(variable == "Emissions|CO2" | 
           variable == "Emissions|CH4" |
           variable == "Emissions|N2O" | 
           variable == "Emissions|F-Gases") %>%
  mutate(value = case_when(
    unit == "Mt CH4/yr" ~ value * 28,
    unit == "kt N2O/yr" ~ value * 265/1000, 
    T ~ value
  )) %>%
  group_by(year, scenario) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>%
  group_by(year) %>%
  summarize(ymax = max(value), 
            ymin = min(value), 
            med = median(value)) %>%
  filter(year <= 2035) %>%
  filter(year >= 2021)

lts <- rbind(lts, connect)

IRA <- clean_data %>%
  filter(scenario == "IRA" | scenario == "No IRA") %>%
  filter(year > 2021  & year <= 2035) %>%
  filter(variable == "Emissions|CO2" | variable == "Emissions|Non-CO2 GHG") %>%
  group_by(year, model, scenario) %>%
  summarise(
    value = sum(value)
  )%>%
  filter(!model == "USREP-ReEDS")

histcon <- IRA %>%
  group_by(model, scenario) %>%
  slice(1) %>%
  mutate(year = 2021) %>%
  mutate(value = ghgi$value[ghgi$year == 2021])

IRA <- rbind(IRA, histcon)

IRA <- IRA %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  )) 


fin = ggplot() + 
  geom_line(ghgi, mapping = aes(x = year, y = value/1000, color = "Historic"), size = 0.8) +
  geom_line(lts, mapping = aes(x=year, y = ymin/1000, color = "LTS"), linetype = "dashed", size = 0.8, color = "green")+
  geom_line(lts, mapping = aes(x=year, y = ymax/1000, color = "LTS"), linetype = "dashed", size = 0.8, color = "green")+
  geom_ribbon(lts, mapping = aes(x=year, ymax = ymax/1000, ymin = ymin/1000, fill = "LTS"), alpha = 0.2) + 
  geom_line(IRA, mapping = aes(x=year, y = value/1000, group = interaction(model, scenario), color = scenario, alpha = alpha)) + 
  scale_color_manual(name = "", 
                     breaks = c("IRA", "No IRA", "Historic", "LTS"), 
                     values = c("#0388B3","#F28063", "black", "green"), 
                     labels = c("IRA", "No IRA", "Historic Emissions", "Emissions Targets")) + 
  scale_fill_manual(name = "", 
                    breaks = c("IRA", "No IRA", "Historic", "LTS"), 
                     values = c("#0388B3","#F28063", "black", "green"), 
                     labels = c("IRA", "No IRA", "Historic Emissions", "Emissions Targets")) +
  theme_emf() + 
  labs(title = "", 
       y = expression(paste("Emissions (MMt ", CO[2], "e)", sep = "")), 
       x = "") +
  scale_alpha(range = c(0.6, 1), guide = F) + 
  ylim(-0.5, 8) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        legend.box = "vertical",
        legend.text = element_text(size = 8),
        legend.spacing.y = unit(0.5, "mm"),
        legend.position = c(0.2, 0.3), 
        legend.background = element_blank()) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) + 
  guides(fill = guide_legend(nrow=4, byrow = T))


df_30 = IRA %>%
    filter(year %in% c(2030))%>%
    mutate(value = value/1000)
  df_stat_30 = df_30 %>%
    group_by(scenario,year) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = IRA %>%
    filter(year %in% c(2035)) %>%
    mutate(value = value/1000)
  df_stat_35 = df_35 %>%
    group_by(scenario,year) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.1)) +
    geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario))+
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(-0.5,8)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = -0.1)) +
    geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario))+
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(0,8)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))


final = fin + dots_30 + dots_35 +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)

```

## Fig ES4/3/6.1 THIS IS THE VERSION WE WANT TO USE THE OTHER ONE ISNT GOOD!

```{r} 
look <- clean_data %>%
  filter(grepl("Seq", variable))
unique(look$variable)


ghgi <- clean_data %>%
  filter(model == "EPA-GHGI") %>%
  filter(variable == "Emissions|GHG|Net")%>%
  filter(year >= 2005)

connect <- ghgi[ghgi$year == 2021,] %>%
  select(year, value)%>%
  mutate(ymin = value, 
         ymax = value, 
         med = value) %>%
  select(-value)

lts <- clean_data %>%
  filter(model == "GCAM-LTS") %>%
  filter(variable == "Emissions|CO2" | 
           variable == "Emissions|CH4" |
           variable == "Emissions|N2O" | 
           variable == "Emissions|F-Gases" |
           variable == "Carbon Sequestration|CCS|Biomass|Energy" | 
           variable == "Carbon Sequestration|LULUCF" | 
           variable == "Carbon Sequestration|Direct Air Capture|Net") %>%
  mutate(value = case_when(
    # unit == "Mt CH4/yr" ~ value * 28,
    # unit == "kt N2O/yr" ~ value * 265/1000, 
    grepl("Sequestration", variable) ~ value * -1, 
    T ~ value
  )) %>%
  group_by(year, scenario) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>%
  group_by(year) %>%
  summarize(ymax = max(value), 
            ymin = min(value), 
            med = median(value)) %>%
  filter(year >= 2021) %>%
  filter(year <= 2035)

lts <- rbind(lts, connect)

IRA <- clean_data %>%
  filter(scenario == "IRA" | scenario == "No IRA") %>%
  filter(year > 2021  & year <= 2035) %>%
  filter(variable == "Emissions|CO2" | variable == "Emissions|Non-CO2 GHG" |
           variable == "Carbon Sequestration|CCS|Biomass|Energy" | 
           variable == "Carbon Sequestration|LULUCF" | 
           variable == "Carbon Sequestration|Direct Air Capture|Net") %>%
  group_by(year, model, scenario) %>%
  summarise(
    value = sum(value)
  ) %>%
  filter(!model == "USREP-ReEDS") %>%
  filter(!model== "OP-NEMS") %>%
  filter(model != "MARKAL-NETL") %>%
  filter(!model == "AEO.2023")
  
histcon <- IRA %>%
  group_by(model, scenario) %>%
  slice(1) %>%
  mutate(year = 2021) %>%
  mutate(value = ghgi$value[ghgi$year == 2021])

IRA <- rbind(IRA, histcon)

IRA <- IRA %>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.8
  )) 


fin = ggplot() + 
  geom_line(ghgi, mapping = aes(x = year, y = value/1000, color = "Historic"), size = 0.8) +
  geom_line(lts, mapping = aes(x=year, y = ymin/1000, color = "LTS"), linetype = "dashed", size = 0.8, color = "#767684")+
  geom_line(lts, mapping = aes(x=year, y = ymax/1000, color = "LTS"), linetype = "dashed", size = 0.8, color = "#767684")+
  geom_ribbon(lts, mapping = aes(x=year, ymax = ymax/1000, ymin = ymin/1000, fill = "LTS"), alpha = 0.2) + 
  geom_line(IRA, mapping = aes(x=year, y = value/1000, group = interaction(model, scenario), color = scenario, alpha = alpha)) + 
  scale_color_manual(name = "", 
                     breaks = c("IRA", "No IRA", "Historic", "LTS"), 
                     values = c("#0388B3","#F28063", "black", "#767684"), 
                     labels = c("IRA", "No IRA", "Historic Emissions", "Emissions Targets")) + 
  scale_fill_manual(name = "", 
                    breaks = c("IRA", "No IRA", "Historic", "LTS"), 
                     values = c("#0388B3","#F28063", "black", "#767684"), 
                     labels = c("IRA", "No IRA", "Historic Emissions", "Emissions Targets")) +
  theme_emf() + 
  labs(title = "", 
       y = expression(paste("Net GHG Emissions (MMt ", CO[2], "e)", sep = "")), 
       x = "") +
  scale_alpha(range = c(0.6, 1), guide = F) + 
  ylim(-0.5, 8) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        legend.box = "vertical",
        legend.text = element_text(size = 8),
        legend.spacing.y = unit(0.5, "mm"),
        legend.position = c(0.2, 0.3), 
        legend.background = element_blank()) + 
  scale_x_continuous(breaks = c(2005, 2021, 2025, 2030, 2035)) + 
  guides(fill = guide_legend(nrow=4, byrow = T))


df_30 = IRA %>%
    filter(year %in% c(2030))%>%
    mutate(value = value/1000)
  df_stat_30 = df_30 %>%
    group_by(scenario,year) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  df_35 = IRA %>%
    filter(year %in% c(2035)) %>%
    mutate(value = value/1000)
  df_stat_35 = df_35 %>%
    group_by(scenario,year) %>%
    summarise(mean = mean(value),
           median = median(value))
  
  dots_30 = ggplot() +
    geom_point(data = df_30, aes(x = year, y = value, alpha = alpha, color = scenario), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    geom_segment(data = df_stat_30, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario))+
    scale_x_continuous(breaks = c(2030), labels = c("2030"), limits = c(2029.9, 2030.1)) +
    scale_y_continuous(limits = c(-0.5,8)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))
  
  # dot plot for 2035
  dots_35 = ggplot() +
    geom_point(data = df_35, aes(x = year, y = value, color = scenario, alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.1)) +
    geom_segment(data = df_stat_35, aes(x = year - 0.025, xend = year + 0.025, y = median, yend = median, color = scenario))+
    scale_x_continuous(breaks = c(2035), labels = c("2035"), limits = c(2034.9, 2035.1)) +
    scale_y_continuous(limits = c(-0.5,8)) +
    theme_emf() +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
  scale_alpha(range = c(0.4, 1), guide = F) + 
    theme(panel.grid = element_blank(), plot.title = element_blank(),
          axis.text.y = element_blank(),
          axis.text.x = element_text(angle = 45, hjust=1),
          axis.title.y = element_blank(), axis.title.x = element_blank(),
          axis.ticks = element_blank(), panel.border = element_blank(),
          legend.position = "none", plot.margin = margin(0,0,0,0))


final = fin + dots_30 + dots_35 +
    plot_layout(widths = c(10,1,1)) +
    theme(plot.margin = margin(0,0,0,0))

print(final)

ggsave(filename = "output/final_figures/Fig6.1andES4.svg", plot = final,width = 7, height = 5, units = "in")
ggsave(filename = "output/final_figures/Fig6.1andES4.png", plot = final,width = 7, height = 5, units = "in")

```

### Table ES4/6.1

```{r}

title = "GHG Emissions Exec"

base <- clean_data %>%
  filter(variable == "Emissions|GHG|Net" & year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- clean_data %>%
  filter(!model == "USREP-ReEDS") %>%
  filter(!model== "OP-NEMS") %>%
  filter(model != "MARKAL-NETL") %>%
  filter(!model == "AEO.2023") %>%
  filter(variable == "Emissions|GHG") %>%
  filter(year %in% c(2025,2030,2035)) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- clean_data %>%
  filter(!model == "USREP-ReEDS") %>%
  filter(!model== "OP-NEMS") %>%
  filter(model != "MARKAL-NETL") %>%
  filter(!model == "AEO.2023") %>%
  filter(variable == "Emissions|GHG") %>%
  filter(year %in% c(2025,2030,2035)) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2025 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2025 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2025 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2025 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2025 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2025 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2025 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

write.csv(IRA, paste0("./output/leep/", title, ".csv"), row.names = F)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```
