---
title: "Chapter 3: Transportation"
output: 
  html_document:
    toc: true
    toc_float: true
date: "`r Sys.time()`"
params:
  mode: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
if(is.null(params$mode)) {
  source("packages.R")
  devtools::load_all()
}

# load data from targets pipeline
targets::tar_load(config)
targets::tar_load(clean_data)
targets::tar_load(figmap_leep_timeseries)
targets::tar_load(figmap_leep_cone)
targets::tar_load(figmap_leep_stackbar)
targets::tar_load(data_min)
targets::tar_load(data_raw)
```

## 3.1 co2 emissions from the transportation sector in the us compared to economy-wide co2 emissions

```{r}
fig_no = 3.1

subpalettes = create_subpalettes(figmap_leep_stackbar, config)

dta2 = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 9, "United States") %>%
  mutate(variable_rename = case_when(
    variable_rename == "Transportation: Direct" ~ variable_rename,
    variable_rename == "Transportation: Indirect" ~ variable_rename,
    TRUE ~ "Other Sectors"
  )) %>%
  mutate(variable_rename = factor(variable_rename, 
                                  levels = c("Transportation: Direct", "Transportation: Indirect", "Other Sectors")))

p2 = emis_stack(dta2, "Transportation CO2 Emissions", figmap_leep_stackbar, config) + 
  scale_fill_manual(values = c("Other Sectors" = "white", "Transportation: Indirect" = subpalettes$`Emissions Stack`[["Transportation: Indirect"]], "Transportation: Direct" = subpalettes$`Emissions Stack`[["Transportation: Direct"]])) + 
  scale_color_manual(values = c("Other Sectors" = "#CECECE", "Transportation: Indirect" = subpalettes$`Emissions Stack`[["Transportation: Indirect"]], "Transportation: Direct" = subpalettes$`Emissions Stack`[["Transportation: Direct"]])) +
  scale_alpha_manual(values = c("Other Sectors" = 0.5, "Transportation: Indirect" = 1, "Transportation: Direct" = 1))
p2

dta2 = clean_supplemental_data(dta2, fig_no)

saveall(p2, dta2, fig_no)
```

## 3.2 co2 emissions from the transportation sector in the us by end use

```{r}
fig_no = 3.2

fig = print_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 3, "United States", 
                  level_var = c("Other", "Pipelines", 
                                "Water", "Aircraft", "MHD Trucks", "LD Trucks", "Passenger Cars")) +
  labs(y = "Emissions (Mt CO2/yr)") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), plot.title = element_blank()) +
  bottom1

fig

dta = data_from_graph("stacked_bar", config, clean_data, figmap_leep_stackbar, 3, "United States")

dta = clean_supplemental_data(dta, fig_no)

saveall(fig, dta, fig_no)
```

## 3.3 total co2 emissions in the transportation sector

```{r}
fig_no = 3.3

Tran_data = spg_clean(
  19, 
  c("IPM-NRDC", "IPM-EPA", "ReEDS-NREL", "Scout-LEEP", "Haiku-RFF"),
  "EPA-GHGI", 
  config, 
  clean_data, 
  figmap_leep_timeseries
)

TranSpg = spg2(
  Tran_data,
  "",
  expression(paste("Emissions (Mt C", O[2], "/yr)")),
  gd = "none",
  0,
  2500,
  c(0, 500, 1000, 1500, 2000, 2500),
  scales::comma, 
  1, 
  c(2015, 2000), 
  c(2030, 2100), 
  c(2025, 1250), 
  config, 
  figmap_leep_timeseries) 

fig = dotted(TranSpg$data, TranSpg$figure, "median", 0, 2500, config, figmap_leep_timeseries)
fig

TranSpg$data = clean_supplemental_data(TranSpg$data, fig_no)

saveall(fig, TranSpg$data, fig_no)

html(TranSpg$data, "Transportation CO<sub>2<sub>")
```

## 3.4 electric vehicle percent share of new sales

```{r}
fig_no = "3.4"

# clean_data_evshare = spg_clean(ts_map_ID = 118, drop = c(""), histsrc = "EPA-ATR", 
#                            config = config, clean_data = clean_data4, figmap_leep_timeseries = figmap_leep_timeseries)
scen_map = read.csv("./data-raw/scenario-mapping.csv") %>% select(datasrc, model, scenario, model_new, scenario_new)
raw = data_raw %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new) %>%
  filter(unit != "thousands") %>%
  filter(!(model == "EPA-ATR" & year >= 2022))

atr_2022 = raw %>% filter(model == "EPA-ATR", year == 2021) %>% mutate(year = 2022)
nems = data_min %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
  filter(model == "OP-NEMS", 
         scenario %in% c("IRA", "No IRA"),
         datasrc != "LTS_data_small.xlsx",
         grepl("Sales Share", variable),
         unit == "%") %>%
  left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
  select(-c(model, scenario)) %>%
  rename(model = model_new) %>%
  rename(scenario = scenario_new)

clean_data_evshare = rbind(raw, atr_2022, nems) %>% 
  filter(unit != "thousands") %>% 
  mutate(value = 100 * value) %>%
  filter(model != "EIA-LTS") %>% 
  duplicate_historical_data("EPA-ATR", 2022, criteria = TRUE) %>% mutate(
    variable = case_when(
      variable %in% c(
        "Energy Service|Transportation|Passenger|BEV|Sales Share",
        # "Energy Service|Transportation|Passenger|FCEV|Sales Share",
        # "Energy Service|Transportation|Passenger|HEV|Sales Share",
        # "Energy Service|Transportation|Freight|BEV|Sales Share",
        # "Energy Service|Transportation|Freight|FCEV|Sales Share",
        "Energy Service|Transportation|Passenger|PHEV|Sales Share",
        "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share"
        ) ~ 
        "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share")) %>%
  group_by(model, scenario, unit, datasrc, year, region, variable) %>%
  summarize(value = sum(value)) %>%
  filter(!(is.na(variable))) %>%
  filter(year <= 2035) %>%
#  filter(!(model %in% c("OP-NEMS-LTS"))) %>%
  filter(!(datasrc %in% c("LTS_data_small.xlsx"))) %>%
  mutate(variable_rename = variable) %>%
  mutate(alpha = case_when(
      model == "USREP-ReEDS" ~ 1,
      model == "GCAM-PNNL" ~ 1,
      model == "IPM-EPA" ~ 1,
      scenario == "Historic" ~ 1,
      T ~ 0.6
  )) %>%
  mutate(value = case_when(year == 2022 & model == "OP-NEMS" ~ 100 * atr_2022$value[1], 
                           TRUE ~ value))

output = spg2(df = clean_data_evshare, title = "", yname = "EV Sales Share (%)", gd = "none", ymin = 0, ymax = 100, 
              ybreaks = waiver(), yax_format = waiver(), annotate = 1, 
              historic_coord = c(2015,8), preira_coord = c(2030, 10), ira_coord = c(2027, 74),
              config = config, figmap_leep_timeseries = figmap_leep_timeseries)
output$figure

figure = output$figure

ev_share_data = output$data
ev_share_data = clean_supplemental_data(ev_share_data, fig_no)
figure_full = dotted(clean_data_evshare, figure, "median", ymin = 0, ymax = 100, 
                config = config, figmap_leep_timeseries = figmap_leep_timeseries)
figure_full

saveall(figure_full, ev_share_data, fig_no)

```


Older version
```{r, eval = FALSE}
# fig_no = 3.4
# 
# scen_map = read.csv("./data-raw/scenario-mapping.csv") %>% select(datasrc, model, scenario, model_new, scenario_new)
# 
# raw = data_raw %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
#   left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
#   select(-c(model, scenario)) %>%
#   rename(model = model_new) %>%
#   rename(scenario = scenario_new) %>%
#   filter(unit != "thousands") %>%
#   filter(!(model == "EPA-ATR" & year >= 2022))
# 
# atr_2022 = raw %>% filter(model == "EPA-ATR", year == 2021) %>% mutate(year = 2022)
# nems = data_min %>% select(model, scenario, region, variable, unit, datasrc, year, value) %>%
#   filter(model == "OP-NEMS", grepl("Sales Share", variable),
#          unit == "%") %>%
#   left_join(scen_map, by = c("datasrc", "model", "scenario")) %>%
#   select(-c(model, scenario)) %>%
#   rename(model = model_new) %>%
#   rename(scenario = scenario_new)
# 
# clean_data4 = rbind(raw, atr_2022, nems) %>% 
#   filter(unit != "thousands") %>% 
#   mutate(value = 100 * value) %>%
#   filter(model != "EIA-LTS") %>% 
#   duplicate_historical_data("EPA-ATR", 2022, criteria = TRUE) %>% mutate(
#     variable = case_when(
#       variable %in% c(
#         "Energy Service|Transportation|Passenger|BEV|Sales Share",
#         # "Energy Service|Transportation|Passenger|FCEV|Sales Share",
#         # "Energy Service|Transportation|Passenger|HEV|Sales Share",
#         # "Energy Service|Transportation|Freight|BEV|Sales Share",
#         # "Energy Service|Transportation|Freight|FCEV|Sales Share",
#         "Energy Service|Transportation|Passenger|PHEV|Sales Share",
#         "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share"
#         ) ~ 
#         "Energy Service|Transportation|Passenger|BEV and PHEV|Sales Share")) %>%
#   group_by(model, scenario, unit, datasrc, year, region, variable) %>%
#   summarize(value = sum(value)) %>%
#   filter(!(is.na(variable))) %>%
#   mutate(alpha = case_when(
#     model == "USREP-ReEDS" ~ 1,
#     model == "GCAM-PNNL" ~ 1,
#     model == "OP-NEMS" ~ 1,
#     scenario == "Historic" ~ 1,
#     TRUE ~ 0.8)
#   ) %>%
#   mutate(value = case_when(year == 2022 & model == "OP-NEMS" ~ 100 * atr_2022$value[1], 
#                            TRUE ~ value))
# 
# fig = print_graph("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States")
# fig
# dta = data_from_graph("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States")
# dta = clean_supplemental_data(dta, fig_no)
# 
# p = dot_plots("time_series", config, clean_data4, figmap_leep_timeseries, 118, "United States", 0, 100, "EV Share", metric = "median", hist_year = 2022, historic_coord = c(2015,8), preira_coord = c(2030, 10), ira_coord = c(2027, 53), ylab = "EV Sales Share (%)")
# p$full
# 
# print(p$stats)
# 
# saveall(p$full, dta, fig_no)
```

## 3.5 electricity demand from light-duty vehicles in the transportation sector

```{r}
fig_no = 3.5

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 24, "United States")

ymin = 0
ymin = 700
metric = "median"

data <- fig$data %>%
  filter(year == 2025 | year == 2030 | year == 2035)%>%
  mutate(alpha = case_when(
    model == "USREP-ReEDS" ~ 1, 
    model == "GCAM-PNNL" ~ 1, 
    model == "IPM-EPA" ~ 1,
    scenario == "Historic" ~ 1,
    T ~ 0.6
  ))%>%
  mutate(value = value/0.0036, 
         unit = "TWh")

df_25 = data %>%
  filter(year %in% c(2025))
df_stat_25 = df_25 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_30 = data %>%
  filter(year %in% c(2030))
df_stat_30 = df_30 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

df_35 = data %>%
  filter(year %in% c(2035))
df_stat_35 = df_35 %>%
  group_by(scenario,year,variable_rename) %>%
  summarise(mean = mean(value),
            median = median(value))
  

mean_diff_25 = df_stat_30[df_stat_25$scenario == "No IRA","mean"]$mean - df_stat_25[df_stat_25$scenario == "IRA","mean"]$mean
median_diff_25 = df_stat_35[df_stat_25$scenario == "No IRA","median"]$median - df_stat_25[df_stat_25$scenario == "IRA","median"]$median

mean_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","mean"]$mean - df_stat_30[df_stat_30$scenario == "IRA","mean"]$mean
mean_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","mean"]$mean - df_stat_35[df_stat_35$scenario == "IRA","mean"]$mean

median_diff_30 = df_stat_30[df_stat_30$scenario == "No IRA","median"]$median - df_stat_30[df_stat_30$scenario == "IRA","median"]$median
median_diff_35 = df_stat_35[df_stat_35$scenario == "No IRA","median"]$median - df_stat_35[df_stat_35$scenario == "IRA","median"]$median

stats = data.frame("year" = c(2025, 2030, 2035, 2025,  2030, 2035), "metric" = c("mean","mean", "mean", "median", "median","median"), 
                   "difference" = c(mean_diff_25, mean_diff_30, mean_diff_35, median_diff_25, median_diff_30, median_diff_35))

data = rbind(df_25, df_30, df_35) 

print("Light-Duty Vehicles")

data <- data %>%
  mutate(axe = case_when(
    year == 2025 ~ 1, 
    year == 2030 ~ 2, 
    year == 2035 ~ 3
  )) %>%
  filter(scenario == "No IRA" | scenario == "IRA")

subpalettes = create_subpalettes(figmap_leep_timeseries, config)

A = ggplot(data = data, aes(x = axe, y = value,  color = scenario)) +
  geom_point(aes(alpha = alpha), shape = 1, size = 1.5, position = position_dodge(width = 0.5)) +
  geom_segment(data = df_stat_35, aes(x = 2.94, xend = 3.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_30, aes(x = 1.94, xend = 2.06, y = median, yend = median, color = scenario), size = 0.5) +
  geom_segment(data = df_stat_25, aes(x = 0.94, xend = 1.06, y = median, yend = median, color = scenario), size = 0.5) +
    scale_x_continuous(breaks = c(1,2,3), labels = c("2025", "2030", "2035")) +
    theme_emf() +
    labs(y = "Final Energy (TWh)") +
    scale_subpalette(subpalettes, "Emissions|CO2|Energy|Demand|Industry") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "bottom") + 
  scale_alpha(range = c(0.6, 1), guide = F) + 
  ylim(0, 700)

print(A)

data = clean_supplemental_data(data, fig_no)

savefig(A, fig_no)
savedata(data, fig_no)
```

### Table 3.5

```{r}
title = "Light Duty Vehicles"

fig = print_graph("time_series", config, clean_data, figmap_leep_timeseries, 24, "United States")

fig$data <- fig$data %>%
   mutate(value = value/0.0036)

base <- fig$data %>%
  filter(year == 2005 & model == "EPA-GHGI")

baseline = base$value[1]

base <- as.data.frame(base) %>%
  select(Year = year, 
         `Absolute Level (Mt CO2)` = value) %>%
  mutate(Scenario = "Baseline", 
    `% Reductions from 2005` = NA,
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA)  %>%
  select(Year, Scenario, `Absolute Level (Mt CO2)`, `% Reductions from 2005`, `% Reductions from No IRA`, `Reductions from No IRA (Mt CO2)`)

NoIRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "No IRA") %>%
  group_by(year) %>%
  summarize(`No IRA Median` = median(value), 
            `No IRA Min` = min(value),
            `No IRA Max` =  max(value))%>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(`2005_perc_red` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100) %>%
  mutate(
    Year = year, 
    `% Reductions from 2005` = `2005_perc_red`, 
    `% Reductions from No IRA` = NA, 
    `Reductions from No IRA (Mt CO2)` = NA
  ) %>%
  select(!year & !`2005_perc_red`)

IRA <- fig$data %>%
  filter(year == 2030 | year == 2035) %>%
  filter(scenario == "IRA") %>%
  select(!scenario) %>%
  group_by(year) %>%
  summarize(
    `IRA Max` = max(value), 
    `IRA Min` = min(value), 
    `IRA Median` = median(value)) %>%
  pivot_longer(cols = !year, names_to = "Scenario", values_to = "Absolute Level (Mt CO2)") %>%
  mutate(
    `% Reductions from 2005` = ((baseline-`Absolute Level (Mt CO2)`)/baseline) * 100
  )%>%
  mutate(
    `% Reductions from No IRA` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]) * 100,
      
            year == 2035 & Scenario == "IRA Max" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]) * 100, 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]) * 100, 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        ((NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)/NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]) * 100
    ), 

    `Reductions from No IRA (Mt CO2)` = case_when(
      year == 2030 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2030 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2030 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`),
      
            year == 2035 & Scenario == "IRA Max" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Max"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Median" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Median"]-`Absolute Level (Mt CO2)`), 
      
      year == 2035 & Scenario == "IRA Min" ~ 
        (NoIRA$`Absolute Level (Mt CO2)`[NoIRA$Year == 2035 & NoIRA$Scenario == "No IRA Min"]-`Absolute Level (Mt CO2)`)
    )
  ) %>%
  rename(Year = year)

IRA = rbind(NoIRA, IRA)

IRA$`Absolute Level (Mt CO2)` = round(IRA$`Absolute Level (Mt CO2)`, 3)
IRA$`% Reductions from 2005` = round(IRA$`% Reductions from 2005`, 3)
IRA$`% Reductions from No IRA` = round(IRA$`% Reductions from No IRA`, 3)
IRA$`Reductions from No IRA (Mt CO2)` = round(IRA$`Reductions from No IRA (Mt CO2)`,3)

IRA <- IRA %>%
  arrange(desc(IRA)) %>%
  arrange(Year)

IRA = rbind(base, IRA)

IRA %>%
tableHTML(caption = paste(title), rownames = F)
```
